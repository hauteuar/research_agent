<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Mainframe Analyzer with File Flow</title>
    <style>
        /* Enhanced styles with new Flow Analysis features */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            color: #f8fafc;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 198, 121, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 3.2rem;
            margin-bottom: 12px;
            font-weight: 800;
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 25%, #8b5cf6 50%, #ec4899 75%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            letter-spacing: -0.02em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 520px 1fr 400px;
            gap: 25px;
            min-height: 80vh;
        }

        .control-panel, .analysis-workspace, .chat-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .control-panel {
            height: fit-content;
            max-height: 85vh;
            overflow-y: auto;
        }

        .analysis-workspace {
            min-height: 80vh;
            overflow-y: auto;
        }

        .chat-panel {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        /* Enhanced tab system for new Flow Analysis */
        .tabs {
            display: flex;
            margin-bottom: 25px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 6px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            flex-wrap: wrap;
            gap: 4px;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            background: transparent;
            color: rgba(148, 163, 184, 0.8);
            border: none;
            padding: 12px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
            text-align: center;
        }

        .tab.active {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.25);
        }

        .tab:hover:not(.active) {
            background: rgba(148, 163, 184, 0.1);
            color: #f8fafc;
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Flow Analysis Styles */
        .flow-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #06b6d4;
        }

        .flow-stage {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 3px solid;
        }

        .flow-stage.input { border-left-color: #22c55e; }
        .flow-stage.process { border-left-color: #3b82f6; }
        .flow-stage.output { border-left-color: #f59e0b; }
        .flow-stage.unused { border-left-color: #ef4444; }

        .flow-field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .flow-field-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            border-left: 2px solid;
        }

        .flow-field-item.input { border-left-color: #22c55e; }
        .flow-field-item.derived { border-left-color: #3b82f6; }
        .flow-field-item.output { border-left-color: #f59e0b; }
        .flow-field-item.condition { border-left-color: #8b5cf6; }
        .flow-field-item.unused { border-left-color: #ef4444; }
        .flow-field-item.static { border-left-color: #64748b; }

        /* Program Flow Chart */
        .program-flow-chart {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .flow-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid #06b6d4;
        }

        .flow-step-number {
            background: #06b6d4;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 12px;
        }

        .flow-step-content {
            flex: 1;
        }

        .flow-step-title {
            font-weight: bold;
            color: #06b6d4;
            margin-bottom: 4px;
        }

        .flow-step-description {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.4;
        }

        /* File lifecycle visualization */
        .lifecycle-timeline {
            position: relative;
            padding-left: 30px;
        }

        .lifecycle-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #22c55e, #3b82f6, #f59e0b, #ef4444);
        }

        .lifecycle-event {
            position: relative;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-left: 15px;
        }

        .lifecycle-event::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--event-color);
            border: 2px solid rgba(15, 23, 42, 0.8);
        }

        .lifecycle-event.create { --event-color: #22c55e; }
        .lifecycle-event.read { --event-color: #3b82f6; }
        .lifecycle-event.update { --event-color: #f59e0b; }
        .lifecycle-event.unused { --event-color: #ef4444; }

        /* Component Search Section Styles */
.component-search-section {
    margin-bottom: 25px;
    padding: 24px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.08) 100%);
    border-radius: 16px;
    border: 1px solid rgba(34, 197, 94, 0.3);
    box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.1);
}

.component-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid rgba(148, 163, 184, 0.3);
    border-radius: 12px;
    background: rgba(30, 41, 59, 0.6);
    color: #f8fafc;
    font-size: 14px;
    margin-bottom: 10px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
}

.component-input:focus {
    outline: none;
    border-color: #06b6d4;
    background: rgba(30, 41, 59, 0.8);
    box-shadow: 
        0 0 0 3px rgba(6, 182, 212, 0.1),
        0 4px 6px -1px rgba(6, 182, 212, 0.1);
    transform: translateY(-1px);
}

.component-input::placeholder {
    color: rgba(148, 163, 184, 0.7);
}

.component-suggestions {
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 12px;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    border: 1px solid rgba(148, 163, 184, 0.3);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 13px;
}

.suggestion-item:hover {
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
    transform: translateX(4px);
    border-left: 3px solid #06b6d4;
}

/* Token Management */
.token-info {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.08) 100%);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
    font-size: 12px;
    box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1);
}

.token-bar {
    background: rgba(15, 23, 42, 0.6);
    height: 8px;
    border-radius: 4px;
    margin: 10px 0;
    overflow: hidden;
    border: 1px solid rgba(148, 163, 184, 0.2);
}

.token-fill {
    height: 100%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 4px;
    background: linear-gradient(90deg, var(--token-color-start), var(--token-color-end));
}

.token-fill.safe { 
    --token-color-start: #22c55e;
    --token-color-end: #16a34a;
}
.token-fill.warning { 
    --token-color-start: #f59e0b;
    --token-color-end: #d97706;
}
.token-fill.danger { 
    --token-color-start: #ef4444;
    --token-color-end: #dc2626;
}

/* General Form Styles */
.section-title { 
    color: #06b6d4; 
    font-size: 1.3rem; 
    margin-bottom: 18px; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
    gap: 12px;
    letter-spacing: -0.01em;
}

.form-group { 
    margin-bottom: 20px; 
}

.form-group input, 
.form-group select, 
.form-group textarea { 
    width: 100%; 
    padding: 14px 16px; 
    border: 2px solid rgba(148, 163, 184, 0.3); 
    border-radius: 12px; 
    background: rgba(30, 41, 59, 0.6); 
    color: #f8fafc; 
    font-size: 14px; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #06b6d4;
    background: rgba(30, 41, 59, 0.8);
    box-shadow: 
        0 0 0 3px rgba(6, 182, 212, 0.1),
        0 4px 6px -1px rgba(6, 182, 212, 0.1);
    transform: translateY(-1px);
}

.form-group input::placeholder,
.form-group textarea::placeholder {
    color: rgba(148, 163, 184, 0.7);
}

.action-btn { 
    width: 100%; 
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
    color: white; 
    border: none; 
    padding: 16px 20px; 
    border-radius: 12px; 
    cursor: pointer; 
    font-size: 15px; 
    font-weight: 600; 
    margin-bottom: 12px; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    text-transform: uppercase; 
    letter-spacing: 0.5px;
    box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.25);
}

.action-btn:hover:not(:disabled) { 
    transform: translateY(-2px); 
    box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.4);
    background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
}

.action-btn:active:not(:disabled) {
    transform: translateY(0);
}

.action-btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
    transform: none; 
    box-shadow: none; 
}

.validate-btn { 
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
    box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.25);
}

.validate-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.4);
}

.component-btn { 
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
    box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.25);
}

.component-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.4);
}

.secondary-btn { 
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.25);
}

.secondary-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
}

/* API Status */
.api-status {
    padding: 14px 16px;
    border-radius: 12px;
    margin-top: 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.api-status.connected {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.1) 100%);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: #4ade80;
    box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.1);
}

.api-status.connecting {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #fbbf24;
    box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1);
}

.api-status.disconnected {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #f87171;
    box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.1);
}

/* Upload Area */
.upload-area {
    border: 2px dashed rgba(148, 163, 184, 0.4);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 20px;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.3) 0%, rgba(51, 65, 85, 0.2) 100%);
}

.upload-area:hover {
    border-color: #06b6d4;
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(6, 182, 212, 0.1);
}

.upload-area.drag-over {
    border-color: #22c55e;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
    transform: scale(1.02);
}

.file-list {
    max-height: 200px;
    overflow-y: auto;
}

.file-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: bold;
    margin-bottom: 2px;
}

.file-details {
    font-size: 11px;
    opacity: 0.8;
}

.file-remove {
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-remove:hover {
    background: #d32f2f;
}
</style>
</head>    
<body>
<!-- File Upload Section -->
                <div style="margin-bottom: 25px;">
                    <h2 class="section-title">📁 Upload Mainframe Files</h2>
                    <div class="upload-area" id="uploadArea">
                        <div>
                            <h3 style="margin-bottom: 8px;">📤 Drop files here</h3>
                            <p style="font-size: 14px;">COBOL (.cbl), Copybooks (.cpy), JCL (.jcl)</p>
                        </div>
                        <input type="file" id="fileInput" multiple accept=".cbl,.cob,.cpy,.copybook,.jcl,.txt,.proc" style="display: none;">
                    </div>
                    <div id="uploadedFiles" class="file-list"></div>
                </div>

                <!-- Quick Actions -->
                <div>
                    <h3 class="section-title">⚡ Actions</h3>
                    <button class="action-btn secondary-btn" id="bulkAnalyzeBtn" disabled>
                        📊 Bulk Analyze
                    </button>
                    
                    <!-- Export Section -->
                    <div class="export-section">
                        <h4 style="color: #FFC107; margin-bottom: 10px; font-size: 14px;">📤 Export Options</h4>
                        <div class="export-btn-group">
                            <button class="export-btn-small" id="exportJsonBtn" disabled>
                                📋 JSON Export
                            </button>
                            <button class="export-btn-small" id="exportMdBtn" disabled>
                                📝 Markdown Export
                            </button>
                        </div>
                    </div>
                    
                    <button class="action-btn secondary-btn" id="clearBtn">
                        🗑️ Clear All Data
                    </button>
                </div>
            </div>

            <!-- Analysis Workspace -->
            <div class="analysis-workspace">
                <div class="tabs">
                    <button class="tab active" data-tab="lifecycle">🔄 Analysis Results</button>
                    <button class="tab" data-tab="fieldmatrix">📋 Field Matrix</button>
                    <button class="tab" data-tab="fileflow">🌊 File Flow</button>
                    <button class="tab" data-tab="programflow">🔀 Program Flow</button>
                    <button class="tab" data-tab="usage">📈 Usage Patterns</button>
                    <button class="tab" data-tab="dependencies">🔗 Dependencies</button>
                </div>

                <!-- Tab Contents -->
                <div id="lifecycle" class="tab-content active">
                    <div id="lifecycleContent">
                        <h3>🎯 LLM-Powered Component Analysis with Flow Tracking</h3>
                        <p style="margin-bottom: 20px; line-height: 1.6;">
                            Upload files, test your connection, and analyze components for detailed LLM-powered field flows and business rules.
                        </p>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; border-left: 4px solid #FFD700;">
                            <h4 style="color: #FFD700; margin-bottom: 15px;">🤖 Enhanced LLM Features:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <strong style="color: #4CAF50;">🧠 LLM Field Analysis:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Smart field lifecycle tracking</li>
                                        <li>• Context-aware usage patterns</li>
                                        <li>• Intelligent field categorization</li>
                                        <li>• Cross-program flow analysis</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #2196F3;">🌊 File Flow Analysis:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Complete file lifecycle tracking</li>
                                        <li>• Input → Process → Output flow</li>
                                        <li>• Field usage across programs</li>
                                        <li>• Unused field identification</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #FF9800;">🔀 Program Flow:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Step-by-step program execution</li>
                                        <li>• Data transformation tracking</li>
                                        <li>• Business logic flow mapping</li>
                                        <li>• Decision point analysis</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #9C27B0;">🎯 Enhanced Chat:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Flow-aware question answering</li>
                                        <li>• Lifecycle impact explanations</li>
                                        <li>• Optimization recommendations</li>
                                        <li>• Interactive flow exploration</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fieldmatrix" class="tab-content">
                    <div id="fieldMatrixContent">
                        <h3>📋 LLM Field Matrix Analysis</h3>
                        <p style="margin-bottom: 20px;">Enhanced field-level analysis with LLM-powered categorization will appear here after component analysis.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">LLM-enhanced field matrix will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="fileflow" class="tab-content">
                    <div id="fileFlowContent">
                        <h3>🌊 File Flow Lifecycle Analysis</h3>
                        <p style="margin-bottom: 20px;">Complete file and field lifecycle tracking across all programs.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">File flow analysis will appear here after component analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="programflow" class="tab-content">
                    <div id="programFlowContent">
                        <h3>🔀 Program Flow Analysis</h3>
                        <p style="margin-bottom: 20px;">Step-by-step program execution flow with data transformation tracking.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">Program flow analysis will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="usage" class="tab-content">
                    <div id="usageContent">
                        <h3>📈 Smart Usage Patterns</h3>
                        <p style="margin-bottom: 20px;">LLM-powered usage pattern analysis will appear here after component analysis.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">Smart usage patterns will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="dependencies" class="tab-content">
                    <div id="dependenciesContent">
                        <h3>🔗 Hybrid Dependency Analysis</h3>
                        <p style="margin-bottom: 20px;">Regex + LLM dependency mapping will appear here after component analysis.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">Hybrid dependency graph will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <h3>🤖 LLM Analyzing Component Flow</h3>
                    <p id="loadingStatus">Processing component analysis with LLM...</p>
                    <div id="progressBar" style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; margin: 15px 0; overflow: hidden;">
                        <div id="progressFill" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>
    <!-- File Upload Section -->
                <div style="margin-bottom: 25px;">
                    <h2 class="section-title">📁 Upload Mainframe Files</h2>
                    <div class="upload-area" id="uploadArea">
                        <div>
                            <h3 style="margin-bottom: 8px;">📤 Drop files here</h3>
                            <p style="font-size: 14px;">COBOL (.cbl), Copybooks (.cpy), JCL (.jcl)</p>
                        </div>
                        <input type="file" id="fileInput" multiple accept=".cbl,.cob,.cpy,.copybook,.jcl,.txt,.proc" style="display: none;">
                    </div>
                    <div id="uploadedFiles" class="file-list"></div>
                </div>

                <!-- Quick Actions -->
                <div>
                    <h3 class="section-title">⚡ Actions</h3>
                    <button class="action-btn secondary-btn" id="bulkAnalyzeBtn" disabled>
                        📊 Bulk Analyze
                    </button>
                    
                    <!-- Export Section -->
                    <div class="export-section">
                        <h4 style="color: #FFC107; margin-bottom: 10px; font-size: 14px;">📤 Export Options</h4>
                        <div class="export-btn-group">
                            <button class="export-btn-small" id="exportJsonBtn" disabled>
                                📋 JSON Export
                            </button>
                            <button class="export-btn-small" id="exportMdBtn" disabled>
                                📝 Markdown Export
                            </button>
                        </div>
                    </div>
                    
                    <button class="action-btn secondary-btn" id="clearBtn">
                        🗑️ Clear All Data
                    </button>
                </div>
            </div>

            <!-- Analysis Workspace -->
            <div class="analysis-workspace">
                <div class="tabs">
                    <button class="tab active" data-tab="lifecycle">🔄 Analysis Results</button>
                    <button class="tab" data-tab="fieldmatrix">📋 Field Matrix</button>
                    <button class="tab" data-tab="fileflow">🌊 File Flow</button>
                    <button class="tab" data-tab="programflow">🔀 Program Flow</button>
                    <button class="tab" data-tab="usage">📈 Usage Patterns</button>
                    <button class="tab" data-tab="dependencies">🔗 Dependencies</button>
                </div>

                <!-- Tab Contents -->
                <div id="lifecycle" class="tab-content active">
                    <div id="lifecycleContent">
                        <h3>🎯 LLM-Powered Component Analysis with Flow Tracking</h3>
                        <p style="margin-bottom: 20px; line-height: 1.6;">
                            Upload files, test your connection, and analyze components for detailed LLM-powered field flows and business rules.
                        </p>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; border-left: 4px solid #FFD700;">
                            <h4 style="color: #FFD700; margin-bottom: 15px;">🤖 Enhanced LLM Features:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <strong style="color: #4CAF50;">🧠 LLM Field Analysis:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Smart field lifecycle tracking</li>
                                        <li>• Context-aware usage patterns</li>
                                        <li>• Intelligent field categorization</li>
                                        <li>• Cross-program flow analysis</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #2196F3;">🌊 File Flow Analysis:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Complete file lifecycle tracking</li>
                                        <li>• Input → Process → Output flow</li>
                                        <li>• Field usage across programs</li>
                                        <li>• Unused field identification</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #FF9800;">🔀 Program Flow:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Step-by-step program execution</li>
                                        <li>• Data transformation tracking</li>
                                        <li>• Business logic flow mapping</li>
                                        <li>• Decision point analysis</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #9C27B0;">🎯 Enhanced Chat:</strong>
                                    <ul style="list-style: none; margin-left: 10px; line-height: 1.8;">
                                        <li>• Flow-aware question answering</li>
                                        <li>• Lifecycle impact explanations</li>
                                        <li>• Optimization recommendations</li>
                                        <li>• Interactive flow exploration</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fieldmatrix" class="tab-content">
                    <div id="fieldMatrixContent">
                        <h3>📋 LLM Field Matrix Analysis</h3>
                        <p style="margin-bottom: 20px;">Enhanced field-level analysis with LLM-powered categorization will appear here after component analysis.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">LLM-enhanced field matrix will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="fileflow" class="tab-content">
                    <div id="fileFlowContent">
                        <h3>🌊 File Flow Lifecycle Analysis</h3>
                        <p style="margin-bottom: 20px;">Complete file and field lifecycle tracking across all programs.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">File flow analysis will appear here after component analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="programflow" class="tab-content">
                    <div id="programFlowContent">
                        <h3>🔀 Program Flow Analysis</h3>
                        <p style="margin-bottom: 20px;">Step-by-step program execution flow with data transformation tracking.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">Program flow analysis will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="usage" class="tab-content">
                    <div id="usageContent">
                        <h3>📈 Smart Usage Patterns</h3>
                        <p style="margin-bottom: 20px;">LLM-powered usage pattern analysis will appear here after component analysis.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">Smart usage patterns will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <div id="dependencies" class="tab-content">
                    <div id="dependenciesContent">
                        <h3>🔗 Hybrid Dependency Analysis</h3>
                        <p style="margin-bottom: 20px;">Regex + LLM dependency mapping will appear here after component analysis.</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <p style="text-align: center; opacity: 0.8;">Hybrid dependency graph will appear here after analysis.</p>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <h3>🤖 LLM Analyzing Component Flow</h3>
                    <p id="loadingStatus">Processing component analysis with LLM...</p>
                    <div id="progressBar" style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; margin: 15px 0; overflow: hidden;">
                        <div id="progressFill" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>
            <!-- Enhanced Chat Panel -->
            <div class="chat-panel">
                <div style="background: rgba(76, 175, 80, 0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #4CAF50;">
                    <h3 style="margin-bottom: 8px; color: #FFD700;">💬 LLM Flow Analysis Chat</h3>
                    <p style="font-size: 12px; opacity: 0.8;">Enhanced interactive chat with flow-aware analysis and export</p>
                </div>
                
                <div style="flex: 1; overflow-y: auto; margin-bottom: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 10px; padding: 15px;" id="chatMessages">
                    <div class="chat-message assistant">
                        <div class="sender">LLM Flow Analysis Assistant</div>
                        <div class="content">
                            👋 <strong>Welcome to Flow-Enhanced Mainframe Analysis!</strong>
                            <br><br>
                            I can now provide detailed flow analysis including:
                            <br><br>
                            🌊 <strong>File Lifecycle:</strong> Complete field journey across programs
                            <br>🔀 <strong>Program Flow:</strong> Step-by-step execution tracking  
                            <br>📊 <strong>Usage Patterns:</strong> Field utilization analysis
                            <br>🎯 <strong>Optimization:</strong> Unused field identification
                            <br><br>
                            <em>Upload files and analyze a component to unlock comprehensive flow analysis!</em>
                        </div>
                        <div class="timestamp">Ready</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Ask about field flows, lifecycle, or usage patterns..." 
                           style="flex: 1; padding: 12px; border: 2px solid rgba(148, 163, 184, 0.3); border-radius: 10px; background: rgba(30, 41, 59, 0.6); color: #f8fafc;" disabled>
                    <button id="chatSendBtn" class="action-btn validate-btn" style="width: auto; padding: 12px 20px; margin: 0;" disabled>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Mainframe Analyzer with File Flow Analysis
        class EnhancedMainframeAnalyzerWithFlow {
            constructor() {
                // Core properties
                this.uploadedFiles = [];
                this.analysisResults = {};
                this.componentSuggestions = [];
                this.serverValidated = false;
                this.vllmEndpoint = 'http://localhost:8000';
                this.maxTokens = 4000;
                this.storageKey = 'enhanced_mainframe_flow_analysis';
                this.currentAnalyzedComponent = null;
                this.chatHistory = [];
                
                // Token management
                this.averageCharsPerToken = 3;
                this.tokenSafetyMargin = 0.7;
                
                // LLM Analysis configuration
                this.llmConfig = {
                    temperature: 0.1,
                    maxRetries: 3,
                    chunkSize: 2000,
                    analysisTimeout: 120000
                };
                
                this.initializeBasicEventListeners();
                this.loadStoredData();
                this.initializeTokenManagement();
                this.initializeChat();
                
                console.log('🚀 Enhanced Mainframe Analyzer with File Flow Analysis Initialized');
            }

            // === BASIC EVENT LISTENERS ===
            initializeBasicEventListeners() {
                // API validation
                document.getElementById('validateApiBtn').addEventListener('click', () => this.validateConnection());
                document.getElementById('vllmEndpoint').addEventListener('input', () => this.onEndpointChange());
                document.getElementById('maxTokens').addEventListener('input', () => this.onSettingsChange());
                
                // File upload handlers
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => {
                    if (this.serverValidated) fileInput.click();
                });
                uploadArea.addEventListener('drop', (e) => this.handleFileDrop(e));
                uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

                // Component analysis
                document.getElementById('componentName').addEventListener('input', () => this.onComponentInput());
                document.getElementById('analyzeComponentBtn').addEventListener('click', () => this.analyzeComponent());
                
                // Quick actions
                document.getElementById('bulkAnalyzeBtn').addEventListener('click', () => this.bulkAnalyze());
                document.getElementById('exportJsonBtn').addEventListener('click', () => this.exportResults('json'));
                document.getElementById('exportMdBtn').addEventListener('click', () => this.exportResults('markdown'));
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAllData());

                // Tab navigation
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e));
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.component-search-section')) {
                        document.getElementById('componentSuggestions').style.display = 'none';
                    }
                });
            }

            initializeTokenManagement() {
                this.updateTokenDisplay(0);
                this.showSuccess('🚀 Enhanced Flow Analysis Mainframe Analyzer Ready!');
            }

            initializeChat() {
                this.initializeChatEventListeners();
            }

            initializeChatEventListeners() {
                const chatSendBtn = document.getElementById('chatSendBtn');
                const chatInput = document.getElementById('chatInput');
                
                if (chatSendBtn && chatInput) {
                    chatSendBtn.addEventListener('click', () => this.sendChatMessage());
                    
                    chatInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendChatMessage();
                        }
                    });
                }
            }

            // === TOKEN MANAGEMENT ===
            estimateTokenCount(text) {
                if (!text) return 0;
                return Math.ceil(text.length / this.averageCharsPerToken);
            }

            updateTokenDisplay(currentTokens) {
                const tokenInfo = document.getElementById('tokenInfo');
                const tokenCount = document.getElementById('tokenCount');
                const tokenFill = document.getElementById('tokenFill');
                const tokenWarning = document.getElementById('tokenWarning');

                tokenInfo.style.display = 'block';
                tokenCount.textContent = `${currentTokens} / ${this.maxTokens}`;
                
                const percentage = (currentTokens / this.maxTokens) * 100;
                tokenFill.style.width = `${Math.min(percentage, 100)}%`;
                
                tokenFill.className = 'token-fill';
                if (percentage <= 50) {
                    tokenFill.classList.add('safe');
                    tokenWarning.textContent = '🟢 Optimal token usage - full LLM analysis available';
                } else if (percentage <= 70) {
                    tokenFill.classList.add('warning');
                    tokenWarning.textContent = '🟡 Moderate usage - intelligent LLM chunking active';
                } else {
                    tokenFill.classList.add('danger');
                    tokenWarning.textContent = '🔴 High usage - LLM optimization required';
                }
            }
// === API CONNECTION ===
            async validateConnection() {
                const endpoint = document.getElementById('vllmEndpoint').value.trim();
                if (!endpoint) {
                    this.showError('Please enter vLLM endpoint');
                    return;
                }

                this.updateConnectionStatus('connecting', 'Testing LLM connection...');

                try {
                    const response = await fetch(`${endpoint}/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: "Test LLM connection. Respond with 'LLM Connected'",
                            max_tokens: 20,
                            temperature: 0.1
                        }),
                        signal: AbortSignal.timeout(10000)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.serverValidated = true;
                        this.vllmEndpoint = endpoint;
                        this.updateConnectionStatus('connected', `✅ LLM connection verified`);
                        this.showSuccess('🚀 vLLM server connected successfully!');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.serverValidated = false;
                    this.updateConnectionStatus('disconnected', `❌ LLM connection failed: ${error.message}`);
                    this.showError(`LLM connection failed: ${error.message}`);
                }
                
                this.validateForm();
            }

            updateConnectionStatus(status, message) {
                const statusElement = document.getElementById('apiStatus');
                statusElement.className = `api-status ${status}`;
                statusElement.innerHTML = message;
            }

            // === FILE UPLOAD ===
            handleFileDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.classList.remove('drag-over');
                
                if (!this.serverValidated) {
                    this.showError('Please validate LLM API connection first');
                    return;
                }
                
                const files = Array.from(e.dataTransfer.files);
                this.processFiles(files);
            }

            handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('uploadArea').classList.add('drag-over');
            }

            handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('uploadArea').classList.remove('drag-over');
            }

            handleFileSelect(e) {
                if (!this.serverValidated) {
                    this.showError('Please validate LLM API connection first');
                    return;
                }
                
                const files = Array.from(e.target.files);
                this.processFiles(files);
            }

            async processFiles(files) {
                for (const file of files) {
                    try {
                        const content = await this.readFile(file);
                        const fileType = this.detectFileType(file.name, content);
                        
                        const fileObj = {
                            name: file.name,
                            content: content,
                            size: file.size,
                            type: fileType,
                            uploadDate: new Date().toISOString(),
                            id: Date.now() + Math.random()
                        };
                        
                        this.uploadedFiles.push(fileObj);
                        this.updateComponentSuggestions();
                        
                    } catch (error) {
                        this.showError(`Failed to read ${file.name}: ${error.message}`);
                    }
                }
                
                this.displayUploadedFiles();
                this.validateForm();
                this.saveToStorage();
                this.showSuccess(`📁 ${files.length} files uploaded successfully!`);
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(new Error('File read failed'));
                    reader.readAsText(file);
                });
            }

            detectFileType(fileName, content) {
                const name = fileName.toLowerCase();
                const upperContent = content.toUpperCase();
                
                if (name.includes('.cpy') || name.includes('copybook')) {
                    return 'Copybook';
                } else if (name.includes('.jcl') || upperContent.includes('//JOB ')) {
                    return 'JCL Job';
                } else if (name.includes('.cbl') || name.includes('.cob') || 
                          upperContent.includes('IDENTIFICATION DIVISION') ||
                          upperContent.includes('PROGRAM-ID')) {
                    return 'COBOL Program';
                } else if (name.includes('.proc')) {
                    return 'JCL Procedure';
                } else {
                    return 'Text File';
                }
            }

            displayUploadedFiles() {
                const container = document.getElementById('uploadedFiles');
                if (this.uploadedFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                let html = '';
                this.uploadedFiles.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-details">${file.type} • ${Math.round(file.size/1024)}KB</div>
                            </div>
                            <button class="file-remove" onclick="analyzer.removeFile('${file.id}')">🗑️</button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }

            removeFile(fileId) {
                this.uploadedFiles = this.uploadedFiles.filter(f => f.id != fileId);
                this.displayUploadedFiles();
                this.updateComponentSuggestions();
                this.validateForm();
                this.saveToStorage();
            }

            // === ENHANCED COMPONENT SUGGESTIONS ===
            updateComponentSuggestions() {
                this.componentSuggestions = [];
                
                this.uploadedFiles.forEach(file => {
                    const content = file.content.toUpperCase();
                    const lines = content.split('\n');
                    
                    lines.forEach(line => {
                        const trimmed = line.trim();
                        
                        // Extract COBOL field names
                        const fieldMatch = trimmed.match(/^\s*\d{2}\s+([A-Z][A-Z0-9\-_]{2,})/);
                        if (fieldMatch) {
                            this.componentSuggestions.push({
                                name: fieldMatch[1],
                                type: 'FIELD',
                                file: file.name
                            });
                        }
                        
                        // Extract copybook names
                        const copyMatch = trimmed.match(/COPY\s+([A-Z][A-Z0-9\-_]{2,})/);
                        if (copyMatch) {
                            this.componentSuggestions.push({
                                name: copyMatch[1],
                                type: 'COPYBOOK',
                                file: file.name
                            });
                        }
                        
                        // Extract program names
                        const programMatch = trimmed.match(/PROGRAM-ID\.?\s+([A-Z][A-Z0-9\-_]{2,})/);
                        if (programMatch) {
                            this.componentSuggestions.push({
                                name: programMatch[1],
                                type: 'PROGRAM',
                                file: file.name
                            });
                        }
                    });
                });
                
                // Remove duplicates
                this.componentSuggestions = this.componentSuggestions.filter((item, index, self) => 
                    index === self.findIndex(t => t.name === item.name && t.type === item.type)
                );
            }

            onComponentInput() {
                const input = document.getElementById('componentName');
                const value = input.value.trim().toUpperCase();
                const suggestions = document.getElementById('componentSuggestions');
                
                if (value.length < 2) {
                    suggestions.style.display = 'none';
                    this.validateForm();
                    return;
                }
                
                const filtered = this.componentSuggestions.filter(item => 
                    item.name.includes(value)
                ).slice(0, 8);
                
                if (filtered.length > 0) {
                    let html = '';
                    filtered.forEach(item => {
                        html += `
                            <div class="suggestion-item" onclick="analyzer.selectSuggestion('${item.name}')">
                                <strong>${item.name}</strong> 
                                <span style="opacity: 0.7;">(${item.type} in ${item.file})</span>
                            </div>
                        `;
                    });
                    suggestions.innerHTML = html;
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
                
                this.validateForm();
            }

            selectSuggestion(componentName) {
                document.getElementById('componentName').value = componentName;
                document.getElementById('componentSuggestions').style.display = 'none';
                this.validateForm();
            }
            // === FORM VALIDATION ===
            validateForm() {
                const hasFiles = this.uploadedFiles.length > 0;
                const hasComponent = document.getElementById('componentName').value.trim().length > 0;
                const hasConnection = this.serverValidated;
                
                document.getElementById('analyzeComponentBtn').disabled = !(hasFiles && hasComponent && hasConnection);
                document.getElementById('bulkAnalyzeBtn').disabled = !(hasFiles && hasConnection);
                
                const hasResults = Object.keys(this.analysisResults).length > 0;
                document.getElementById('exportJsonBtn').disabled = !hasResults;
                document.getElementById('exportMdBtn').disabled = !hasResults;
            }

            // === EVENT HANDLERS ===
            onEndpointChange() {
                this.serverValidated = false;
                this.updateConnectionStatus('disconnected', '🔴 LLM connection not validated');
                this.validateForm();
            }

            onSettingsChange() {
                this.maxTokens = parseInt(document.getElementById('maxTokens').value) || 4000;
                this.saveToStorage();
            }

            switchTab(e) {
                const targetTab = e.target?.dataset?.tab || e.dataset?.tab;
                if (!targetTab) return;
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const clickedTab = e.target || e;
                if (clickedTab.classList) {
                    clickedTab.classList.add('active');
                }
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const targetContent = document.getElementById(targetTab);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            }

            // === ANALYSIS HELPER METHODS ===
            findRelevantFiles(componentName) {
                return this.uploadedFiles.filter(file => 
                    file.content.toUpperCase().includes(componentName.toUpperCase()) ||
                    file.name.toUpperCase().includes(componentName.toUpperCase())
                );
            }

            detectComponentType(componentName, files) {
                const copybookFile = files.find(f => f.type === 'Copybook');
                if (copybookFile) return 'Copybook';
                
                const programFile = files.find(f => f.type === 'COBOL Program');
                if (programFile) return 'COBOL Program';
                
                return 'Component';
            }

            findProgramsUsingCopybook(copybookName) {
                const usingPrograms = [];
                
                this.uploadedFiles.forEach(file => {
                    if (file.type === 'COBOL Program') {
                        const content = file.content.toUpperCase();
                        const copyPattern = new RegExp(`COPY\\s+['"]*${copybookName.toUpperCase()}['"]*`, 'g');
                        if (copyPattern.test(content)) {
                            usingPrograms.push(file);
                        }
                    }
                });
                
                return usingPrograms;
            }

            calculateQualityScore(analysisResult) {
                if (!analysisResult) return 5;
                
                if (analysisResult.qualityScore) {
                    return analysisResult.qualityScore;
                }
                
                let score = 5;
                
                if (analysisResult.fieldCategories) score += 2;
                if (analysisResult.businessLogic) score += 2;
                if (analysisResult.recommendations) score += 1;
                
                return Math.min(Math.max(score, 1), 10);
            }

            assessCompleteness(analysisResult) {
                if (!analysisResult) {
                    return { score: 0, checkpoints: {}, completed: 0, total: 6 };
                }
                
                const checkpoints = {
                    'LLM Analysis': !!analysisResult,
                    'Field Analysis': !!(analysisResult.fieldCategories || analysisResult.fieldDetails),
                    'Business Logic': !!(analysisResult.businessLogic || analysisResult.businessRules),
                    'Dependencies': !!(analysisResult.dependencies || analysisResult.validatedDependencies),
                    'Flow Analysis': !!(analysisResult.fileFlowAnalysis || analysisResult.programFlowAnalysis),
                    'Recommendations': !!(analysisResult.recommendations && analysisResult.recommendations.length > 0)
                };
                
                const completed = Object.values(checkpoints).filter(Boolean).length;
                const total = Object.keys(checkpoints).length;
                
                return {
                    score: Math.round((completed / total) * 100),
                    checkpoints: checkpoints,
                    completed: completed,
                    total: total
                };
            }

            // === UTILITY METHODS ===
            showLoading() { 
                document.getElementById('loadingIndicator').classList.add('show'); 
            }
            
            hideLoading() { 
                document.getElementById('loadingIndicator').classList.remove('show'); 
            }
            
            updateLoadingStatus(status) { 
                document.getElementById('loadingStatus').textContent = status; 
            }

            updateProgress(percentage) {
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    progressFill.style.width = `${percentage}%`;
                }
            }

            showMessage(type, message, duration = 3000) {
                const messageDiv = document.createElement('div');
                messageDiv.className = type;
                messageDiv.textContent = message;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, duration);
            }
            
            showError(message) { this.showMessage('error', message, 5000); }
            showSuccess(message) { this.showMessage('success', message, 3000); }
            showWarning(message) { this.showMessage('warning', message, 4000); }
            
            sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

            // === BASIC DEPENDENCY EXTRACTION ===
            async extractBasicDependencies() {
                console.log('Extracting basic dependencies using regex patterns...');
                
                const dependencies = {
                    copyStatements: new Set(),
                    callStatements: new Set(),
                    execStatements: new Set(),
                    jclDatasets: new Set(),
                    programIds: new Set(),
                    sqlTables: new Set(),
                    fileReferences: new Set()
                };

                for (const file of this.uploadedFiles) {
                    const fileDeps = this.extractDependenciesFromFile(file);
                    
                    Object.keys(fileDeps).forEach(depType => {
                        if (dependencies[depType]) {
                            fileDeps[depType].forEach(dep => dependencies[depType].add(dep));
                        }
                    });
                }

                const cleanDependencies = {};
                Object.keys(dependencies).forEach(key => {
                    cleanDependencies[key] = Array.from(dependencies[key])
                        .filter(dep => dep && dep.length > 1)
                        .slice(0, 50);
                });

                console.log('Basic dependencies extracted:', cleanDependencies);
                return cleanDependencies;
            }

            extractDependenciesFromFile(file) {
                const dependencies = {
                    copyStatements: [],
                    callStatements: [],
                    execStatements: [],
                    jclDatasets: [],
                    programIds: [],
                    sqlTables: [],
                    fileReferences: []
                };

                const lines = file.content.split('\n');
                
                lines.forEach((line, lineNum) => {
                    const trimmed = line.trim().toUpperCase();
                    
                    // COPY statements
                    let copyMatch = trimmed.match(/COPY\s+(['"]*[A-Z][A-Z0-9\-_]{1,}['"]*)/);
                    if (copyMatch) {
                        const copyName = copyMatch[1].replace(/['"]/g, '');
                        dependencies.copyStatements.push(copyName);
                    }

                    // CALL statements
                    let callMatch = trimmed.match(/CALL\s+['"]*([A-Z][A-Z0-9\-_]{1,})['"]*/) ||
                                   trimmed.match(/LINK\s+['"]*([A-Z][A-Z0-9\-_]{1,})['"]*/) ||
                                   trimmed.match(/XCTL\s+['"]*([A-Z][A-Z0-9\-_]{1,})['"]*/);
                    if (callMatch) {
                        dependencies.callStatements.push(callMatch[1]);
                    }

                    // JCL EXEC statements
                    let execMatch = trimmed.match(/EXEC\s+PGM=([A-Z][A-Z0-9\-_]{1,})/) ||
                                   trimmed.match(/\/\/\w+\s+EXEC\s+([A-Z][A-Z0-9\-_]{1,})/);
                    if (execMatch) {
                        dependencies.execStatements.push(execMatch[1]);
                    }

                    // JCL Dataset references
                    let datasetMatch = trimmed.match(/DSN=([A-Z][A-Z0-9\.\-_]{3,})/) ||
                                      trimmed.match(/DSNAME=([A-Z][A-Z0-9\.\-_]{3,})/);
                    if (datasetMatch) {
                        dependencies.jclDatasets.push(datasetMatch[1]);
                    }

                    // PROGRAM-ID
                    let programMatch = trimmed.match(/PROGRAM-ID\.?\s+([A-Z][A-Z0-9\-_]{1,})/);
                    if (programMatch) {
                        dependencies.programIds.push(programMatch[1]);
                    }

                    // SQL Table references
                    let tableMatch = trimmed.match(/FROM\s+([A-Z][A-Z0-9_]{1,})/) ||
                                    trimmed.match(/INTO\s+([A-Z][A-Z0-9_]{1,})/) ||
                                    trimmed.match(/UPDATE\s+([A-Z][A-Z0-9_]{1,})/) ||
                                    trimmed.match(/DELETE\s+FROM\s+([A-Z][A-Z0-9_]{1,})/);
                    if (tableMatch) {
                        dependencies.sqlTables.push(tableMatch[1]);
                    }

                    // File references
                    let fileMatch = trimmed.match(/FD\s+([A-Z][A-Z0-9\-_]{1,})/) ||
                                   trimmed.match(/SELECT\s+([A-Z][A-Z0-9\-_]{1,})\s+ASSIGN/) ||
                                   trimmed.match(/OPEN\s+(?:INPUT|OUTPUT|I-O)\s+([A-Z][A-Z0-9\-_]{1,})/);
                    if (fileMatch) {
                        dependencies.fileReferences.push(fileMatch[1]);
                    }
                });

                return dependencies;
            }

// === LLM UTILITY METHODS ===
            prepareContentForLLM(content, type) {
                const maxChars = this.maxTokens * this.averageCharsPerToken * 0.7;
                
                if (content.length <= maxChars) {
                    return content;
                }
                
                if (type === 'copybook') {
                    const lines = content.split('\n');
                    const importantLines = lines.filter(line => {
                        const trimmed = line.trim().toUpperCase();
                        return trimmed.match(/^\s*\d{2}\s+/) ||
                               trimmed.includes('PIC ') ||
                               trimmed.includes('VALUE ') ||
                               trimmed.includes('REDEFINES ');
                    });
                    
                    let result = importantLines.join('\n');
                    if (result.length > maxChars) {
                        result = result.substring(0, maxChars);
                    }
                    return result;
                    
                } else if (type === 'program') {
                    const procedureIndex = content.toUpperCase().indexOf('PROCEDURE DIVISION');
                    if (procedureIndex > -1) {
                        const procedureContent = content.substring(procedureIndex);
                        if (procedureContent.length <= maxChars) {
                            return procedureContent;
                        }
                        return procedureContent.substring(0, maxChars);
                    }
                } else if (type === 'flow') {
                    // For flow analysis, prioritize structure and key statements
                    const lines = content.split('\n');
                    const flowLines = lines.filter(line => {
                        const trimmed = line.trim().toUpperCase();
                        return trimmed.includes('PERFORM ') ||
                               trimmed.includes('IF ') ||
                               trimmed.includes('WHEN ') ||
                               trimmed.includes('MOVE ') ||
                               trimmed.includes('COMPUTE ') ||
                               trimmed.includes('READ ') ||
                               trimmed.includes('WRITE ') ||
                               trimmed.includes('OPEN ') ||
                               trimmed.includes('CLOSE ') ||
                               trimmed.match(/^\s*\d{2}\s+/) ||
                               trimmed.includes('CALL ') ||
                               trimmed.includes('COPY ');
                    });
                    
                    let result = flowLines.join('\n');
                    if (result.length > maxChars) {
                        result = result.substring(0, maxChars);
                    }
                    return result;
                }
                
                return content.substring(0, maxChars);
            }

            async callLLMAPI(prompt, retries = 0) {
                try {
                    const response = await fetch(`${this.vllmEndpoint}/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            max_tokens: Math.floor(this.maxTokens * 0.8),
                            temperature: this.llmConfig.temperature,
                            top_p: 0.95,
                            stop: ["Human:", "Assistant:", "TASK:", "INSTRUCTIONS:"],
                            stream: false
                        }),
                        signal: AbortSignal.timeout(this.llmConfig.analysisTimeout)
                    });

                    if (!response.ok) {
                        throw new Error(`LLM API request failed: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    let resultText = '';
                    if (data.text) {
                        resultText = data.text.trim();
                    } else if (data.choices && data.choices[0]) {
                        resultText = data.choices[0].text.trim();
                    } else {
                        throw new Error('Invalid LLM API response format');
                    }

                    try {
                        return JSON.parse(resultText);
                    } catch (parseError) {
                        const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            try {
                                return JSON.parse(jsonMatch[0]);
                            } catch (secondParseError) {
                                console.warn('Failed to parse LLM JSON response:', resultText);
                                return {
                                    error: 'LLM response parsing failed',
                                    rawResponse: resultText,
                                    fallbackAnalysis: this.createFallbackAnalysis(resultText)
                                };
                            }
                        } else {
                            return {
                                rawAnalysis: resultText,
                                parsedAnalysis: this.parseRawLLMResponse(resultText)
                            };
                        }
                    }

                } catch (error) {
                    if (retries < this.llmConfig.maxRetries) {
                        console.warn(`LLM API call failed, retrying (${retries + 1}/${this.llmConfig.maxRetries}):`, error);
                        await this.sleep(2000);
                        return this.callLLMAPI(prompt, retries + 1);
                    }
                    throw new Error(`LLM API failed after ${this.llmConfig.maxRetries} retries: ${error.message}`);
                }
            }

            createFallbackAnalysis(rawResponse) {
                return {
                    analysisType: 'Fallback Analysis',
                    summary: rawResponse.substring(0, 500),
                    recommendations: ['Review raw LLM response for detailed analysis'],
                    qualityScore: 5
                };
            }

            parseRawLLMResponse(rawText) {
                const lines = rawText.split('\n');
                const analysis = {
                    fields: [],
                    recommendations: [],
                    businessRules: []
                };

                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed.includes('field') || trimmed.includes('FIELD')) {
                        analysis.fields.push(trimmed);
                    } else if (trimmed.includes('recommend') || trimmed.includes('RECOMMEND')) {
                        analysis.recommendations.push(trimmed);
                    } else if (trimmed.includes('rule') || trimmed.includes('RULE')) {
                        analysis.businessRules.push(trimmed);
                    }
                });

                return analysis;
            }

            // === LLM DEPENDENCY VALIDATION ===
            async validateDependenciesWithLLM(basicDependencies, relevantFiles) {
                console.log('LLM validating dependencies...');
                
                const fileContext = relevantFiles.map(f => 
                    `FILE: ${f.name} (${f.type})\nCONTENT_SAMPLE: ${f.content.substring(0, 500)}...`
                ).join('\n\n');

                const llmPrompt = `MAINFRAME DEPENDENCY VALIDATION WITH FLOW CONTEXT

TASK: Validate and enhance the discovered dependencies with flow analysis context.

BASIC DEPENDENCIES FOUND:
Copy Statements: ${basicDependencies.copyStatements.join(', ')}
Call Statements: ${basicDependencies.callStatements.join(', ')}
Exec Statements: ${basicDependencies.execStatements.join(', ')}
Program IDs: ${basicDependencies.programIds.join(', ')}
JCL Datasets: ${basicDependencies.jclDatasets.join(', ')}
SQL Tables: ${basicDependencies.sqlTables.join(', ')}
File References: ${basicDependencies.fileReferences.join(', ')}

FILE CONTEXT:
${fileContext}

INSTRUCTIONS:
1. Validate each dependency against actual file content
2. Remove false positives and add missed dependencies
3. Categorize dependencies by flow impact and criticality
4. Identify dependency chains and data flow relationships
5. Assess impact and coupling levels with flow context

OUTPUT FORMAT:
{
  "validatedDependencies": {
    "copyStatements": [<validated_copies>],
    "callStatements": [<validated_calls>],
    "execStatements": [<validated_execs>],
    "programIds": [<validated_programs>],
    "jclDatasets": [<validated_datasets>],
    "sqlTables": [<validated_tables>],
    "fileReferences": [<validated_files>]
  },
  "dependencyChains": [<dependency_flow_relationships>],
  "couplingLevel": "<LOW|MEDIUM|HIGH>",
  "flowImpact": "<LOW|MEDIUM|HIGH>",
  "impactAssessment": [<flow_impact_descriptions>],
  "recommendations": [<dependency_flow_recommendations>]
}

Respond with valid JSON only.`;

                return await this.callLLMAPI(llmPrompt);
            }

            // === NEW PROGRAM FLOW ANALYSIS ===
            async analyzeProgramFlowWithLLM(componentName, relevantFiles, basicDependencies) {
                console.log(`LLM analyzing program flow for: ${componentName}`);
                
                const programFile = relevantFiles.find(f => 
                    f.type === 'COBOL Program' && 
                    (f.name.toUpperCase().includes(componentName.toUpperCase()) || 
                     f.content.toUpperCase().includes(`PROGRAM-ID. ${componentName.toUpperCase()}`))
                );

                if (!programFile) {
                    // Return empty flow analysis for non-programs
                    return {
                        programFlow: {
                            componentName: componentName,
                            componentType: "Non-Program",
                            flowSteps: [],
                            executionPath: [],
                            decisionPoints: [],
                            dataTransformations: []
                        }
                    };
                }

                const programContent = this.prepareContentForLLM(programFile.content, 'program');

                const llmPrompt = `MAINFRAME PROGRAM FLOW ANALYSIS

TASK: Analyze the step-by-step execution flow for COBOL program "${componentName}".

PROGRAM CONTENT:
${programContent}

DEPENDENCIES CONTEXT:
Copy Statements: ${basicDependencies.copyStatements.join(', ')}
Call Statements: ${basicDependencies.callStatements.join(', ')}
File References: ${basicDependencies.fileReferences.join(', ')}

INSTRUCTIONS:
Perform detailed program flow analysis focusing on:

1. **Execution Sequence**: Step-by-step program flow
2. **Decision Points**: IF/WHEN/EVALUATE conditions and branches
3. **Data Transformations**: Where data is modified or calculated
4. **Loop Structures**: PERFORM loops and iterations
5. **File Operations**: OPEN/READ/WRITE/CLOSE sequences
6. **Error Handling**: Exception and error processing paths

OUTPUT FORMAT:
{
  "programFlow": {
    "componentName": "${componentName}",
    "executionPath": [
      {
        "stepNumber": <number>,
        "operation": "<operation_type>",
        "location": "<paragraph_or_section>",
        "description": "<step_description>",
        "fieldsInvolved": ["<field_names>"],
        "businessLogic": "<business_purpose>"
      }
    ],
    "decisionPoints": [
      {
        "location": "<paragraph_or_section>",
        "condition": "<if_when_condition>",
        "truePath": "<action_if_true>",
        "falsePath": "<action_if_false>",
        "fieldsUsed": ["<field_names>"],
        "businessRule": "<business_logic>"
      }
    ],
    "dataTransformations": [
      {
        "location": "<paragraph_or_section>",
        "operation": "COMPUTE|MOVE|ADD|SUBTRACT|MULTIPLY|DIVIDE|STRING",
        "sourceFields": ["<input_fields>"],
        "targetFields": ["<output_fields>"],
        "transformation": "<transformation_description>",
        "businessPurpose": "<why_transformation>"
      }
    ],
    "fileOperations": [
      {
        "operation": "OPEN|READ|WRITE|CLOSE",
        "fileName": "<file_name>",
        "location": "<paragraph_or_section>",
        "fieldsInvolved": ["<field_names>"],
        "purpose": "<operation_purpose>"
      }
    ],
    "flowMetrics": {
      "totalSteps": <number>,
      "decisionPoints": <number>,
      "transformations": <number>,
      "fileOperations": <number>,
      "complexity": "LOW|MEDIUM|HIGH"
    }
  },
  "recommendations": [
    "<program_flow_optimization_recommendations>"
  ]
}

Respond with valid JSON only. Focus on actual execution flow and data processing steps.`;

                return await this.callLLMAPI(llmPrompt);
            }

            // === EXISTING LLM ANALYSIS METHODS (Enhanced for Flow) ===
            async analyzeCopybookWithLLM(componentName, relevantFiles, basicDependencies) {
                console.log(`LLM analyzing copybook with flow context: ${componentName}`);
                
                const copybookFile = relevantFiles.find(f => 
                    f.type === 'Copybook' && 
                    (f.name.toUpperCase().includes(componentName.toUpperCase()) || 
                     f.content.toUpperCase().includes(componentName.toUpperCase()))
                );

                if (!copybookFile) {
                    throw new Error(`Copybook file for ${componentName} not found`);
                }

                const copybookContent = this.prepareContentForLLM(copybookFile.content, 'copybook');
                const usingPrograms = this.findProgramsUsingCopybook(componentName);
                
                const llmPrompt = `MAINFRAME COPYBOOK FLOW-ENHANCED ANALYSIS

TASK: Analyze the copybook "${componentName}" with focus on field lifecycle and usage patterns.

COPYBOOK CONTENT:
${copybookContent}

PROGRAMS USING THIS COPYBOOK:
${usingPrograms.map(p => p.name).join(', ')}

DEPENDENCIES CONTEXT:
Copy Statements: ${basicDependencies.copyStatements.join(', ')}
Call Statements: ${basicDependencies.callStatements.join(', ')}

INSTRUCTIONS:
Perform comprehensive copybook analysis with flow tracking:

1. **Field Categorization**: Classify fields by usage pattern
2. **Lifecycle Analysis**: Track field usage across programs
3. **Business Context**: Extract business purpose of each field
4. **Usage Patterns**: Identify how fields flow through processes
5. **Optimization**: Find unused or redundant fields

OUTPUT FORMAT:
{
  "totalFields": <number>,
  "fieldCategories": {
    "INPUT_FIELDS": [<fields_used_for_data_entry>],
    "OUTPUT_FIELDS": [<fields_used_for_reporting>],
    "DERIVED_FIELDS": [<fields_calculated_from_others>],
    "CONDITION_FIELDS": [<fields_used_in_decisions>],
    "UNUSED_FIELDS": [<fields_never_referenced>],
    "STATIC_FIELDS": [<fields_with_constant_values>]
  },
  "fieldDetails": {
    "<field_name>": {
      "level": <number>,
      "picture": "<pic_clause>",
      "value": "<value_clause>",
      "category": "<category>",
      "usagePattern": "<how_field_is_used>",
      "businessRole": "<business_purpose>",
      "flowStage": "INPUT|PROCESS|OUTPUT|UNUSED",
      "usedInPrograms": ["<program_names>"]
    }
  },
  "flowAnalysis": {
    "inputFieldsCount": <number>,
    "outputFieldsCount": <number>,
    "processFieldsCount": <number>,
    "unusedFieldsCount": <number>,
    "flowComplexity": "LOW|MEDIUM|HIGH"
  },
  "businessRules": [<extracted_business_rules>],
  "recommendations": [<flow_optimization_recommendations>],
  "qualityScore": <1-10>
}

Respond with valid JSON only.`;

                return await this.callLLMAPI(llmPrompt);
            }

            // === NEW FILE FLOW ANALYSIS ===
            async analyzeFileFlowWithLLM(componentName, relevantFiles, basicDependencies) {
                console.log(`LLM analyzing file flow for: ${componentName}`);
                
                // Prepare comprehensive content for file flow analysis
                const allFilesContent = relevantFiles.map(f => 
                    `FILE: ${f.name} (${f.type})\nCONTENT:\n${this.prepareContentForLLM(f.content, 'flow')}`
                ).join('\n\n' + '='.repeat(50) + '\n\n');
                
                const llmPrompt = `MAINFRAME FILE FLOW LIFECYCLE ANALYSIS

TASK: Analyze the complete file and field lifecycle for component "${componentName}" across all programs.

ALL FILES CONTENT:
${allFilesContent}

DEPENDENCIES CONTEXT:
Copy Statements: ${basicDependencies.copyStatements.join(', ')}
Call Statements: ${basicDependencies.callStatements.join(', ')}
File References: ${basicDependencies.fileReferences.join(', ')}
Program IDs: ${basicDependencies.programIds.join(', ')}

INSTRUCTIONS:
Perform comprehensive file flow analysis focusing on:

1. **Field Lifecycle Tracking**: Track each field from creation to final use
2. **Cross-Program Flow**: How fields move between programs
3. **Data Transformation**: Where and how fields are modified
4. **Input/Output Mapping**: Source and destination of each field
5. **Unused Field Detection**: Fields defined but never used
6. **Flow Bottlenecks**: Critical processing points

OUTPUT FORMAT:
{
  "fileLifecycle": {
    "componentName": "${componentName}",
    "flowStages": [
      {
        "stage": "INPUT|PROCESS|OUTPUT|UNUSED",
        "stageDescription": "<detailed_stage_description>",
        "fields": [
          {
            "fieldName": "<field_name>",
            "action": "CREATE|READ|UPDATE|DERIVE|VALIDATE|OUTPUT|IGNORE",
            "program": "<program_name>",
            "location": "<section_or_paragraph>",
            "businessPurpose": "<business_context>",
            "dataFlow": "<flow_description>"
          }
        ]
      }
    ],
    "crossProgramFlow": [
      {
        "fromProgram": "<source_program>",
        "toProgram": "<target_program>",
        "fieldsTransferred": ["<field_names>"],
        "transferMethod": "COPY|CALL|FILE|PARAMETER",
        "transformations": ["<field_transformations>"]
      }
    ],
    "unusedFields": [
      {
        "fieldName": "<field_name>",
        "definedIn": "<program_or_copybook>",
        "reason": "<why_unused>",
        "optimizationOpportunity": "<cleanup_suggestion>"
      }
    ],
    "flowMetrics": {
      "totalFields": <number>,
      "activeFields": <number>,
      "unusedFields": <number>,
      "transformationPoints": <number>,
      "flowComplexity": "LOW|MEDIUM|HIGH"
    }
  },
  "recommendations": [
    "<flow_optimization_recommendations>"
  ]
}

Respond with valid JSON only. Focus on actual field usage patterns and lifecycle tracking.`;

                return await this.call
    }
                async analyzeProgramWithLLM(componentName, relevantFiles, basicDependencies) {
                console.log(`LLM analyzing program with flow context: ${componentName}`);
                
                const programFile = relevantFiles.find(f => 
                    f.type === 'COBOL Program' && 
                    (f.name.toUpperCase().includes(componentName.toUpperCase()) || 
                     f.content.toUpperCase().includes(`PROGRAM-ID. ${componentName.toUpperCase()}`))
                );

                if (!programFile) {
                    throw new Error(`Program file for ${componentName} not found`);
                }

                const programContent = this.prepareContentForLLM(programFile.content, 'program');

                const llmPrompt = `MAINFRAME COBOL PROGRAM FLOW-ENHANCED ANALYSIS

TASK: Analyze the COBOL program "${componentName}" with comprehensive flow and business logic tracking.

PROGRAM CONTENT:
${programContent}

DEPENDENCIES CONTEXT:
Copy Statements: ${basicDependencies.copyStatements.join(', ')}
Call Statements: ${basicDependencies.callStatements.join(', ')}
File References: ${basicDependencies.fileReferences.join(', ')}

INSTRUCTIONS:
Perform comprehensive program analysis with flow focus:

1. **Program Structure**: Map divisions, sections, paragraphs
2. **Business Logic Flow**: Extract validation rules and calculations
3. **Data Flow**: Track input/output and transformations
4. **Decision Logic**: Map IF/WHEN/EVALUATE conditions
5. **File Processing**: Identify file operations and data movement

OUTPUT FORMAT:
{
  "programStructure": {
    "divisions": [<division_names>],
    "paragraphs": [<paragraph_names>],
    "sections": [<section_names>]
  },
  "businessLogic": {
    "validationRules": [<validation_rules>],
    "calculations": [<calculation_logic>],
    "decisionPoints": [<if_when_conditions>]
  },
  "dataFlow": {
    "inputFiles": [<input_files>],
    "outputFiles": [<output_files>],
    "workingStorage": [<key_variables>],
    "dataTransformations": [<transformation_descriptions>]
  },
  "dependencies": {
    "copybooks": [<used_copybooks>],
    "calledPrograms": [<called_programs>],
    "files": [<accessed_files>]
  },
  "flowMetrics": {
    "totalParagraphs": <number>,
    "decisionPoints": <number>,
    "fileOperations": <number>,
    "calculations": <number>
  },
  "recommendations": [<modernization_suggestions>],
  "complexity": "<LOW|MEDIUM|HIGH>",
  "qualityScore": <1-10>
}

Respond with valid JSON only.`;

                return await this.callLLMAPI(llmPrompt);
            }

            async analyzeGenericComponentWithLLM(componentName, relevantFiles, basicDependencies) {
                console.log(`LLM analyzing generic component with flow context: ${componentName}`);
                
                const componentFile = relevantFiles[0];
                const componentContent = this.prepareContentForLLM(componentFile.content, 'generic');

                const llmPrompt = `MAINFRAME COMPONENT FLOW ANALYSIS

TASK: Analyze the mainframe component "${componentName}" with flow context.

COMPONENT CONTENT:
${componentContent}

COMPONENT TYPE: ${componentFile.type}
FILE SIZE: ${componentFile.size} bytes

DEPENDENCIES CONTEXT:
${Object.keys(basicDependencies).map(key => 
    `${key}: ${basicDependencies[key].join(', ')}`
).join('\n')}

INSTRUCTIONS:
1. Identify the component type and purpose
2. Extract key elements and flow patterns
3. Identify any data processing or transformation patterns
4. Provide flow-aware recommendations

OUTPUT FORMAT:
{
  "componentType": "${componentFile.type}",
  "purpose": "<identified_purpose>",
  "keyElements": [<important_elements>],
  "flowPatterns": [<data_flow_patterns>],
  "recommendations": [<flow_optimization_recommendations>],
  "qualityScore": <1-10>
}

Respond with valid JSON only.`;

                return await this.callLLMAPI(llmPrompt);
            }

            // === ENHANCED LLM ANALYSIS ENGINE WITH FLOW TRACKING ===
            async analyzeComponent() {
                const componentName = document.getElementById('componentName').value.trim();
                if (!componentName) return;

                this.showLoading();
                this.updateProgress(0);

                try {
                    this.updateLoadingStatus('🧠 Initializing LLM flow analysis...');
                    const results = await this.runLLMEnhancedFlowAnalysis(componentName);
                    
                    this.analysisResults[componentName] = results;
                    this.currentAnalyzedComponent = componentName;
                    
                    this.displayAnalysisResults(componentName, results);
                    this.enableChat();
                    this.saveToStorage();
                    
                    this.hideLoading();
                    this.showSuccess(`✅ LLM-enhanced flow analysis complete for ${componentName}!`);
                    
                } catch (error) {
                    this.hideLoading();
                    this.showError(`LLM flow analysis failed: ${error.message}`);
                    console.error('LLM Flow Analysis error:', error);
                }
            }

            async runLLMEnhancedFlowAnalysis(componentName) {
                console.log(`Starting LLM-enhanced flow analysis for: ${componentName}`);
                
                // Stage 1: Find relevant files and detect component type
                this.updateLoadingStatus('🔍 Stage 1: Finding relevant files...');
                this.updateProgress(10);
                
                const relevantFiles = this.findRelevantFiles(componentName);
                if (relevantFiles.length === 0) {
                    throw new Error(`Component "${componentName}" not found in uploaded files`);
                }

                const componentType = this.detectComponentType(componentName, relevantFiles);
                console.log(`Component type detected: ${componentType}`);

                // Stage 2: Basic dependency extraction
                this.updateLoadingStatus('🔗 Stage 2: Extracting basic dependencies...');
                this.updateProgress(20);
                
                const basicDependencies = await this.extractBasicDependencies();

                // Stage 3: Enhanced Flow Analysis
                this.updateLoadingStatus('🌊 Stage 3: LLM analyzing file flows...');
                this.updateProgress(40);
                
                const fileFlowAnalysis = await this.analyzeFileFlowWithLLM(componentName, relevantFiles, basicDependencies);

                // Stage 4: Program Flow Analysis
                this.updateLoadingStatus('🔀 Stage 4: LLM analyzing program flows...');
                this.updateProgress(60);
                
                const programFlowAnalysis = await this.analyzeProgramFlowWithLLM(componentName, relevantFiles, basicDependencies);

                // Stage 5: LLM Component Analysis
                this.updateLoadingStatus('🤖 Stage 5: LLM analyzing component structure...');
                this.updateProgress(75);
                
                let llmAnalysis;
                if (componentType === 'Copybook') {
                    llmAnalysis = await this.analyzeCopybookWithLLM(componentName, relevantFiles, basicDependencies);
                } else if (componentType === 'COBOL Program') {
                    llmAnalysis = await this.analyzeProgramWithLLM(componentName, relevantFiles, basicDependencies);
                } else {
                    llmAnalysis = await this.analyzeGenericComponentWithLLM(componentName, relevantFiles, basicDependencies);
                }
                
                // Stage 6: LLM validation of dependencies
                this.updateLoadingStatus('🔍 Stage 6: LLM validating dependencies...');
                this.updateProgress(90);
                
                const validatedDependencies = await this.validateDependenciesWithLLM(basicDependencies, relevantFiles);
                
                this.updateProgress(100);
                
                return {
                    componentName: componentName,
                    timestamp: new Date().toISOString(),
                    filesAnalyzed: relevantFiles.map(f => f.name),
                    componentType: componentType,
                    basicDependencies: basicDependencies,
                    validatedDependencies: validatedDependencies,
                    llmAnalysis: llmAnalysis,
                    fileFlowAnalysis: fileFlowAnalysis,
                    programFlowAnalysis: programFlowAnalysis,
                    qualityScore: this.calculateQualityScore(llmAnalysis),
                    completeness: this.assessCompleteness(llmAnalysis),
                    analysisMethod: 'LLM-Enhanced-Flow'
                };
            }
// === STORAGE MANAGEMENT ===
            saveToStorage() {
                try {
                    const data = {
                        uploadedFiles: this.uploadedFiles,
                        analysisResults: this.analysisResults,
                        chatHistory: this.chatHistory,
                        vllmEndpoint: this.vllmEndpoint,
                        maxTokens: this.maxTokens,
                        llmConfig: this.llmConfig,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem(this.storageKey, JSON.stringify(data));
                } catch (error) {
                    console.warn('Failed to save to storage:', error);
                }
            }

            loadStoredData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.uploadedFiles = data.uploadedFiles || [];
                        this.analysisResults = data.analysisResults || {};
                        this.chatHistory = data.chatHistory || [];
                        
                        if (data.vllmEndpoint) {
                            document.getElementById('vllmEndpoint').value = data.vllmEndpoint;
                            this.vllmEndpoint = data.vllmEndpoint;
                        }
                        
                        if (data.maxTokens) {
                            document.getElementById('maxTokens').value = data.maxTokens;
                            this.maxTokens = data.maxTokens;
                        }

                        if (data.llmConfig) {
                            this.llmConfig = { ...this.llmConfig, ...data.llmConfig };
                        }
                        
                        this.displayUploadedFiles();
                        this.updateComponentSuggestions();
                        this.validateForm();
                        
                        console.log('📁 Stored LLM flow analysis data loaded successfully');
                    }
                } catch (error) {
                    console.warn('Failed to load stored data:', error);
                }
            }

            clearAllData() {
                if (confirm('Are you sure you want to clear all LLM flow analysis data? This cannot be undone.')) {
                    this.uploadedFiles = [];
                    this.analysisResults = {};
                    this.componentSuggestions = [];
                    this.currentAnalyzedComponent = null;
                    this.chatHistory = [];
                    
                    localStorage.removeItem(this.storageKey);
                    
                    this.displayUploadedFiles();
                    this.validateForm();
                    
                    // Reset chat area
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = `
                            <div class="chat-message assistant">
                                <div class="sender">LLM Flow Analysis Assistant</div>
                                <div class="content">
                                    👋 <strong>Welcome to Flow-Enhanced Mainframe Analysis!</strong>
                                    <br><br>
                                    I can now provide detailed flow analysis including:
                                    <br><br>
                                    🌊 <strong>File Lifecycle:</strong> Complete field journey across programs
                                    <br>🔀 <strong>Program Flow:</strong> Step-by-step execution tracking  
                                    <br>📊 <strong>Usage Patterns:</strong> Field utilization analysis
                                    <br>🎯 <strong>Optimization:</strong> Unused field identification
                                    <br><br>
                                    <em>Upload files and analyze a component to unlock comprehensive flow analysis!</em>
                                </div>
                                <div class="timestamp">Ready</div>
                            </div>
                        `;
                    }
                    
                    // Disable chat input
                    const chatInput = document.getElementById('chatInput');
                    const chatSendBtn = document.getElementById('chatSendBtn');
                    if (chatInput) chatInput.disabled = true;
                    if (chatSendBtn) chatSendBtn.disabled = true;
                    
                    document.getElementById('lifecycleContent').innerHTML = `
                        <h3>🎯 LLM-Powered Component Analysis with Flow Tracking</h3>
                        <p style="margin-bottom: 20px;">Upload files and analyze components to get started with LLM-enhanced flow analysis.</p>
                    `;
                    
                    this.showSuccess('🗑️ All LLM flow analysis data cleared successfully');
                }
            }

            // === BULK ANALYSIS ===
            async bulkAnalyze() {
                if (this.uploadedFiles.length === 0) {
                    this.showError('No files uploaded for bulk analysis');
                    return;
                }

                this.showLoading();
                this.updateLoadingStatus('🔄 Starting LLM flow bulk analysis...');

                const components = this.componentSuggestions.filter(c => c.type === 'COPYBOOK' || c.type === 'PROGRAM').slice(0, 5);
                let completed = 0;

                try {
                    for (const component of components) {
                        this.updateLoadingStatus(`LLM flow analyzing ${component.name} (${completed + 1}/${components.length})...`);
                        this.updateProgress((completed / components.length) * 100);
                        
                        try {
                            document.getElementById('componentName').value = component.name;
                            const results = await this.runLLMEnhancedFlowAnalysis(component.name);
                            this.analysisResults[component.name] = results;
                            completed++;
                            
                            await this.sleep(3000);
                        } catch (error) {
                            console.warn(`Failed to analyze ${component.name}:`, error);
                        }
                    }

                    this.hideLoading();
                    this.saveToStorage();
                    this.showSuccess(`✨ LLM flow bulk analysis complete! ${completed}/${components.length} components analyzed`);

                } catch (error) {
                    this.hideLoading();
                    this.showError(`LLM flow bulk analysis failed: ${error.message}`);
                }
            }

            // === ENHANCED CHAT FUNCTIONALITY ===
            enableChat() {
                const chatInput = document.getElementById('chatInput');
                const chatSendBtn = document.getElementById('chatSendBtn');
                
                if (chatInput && chatSendBtn) {
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                    
                    this.addChatMessage('assistant', 
                        `🎯 **LLM-Enhanced Flow Analysis complete for ${this.currentAnalyzedComponent}!**
                        
I can now provide comprehensive insights using advanced flow-aware analysis:

🌊 **File Flow Analysis:** Complete field lifecycle tracking across all programs
🔀 **Program Flow:** Step-by-step execution with data transformation mapping
🧠 **Smart Field Analysis:** Context-aware categorization with business purpose
⚖️ **Business Logic:** Extracted validation rules and decision patterns  
🔗 **Flow-Aware Dependencies:** Comprehensive relationship mapping with impact assessment
💡 **Flow Optimization:** AI-powered recommendations for field lifecycle optimization

**Try these flow-enhanced questions:**
• "Show me the complete lifecycle of field CUSTOMER-ID from input to output"
• "Which fields are unused and what's the optimization impact?"
• "Explain the data transformation flow in the main program logic"
• "What are the critical dependency chains and their flow impact?"
• "How can we optimize the field flow for better performance?"
• "Map the complete data flow from copybook to final output"`
                    );
                }
            }

            async sendChatMessage() {
                const input = document.getElementById('chatInput');
                const sendBtn = document.getElementById('chatSendBtn');
                const message = input.value.trim();
                
                if (!message) {
                    this.showError('Please enter a message');
                    return;
                }
                
                if (!this.currentAnalyzedComponent) {
                    this.showError('Please analyze a component first');
                    return;
                }
                
                input.disabled = true;
                sendBtn.disabled = true;
                sendBtn.textContent = 'Processing...';
                
                this.addChatMessage('user', message);
                input.value = '';
                
                this.showChatTyping();
                
                try {
                    const response = await this.processEnhancedFlowChatQuery(message);
                    this.hideChatTyping();
                    this.addChatMessage('assistant', response);
                } catch (error) {
                    console.error('Enhanced flow chat error:', error);
                    this.hideChatTyping();
                    this.addChatMessage('assistant', `I apologize, but I encountered an error processing your flow-related question: ${error.message}. Please try rephrasing your question or check the LLM connection.`);
                } finally {
                    input.disabled = false;
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send';
                    input.focus();
                }
            }

            async processEnhancedFlowChatQuery(question) {
                const analysisData = this.analysisResults[this.currentAnalyzedComponent];
                
                // Create comprehensive context for enhanced flow chat
                let context = `ENHANCED LLM MAINFRAME FLOW ANALYSIS CONTEXT

COMPONENT: ${this.currentAnalyzedComponent}
COMPONENT TYPE: ${analysisData.componentType}
ANALYSIS METHOD: ${analysisData.analysisMethod}
FILES ANALYZED: ${analysisData.filesAnalyzed.join(', ')}
QUALITY SCORE: ${analysisData.qualityScore}/10
COMPLETENESS: ${analysisData.completeness.score}%

`;

                // Add LLM analysis results
                if (analysisData.llmAnalysis) {
                    context += `LLM ANALYSIS RESULTS:
${JSON.stringify(analysisData.llmAnalysis, null, 2)}

`;
                }

                // Add file flow analysis
                if (analysisData.fileFlowAnalysis) {
                    context += `FILE FLOW ANALYSIS:
${JSON.stringify(analysisData.fileFlowAnalysis, null, 2)}

`;
                }

                // Add program flow analysis
                if (analysisData.programFlowAnalysis) {
                    context += `PROGRAM FLOW ANALYSIS:
${JSON.stringify(analysisData.programFlowAnalysis, null, 2)}

`;
                }

                // Add validated dependencies
                if (analysisData.validatedDependencies) {
                    context += `VALIDATED DEPENDENCIES:
${JSON.stringify(analysisData.validatedDependencies, null, 2)}

`;
                }

                const enhancedFlowChatPrompt = `ENHANCED MAINFRAME FLOW ANALYSIS CHAT ASSISTANT

CONTEXT:
${context}

USER QUESTION: "${question}"

INSTRUCTIONS:
You are an expert mainframe analyst with deep knowledge of COBOL, copybooks, legacy system modernization, and comprehensive FLOW ANALYSIS. 

Based on the flow-enhanced LLM analysis results above, provide a detailed, insightful response that:

1. **Addresses the specific flow question** with concrete examples from the flow analysis data
2. **Uses rich formatting** with headers, bullets, and emphasis for readability
3. **Provides actionable flow insights** based on the comprehensive analysis data
4. **References specific fields, programs, or flow stages** when relevant
5. **Explains flow context** and lifecycle implications
6. **Offers practical flow optimization recommendations** for improvement

For flow-related questions, focus on:
- **Complete field lifecycle:** From creation through transformation to final output
- **Cross-program flow patterns:** How data moves between components
- **Optimization opportunities:** Unused fields, bottlenecks, and efficiency improvements
- **Flow impact analysis:** Dependencies and their effects on data processing
- **Business process mapping:** How technical flow relates to business operations

For copybook flow questions, focus on:
- Field lifecycle stages (INPUT → PROCESS → OUTPUT → UNUSED)
- Cross-program usage patterns with specific flow examples
- Unused field optimization opportunities with flow impact analysis
- Business rule extraction from flow context
- Flow-aware modernization strategies

For program flow questions, focus on:
- Step-by-step execution flow with data transformations
- Decision point flow analysis and business impact
- File operation sequencing and data movement
- Performance bottlenecks in execution flow
- Flow optimization for maintainability

Format your response with:
- **Bold headers** for major flow sections
- 🌊 **Flow indicators** and emojis for visual appeal
- Code snippets for field names and technical terms
- • Bullet points for flow step lists
- Clear explanations of flow impact and business implications

If specific flow information isn't available in the analysis, clearly state what additional flow analysis would be helpful.

Provide a comprehensive, well-formatted response that demonstrates deep understanding of the flow analysis results and their business implications.`;

                const response = await this.callLLMAPI(enhancedFlowChatPrompt);
                
                // Enhanced response formatting for flow context
                if (typeof response === 'string') {
                    return response;
                } else if (response && typeof response === 'object') {
                    // Handle structured response
                    return this.formatStructuredFlowResponse(response, question);
                } else {
                    return "I've analyzed your flow question, but received an unexpected response format. Please try rephrasing your question about field flows, program execution, or lifecycle analysis.";
                }
            }

            formatStructuredFlowResponse(response, question) {
                if (response.error) {
                    return `I encountered an issue processing your flow question: ${response.error}. Please try asking about specific field lifecycles, program flows, or optimization opportunities.`;
                }
                
                let formatted = '';
                
                if (response.flowAnalysis) {
                    formatted += `🌊 **Flow Analysis Results:**\n\n${response.flowAnalysis}\n\n`;
                }
                
                if (response.fieldLifecycle) {
                    formatted += `📊 **Field Lifecycle:**\n\n${response.fieldLifecycle}\n\n`;
                }
                
                if (response.recommendations) {
                    formatted += `💡 **Flow Optimization Recommendations:**\n\n`;
                    if (Array.isArray(response.recommendations)) {
                        response.recommendations.forEach((rec, index) => {
                            formatted += `${index + 1}. ${rec}\n`;
                        });
                    } else {
                        formatted += response.recommendations;
                    }
                    formatted += '\n';
                }
                
                if (response.rawAnalysis) {
                    formatted += response.rawAnalysis;
                }
                
                return formatted || "I've processed your flow question but couldn't generate a specific response. Please ask about field lifecycles, program execution flows, or optimization opportunities.";
            }

            addChatMessage(sender, content) {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) return;
                
                const messageId = 'msg_' + Date.now();
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;
                messageDiv.id = messageId;
                
                messageDiv.innerHTML = `
                    <div class="sender">${sender === 'user' ? 'You' : 'LLM Flow Analysis Assistant'}</div>
                    <div class="content">${this.formatChatMessage(content)}</div>
                    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                    ${sender === 'assistant' ? `<button class="export-btn" onclick="analyzer.exportChatMessage('${messageId}')">💾</button>` : ''}
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Store in chat history
                this.chatHistory.push({
                    id: messageId,
                    sender: sender,
                    content: content,
                    timestamp: new Date().toISOString()
                });
            }

            formatChatMessage(content) {
                return content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #FFD700;">$1</strong>')
                    .replace(/`([^`]+)`/g, '<code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px; color: #4CAF50; font-family: monospace;">$1</code>')
                    .replace(/^- /gm, '• ')
                    .replace(/^• /gm, '<span style="color: #4CAF50;">•</span> ')
                    // Enhanced formatting for flow content
                    .replace(/🌊|🔀|🧠|⚖️|🔗|💡|🎯|📊|🔍|🚀|📥|📤|🔄|❓|🚫|🔒/g, '<span style="font-size: 1.2em;"></span>')
                    // Format lists better
                    .replace(/(\d+\.\s)/g, '<strong style="color: #2196F3;">$1</strong>')
                    // Enhanced flow stage formatting
                    .replace(/\b(INPUT|PROCESS|OUTPUT|UNUSED)\b/g, '<span style="background: rgba(6, 182, 212, 0.2); padding: 1px 4px; border-radius: 3px; font-weight: bold;">$1</span>');
            }

            showChatTyping() {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) return;
                
                const typingDiv = document.createElement('div');
                typingDiv.className = 'chat-message assistant';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="sender">LLM Flow Analysis Assistant</div>
                    <div class="content">
                        <span style="opacity: 0.7;">Analyzing flow patterns</span>
                        <span style="animation: blink 1s infinite;">...</span>
                    </div>
                `;
                
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            hideChatTyping() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator && typingIndicator.parentNode) {
                    typingIndicator.parentNode.removeChild(typingIndicator);
                }
            }

            // === EXPORT FUNCTIONALITY ===
            exportChatMessage(messageId) {
                const messageElement = document.getElementById(messageId);
                if (!messageElement) return;
                
                const chatData = this.chatHistory.find(msg => msg.id === messageId);
                if (!chatData) return;
                
                const timestamp = new Date(chatData.timestamp).toLocaleString();
                const filename = `flow-chat-response-${this.currentAnalyzedComponent}-${Date.now()}.txt`;
                
                const exportContent = `MAINFRAME FLOW ANALYSIS CHAT RESPONSE
=======================================

Component: ${this.currentAnalyzedComponent}
Timestamp: ${timestamp}
Question: ${chatData.content.split('\n')[0]}

Response:
${chatData.content.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ')}

Generated by: Enhanced Mainframe Analyzer with Flow Analysis
Analysis Date: ${new Date().toLocaleString()}
`;

                this.downloadTextFile(exportContent, filename);
                this.showSuccess(`💾 Flow chat response exported as ${filename}`);
            }

            async exportResults(format) {
                if (Object.keys(this.analysisResults).length === 0) {
                    this.showError('No analysis results to export');
                    return;
                }

                try {
                    if (format === 'json') {
                        await this.exportAsJSON();
                    } else if (format === 'markdown') {
                        await this.exportAsMarkdown();
                    }
                } catch (error) {
                    this.showError(`Export failed: ${error.message}`);
                }
            }

            async exportAsJSON() {
                const exportData = {
                    metadata: {
                        timestamp: new Date().toISOString(),
                        totalComponents: Object.keys(this.analysisResults).length,
                        totalFiles: this.uploadedFiles.length,
                        analysisMethod: 'LLM-Enhanced-Flow',
                        version: '4.0.0-flow-enhanced'
                    },
                    analysisResults: this.analysisResults,
                    chatHistory: this.chatHistory,
                    fileInfo: this.uploadedFiles.map(f => ({
                        name: f.name,
                        type: f.type,
                        size: f.size,
                        uploadDate: f.uploadDate
                    })),
                    systemInfo: {
                        vllmEndpoint: this.vllmEndpoint,
                        maxTokens: this.maxTokens,
                        llmConfig: this.llmConfig
                    }
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const filename = `enhanced-flow-mainframe-analysis-${new Date().toISOString().split('T')[0]}.json`;
                
                this.downloadTextFile(dataStr, filename);
                this.showSuccess(`📋 Enhanced flow analysis results exported as ${filename}`);
            }

            async exportAsMarkdown() {
                const exportContent = await this.generateFlowMarkdownReport();
                const filename = `mainframe-flow-analysis-report-${new Date().toISOString().split('T')[0]}.md`;
                
                this.downloadTextFile(exportContent, filename);
                this.showSuccess(`📝 Flow analysis markdown report exported as ${filename}`);
            }

            async generateFlowMarkdownReport() {
                const timestamp = new Date().toLocaleString();
                
                let markdown = `# Enhanced Mainframe Flow Analysis Report

**Generated:** ${timestamp}  
**Analysis Method:** LLM-Enhanced-Flow  
**Components Analyzed:** ${Object.keys(this.analysisResults).length}  
**Files Processed:** ${this.uploadedFiles.length}  

---

## Executive Summary

- **Total Components:** ${Object.keys(this.analysisResults).length}
- **Flow Analysis Coverage:** ${Object.keys(this.analysisResults).length} components
- **Analysis Method:** LLM-Enhanced with Flow Tracking

---

## 🌊 Flow Analysis Overview

This report includes comprehensive flow analysis covering:

- **Field Lifecycle Tracking**: Complete journey of fields from input to output
- **Cross-Program Flow**: Data movement and transformation between components
- **Unused Field Optimization**: Identification of cleanup opportunities
- **Program Execution Flow**: Step-by-step processing analysis
- **Dependency Impact**: Flow-aware relationship mapping

---

`;

                // Generate detailed analysis for each component
                for (const [componentName, results] of Object.entries(this.analysisResults)) {
                    markdown += `## Component Flow Analysis: ${componentName}

**Type:** ${results.componentType}  
**Quality Score:** ${results.qualityScore}/10  
**Completeness:** ${results.completeness.score}%  
**Files Analyzed:** ${results.filesAnalyzed.join(', ')}  
**Analysis Date:** ${new Date(results.timestamp).toLocaleString()}  
**Method:** ${results.analysisMethod}  

`;

                    if (results.llmAnalysis) {
                        markdown += `### 🤖 LLM Analysis Results\n\n`;
                        markdown += `Analysis completed with ${results.analysisMethod} method.\n\n`;
                    }

                    markdown += '\n---\n\n';
                }

                return markdown;
            }

            downloadTextFile(content, filename) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // === ENHANCED DISPLAY METHODS WITH FLOW ANALYSIS ===
            displayAnalysisResults(componentName, results) {
                console.log('Displaying LLM flow analysis results for:', componentName);
                
                this.displayMainAnalysis(componentName, results);
                this.displayFieldMatrix(componentName, results);
                this.displayFileFlow(componentName, results);
                this.displayProgramFlow(componentName, results);
                this.displayUsagePatterns(componentName, results);
                this.displayDependencies(componentName, results);
                
                this.switchTab({ target: { dataset: { tab: 'lifecycle' } } });
            }

            displayMainAnalysis(componentName, results) {
                const container = document.getElementById('lifecycleContent');
                
                let html = `
                    <h3>🤖 LLM-Enhanced Flow Analysis Results: ${componentName}</h3>
                    <p style="margin-bottom: 20px;">
                        Component type: <strong>${results.componentType}</strong> • 
                        Analysis method: <strong>${results.analysisMethod}</strong> • 
                        Files analyzed: <strong>${results.filesAnalyzed.length}</strong> • 
                        Completed: <strong>${new Date(results.timestamp).toLocaleString()}</strong>
                    </p>
                    
                    <!-- Enhanced Quality Metrics with Flow -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #4CAF50;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #FFD700;">${results.qualityScore}/10</div>
                            <div style="font-size: 11px;">LLM Quality Score</div>
                        </div>
                        <div style="background: rgba(33, 150, 243, 0.1); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #2196F3;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #FFD700;">${results.completeness.score}%</div>
                            <div style="font-size: 11px;">Completeness</div>
                        </div>
                        <div style="background: rgba(6, 182, 212, 0.1); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #06b6d4;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #FFD700;">🌊</div>
                            <div style="font-size: 11px;">Flow Enhanced</div>
                        </div>
                        <div style="background: rgba(156, 39, 176, 0.1); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #FFD700;">LLM</div>
                            <div style="font-size: 11px;">AI Enhanced</div>
                        </div>
                    </div>
                `;

                // Display LLM analysis based on component type
                if (results.componentType === 'Copybook' && results.llmAnalysis) {
                    html += this.displayLLMCopybookAnalysis(results.llmAnalysis);
                } else if (results.componentType === 'COBOL Program' && results.llmAnalysis) {
                    html += this.displayLLMProgramAnalysis(results.llmAnalysis);
                } else if (results.llmAnalysis) {
                    html += this.displayLLMGenericAnalysis(results.llmAnalysis);
                }

                // Display Flow Analysis Summary
                if (results.fileFlowAnalysis || results.programFlowAnalysis) {
                    html += this.displayFlowAnalysisSummary(results);
                }

                // Display LLM recommendations
                if (results.llmAnalysis && results.llmAnalysis.recommendations) {
                    html += this.displayLLMRecommendations(results.llmAnalysis.recommendations);
                }
                
                container.innerHTML = html;
            }

            displayLLMCopybookAnalysis(llmAnalysis) {
                if (!llmAnalysis || llmAnalysis.error) {
                    return `
                        <div style="background: rgba(244, 67, 54, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #f44336;">
                            <h4 style="color: #f44336; margin-bottom: 15px;">⚠️ LLM Analysis Error</h4>
                            <p>LLM analysis encountered an issue. Raw response available in export.</p>
                        </div>
                    `;
                }

                return `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                        <h4 style="color: #2196F3; margin-bottom: 15px;">🤖 LLM Program Analysis with Flow Context</h4>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                            <p>Detailed program flow analysis completed with LLM enhancement.</p>
                            <p><strong>Program Structure:</strong> ${llmAnalysis.programStructure ? 'Analyzed' : 'Basic'}</p>
                            <p><strong>Business Logic:</strong> ${llmAnalysis.businessLogic ? 'Extracted' : 'N/A'}</p>
                            <p><strong>Flow Metrics:</strong> ${llmAnalysis.flowMetrics ? 'Available' : 'N/A'}</p>
                        </div>
                    </div>
                `;
            }

            displayLLMGenericAnalysis(llmAnalysis) {
                return `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; border-left: 4px solid #9C27B0;">
                        <h4 style="color: #9C27B0; margin-bottom: 15px;">🤖 LLM Component Analysis with Flow Context</h4>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                            <p><strong>Component Type:</strong> ${llmAnalysis.componentType || 'Generic'}</p>
                            ${llmAnalysis.purpose ? `<p><strong>Purpose:</strong> ${llmAnalysis.purpose}</p>` : ''}
                            ${llmAnalysis.flowPatterns ? `<p><strong>Flow Patterns:</strong> ${llmAnalysis.flowPatterns.length} identified</p>` : ''}
                            <p style="margin-top: 15px; opacity: 0.8;">
                                Detailed flow analysis available through chat interface and export functionality.
                            </p>
                        </div>
                    </div>
                `;
            }

            displayFlowAnalysisSummary(results) {
                let html = `
                    <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #06b6d4; margin-top: 20px;">
                        <h4 style="color: #06b6d4; margin-bottom: 15px;">🌊 Flow Analysis Summary</h4>
                `;

                // File Flow Summary
                if (results.fileFlowAnalysis && results.fileFlowAnalysis.fileLifecycle) {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <h6 style="color: #22c55e; margin-bottom: 8px;">📊 File Lifecycle Metrics:</h6>
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px;">
                                <p>Flow stages analyzed with field lifecycle tracking</p>
                                <p><strong>Component:</strong> ${results.fileFlowAnalysis.fileLifecycle.componentName}</p>
                                <p><strong>Flow Stages:</strong> ${results.fileFlowAnalysis.fileLifecycle.flowStages ? results.fileFlowAnalysis.fileLifecycle.flowStages.length : 0}</p>
                            </div>
                        </div>
                    `;
                }

                // Program Flow Summary
                if (results.programFlowAnalysis && results.programFlowAnalysis.programFlow) {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <h6 style="color: #3b82f6; margin-bottom: 8px;">🔀 Program Flow Metrics:</h6>
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px;">
                                <p>Program execution flow analyzed with data transformations</p>
                                <p><strong>Component:</strong> ${results.programFlowAnalysis.programFlow.componentName}</p>
                                <p><strong>Execution Steps:</strong> ${results.programFlowAnalysis.programFlow.executionPath ? results.programFlowAnalysis.programFlow.executionPath.length : 0}</p>
                            </div>
                        </div>
                    `;
                }

                html += `
                    <div style="text-align: center; font-size: 12px; opacity: 0.8; margin-top: 10px;">
                        💡 <strong>Tip:</strong> Use the File Flow and Program Flow tabs for detailed analysis
                    </div>
                </div>
                `;

                return html;
            }

            displayLLMRecommendations(recommendations) {
                if (!recommendations || recommendations.length === 0) return '';
                
                let html = `
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #FFC107; margin-top: 20px;">
                        <h4 style="color: #FFC107; margin-bottom: 15px;">🤖 LLM Flow-Enhanced Recommendations</h4>
                `;

                recommendations.forEach((rec, index) => {
                    html += `
                        <div style="margin-bottom: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 3px solid #FFC107;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #FFC107;">💡 Flow Recommendation ${index + 1}</strong>
                                <span style="font-size: 11px; background: #FFC107; color: #000; padding: 2px 6px; border-radius: 3px; font-weight: bold;">
                                    FLOW-ENHANCED
                                </span>
                            </div>
                            <div style="line-height: 1.6;">${rec}</div>
                        </div>
                    `;
                });

                html += '</div>';
                return html;
            }

            // === DISPLAY METHODS FOR OTHER TABS ===
            displayFieldMatrix(componentName, results) {
                const container = document.getElementById('fieldMatrixContent');
                container.innerHTML = `
                    <h3>📋 LLM Field Matrix Analysis: ${componentName}</h3>
                    <p style="margin-bottom: 20px;">Enhanced field-level analysis with LLM-powered categorization and flow context.</p>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                        <p style="text-align: center; opacity: 0.8;">Field matrix analysis completed. Full details available in chat and export.</p>
                        ${results.llmAnalysis && results.llmAnalysis.fieldDetails ? 
                            `<p style="text-align: center; margin-top: 10px;"><strong>Fields Analyzed:</strong> ${Object.keys(results.llmAnalysis.fieldDetails).length}</p>` : 
                            ''}
                    </div>
                `;
            }

            displayFileFlow(componentName, results) {
                const container = document.getElementById('fileFlowContent');
                let html = `
                    <h3>🌊 File Flow Lifecycle Analysis: ${componentName}</h3>
                    <p style="margin-bottom: 20px;">Complete file and field lifecycle tracking across all programs.</p>
                `;

                if (results.fileFlowAnalysis && results.fileFlowAnalysis.fileLifecycle) {
                    const lifecycle = results.fileFlowAnalysis.fileLifecycle;
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <h4 style="color: #06b6d4; margin-bottom: 15px;">📊 File Lifecycle Overview</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="text-align: center; background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; color: #22c55e;">${lifecycle.flowStages ? lifecycle.flowStages.length : 0}</div>
                                    <div style="font-size: 12px;">Flow Stages</div>
                                </div>
                                <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; color: #3b82f6;">${lifecycle.crossProgramFlow ? lifecycle.crossProgramFlow.length : 0}</div>
                                    <div style="font-size: 12px;">Cross-Program Flows</div>
                                </div>
                                <div style="text-align: center; background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; color: #ef4444;">${lifecycle.unusedFields ? lifecycle.unusedFields.length : 0}</div>
                                    <div style="font-size: 12px;">Unused Fields</div>
                                </div>
                            </div>
                            <p style="text-align: center; margin-top: 15px; opacity: 0.8;">Use chat to explore detailed field lifecycle patterns</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="opacity: 0.8;">File flow analysis completed. Full details available in chat and export.</p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }

            displayProgramFlow(componentName, results) {
                const container = document.getElementById('programFlowContent');
                let html = `
                    <h3>🔀 Program Flow Analysis: ${componentName}</h3>
                    <p style="margin-bottom: 20px;">Step-by-step program execution flow with data transformation tracking.</p>
                `;

                if (results.programFlowAnalysis && results.programFlowAnalysis.programFlow) {
                    const programFlow = results.programFlowAnalysis.programFlow;
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <h4 style="color: #3b82f6; margin-bottom: 15px;">🔀 Program Execution Overview</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="text-align: center; background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; color: #22c55e;">${programFlow.executionPath ? programFlow.executionPath.length : 0}</div>
                                    <div style="font-size: 12px;">Execution Steps</div>
                                </div>
                                <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; color: #f59e0b;">${programFlow.decisionPoints ? programFlow.decisionPoints.length : 0}</div>
                                    <div style="font-size: 12px;">Decision Points</div>
                                </div>
                                <div style="text-align: center; background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; color: #8b5cf6;">${programFlow.dataTransformations ? programFlow.dataTransformations.length : 0}</div>
                                    <div style="font-size: 12px;">Transformations</div>
                                </div>
                            </div>
                            <p style="text-align: center; margin-top: 15px; opacity: 0.8;">Use chat to explore detailed execution flow patterns</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="opacity: 0.8;">Program flow analysis completed. Full details available in chat and export.</p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }

            displayUsagePatterns(componentName, results) {
                const container = document.getElementById('usageContent');
                container.innerHTML = `
                    <h3>📈 LLM Usage Patterns Analysis: ${componentName}</h3>
                    <p style="margin-bottom: 20px;">Advanced usage pattern analysis powered by LLM insights with flow context.</p>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                        <p style="text-align: center; opacity: 0.8;">Usage patterns analysis completed. Full details available in chat and export.</p>
                        ${results.llmAnalysis && results.llmAnalysis.fieldCategories ? 
                            `<div style="margin-top: 15px; text-align: center;">
                                <strong>Field Categories Identified:</strong> ${Object.keys(results.llmAnalysis.fieldCategories).length}
                            </div>` : ''}
                    </div>
                `;
            }

            displayDependencies(componentName, results) {
                const container = document.getElementById('dependenciesContent');
                let html = `
                    <h3>🔗 Hybrid Dependency Analysis: ${componentName}</h3>
                    <p style="margin-bottom: 20px;">Regex discovery + LLM validation for comprehensive dependency mapping with flow context.</p>
                `;

                if (results.validatedDependencies || results.basicDependencies) {
                    const deps = results.validatedDependencies || results.basicDependencies;
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                            <h4 style="color: #FFD700; margin-bottom: 15px;">🔗 Dependencies Overview</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    `;

                    const depTypes = [
                        { key: 'copyStatements', label: 'Copy Statements', color: '#22c55e' },
                        { key: 'callStatements', label: 'Call Statements', color: '#3b82f6' },
                        { key: 'fileReferences', label: 'File References', color: '#f59e0b' },
                        { key: 'sqlTables', label: 'SQL Tables', color: '#8b5cf6' }
                    ];

                    depTypes.forEach(depType => {
                        const count = deps[depType.key] ? deps[depType.key].length : 0;
                        html += `
                            <div style="text-align: center; background: rgba(${this.hexToRgb(depType.color)}, 0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 1.5rem; color: ${depType.color};">${count}</div>
                                <div style="font-size: 12px;">${depType.label}</div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                            <p style="text-align: center; margin-top: 15px; opacity: 0.8;">Use chat to explore detailed dependency relationships</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="opacity: 0.8;">Dependency analysis completed. Full details available in chat and export.</p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }

            // === UTILITY METHODS FOR DISPLAY ===
            getCategoryColor(category) {
                const colors = {
                    'INPUT_FIELDS': '#4CAF50',
                    'OUTPUT_FIELDS': '#2196F3',
                    'DERIVED_FIELDS': '#FF9800',
                    'CONDITION_FIELDS': '#9C27B0',
                    'UNUSED_FIELDS': '#f44336',
                    'STATIC_FIELDS': '#607D8B'
                };
                return colors[category] || '#FFD700';
            }

            getCategoryIcon(category) {
                const icons = {
                    'INPUT_FIELDS': '📥',
                    'OUTPUT_FIELDS': '📤',
                    'DERIVED_FIELDS': '🔄',
                    'CONDITION_FIELDS': '❓',
                    'UNUSED_FIELDS': '🚫',
                    'STATIC_FIELDS': '🔒'
                };
                return icons[category] || '📋';
            }

            formatCategoryName(category) {
                return category.replace(/_/g, ' ').toLowerCase()
                    .replace(/\b\w/g, l => l.toUpperCase());
            }

            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? 
                    `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                    '255, 255, 255';
            }
        }

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', function() {
            window.analyzer = new EnhancedMainframeAnalyzerWithFlow();
            
            console.log('🚀 Enhanced Mainframe Analyzer with Complete Flow Analysis Ready!');
            console.log('✅ Flow-Enhanced Features:');
            console.log('   • 🌊 Complete File Flow Analysis: Field lifecycle tracking across all programs');
            console.log('   • 🔀 Program Flow Analysis: Step-by-step execution with data transformations');
            console.log('   • 🧠 LLM-powered field lifecycle analysis with business context');
            console.log('   • ⚖️ Smart dependency detection: Regex discovery + LLM validation');
            console.log('   • 🎯 Context-aware copybook field categorization with flow stages');
            console.log('   • 📊 Cross-program flow mapping and optimization opportunities');
            console.log('   • 💬 Enhanced interactive chat with flow-aware analysis');
            console.log('   • 📤 Export capabilities: JSON + Markdown with flow analysis data');
            console.log('   • 💾 Individual chat message export for flow discussions');
            console.log('   • 🔄 Bulk analysis support with comprehensive flow processing');
            console.log('   • 🎛️ Token management and intelligent content chunking');
            console.log('   • 🛡️ Fallback handling for LLM response parsing');
            console.log('   • 🌊 NEW: File Flow Tab - Complete field lifecycle visualization');
            console.log('   • 🔀 NEW: Program Flow Tab - Step-by-step execution mapping');
            console.log('   • 🚫 NEW: Unused field identification and optimization recommendations');
            console.log('   • 🔗 NEW: Flow-aware dependency impact assessment');
            console.log('🎯 Ready for comprehensive LLM-enhanced mainframe flow analysis!');
        });

        // Fallback initialization
        if (document.readyState === 'loading') {
            // Document still loading, wait for DOMContentLoaded
        } else {
            // Document already loaded
            window.analyzer = new EnhancedMainframeAnalyzerWithFlow();
            console.log('🚀 Enhanced Flow Analysis Mainframe Analyzer initialized (fallback)');
        }
    </script>
</body>
</html>