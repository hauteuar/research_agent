<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Mainframe Analyzer - Dashboard Edition</title>
    <style>
        /* ============================================
           ENHANCED STYLES FOR DASHBOARD-DRIVEN INTERFACE
           ============================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Enhanced Color Palette */
            --primary-blue: #2563eb;
            --primary-blue-dark: #1e40af;
            --primary-blue-light: #3b82f6;
            --secondary-blue: #60a5fa;
            --accent-blue: #93c5fd;
            
            --grey-50: #f9fafb;
            --grey-100: #f3f4f6;
            --grey-200: #e5e7eb;
            --grey-300: #d1d5db;
            --grey-400: #9ca3af;
            --grey-500: #6b7280;
            --grey-600: #4b5563;
            --grey-700: #374151;
            --grey-800: #1f2937;
            --grey-900: #111827;
            
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --error-red: #ef4444;
            --info-blue: #3b82f6;
            --purple: #8b5cf6;
            --indigo: #6366f1;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            background: #ffffff;
            color: var(--grey-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--grey-50);
        }

        /* Enhanced Header */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-left: 3rem;
            font-weight: 400;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.85rem;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            display: block;
        }

        .header-stat-label {
            opacity: 0.8;
            font-size: 0.75rem;
        }

        /* Content Layout */
        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Enhanced Collapsible Panels */
        .panel {
            background: white;
            position: relative;
            transition: all var(--transition-normal);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--grey-200);
            box-shadow: var(--shadow-sm);
        }

        .panel.left {
            width: 420px;
            min-width: 60px;
        }

        .panel.left.collapsed {
            width: 60px;
        }

        .panel.right {
            width: 500px;
            min-width: 60px;
            border-left: 1px solid var(--grey-200);
            border-right: none;
        }

        .panel.right.collapsed {
            width: 60px;
        }

        .panel-header {
            padding: 1rem;
            background: linear-gradient(135deg, var(--grey-50) 0%, var(--grey-100) 100%);
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--grey-700);
            font-size: 0.95rem;
        }

        .panel-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
        }

        .collapse-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--grey-600);
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .collapse-btn:hover {
            background: var(--primary-blue);
            color: white;
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            transition: opacity var(--transition-normal);
        }

        .panel.collapsed .panel-content {
            opacity: 0;
            pointer-events: none;
            padding: 0;
        }

        .panel.collapsed .panel-title span {
            display: none;
        }

        /* Enhanced Component Cards */
        .component-card {
            background: white;
            border: 1px solid var(--grey-200);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .component-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        .component-card.selected {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
            box-shadow: var(--shadow-md);
        }

        .component-card-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .component-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .component-card-icon.program {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
        }

        .component-card-icon.copybook {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: white;
        }

        .component-card-icon.file {
            background: linear-gradient(135deg, var(--warning-yellow) 0%, #d97706 100%);
            color: white;
        }

        .component-card-info {
            flex: 1;
            min-width: 0;
        }

        .component-card-name {
            font-weight: 600;
            color: var(--grey-800);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .component-card-friendly {
            font-size: 0.8rem;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .component-card-description {
            font-size: 0.8rem;
            color: var(--grey-600);
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .component-card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .component-metric {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--grey-600);
        }

        .component-metric-icon {
            width: 14px;
            height: 14px;
            color: var(--grey-500);
        }

        /* Enhanced Collapsible Sections */
        .collapsible-section {
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--grey-200);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .collapsible-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--grey-50) 0%, var(--grey-100) 100%);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-fast);
            user-select: none;
            border-bottom: 1px solid var(--grey-200);
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: var(--grey-700);
        }

        .collapsible-header:hover .collapsible-title {
            color: white;
        }

        .collapsible-icon {
            width: 20px;
            height: 20px;
        }

        .expand-icon {
            width: 20px;
            height: 20px;
            color: var(--grey-400);
            transition: transform var(--transition-fast);
        }

        .collapsible-header:hover .expand-icon {
            color: white;
        }

        .collapsible-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
            background: white;
        }

        .collapsible-section.expanded .collapsible-content {
            max-height: 3000px;
        }

        .collapsible-body {
            padding: 1.5rem;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        /* Enhanced Tabs */
        .tabs-container {
            background: linear-gradient(135deg, white 0%, var(--grey-50) 100%);
            border-bottom: 1px solid var(--grey-200);
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            min-height: 60px;
            box-shadow: var(--shadow-sm);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--grey-600);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 8px;
            margin-right: 0.5rem;
        }

        .tab:hover {
            color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.1);
        }

        .tab.active {
            color: white;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            box-shadow: var(--shadow-md);
        }

        .tab-icon {
            width: 18px;
            height: 18px;
        }

        /* Tab Content */
        .tab-content-container {
            flex: 1;
            overflow-y: auto;
            background: var(--grey-50);
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            min-height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--grey-200);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-blue);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
        }

        .dashboard-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .dashboard-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--secondary-blue) 100%);
            color: white;
        }

        .dashboard-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--grey-800);
        }

        .dashboard-card-subtitle {
            font-size: 0.85rem;
            color: var(--grey-600);
        }

        .dashboard-card-content {
            margin-bottom: 1rem;
        }

        .dashboard-card-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--grey-100);
        }

        .dashboard-metric {
            text-align: center;
        }

        .dashboard-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            display: block;
        }

        .dashboard-metric-label {
            font-size: 0.7rem;
            color: var(--grey-500);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Status Indicators */
        .status-indicator {
            padding: 0.75rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .status-indicator.connected {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success-green);
        }

        .status-indicator.connecting {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning-yellow);
        }

        .status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Enhanced Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-block {
            width: 100%;
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-primary {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-blue);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-green);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-yellow);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-red);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-blue);
        }

        .badge-grey {
            background: var(--grey-100);
            color: var(--grey-600);
        }

        /* Form Elements */
        .form-section {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--grey-200);
            box-shadow: var(--shadow-sm);
        }

        .form-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--grey-700);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--grey-700);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all var(--transition-fast);
            background: white;
            color: var(--grey-800);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--grey-300);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--grey-50);
            margin-bottom: 1rem;
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .upload-area.drag-over {
            border-color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.1);
            transform: scale(0.98);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary-blue);
        }

        .upload-text {
            color: var(--grey-700);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .upload-subtext {
            color: var(--grey-500);
            font-size: 0.9rem;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--grey-200);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--grey-200);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--grey-800);
            margin-bottom: 0.5rem;
        }

        .loading-status {
            font-size: 0.9rem;
            color: var(--grey-600);
            margin-bottom: 1rem;
        }

        .loading-progress {
            width: 250px;
            height: 6px;
            background: var(--grey-200);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--grey-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--grey-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--grey-500);
        }

        /* Alert Messages */
        .alert {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            z-index: 10000;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: var(--success-green);
            color: white;
        }

        .alert-error {
            background: var(--error-red);
            color: white;
        }

        .alert-warning {
            background: var(--warning-yellow);
            color: white;
        }

        .alert-info {
            background: var(--info-blue);
            color: white;
        }

        .alert-icon {
            font-size: 1.25rem;
        }

        .alert-message {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Enhanced Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>
                        <div class="header-stats">
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerComponents">0</span>
                        <span class="header-stat-label">Components</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerPrograms">0</span>
                        <span class="header-stat-label">Programs</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerCopybooks">0</span>
                        <span class="header-stat-label">Copybooks</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerFields">0</span>
                        <span class="header-stat-label">Fields</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="content-wrapper">
            <!-- Left Panel - Component Dashboard -->
            <div class="panel left" id="leftPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">📊</div>
                        <span>Component Dashboard</span>
                    </div>
                    <button class="collapse-btn" onclick="togglePanel('left')">
                        ◀
                    </button>
                </div>
                <div class="panel-content" id="leftPanelContent">
                    <!-- LLM Server Setup -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span style="color: var(--success-green);">🚀</span>
                            LLM Server Setup
                        </div>

                        <div class="form-group">
                            <label class="form-label">Server Endpoint</label>
                            <input type="text" 
                                   id="vllmEndpoint" 
                                   class="form-input" 
                                   placeholder="http://localhost:8000" 
                                   value="http://localhost:8000">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" 
                                   id="maxTokens" 
                                   class="form-input" 
                                   value="4000" 
                                   min="1000" 
                                   max="8000">
                        </div>

                        <button id="validateApiBtn" class="btn btn-success btn-block">
                            <span>🔐</span>
                            Test Connection
                        </button>

                        <div id="apiStatus" class="status-indicator disconnected">
                            <span class="status-dot"></span>
                            <span>Enter server details and test connection</span>
                        </div>
                    </div>

                    <!-- File Upload Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span style="color: var(--info-blue);">📁</span>
                            Upload & Auto-Analyze
                        </div>

                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">📤</div>
                            <div class="upload-text">Drop files here or click to browse</div>
                            <div class="upload-subtext">COBOL (.cbl), Copybooks (.cpy), JCL (.jcl) - Auto-analysis starts immediately</div>
                            <input type="file" 
                                   id="fileInput" 
                                   multiple 
                                   accept=".cbl,.cob,.cpy,.copybook,.jcl,.txt,.proc" 
                                   style="display: none;">
                        </div>

                        <button id="autoAnalyzeBtn" class="btn btn-primary btn-block" disabled>
                            <span>🤖</span>
                            Start Auto-Analysis
                        </button>
                    </div>

                    <!-- Discovered Components -->
                    <div class="collapsible-section expanded" id="discoveredComponents">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <span class="collapsible-icon">🎯</span>
                                Discovered Components (<span id="componentCount">0</span>)
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-body" id="componentsList">
                                <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                                    Upload files to auto-discover components
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Programs Section -->
                    <div class="collapsible-section" id="programsSection">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <span class="collapsible-icon">💼</span>
                                COBOL Programs (<span id="programCount">0</span>)
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-body" id="programsList">
                                <p style="color: var(--grey-500); text-align: center;">No programs discovered yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Copybooks Section -->
                    <div class="collapsible-section" id="copybooksSection">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <span class="collapsible-icon">📚</span>
                                Copybooks (<span id="copybookCount">0</span>)
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-body" id="copybooksList">
                                <p style="color: var(--grey-500); text-align: center;">No copybooks discovered yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Files Section -->
                    <div class="collapsible-section" id="filesSection">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <span class="collapsible-icon">📋</span>
                                Files & Jobs (<span id="fileCount">0</span>)
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-body" id="filesList">
                                <p style="color: var(--grey-500); text-align: center;">No files discovered yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span style="color: var(--warning-yellow);">⚡</span>
                            Actions
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <button id="exportJsonBtn" class="btn btn-primary" disabled>
                                <span>📋</span>
                                Export JSON
                            </button>
                            <button id="exportMdBtn" class="btn btn-primary" disabled>
                                <span>📝</span>
                                Export MD
                            </button>
                        </div>

                        <button id="clearBtn" class="btn btn-danger btn-block">
                            <span>🗑️</span>
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Enhanced Tabs -->
                <div class="tabs-container">
                    <button class="tab active" data-tab="dashboard">
                        <span class="tab-icon">📊</span>
                        Dashboard Overview
                    </button>
                    <button class="tab" data-tab="fieldmatrix">
                        <span class="tab-icon">📋</span>
                        Field Matrix
                    </button>
                    <button class="tab" data-tab="dependencies">
                        <span class="tab-icon">🔗</span>
                        Dependencies Flow
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content-container">
                    <!-- Dashboard Overview Tab -->
                    <div id="dashboard" class="tab-content active">
                        <!-- Overview Cards -->
                        <div class="dashboard-grid" id="dashboardGrid">
                            <div class="dashboard-card">
                                <div class="dashboard-card-header">
                                    <div class="dashboard-card-icon">📊</div>
                                    <div>
                                        <div class="dashboard-card-title">System Overview</div>
                                        <div class="dashboard-card-subtitle">Complete mainframe analysis</div>
                                    </div>
                                </div>
                                <div class="dashboard-card-content">
                                    <p>Upload your mainframe files to automatically discover and analyze all components with business intelligence.</p>
                                </div>
                                <div class="dashboard-card-metrics">
                                    <div class="dashboard-metric">
                                        <span class="dashboard-metric-value" id="dashTotalComponents">0</span>
                                        <span class="dashboard-metric-label">Components</span>
                                    </div>
                                    <div class="dashboard-metric">
                                        <span class="dashboard-metric-value" id="dashTotalFiles">0</span>
                                        <span class="dashboard-metric-label">Files</span>
                                    </div>
                                    <div class="dashboard-metric">
                                        <span class="dashboard-metric-value" id="dashTotalFields">0</span>
                                        <span class="dashboard-metric-label">Fields</span>
                                    </div>
                                    <div class="dashboard-metric">
                                        <span class="dashboard-metric-value" id="dashQualityScore">-</span>
                                        <span class="dashboard-metric-label">Avg Quality</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Component Analysis Results -->
                        <div id="dashboardContent">
                            <!-- Programs Overview -->
                            <div class="collapsible-section expanded">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span class="collapsible-icon">💼</span>
                                        Programs Overview
                                    </div>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-body" id="programsOverview">
                                        <p style="color: var(--grey-500); text-center: center;">Upload and analyze files to see program overview</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Copybooks Overview -->
                            <div class="collapsible-section expanded">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span class="collapsible-icon">📚</span>
                                        Copybooks Overview
                                    </div>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-body" id="copybooksOverview">
                                        <p style="color: var(--grey-500); text-align: center;">Upload and analyze files to see copybook overview</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Dependencies Summary -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span class="collapsible-icon">🔗</span>
                                        Dependencies Summary
                                    </div>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-body" id="dependenciesSummary">
                                        <p style="color: var(--grey-500); text-align: center;">Upload and analyze files to see dependencies summary</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Field Statistics -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span class="collapsible-icon">📋</span>
                                        Field Statistics
                                    </div>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-body" id="fieldStatistics">
                                        <p style="color: var(--grey-500); text-align: center;">Upload and analyze files to see field statistics</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Business Logic Summary -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span class="collapsible-icon">⚖️</span>
                                        Business Logic Summary
                                    </div>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-body" id="businessLogicSummary">
                                        <p style="color: var(--grey-500); text-align: center;">Upload and analyze files to see business logic summary</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Field Matrix Tab -->
                    <div id="fieldmatrix" class="tab-content">
                        <div class="collapsible-section expanded">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <div class="collapsible-title">
                                    <span class="collapsible-icon">📊</span>
                                    Field Matrix Analysis
                                </div>
                                <span class="expand-icon">▼</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-body" id="fieldMatrixContent">
                                    <p style="color: var(--grey-500); text-align: center;">Select a component from the dashboard to view field matrix analysis.</p>
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <div class="collapsible-title">
                                    <span class="collapsible-icon">📈</span>
                                    Field Usage Patterns
                                </div>
                                <span class="expand-icon">▼</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-body" id="fieldUsagePatterns">
                                    <p style="color: var(--grey-500); text-align: center;">Field usage patterns will appear here.</p>
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <div class="collapsible-title">
                                    <span class="collapsible-icon">🌊</span>
                                    Field Lifecycle Details
                                </div>
                                <span class="expand-icon">▼</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-body" id="fieldLifecycleDetails">
                                    <p style="color: var(--grey-500); text-align: center;">Field lifecycle details will appear here.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dependencies Flow Tab -->
                    <div id="dependencies" class="tab-content">
                        <div class="collapsible-section expanded">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <div class="collapsible-title">
                                    <span class="collapsible-icon">🗺️</span>
                                    High-Level Dependency Flow
                                </div>
                                <span class="expand-icon">▼</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-body" id="dependencyFlowChart">
                                    <p style="color: var(--grey-500); text-align: center;">Upload and analyze files to see dependency flow visualization.</p>
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <div class="collapsible-title">
                                    <span class="collapsible-icon">🔍</span>
                                    Detailed Flow Analysis
                                </div>
                                <span class="expand-icon">▼</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-body" id="detailedFlowAnalysis">
                                    <p style="color: var(--grey-500); text-align: center;">Detailed flow analysis will appear here.</p>
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <div class="collapsible-title">
                                    <span class="collapsible-icon">⚡</span>
                                    Impact Analysis
                                </div>
                                <span class="expand-icon">▼</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-body" id="impactAnalysis">
                                    <p style="color: var(--grey-500); text-align: center;">Impact analysis will appear here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
           
                <!-- Right Panel - Enhanced Chat -->
            <div class="panel right" id="rightPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">💬</div>
                        <span>Business Intelligence Chat</span>
                    </div>
                    <button class="collapse-btn" onclick="togglePanel('right')">
                        ▶
                    </button>
                </div>
                <div class="panel-content" id="rightPanelContent">
                    <!-- Chat Container -->
                    <div class="chat-container">
                        <!-- Chat Header Info -->
                        <div style="padding: 1rem; background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); color: white; border-radius: 12px; margin-bottom: 1rem;">
                            <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">🧠 Business Intelligence Chat</h3>
                            <p style="font-size: 0.8rem; opacity: 0.9;">Drill down into programs, fields, files, and business logic</p>
                        </div>

                        <!-- Context Selector -->
                        <div class="form-section" id="chatContextSection" style="display: none;">
                            <div class="form-section-title">
                                <span style="color: var(--info-blue);">🎯</span>
                                Chat Context
                            </div>
                            <div class="form-group">
                                <label class="form-label">Current Focus</label>
                                <select id="chatContext" class="form-input">
                                    <option value="general">General Analysis</option>
                                    <option value="component">Specific Component</option>
                                    <option value="program">Program Level</option>
                                    <option value="field">Field Level</option>
                                    <option value="file">File Level</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Selected Item</label>
                                <input type="text" id="chatSelectedItem" class="form-input" placeholder="Auto-selected based on dashboard" readonly>
                            </div>
                        </div>

                        <!-- Chat Suggestions -->
                        <div id="chatSuggestions" class="chat-suggestions" style="display: none;">
                            <div class="chat-suggestions-title">💡 Suggested Questions:</div>
                            <div class="chat-suggestion-chips">
                                <button class="chat-suggestion-btn" data-question="What is the business purpose of this component?">
                                    🎯 Business Purpose
                                </button>
                                <button class="chat-suggestion-btn" data-question="Show me the complete field lifecycle flow">
                                    🌊 Field Lifecycle
                                </button>
                                <button class="chat-suggestion-btn" data-question="What programs create vs update vs read this data?">
                                    🔄 Data Operations
                                </button>
                                <button class="chat-suggestion-btn" data-question="What are the missing dependencies and their impact?">
                                    ⚠️ Missing Dependencies
                                </button>
                                <button class="chat-suggestion-btn" data-question="What business rules and validations are implemented?">
                                    ⚖️ Business Rules
                                </button>
                                <button class="chat-suggestion-btn" data-question="How can we optimize this component for modernization?">
                                    🚀 Optimization
                                </button>
                            </div>
                        </div>

                        <!-- Chat Messages Area -->
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message assistant">
                                <div class="chat-bubble">
                                    <div class="chat-message-header">Business Intelligence Assistant</div>
                                    <div class="chat-message-content">
                                        👋 <strong>Welcome to Business Intelligence Chat!</strong>
                                        <br><br>
                                        I provide contextual analysis and can drill down into:
                                        <br><br>
                                        🎯 <strong>Business Purpose:</strong> What each component does in business terms<br>
                                        📊 <strong>Program Analysis:</strong> Detailed program structure and logic<br>
                                        📋 <strong>Field Analysis:</strong> Field lifecycle, usage, and business meaning<br>
                                        📁 <strong>File Analysis:</strong> Data flow and file relationships<br>
                                        🔗 <strong>Dependency Impact:</strong> How changes affect the system<br>
                                        ⚖️ <strong>Business Rules:</strong> Logic validation and business constraints<br>
                                        🚀 <strong>Modernization:</strong> Optimization and migration recommendations
                                        <br><br>
                                        <em>Upload files and start auto-analysis to unlock intelligent conversations!</em>
                                    </div>
                                    <div class="chat-message-time">${new Date().toLocaleTimeString()}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Input Section -->
                        <div class="chat-input-section">
                            <div class="chat-input-group">
                                <textarea id="chatInput" 
                                          class="chat-input" 
                                          placeholder="Ask about business purpose, field flows, dependencies, optimization..." 
                                          disabled 
                                          rows="1"></textarea>
                                <button id="chatSendBtn" class="chat-send-btn" disabled>
                                    <span>Send</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingIndicator">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-title">🤖 Auto-Analyzing Components</div>
            <div class="loading-status" id="loadingStatus">Processing component auto-discovery...</div>
            <div class="loading-progress">
                <div class="loading-progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Enhanced Chat Styles -->
    <style>
        /* Chat Styles - Enhanced Layout */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Chat Suggestions */
        .chat-suggestions {
            padding: 0.75rem;
            background: var(--grey-50);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--grey-200);
        }

        .chat-suggestions-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--grey-700);
            margin-bottom: 0.5rem;
        }

        .chat-suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .chat-suggestion-btn {
            padding: 0.375rem 0.75rem;
            background: white;
            border: 1px solid var(--grey-300);
            border-radius: 20px;
            font-size: 0.7rem;
            color: var(--grey-700);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .chat-suggestion-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: translateY(-1px);
        }

        /* Enhanced Chat Messages Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--grey-50);
            border-radius: 8px;
            margin-bottom: 1rem;
            min-height: 400px;
            max-height: calc(100vh - 400px);
            border: 1px solid var(--grey-200);
        }

        .chat-message {
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            display: flex;
            justify-content: flex-end;
        }

        .chat-message.assistant {
            display: flex;
            justify-content: flex-start;
        }

        /* Enhanced Chat Bubbles */
        .chat-bubble {
            max-width: 95%;
            padding: 1rem;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.6;
        }

        .user .chat-bubble {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .assistant .chat-bubble {
            background: white;
            color: var(--grey-800);
            border: 1px solid var(--grey-200);
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .chat-message-header {
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            opacity: 0.7;
        }

        .chat-message-content {
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .chat-message-content strong {
            font-weight: 600;
            color: var(--primary-blue);
        }

        .assistant .chat-message-content strong {
            color: var(--primary-blue);
        }

        .user .chat-message-content strong {
            color: white;
        }

        .chat-message-time {
            font-size: 0.65rem;
            opacity: 0.5;
            margin-top: 0.25rem;
        }

        /* Enhanced Chat Input Section */
        .chat-input-section {
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--grey-200);
            box-shadow: var(--shadow-sm);
        }

        .chat-input-group {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            resize: none;
            min-height: 80px;
            max-height: 160px;
            font-size: 0.95rem;
            transition: all var(--transition-fast);
            font-family: inherit;
            line-height: 1.4;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chat-input::placeholder {
            color: var(--grey-400);
            font-size: 0.9rem;
        }

        .chat-send-btn {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            min-height: 80px;
            align-self: stretch;
        }

        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Table Styles for Analysis Results */
        .data-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--grey-200);
            margin-bottom: 1rem;
        }

        .data-table thead {
            background: var(--grey-50);
        }

        .data-table th {
            padding: 0.75rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 1px solid var(--grey-200);
        }

        .data-table td {
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--grey-800);
            border-bottom: 1px solid var(--grey-100);
        }

        .data-table tbody tr:hover {
            background: var(--grey-50);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Metric Cards for Dashboard */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            border: 1px solid var(--grey-200);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--primary-blue);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .metric-details {
            flex: 1;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--grey-500);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--grey-800);
        }

        .metric-change {
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-change.positive {
            color: var(--success-green);
        }

        .metric-change.negative {
            color: var(--error-red);
        }

        /* File List Styles */
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border: 1px solid var(--grey-200);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all var(--transition-fast);
        }

        .file-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateX(2px);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            background: var(--grey-100);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: var(--grey-800);
            font-size: 0.9rem;
        }

        .file-meta {
            font-size: 0.75rem;
            color: var(--grey-500);
            margin-top: 0.125rem;
        }

        .file-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--error-red);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .file-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Flow Visualization Styles */
        .flow-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            border: 1px solid var(--grey-200);
        }

        .flow-diagram {
            min-width: 800px;
            padding: 2rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            position: relative;
        }

        .flow-level {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .flow-level:last-child {
            margin-bottom: 0;
        }

        .flow-level-title {
            position: absolute;
            left: -120px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            color: var(--grey-600);
            font-size: 0.9rem;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .flow-nodes {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
        }

        .flow-node {
            background: white;
            border: 2px solid var(--grey-300);
            border-radius: 12px;
            padding: 1rem;
            min-width: 120px;
            text-align: center;
            position: relative;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .flow-node:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        .flow-node.current {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .flow-node.upstream {
            border-color: var(--success-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .flow-node.downstream {
            border-color: var(--warning-yellow);
            background: rgba(245, 158, 11, 0.1);
        }

        .flow-node.missing {
            border-color: var(--error-red);
            background: rgba(239, 68, 68, 0.1);
            border-style: dashed;
        }

        .flow-node-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .flow-node-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .flow-node-type {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .flow-arrow {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -2rem;
            color: var(--primary-blue);
            font-size: 1.5rem;
            opacity: 0.7;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--grey-200);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
        }

        .progress-fill.success {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
        }

        .progress-fill.warning {
            background: linear-gradient(135deg, var(--warning-yellow) 0%, #d97706 100%);
        }

        .progress-fill.danger {
            background: linear-gradient(135deg, var(--error-red) 0%, #dc2626 100%);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .panel.left {
                width: 350px;
            }
            .panel.right {
                width: 400px;
            }
        }

        @media (max-width: 768px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .panel {
                width: 100% !important;
                min-height: 200px;
            }
            
            .panel.left.collapsed,
            .panel.right.collapsed {
                min-height: 60px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // ============================================
        // ENHANCED MAINFRAME ANALYZER - DASHBOARD EDITION
        // Core JavaScript Functions and Event Handlers
        // ============================================
        
        // Basic UI Functions
        function togglePanel(side) {
            const panel = document.getElementById(side + 'Panel');
            panel.classList.toggle('collapsed');
            
            // Update button icon
            const btn = panel.querySelector('.collapse-btn');
            if (side === 'left') {
                btn.textContent = panel.classList.contains('collapsed') ? '▶' : '◀';
            } else {
                btn.textContent = panel.classList.contains('collapsed') ? '◀' : '▶';
            }
            
            // Save state to localStorage
            localStorage.setItem(side + 'PanelCollapsed', panel.classList.contains('collapsed'));
        }

        function toggleCollapsible(header) {
            const section = header.parentElement;
            section.classList.toggle('expanded');
        }

        // Initialize tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active to clicked tab
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Restore panel states from localStorage
        window.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('leftPanelCollapsed') === 'true') {
                togglePanel('left');
            }
            if (localStorage.getItem('rightPanelCollapsed') === 'true') {
                togglePanel('right');
            }
        });

        // Enhanced Mainframe Analyzer Class - Dashboard Edition
        class EnhancedMainframeAnalyzer {
            constructor() {
                // Core properties
                this.uploadedFiles = [];
                this.analysisResults = {};
                this.componentSuggestions = [];
                this.discoveredComponents = new Map();
                this.serverValidated = false;
                this.vllmEndpoint = 'http://localhost:8000';
                this.maxTokens = 4000;
                this.currentSelectedComponent = null;
                this.chatHistory = [];
                this.chatContext = 'general';
                
                // Business intelligence properties
                this.friendlyNameCache = new Map();
                this.businessContextCache = new Map();
                this.componentMetrics = new Map();
                
                // SQLite Database
                this.db = null;
                this.dbInitialized = false;
                
                // Auto-analysis state
                this.autoAnalysisInProgress = false;
                this.analysisQueue = [];
                
                // Initialize
                this.initializeDatabase();
                this.initializeEventListeners();
                this.loadStoredData();
                this.initializeChat();
                this.addTypingAnimationStyles();

                console.log('🚀 Enhanced Mainframe Analyzer - Dashboard Edition Initialized');
            }

            // Initialize Event Listeners
            initializeEventListeners() {
                // API Validation
                const validateBtn = document.getElementById('validateApiBtn');
                if (validateBtn) {
                    validateBtn.addEventListener('click', () => this.validateConnection());
                }
                
                // File Upload
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                if (uploadArea && fileInput) {
                    uploadArea.addEventListener('click', () => {
                        if (this.serverValidated) fileInput.click();
                    });
                    uploadArea.addEventListener('drop', (e) => this.handleFileDrop(e));
                    uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                    uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                    fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }
                
                // Auto Analysis
                const autoAnalyzeBtn = document.getElementById('autoAnalyzeBtn');
                if (autoAnalyzeBtn) {
                    autoAnalyzeBtn.addEventListener('click', () => this.startAutoAnalysis());
                }
                
                // Export buttons
                const exportJsonBtn = document.getElementById('exportJsonBtn');
                const exportMdBtn = document.getElementById('exportMdBtn');
                const clearBtn = document.getElementById('clearBtn');
                
                if (exportJsonBtn) exportJsonBtn.addEventListener('click', () => this.exportResults('json'));
                if (exportMdBtn) exportMdBtn.addEventListener('click', () => this.exportResults('markdown'));
                if (clearBtn) clearBtn.addEventListener('click', () => this.clearAllData());
                
                // Settings
                const endpointInput = document.getElementById('vllmEndpoint');
                const maxTokensInput = document.getElementById('maxTokens');
                
                if (endpointInput) {
                    endpointInput.addEventListener('input', () => this.onEndpointChange());
                }
                
                if (maxTokensInput) {
                    maxTokensInput.addEventListener('input', () => this.onSettingsChange());
                }
                
                // Chat context selector
                const chatContext = document.getElementById('chatContext');
                if (chatContext) {
                    chatContext.addEventListener('change', () => this.onChatContextChange());
                }
            }

            // Show/Hide Loading
            showLoading() {
                const loading = document.getElementById('loadingIndicator');
                if (loading) loading.classList.add('show');
            }

            hideLoading() {
                const loading = document.getElementById('loadingIndicator');
                if (loading) loading.classList.remove('show');
            }

            updateLoadingStatus(status) {
                const statusEl = document.getElementById('loadingStatus');
                if (statusEl) statusEl.textContent = status;
            }

            updateProgress(percentage) {
                const progressFill = document.getElementById('progressFill');
                if (progressFill) progressFill.style.width = `${percentage}%`;
            }

            // Alert Messages
            showMessage(type, message, duration = 3000) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <span class="alert-icon">${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}</span>
                    <span class="alert-message">${message}</span>
                `;
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.style.animation = 'slideInRight 0.3s ease reverse';
                        setTimeout(() => alert.remove(), 300);
                    }
                }, duration);
            }

            showSuccess(message) { this.showMessage('success', message); }
            showError(message) { this.showMessage('error', message, 5000); }
            showWarning(message) { this.showMessage('warning', message, 4000); }
            showInfo(message) { this.showMessage('info', message); }

            // ============================================
// PART 3: CORE ANALYSIS AND DATABASE FUNCTIONS
// Auto-discovery, component analysis, and business intelligence
// ============================================

// Add these methods to the EnhancedMainframeAnalyzer class

// Initialize SQLite Database
async initializeDatabase() {
    try {
        const SQL = await initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });
        
        // Try to load existing database from localStorage
        const savedDb = localStorage.getItem('mainframe_analyzer_db');
        if (savedDb) {
            const uInt8Array = new Uint8Array(JSON.parse(savedDb));
            this.db = new SQL.Database(uInt8Array);
        } else {
            this.db = new SQL.Database();
        }
        
        // Create tables
        this.createTables();
        this.dbInitialized = true;
        console.log('✅ SQLite database initialized');
        
    } catch (error) {
        console.error('Failed to initialize SQLite database:', error);
        this.dbInitialized = false;
    }
}

// Create Database Tables
createTables() {
    if (!this.db) return;
    
    // Uploaded Files table
    this.db.run(`
        CREATE TABLE IF NOT EXISTS uploaded_files (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            file_id TEXT UNIQUE,
            name TEXT,
            content TEXT,
            size INTEGER,
            type TEXT,
            upload_date TEXT,
            components TEXT,
            metrics TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `);
    
    // Discovered Components table
    this.db.run(`
        CREATE TABLE IF NOT EXISTS discovered_components (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            component_name TEXT UNIQUE,
            friendly_name TEXT,
            component_type TEXT,
            business_purpose TEXT,
            file_source TEXT,
            line_count INTEGER,
            complexity_score INTEGER,
            input_files TEXT,
            output_files TEXT,
            field_count INTEGER,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `);
    
    // Analysis Results table
    this.db.run(`
        CREATE TABLE IF NOT EXISTS analysis_results (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            component_name TEXT UNIQUE,
            friendly_name TEXT,
            component_type TEXT,
            results_data TEXT,
            quality_score INTEGER,
            business_context TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `);
    
    // Business Intelligence cache
    this.db.run(`
        CREATE TABLE IF NOT EXISTS business_intelligence (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            component_name TEXT,
            friendly_name TEXT,
            business_context TEXT,
            source TEXT DEFAULT 'LLM',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `);
    
    // Chat History table
    this.db.run(`
        CREATE TABLE IF NOT EXISTS chat_history (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            component_name TEXT,
            context_type TEXT,
            sender TEXT,
            content TEXT,
            timestamp TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `);
}

// Validate LLM Connection
async validateConnection() {
    const endpoint = document.getElementById('vllmEndpoint').value.trim();
    if (!endpoint) {
        this.showError('Please enter vLLM endpoint');
        return;
    }

    this.updateConnectionStatus('connecting', 'Testing LLM connection...');

    try {
        const response = await fetch(`${endpoint}/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: "Test connection. Respond with 'Connected'",
                max_tokens: 10,
                temperature: 0.1
            }),
            signal: AbortSignal.timeout(10000)
        });

        if (response.ok) {
            this.serverValidated = true;
            this.vllmEndpoint = endpoint;
            this.updateConnectionStatus('connected', `✅ LLM connection verified`);
            this.showSuccess('🚀 vLLM server connected successfully!');
            
            // Enable file upload and auto-analysis
            this.enableFileUpload();
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        this.serverValidated = false;
        this.updateConnectionStatus('disconnected', `❌ Connection failed: ${error.message}`);
        this.showError(`LLM connection failed: ${error.message}`);
    }
}

// Enable File Upload
enableFileUpload() {
    const uploadArea = document.getElementById('uploadArea');
    const autoAnalyzeBtn = document.getElementById('autoAnalyzeBtn');
    
    if (uploadArea) {
        uploadArea.style.opacity = '1';
        uploadArea.style.cursor = 'pointer';
    }
    
    // Enable auto-analysis if files are already uploaded
    if (this.uploadedFiles.length > 0 && autoAnalyzeBtn) {
        autoAnalyzeBtn.disabled = false;
    }
}

// Update Connection Status
updateConnectionStatus(status, message) {
    const statusEl = document.getElementById('apiStatus');
    if (statusEl) {
        statusEl.className = `status-indicator ${status}`;
        statusEl.innerHTML = `
            <span class="status-dot"></span>
            <span>${message}</span>
        `;
    }
}

// File Upload Handling
async handleFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.classList.remove('drag-over');
    
    if (!this.serverValidated) {
        this.showError('Please validate LLM API connection first');
        return;
    }
    
    const files = Array.from(e.dataTransfer.files);
    await this.processFiles(files);
}

async handleFileSelect(e) {
    if (!this.serverValidated) {
        this.showError('Please validate LLM API connection first');
        return;
    }
    
    const files = Array.from(e.target.files);
    await this.processFiles(files);
}

handleDragOver(e) {
    e.preventDefault();
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) uploadArea.classList.add('drag-over');
}

handleDragLeave(e) {
    e.preventDefault();
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) uploadArea.classList.remove('drag-over');
}

// Process Files with Auto-Discovery
async processFiles(files) {
    for (const file of files) {
        try {
            const content = await this.readFile(file);
            const fileType = this.detectFileType(file.name, content);
            
            const fileObj = {
                name: file.name,
                content: content,
                size: file.size,
                type: fileType,
                uploadDate: new Date().toISOString(),
                id: Date.now() + Math.random(),
                components: this.extractComponentsFromFile(content, fileType),
                metrics: this.calculateFileMetrics(content, fileType)
            };
            
            this.uploadedFiles.push(fileObj);
            
            // Auto-discover components
            await this.autoDiscoverComponents(fileObj);
            
        } catch (error) {
            this.showError(`Failed to read ${file.name}: ${error.message}`);
        }
    }
    
    this.updateDashboardStats();
    this.displayDiscoveredComponents();
    this.enableAutoAnalysis();
    this.saveToStorage();
    
    this.showSuccess(`📁 ${files.length} files uploaded and components auto-discovered!`);
}

// Read File
readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(new Error('File read failed'));
        reader.readAsText(file);
    });
}

// Detect File Type
detectFileType(fileName, content) {
    const name = fileName.toLowerCase();
    const upperContent = content.toUpperCase();
    
    if (name.includes('.cpy') || name.includes('copybook')) {
        return 'Copybook';
    } else if (name.includes('.jcl') || upperContent.includes('//JOB ')) {
        return 'JCL Job';
    } else if (name.includes('.cbl') || name.includes('.cob') || 
              upperContent.includes('IDENTIFICATION DIVISION') ||
              upperContent.includes('PROGRAM-ID')) {
        return 'COBOL Program';
    } else if (name.includes('.proc')) {
        return 'JCL Procedure';
    } else {
        return 'Text File';
    }
}

// Calculate File Metrics
calculateFileMetrics(content, fileType) {
    const lines = content.split('\n');
    const totalLines = lines.length;
    const codeLines = lines.filter(line => {
        const trimmed = line.trim();
        return trimmed.length > 0 && !trimmed.startsWith('*') && !trimmed.startsWith('//');
    }).length;
    
    const complexity = this.calculateComplexity(content, fileType);
    
    return {
        totalLines,
        codeLines,
        commentLines: totalLines - codeLines,
        complexity,
        fileSize: content.length
    };
}

// Calculate Complexity Score
calculateComplexity(content, fileType) {
    const upperContent = content.toUpperCase();
    let complexity = 1;
    
    if (fileType === 'COBOL Program') {
        // Count decision points
        const ifCount = (upperContent.match(/\bIF\b/g) || []).length;
        const performCount = (upperContent.match(/\bPERFORM\b/g) || []).length;
        const evaluateCount = (upperContent.match(/\bEVALUATE\b/g) || []).length;
        
        complexity = 1 + ifCount + performCount + evaluateCount;
    } else if (fileType === 'Copybook') {
        // Count field definitions
        const fieldCount = (upperContent.match(/^\s*\d{2}\s+/gm) || []).length;
        complexity = Math.ceil(fieldCount / 10);
    }
    
    return Math.min(complexity, 10);
}

// Extract Components from Files
extractComponentsFromFile(content, fileType) {
    const components = [];
    const lines = content.split('\n');

    lines.forEach((line, index) => {
        const trimmed = line.trim().toUpperCase();
        
        // Extract COBOL 01-level fields (main focus for copybooks)
        const field01Match = trimmed.match(/^\s*01\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (field01Match) {
            components.push({
                name: field01Match[1],
                type: 'RECORD_LAYOUT',
                level: '01',
                lineNumber: index + 1,
                fileType: fileType,
                isMainComponent: true,
                businessPurpose: this.generateBusinessPurpose(field01Match[1])
            });
        }
        
        // Extract ALL field levels for complete analysis
        const fieldMatch = trimmed.match(/^\s*(\d{2})\s+([A-Z][A-Z0-9\-_]*)/);
        if (fieldMatch) {
            const level = parseInt(fieldMatch[1]);
            const fieldName = fieldMatch[2];
            
            if (level !== 88 && fieldName) {
                components.push({
                    name: fieldName,
                    type: level === 1 ? 'RECORD_LAYOUT' : 'FIELD',
                    level: level,
                    lineNumber: index + 1,
                    fileType: fileType,
                    isMainComponent: level === 1,
                    businessPurpose: this.generateBusinessPurpose(fieldName)
                });
            }
        }
        
        // Extract copybook names
        const copyMatch = trimmed.match(/COPY\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (copyMatch) {
            components.push({
                name: copyMatch[1],
                type: 'COPYBOOK',
                lineNumber: index + 1,
                fileType: fileType,
                isMainComponent: false,
                businessPurpose: this.generateBusinessPurpose(copyMatch[1])
            });
        }
        
        // Extract program names
        const programMatch = trimmed.match(/PROGRAM-ID\.?\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (programMatch) {
            components.push({
                name: programMatch[1],
                type: 'PROGRAM',
                lineNumber: index + 1,
                fileType: fileType,
                isMainComponent: true,
                businessPurpose: this.generateBusinessPurpose(programMatch[1])
            });
        }

        // Extract file names from FD statements
        const fileMatch = trimmed.match(/FD\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (fileMatch) {
            components.push({
                name: fileMatch[1],
                type: 'FILE',
                lineNumber: index + 1,
                fileType: fileType,
                isMainComponent: false,
                businessPurpose: this.generateBusinessPurpose(fileMatch[1])
            });
        }
    });
    
    return components;
}

// Generate Business Purpose based on naming patterns
generateBusinessPurpose(componentName) {
    const name = componentName.toUpperCase();
    
    // Customer-related
    if (name.includes('CUST') || name.includes('CUSTOMER')) {
        if (name.includes('MASTER') || name.includes('MAST')) {
            return 'Customer Master Data Management';
        } else if (name.includes('TRANS') || name.includes('TXN')) {
            return 'Customer Transaction Processing';
        } else if (name.includes('VALID') || name.includes('CHECK')) {
            return 'Customer Data Validation';
        } else {
            return 'Customer Information Processing';
        }
    }
    
    // Account-related
    else if (name.includes('ACCT') || name.includes('ACCOUNT')) {
        if (name.includes('BAL') || name.includes('BALANCE')) {
            return 'Account Balance Management';
        } else if (name.includes('TRANS') || name.includes('TXN')) {
            return 'Account Transaction Processing';
        } else if (name.includes('MAINT') || name.includes('UPD')) {
            return 'Account Maintenance Operations';
        } else {
            return 'Account Management System';
        }
    }
    
    // Financial/Payment
    else if (name.includes('PAY') || name.includes('PAYMENT')) {
        return 'Payment Processing System';
    } else if (name.includes('INVOICE') || name.includes('INV')) {
        return 'Invoice Management System';
    } else if (name.includes('BILLING') || name.includes('BILL')) {
        return 'Billing Operations System';
    }
    
    // Transaction-related
    else if (name.includes('TRANS') || name.includes('TXN')) {
        if (name.includes('LOG') || name.includes('HIST')) {
            return 'Transaction History & Logging';
        } else if (name.includes('PROC') || name.includes('PROCESS')) {
            return 'Transaction Processing Engine';
        } else {
            return 'Transaction Management System';
        }
    }
    
    // Data management
    else if (name.includes('MASTER') || name.includes('MAST')) {
        return 'Master Data Management';
    } else if (name.includes('COPY') || name.includes('CPY')) {
        return 'Data Structure Definition';
    } else if (name.includes('VALID') || name.includes('CHECK')) {
        return 'Data Validation & Quality Control';
    }
    
    // Reports
    else if (name.includes('REPORT') || name.includes('RPT')) {
        return 'Report Generation System';
    } else if (name.includes('EXTRACT') || name.includes('EXT')) {
        return 'Data Extraction & ETL';
    }
    
    // Maintenance
    else if (name.includes('MAINT') || name.includes('UPD')) {
        return 'Data Maintenance Operations';
    } else if (name.includes('DELETE') || name.includes('DEL')) {
        return 'Data Deletion & Cleanup';
    }
    
    // Generic based on type indicators
    else if (name.includes('PROC') || name.includes('PROCESS')) {
        return 'Business Process Automation';
    } else if (name.includes('UTIL') || name.includes('UTILITY')) {
        return 'System Utility Functions';
    } else if (name.includes('BATCH') || name.includes('JOB')) {
        return 'Batch Processing System';
    } else if (name.includes('ONLINE') || name.includes('CICS')) {
        return 'Online Transaction Processing';
    }
    
    // Fallback based on common patterns
    else if (name.endsWith('-RECORD') || name.endsWith('-REC')) {
        return 'Data Record Structure';
    } else if (name.endsWith('-FILE') || name.endsWith('-FL')) {
        return 'File Management System';
    } else if (name.endsWith('-PROG') || name.endsWith('-PGM')) {
        return 'Business Logic Program';
    } else {
        return 'Mainframe Business Component';
    }
}

// Auto-Discover Components
async autoDiscoverComponents(fileObj) {
    for (const component of fileObj.components) {
        if (component.isMainComponent) {
            const discoveredComponent = {
                name: component.name,
                friendlyName: await this.generateFriendlyName(component.name),
                type: component.type,
                businessPurpose: component.businessPurpose,
                fileSource: fileObj.name,
                lineCount: fileObj.metrics.codeLines,
                complexityScore: fileObj.metrics.complexity,
                inputFiles: this.extractInputFiles(fileObj.content),
                outputFiles: this.extractOutputFiles(fileObj.content),
                fieldCount: fileObj.components.filter(c => c.type === 'FIELD' || c.type === 'RECORD_LAYOUT').length,
                analyzed: false,
                timestamp: new Date().toISOString()
            };
            
            this.discoveredComponents.set(component.name, discoveredComponent);
        }
    }
}

// Extract Input/Output Files
extractInputFiles(content) {
    const files = [];
    const lines = content.split('\n');
    
    lines.forEach(line => {
        const trimmed = line.trim().toUpperCase();
        
        // Look for INPUT file patterns
        const inputPatterns = [
            /SELECT\s+([A-Z][A-Z0-9\-_]+)\s+ASSIGN/,
            /OPEN\s+INPUT\s+([A-Z][A-Z0-9\-_]+)/,
            /READ\s+([A-Z][A-Z0-9\-_]+)/
        ];
        
        for (const pattern of inputPatterns) {
            const match = trimmed.match(pattern);
            if (match && !files.includes(match[1])) {
                files.push(match[1]);
            }
        }
    });
    
    return files.slice(0, 10); // Limit to top 10
}

extractOutputFiles(content) {
    const files = [];
    const lines = content.split('\n');
    
    lines.forEach(line => {
        const trimmed = line.trim().toUpperCase();
        
        // Look for OUTPUT file patterns
        const outputPatterns = [
            /OPEN\s+OUTPUT\s+([A-Z][A-Z0-9\-_]+)/,
            /WRITE\s+([A-Z][A-Z0-9\-_]+)/,
            /DISPLAY\s+.*\s+UPON\s+([A-Z][A-Z0-9\-_]+)/
        ];
        
        for (const pattern of outputPatterns) {
            const match = trimmed.match(pattern);
            if (match && !files.includes(match[1])) {
                files.push(match[1]);
            }
        }
    });
    
    return files.slice(0, 10); // Limit to top 10
}

// Generate Friendly Name using LLM or patterns
async generateFriendlyName(componentName) {
    // Check cache first
    if (this.friendlyNameCache.has(componentName.toUpperCase())) {
        return this.friendlyNameCache.get(componentName.toUpperCase());
    }
    
    // Try LLM generation if available
    if (this.serverValidated) {
        try {
            const prompt = `Generate a business-friendly name for this mainframe component: "${componentName}"

Examples:
- CUST-MASTER → "Customer Master File"
- ACCT-VALIDATE → "Account Validation Program" 
- TRANS-LOG → "Transaction Log Handler"
- PAY-PROCESS → "Payment Processing System"

Return only the friendly name, no explanation.`;

            const response = await this.callLLMAPI(prompt);
            if (response && typeof response === 'string' && response.length < 100) {
                this.friendlyNameCache.set(componentName.toUpperCase(), response.trim());
                return response.trim();
            }
        } catch (error) {
            console.warn('LLM friendly name generation failed:', error);
        }
    }
    
    // Fallback to pattern-based generation
    return this.generateFriendlyNameFromPattern(componentName);
}

// Pattern-based friendly name generation
generateFriendlyNameFromPattern(componentName) {
    const name = componentName.toUpperCase();
    
    // Common mainframe patterns to friendly names
    const patterns = [
        { pattern: /CUST.*MASTER/, replacement: 'Customer Master File' },
        { pattern: /CUST.*MAINT/, replacement: 'Customer Maintenance Program' },
        { pattern: /CUST.*VALID/, replacement: 'Customer Validation Program' },
        { pattern: /ACCT.*MASTER/, replacement: 'Account Master File' },
        { pattern: /ACCT.*TRANS/, replacement: 'Account Transaction Program' },
        { pattern: /ACCT.*BAL/, replacement: 'Account Balance Program' },
        { pattern: /PAY.*PROC/, replacement: 'Payment Processing System' },
        { pattern: /TRANS.*LOG/, replacement: 'Transaction Log Handler' },
        { pattern: /INVOICE.*PROC/, replacement: 'Invoice Processing System' },
        { pattern: /REPORT.*GEN/, replacement: 'Report Generation Program' },
        { pattern: /.*MASTER.*/, replacement: `${name.split('-')[0]} Master Data` },
        { pattern: /.*COPY.*/, replacement: `${name.split('-')[0]} Data Structure` },
        { pattern: /.*VALID.*/, replacement: `${name.split('-')[0]} Validation Program` },
        { pattern: /.*PROC.*/, replacement: `${name.split('-')[0]} Processing System` }
    ];
    
    for (const { pattern, replacement } of patterns) {
        if (pattern.test(name)) {
            return replacement;
        }
    }
    
    // Final fallback
    const parts = name.split('-');
    if (parts.length > 1) {
        return `${parts[0]} ${parts[1]} System`;
    } else {
        return `${name} Component`;
    }
}

// Enable Auto Analysis
enableAutoAnalysis() {
    const autoAnalyzeBtn = document.getElementById('autoAnalyzeBtn');
    if (autoAnalyzeBtn && this.discoveredComponents.size > 0 && this.serverValidated) {
        autoAnalyzeBtn.disabled = false;
    }
}

// Start Auto Analysis
async startAutoAnalysis() {
    if (this.autoAnalysisInProgress) {
        this.showWarning('Auto-analysis already in progress');
        return;
    }
    
    if (this.discoveredComponents.size === 0) {
        this.showError('No components discovered for analysis');
        return;
    }
    
    this.autoAnalysisInProgress = true;
    this.showLoading();
    this.updateLoadingStatus('🚀 Starting auto-analysis of discovered components...');
    
    try {
        const components = Array.from(this.discoveredComponents.values())
            .filter(comp => !comp.analyzed)
            .slice(0, 8); // Limit to 8 components for performance
        
        let completed = 0;
        
        for (const component of components) {
            try {
                this.updateLoadingStatus(`Analyzing ${component.friendlyName || component.name} (${completed + 1}/${components.length})...`);
                this.updateProgress((completed / components.length) * 100);
                
                const relevantFiles = this.findRelevantFiles(component.name);
                const analysisResult = await this.runComponentAnalysis(component.name, relevantFiles);
                
                this.analysisResults[component.name] = analysisResult;
                component.analyzed = true;
                component.qualityScore = analysisResult.qualityScore;
                
                completed++;
                
                // Brief pause between analyses
                await this.sleep(1000);
                
            } catch (error) {
                console.warn(`Failed to analyze ${component.name}:`, error);
                component.analyzed = false;
            }
        }
        
        this.hideLoading();
        this.updateDashboardWithResults();
        this.enableChat();
        this.saveToStorage();
        
        this.showSuccess(`✨ Auto-analysis complete! ${completed}/${components.length} components analyzed`);
        
        // Switch to dashboard to show results
        document.querySelector('.tab[data-tab="dashboard"]').click();
        
    } catch (error) {
        this.hideLoading();
        this.showError(`Auto-analysis failed: ${error.message}`);
    } finally {
        this.autoAnalysisInProgress = false;
    }
}

// Find Relevant Files for Component
findRelevantFiles(componentName) {
    const componentUpper = componentName.toUpperCase();
    const componentBase = componentUpper.replace(/\.(CPY|COPYBOOK|COP)$/, '');
    
    return this.uploadedFiles.filter(file => {
        const fileNameUpper = file.name.toUpperCase();
        const fileNameBase = fileNameUpper.replace(/\.(CPY|COPYBOOK|COP)$/, '');
        
        // Direct name match
        if (fileNameUpper.includes(componentUpper) || 
            fileNameBase === componentBase ||
            componentBase === fileNameBase) {
            return true;
        }
        
        // Content-based matching
        const contentUpper = file.content.toUpperCase();
        if (contentUpper.includes(componentUpper) ||
            contentUpper.includes(componentBase) ||
            contentUpper.includes(`COPY ${componentBase}`) ||
            contentUpper.includes(`"${componentBase}"`) ||
            contentUpper.includes(`'${componentBase}'`)) {
            return true;
        }
        
        // Component-based matching
        if (file.components) {
            return file.components.some(comp => {
                const compNameUpper = comp.name.toUpperCase();
                const compNameBase = compNameUpper.replace(/\.(CPY|COPYBOOK|COP)$/, '');
                return compNameUpper === componentUpper || 
                       compNameBase === componentBase ||
                       componentBase === compNameBase;
            });
        }
        
        return false;
    });
}

// Run Component Analysis (simplified for auto-analysis)
async runComponentAnalysis(componentName, relevantFiles) {
    console.log(`Running analysis for: ${componentName}`);
    
    const component = this.discoveredComponents.get(componentName);
    const friendlyName = component?.friendlyName || componentName;
    
    try {
        // Stage 1: Basic component analysis
        const componentType = this.detectComponentType(componentName, relevantFiles);
        
        // Stage 2: Extract dependencies
        const dependencyAnalysis = await this.extractDependencies(relevantFiles);
        
        // Stage 3: Field analysis (for copybooks)
        let fieldAnalysis = null;
        if (componentType === 'Copybook' || componentType === 'RECORD_LAYOUT') {
            fieldAnalysis = await this.analyzeFieldsInComponent(componentName, relevantFiles);
        }
        
        // Stage 4: LLM-enhanced analysis
        let llmAnalysis = null;
        try {
            llmAnalysis = await this.getBusinessIntelligenceFromLLM(
                componentName, friendlyName, componentType, relevantFiles, dependencyAnalysis, fieldAnalysis
            );
        } catch (llmError) {
            console.warn('LLM analysis failed:', llmError);
            llmAnalysis = {
                error: true,
                message: llmError.message,
                businessPurpose: component?.businessPurpose || 'Business purpose analysis failed',
                recommendations: ['Check LLM server connection', 'Verify component data', 'Try manual analysis']
            };
        }
        
        const results = {
            componentName: componentName,
            friendlyName: friendlyName,
            timestamp: new Date().toISOString(),
            filesAnalyzed: relevantFiles.map(f => f.name),
            componentType: componentType,
            dependencyAnalysis: dependencyAnalysis,
            fieldAnalysis: fieldAnalysis,
            llmAnalysis: llmAnalysis,
            totalFields: fieldAnalysis?.fields?.length || 0,
            qualityScore: this.calculateQualityScore(llmAnalysis, fieldAnalysis),
            analysisMethod: 'Auto-Discovery-Enhanced'
        };
        
        return results;
        
    } catch (error) {
        console.error(`Analysis failed for ${componentName}:`, error);
        throw new Error(`Analysis failed: ${error.message}`);
    }
}

// Utility function
sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
// ============================================
// PART 4: DASHBOARD DISPLAY AND UI UPDATE FUNCTIONS
// Component discovery display, dashboard updates, and user interface
// ============================================

// Update Dashboard Statistics
updateDashboardStats() {
    const components = this.discoveredComponents.size;
    const programs = Array.from(this.discoveredComponents.values()).filter(c => c.type === 'PROGRAM').length;
    const copybooks = Array.from(this.discoveredComponents.values()).filter(c => c.type === 'RECORD_LAYOUT').length;
    const totalFields = Array.from(this.discoveredComponents.values()).reduce((sum, c) => sum + (c.fieldCount || 0), 0);
    
    // Update header stats
    document.getElementById('headerComponents').textContent = components;
    document.getElementById('headerPrograms').textContent = programs;
    document.getElementById('headerCopybooks').textContent = copybooks;
    document.getElementById('headerFields').textContent = totalFields;
    
    // Update dashboard overview card
    document.getElementById('dashTotalComponents').textContent = components;
    document.getElementById('dashTotalFiles').textContent = this.uploadedFiles.length;
    document.getElementById('dashTotalFields').textContent = totalFields;
    
    // Calculate average quality score
    const analyzedComponents = Array.from(this.discoveredComponents.values()).filter(c => c.analyzed && c.qualityScore);
    const avgQuality = analyzedComponents.length > 0 
        ? Math.round(analyzedComponents.reduce((sum, c) => sum + c.qualityScore, 0) / analyzedComponents.length)
        : '-';
    document.getElementById('dashQualityScore').textContent = avgQuality;
    
    // Update component counts in left panel
    document.getElementById('componentCount').textContent = components;
    document.getElementById('programCount').textContent = programs;
    document.getElementById('copybookCount').textContent = copybooks;
    document.getElementById('fileCount').textContent = this.uploadedFiles.length;
}

// Display Discovered Components in Left Panel
displayDiscoveredComponents() {
    this.displayComponentsByType('componentsList', Array.from(this.discoveredComponents.values()));
    this.displayComponentsByType('programsList', Array.from(this.discoveredComponents.values()).filter(c => c.type === 'PROGRAM'));
    this.displayComponentsByType('copybooksList', Array.from(this.discoveredComponents.values()).filter(c => c.type === 'RECORD_LAYOUT'));
    this.displayComponentsByType('filesList', this.uploadedFiles);
}

// Display Components by Type
displayComponentsByType(containerId, items) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (items.length === 0) {
        container.innerHTML = '<p style="color: var(--grey-500); text-align: center;">No items discovered yet</p>';
        return;
    }
    
    let html = '';
    
    items.forEach(item => {
        const isComponent = item.type !== undefined && item.name;
        const isFile = !isComponent;
        
        if (isComponent) {
            const statusColor = item.analyzed ? 'var(--success-green)' : 'var(--grey-400)';
            const statusIcon = item.analyzed ? '✅' : '⏳';
            
            html += `
                <div class="component-card ${item.name === this.currentSelectedComponent ? 'selected' : ''}" 
                     onclick="analyzer.selectComponent('${item.name}')"
                     data-component="${item.name}">
                    <div class="component-card-header">
                        <div class="component-card-icon ${item.type.toLowerCase()}">
                            ${this.getComponentIcon(item.type)}
                        </div>
                        <div class="component-card-info">
                            <div class="component-card-name">${item.name}</div>
                            <div class="component-card-friendly">${item.friendlyName || item.name}</div>
                            <div class="component-card-description">${item.businessPurpose || 'Business purpose analysis pending'}</div>
                        </div>
                    </div>
                    <div class="component-card-metrics">
                        <div class="component-metric">
                            <span class="component-metric-icon">📏</span>
                            <span>${item.lineCount || 0} lines</span>
                        </div>
                        <div class="component-metric">
                            <span class="component-metric-icon">🧩</span>
                            <span>Complex: ${item.complexityScore || 1}</span>
                        </div>
                        <div class="component-metric">
                            <span class="component-metric-icon">📋</span>
                            <span>${item.fieldCount || 0} fields</span>
                        </div>
                        <div class="component-metric">
                            <span class="component-metric-icon" style="color: ${statusColor};">${statusIcon}</span>
                            <span style="color: ${statusColor};">${item.analyzed ? 'Analyzed' : 'Pending'}</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // File display
            html += `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">${this.getFileIcon(item.type)}</div>
                        <div class="file-details">
                            <div class="file-name">${item.name}</div>
                            <div class="file-meta">
                                ${item.type} • ${Math.round(item.size/1024)}KB
                                ${item.components ? ` • ${item.components.length} components` : ''}
                            </div>
                        </div>
                    </div>
                    <button class="file-remove" onclick="analyzer.removeFile('${item.id}')">×</button>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

// Get Component Icon
getComponentIcon(type) {
    const icons = {
        'PROGRAM': '💼',
        'RECORD_LAYOUT': '📚',
        'COPYBOOK': '📚',
        'FIELD': '📋',
        'FILE': '📁'
    };
    return icons[type] || '📄';
}

// Get File Icon
getFileIcon(type) {
    const icons = {
        'Copybook': '📚',
        'COBOL Program': '💼',
        'JCL Job': '📋',
        'JCL Procedure': '⚙️',
        'Text File': '📄'
    };
    return icons[type] || '📁';
}

// Select Component
selectComponent(componentName) {
    this.currentSelectedComponent = componentName;
    
    // Update UI selection
    document.querySelectorAll('.component-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    const selectedCard = document.querySelector(`[data-component="${componentName}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
    
    // Update chat context
    this.updateChatContext('component', componentName);
    
    // Show field matrix for selected component if analyzed
    if (this.analysisResults[componentName]) {
        this.displayFieldMatrix(componentName);
        
        // Switch to field matrix tab
        document.querySelector('.tab[data-tab="fieldmatrix"]').click();
    } else {
        // Show message that analysis is needed
        document.getElementById('fieldMatrixContent').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--grey-500);">
                <h4>Component Analysis Required</h4>
                <p>The component "${componentName}" needs to be analyzed first.</p>
                <p>Run auto-analysis to see detailed field matrix information.</p>
            </div>
        `;
    }
    
    this.showInfo(`Selected component: ${this.getDisplayName(componentName)}`);
}

// Get Display Name (friendly name if available)
getDisplayName(componentName) {
    const component = this.discoveredComponents.get(componentName);
    return component?.friendlyName || componentName;
}

// Update Dashboard with Analysis Results
updateDashboardWithResults() {
    this.updateDashboardStats();
    this.displayProgramsOverview();
    this.displayCopybooksOverview();
    this.displayDependenciesSummary();
    this.displayFieldStatisticsSummary();
    this.displayBusinessLogicSummary();
    
    // Enable export buttons
    document.getElementById('exportJsonBtn').disabled = false;
    document.getElementById('exportMdBtn').disabled = false;
}

// Display Programs Overview
displayProgramsOverview() {
    const container = document.getElementById('programsOverview');
    if (!container) return;
    
    const programs = Array.from(this.discoveredComponents.values()).filter(c => c.type === 'PROGRAM');
    
    if (programs.length === 0) {
        container.innerHTML = '<p style="color: var(--grey-500); text-align: center;">No programs discovered</p>';
        return;
    }
    
    let html = `
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">💼</div>
                <div class="metric-details">
                    <div class="metric-label">Total Programs</div>
                    <div class="metric-value">${programs.length}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">✅</div>
                <div class="metric-details">
                    <div class="metric-label">Analyzed</div>
                    <div class="metric-value">${programs.filter(p => p.analyzed).length}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📏</div>
                <div class="metric-details">
                    <div class="metric-label">Avg Lines</div>
                    <div class="metric-value">${Math.round(programs.reduce((sum, p) => sum + (p.lineCount || 0), 0) / programs.length)}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">🧩</div>
                <div class="metric-details">
                    <div class="metric-label">Avg Complexity</div>
                    <div class="metric-value">${Math.round(programs.reduce((sum, p) => sum + (p.complexityScore || 1), 0) / programs.length)}</div>
                </div>
            </div>
        </div>
    `;
    
    // Add program list
    html += '<h5>Program List</h5>';
    html += '<div class="data-table"><table><thead><tr><th>Program Name</th><th>Friendly Name</th><th>Business Purpose</th><th>Lines</th><th>Complexity</th><th>Status</th></tr></thead><tbody>';
    
    programs.forEach(program => {
        const analysisResult = this.analysisResults[program.name];
        const statusBadge = program.analyzed 
            ? `<span class="badge badge-success">✅ Analyzed</span>`
            : `<span class="badge badge-warning">⏳ Pending</span>`;
        
        html += `
            <tr onclick="analyzer.selectComponent('${program.name}')" style="cursor: pointer;">
                <td style="font-family: monospace; font-weight: 600;">${program.name}</td>
                <td>${program.friendlyName || program.name}</td>
                <td style="font-size: 0.85rem;">${program.businessPurpose || 'Pending analysis'}</td>
                <td>${program.lineCount || 0}</td>
                <td><span class="badge badge-info">${program.complexityScore || 1}</span></td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Display Copybooks Overview
displayCopybooksOverview() {
    const container = document.getElementById('copybooksOverview');
    if (!container) return;
    
    const copybooks = Array.from(this.discoveredComponents.values()).filter(c => c.type === 'RECORD_LAYOUT');
    
    if (copybooks.length === 0) {
        container.innerHTML = '<p style="color: var(--grey-500); text-align: center;">No copybooks discovered</p>';
        return;
    }
    
    let html = `
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">📚</div>
                <div class="metric-details">
                    <div class="metric-label">Total Copybooks</div>
                    <div class="metric-value">${copybooks.length}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">✅</div>
                <div class="metric-details">
                    <div class="metric-label">Analyzed</div>
                    <div class="metric-value">${copybooks.filter(c => c.analyzed).length}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📋</div>
                <div class="metric-details">
                    <div class="metric-label">Total Fields</div>
                    <div class="metric-value">${copybooks.reduce((sum, c) => sum + (c.fieldCount || 0), 0)}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📊</div>
                <div class="metric-details">
                    <div class="metric-label">Avg Fields/Copy</div>
                    <div class="metric-value">${Math.round(copybooks.reduce((sum, c) => sum + (c.fieldCount || 0), 0) / copybooks.length)}</div>
                </div>
            </div>
        </div>
    `;
    
    // Add copybook list
    html += '<h5>Copybook List</h5>';
    html += '<div class="data-table"><table><thead><tr><th>Copybook Name</th><th>Friendly Name</th><th>Business Purpose</th><th>Fields</th><th>Lines</th><th>Status</th></tr></thead><tbody>';
    
    copybooks.forEach(copybook => {
        const statusBadge = copybook.analyzed 
            ? `<span class="badge badge-success">✅ Analyzed</span>`
            : `<span class="badge badge-warning">⏳ Pending</span>`;
        
        html += `
            <tr onclick="analyzer.selectComponent('${copybook.name}')" style="cursor: pointer;">
                <td style="font-family: monospace; font-weight: 600;">${copybook.name}</td>
                <td>${copybook.friendlyName || copybook.name}</td>
                <td style="font-size: 0.85rem;">${copybook.businessPurpose || 'Pending analysis'}</td>
                <td><span class="badge badge-primary">${copybook.fieldCount || 0}</span></td>
                <td>${copybook.lineCount || 0}</td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Display Dependencies Summary
displayDependenciesSummary() {
    const container = document.getElementById('dependenciesSummary');
    if (!container) return;
    
    const analyzedComponents = Object.values(this.analysisResults);
    
    if (analyzedComponents.length === 0) {
        container.innerHTML = '<p style="color: var(--grey-500); text-align: center;">No dependency analysis available yet</p>';
        return;
    }
    
    let totalFound = 0;
    let totalMissing = 0;
    let totalCopybooks = 0;
    let totalPrograms = 0;
    
    analyzedComponents.forEach(result => {
        if (result.dependencyAnalysis) {
            totalFound += result.dependencyAnalysis.summary?.foundCount || 0;
            totalMissing += result.dependencyAnalysis.summary?.missingCount || 0;
            totalCopybooks += result.dependencyAnalysis.found?.copybooks?.length || 0;
            totalPrograms += result.dependencyAnalysis.found?.programs?.length || 0;
        }
    });
    
    let html = `
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">✅</div>
                <div class="metric-details">
                    <div class="metric-label">Found Dependencies</div>
                    <div class="metric-value">${totalFound}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">❌</div>
                <div class="metric-details">
                    <div class="metric-label">Missing Dependencies</div>
                    <div class="metric-value">${totalMissing}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📚</div>
                <div class="metric-details">
                    <div class="metric-label">Copybook Refs</div>
                    <div class="metric-value">${totalCopybooks}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">💼</div>
                <div class="metric-details">
                    <div class="metric-label">Program Calls</div>
                    <div class="metric-value">${totalPrograms}</div>
                </div>
            </div>
        </div>
    `;
    
    // Add dependency health indicator
    const healthPercentage = totalFound + totalMissing > 0 ? Math.round((totalFound / (totalFound + totalMissing)) * 100) : 100;
    const healthColor = healthPercentage >= 80 ? 'var(--success-green)' : healthPercentage >= 60 ? 'var(--warning-yellow)' : 'var(--error-red)';
    
    html += `
        <div style="margin-top: 1rem; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
            <h5>Dependency Health</h5>
            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                <div style="flex: 1;">
                    <div class="progress-bar">
                        <div class="progress-fill primary" style="width: ${healthPercentage}%; background: ${healthColor};"></div>
                    </div>
                </div>
                <div style="font-weight: 600; color: ${healthColor};">${healthPercentage}%</div>
            </div>
            <p style="font-size: 0.85rem; color: var(--grey-600); margin-top: 0.5rem;">
                ${healthPercentage >= 80 ? '🟢 Excellent dependency health' : 
                  healthPercentage >= 60 ? '🟡 Some missing dependencies detected' : 
                  '🔴 Critical missing dependencies - review required'}
            </p>
        </div>
    `;
    
    container.innerHTML = html;
}

// Display Field Statistics Summary
displayFieldStatisticsSummary() {
    const container = document.getElementById('fieldStatistics');
    if (!container) return;
    
    const analyzedComponents = Object.values(this.analysisResults);
    const copybookResults = analyzedComponents.filter(r => r.fieldAnalysis);
    
    if (copybookResults.length === 0) {
        container.innerHTML = '<p style="color: var(--grey-500); text-align: center;">No field analysis available yet</p>';
        return;
    }
    
    let totalFields = 0;
    let totalInput = 0;
    let totalOutput = 0;
    let totalUnused = 0;
    
    copybookResults.forEach(result => {
        if (result.fieldAnalysis) {
            totalFields += result.fieldAnalysis.fields?.length || 0;
            totalInput += result.fieldAnalysis.inputFields?.length || 0;
            totalOutput += result.fieldAnalysis.outputFields?.length || 0;
            totalUnused += result.fieldAnalysis.unusedFields?.length || 0;
        }
    });
    
    let html = `
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">📋</div>
                <div class="metric-details">
                    <div class="metric-label">Total Fields</div>
                    <div class="metric-value">${totalFields}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📥</div>
                <div class="metric-details">
                    <div class="metric-label">Input Fields</div>
                    <div class="metric-value">${totalInput}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📤</div>
                <div class="metric-details">
                    <div class="metric-label">Output Fields</div>
                    <div class="metric-value">${totalOutput}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">⚠️</div>
                <div class="metric-details">
                    <div class="metric-label">Unused Fields</div>
                    <div class="metric-value">${totalUnused}</div>
                </div>
            </div>
        </div>
    `;
    
    // Add usage distribution chart
    if (totalFields > 0) {
        const inputPct = Math.round((totalInput / totalFields) * 100);
        const outputPct = Math.round((totalOutput / totalFields) * 100);
        const unusedPct = Math.round((totalUnused / totalFields) * 100);
        
        html += `
            <div style="margin-top: 1rem;">
                <h5>Field Usage Distribution</h5>
                <div style="margin-top: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span>Input Fields</span>
                        <span>${inputPct}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill success" style="width: ${inputPct}%;"></div>
                    </div>
                </div>
                <div style="margin-top: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span>Output Fields</span>
                        <span>${outputPct}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill primary" style="width: ${outputPct}%;"></div>
                    </div>
                </div>
                <div style="margin-top: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span>Unused Fields</span>
                        <span>${unusedPct}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill danger" style="width: ${unusedPct}%;"></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Display Business Logic Summary
displayBusinessLogicSummary() {
    const container = document.getElementById('businessLogicSummary');
    if (!container) return;
    
    const analyzedComponents = Object.values(this.analysisResults);
    
    if (analyzedComponents.length === 0) {
        container.innerHTML = '<p style="color: var(--grey-500); text-align: center;">No business logic analysis available yet</p>';
        return;
    }
    
    let totalValidations = 0;
    let totalCalculations = 0;
    let totalBusinessRules = 0;
    let componentsWithLogic = 0;
    
    analyzedComponents.forEach(result => {
        if (result.fieldAnalysis?.businessLogicSummary) {
            totalValidations += result.fieldAnalysis.businessLogicSummary.totalValidationRules || 0;
            totalCalculations += result.fieldAnalysis.businessLogicSummary.totalCalculations || 0;
            componentsWithLogic += result.fieldAnalysis.businessLogicSummary.fieldsWithBusinessLogic || 0;
        }
        
        if (result.llmAnalysis?.businessLogic?.businessRules) {
            totalBusinessRules += result.llmAnalysis.businessLogic.businessRules.length;
        }
    });
    
    let html = `
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">⚖️</div>
                <div class="metric-details">
                    <div class="metric-label">Validation Rules</div>
                    <div class="metric-value">${totalValidations}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">🧮</div>
                <div class="metric-details">
                    <div class="metric-label">Calculations</div>
                    <div class="metric-value">${totalCalculations}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📋</div>
                <div class="metric-details">
                    <div class="metric-label">Business Rules</div>
                    <div class="metric-value">${totalBusinessRules}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">🎯</div>
                <div class="metric-details">
                    <div class="metric-label">Fields w/ Logic</div>
                    <div class="metric-value">${componentsWithLogic}</div>
                </div>
            </div>
        </div>
    `;
    
    // Add business logic insights
    const totalLogicItems = totalValidations + totalCalculations + totalBusinessRules;
    const logicDensity = analyzedComponents.length > 0 ? Math.round(totalLogicItems / analyzedComponents.length) : 0;
    
    html += `
        <div style="margin-top: 1rem; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
            <h5>Business Logic Insights</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.75rem;">
                <div>
                    <div style="font-size: 0.85rem; color: var(--grey-600);">Logic Density</div>
                    <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary-blue);">${logicDensity} items/component</div>
                </div>
                <div>
                    <div style="font-size: 0.85rem; color: var(--grey-600);">Total Logic Items</div>
                    <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary-blue);">${totalLogicItems}</div>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: var(--grey-600); margin-top: 0.75rem;">
                ${logicDensity >= 5 ? '🟢 Rich business logic detected - good for analysis' : 
                  logicDensity >= 2 ? '🟡 Moderate business logic - room for enhancement' : 
                  '🔴 Limited business logic detected - consider deeper analysis'}
            </p>
        </div>
    `;
    
    container.innerHTML = html;
}

// Display Field Matrix for Selected Component
displayFieldMatrix(componentName) {
    const container = document.getElementById('fieldMatrixContent');
    if (!container) return;
    
    const analysisResult = this.analysisResults[componentName];
    const component = this.discoveredComponents.get(componentName);
    const displayName = component?.friendlyName || componentName;
    
    if (!analysisResult || !analysisResult.fieldAnalysis) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--grey-500);">
                <h4>Field Analysis Not Available</h4>
                <p>Component "${displayName}" either hasn't been analyzed or doesn't contain field data.</p>
            </div>
        `;
        return;
    }
    
    const fieldAnalysis = analysisResult.fieldAnalysis;
    
    let html = `
        <h4>Field Matrix Analysis for ${displayName}</h4>
        
        <!-- Field Overview Metrics -->
        <div class="metrics-grid" style="margin-bottom: 1.5rem;">
            <div class="metric-card">
                <div class="metric-icon">📋</div>
                <div class="metric-details">
                    <div class="metric-label">Total Fields</div>
                    <div class="metric-value">${fieldAnalysis.fields?.length || 0}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📥</div>
                <div class="metric-details">
                    <div class="metric-label">Input Fields</div>
                    <div class="metric-value">${fieldAnalysis.inputFields?.length || 0}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">📤</div>
                <div class="metric-details">
                    <div class="metric-label">Output Fields</div>
                    <div class="metric-value">${fieldAnalysis.outputFields?.length || 0}</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">⚠️</div>
                <div class="metric-details">
                    <div class="metric-label">Unused Fields</div>
                    <div class="metric-value">${fieldAnalysis.unusedFields?.length || 0}</div>
                </div>
            </div>
        </div>
    `;
    
    if (fieldAnalysis.fields && fieldAnalysis.fields.length > 0) {
        html += `
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Field Name</th>
                            <th>Level</th>
                            <th>Picture</th>
                            <th>Usage Pattern</th>
                            <th>Business Purpose</th>
                            <th>Operations</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        fieldAnalysis.fields.slice(0, 50).forEach(field => {
            const usage = this.determineFieldUsage(field, fieldAnalysis);
            const badgeClass = this.getUsageBadgeClass(usage);
            const usageDetails = fieldAnalysis.fieldUsageDetails?.[field.name];
            const operationCount = usageDetails?.operations?.length || 0;
            const businessPurpose = field.businessLogic?.businessMeaning || this.generateFieldPurpose(field.name);
            
            html += `
                <tr onclick="analyzer.updateChatContext('field', '${field.name}')" style="cursor: pointer;">
                    <td style="font-family: monospace; font-weight: 600;">${field.name}</td>
                    <td><span class="badge badge-grey">${field.level}</span></td>
                    <td style="font-family: monospace;">${field.picture || '-'}</td>
                    <td><span class="badge ${badgeClass}">${usage}</span></td>
                    <td style="font-size: 0.85rem; max-width: 200px;">${businessPurpose}</td>
                    <td>
                        ${operationCount > 0 ? `<span class="badge badge-primary">${operationCount} ops</span>` : `<span class="badge badge-grey">No ops</span>`}
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        if (fieldAnalysis.fields.length > 50) {
            html += `<p style="margin-top: 1rem; color: var(--grey-500);">Showing 50 of ${fieldAnalysis.fields.length} fields</p>`;
        }
    } else {
        html += '<p style="color: var(--grey-500); text-align: center;">No fields found for analysis</p>';
    }
    
    container.innerHTML = html;
}

// Determine Field Usage
determineFieldUsage(field, fieldAnalysis) {
    const fieldName = field.name;
    
    if (fieldAnalysis.inputFields && fieldAnalysis.inputFields.includes(fieldName)) return 'INPUT';
    if (fieldAnalysis.outputFields && fieldAnalysis.outputFields.includes(fieldName)) return 'OUTPUT';
    if (fieldAnalysis.referenceFields && fieldAnalysis.referenceFields.includes(fieldName)) return 'REFERENCE';
    if (fieldAnalysis.unusedFields && fieldAnalysis.unusedFields.includes(fieldName)) return 'UNUSED';
    
    return 'UNKNOWN';
}

// Get Usage Badge Class
getUsageBadgeClass(usage) {
    switch(usage) {
        case 'INPUT': return 'badge-success';
        case 'OUTPUT': return 'badge-primary';
        case 'REFERENCE': return 'badge-warning';
        case 'UNUSED': return 'badge-danger';
        default: return 'badge-grey';
    }
}

// Generate Field Purpose
generateFieldPurpose(fieldName) {
    const name = fieldName.toUpperCase();
    
    if (name.includes('RECORD') || name.includes('REC')) {
        return `Main record structure for ${fieldName.toLowerCase().replace(/-/g, ' ')} data`;
    } else if (name.includes('ID') || name.includes('KEY')) {
        return `Unique identifier for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
    } else if (name.includes('DATE') || name.includes('TIME')) {
        return `Date/time field for ${fieldName.toLowerCase().replace(/-/g, ' ')} tracking`;
    } else if (name.includes('AMT') || name.includes('AMOUNT')) {
        return `Monetary amount for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
    } else if (name.includes('DESC') || name.includes('NAME')) {
        return `Descriptive text for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
    } else if (name.includes('FLAG') || name.includes('IND')) {
        return `Status indicator for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
    } else if (name.includes('CODE') || name.includes('CD')) {
        return `Coded value for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
    } else if (name.includes('COUNT') || name.includes('CNT')) {
        return `Counter/number field for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
    } else {
        return `Business data field for ${fieldName.toLowerCase().replace(/-/g, ' ')} processing`;
    }
}

// Remove File
removeFile(fileId) {
    this.uploadedFiles = this.uploadedFiles.filter(f => f.id != fileId);
    
    // Remove associated components
    this.uploadedFiles.forEach(file => {
        if (file.id === fileId && file.components) {
            file.components.forEach(comp => {
                if (comp.isMainComponent) {
                    this.discoveredComponents.delete(comp.name);
                    delete this.analysisResults[comp.name];
                }
            });
        }
    });
    
    this.updateDashboardStats();
    this.displayDiscoveredComponents();
    this.saveToStorage();
    this.showInfo('File removed and components updated');
}

// Settings Change Handlers
onEndpointChange() {
    this.serverValidated = false;
    this.updateConnectionStatus('disconnected', 'Connection not validated');
}

onSettingsChange() {
    const maxTokensInput = document.getElementById('maxTokens');
    if (maxTokensInput) {
        this.maxTokens = parseInt(maxTokensInput.value) || 4000;
        this.saveToStorage();
    }
}
        }

        // Initialize analyzer on page load
        let analyzer;
        document.addEventListener('DOMContentLoaded', function() {
            analyzer = new EnhancedMainframeAnalyzer();
            console.log('✅ Enhanced Mainframe Analyzer - Dashboard Edition Ready!');
        });
    </script>
</body>
</html>