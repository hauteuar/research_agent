
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Mainframe Analyzer</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e293b;
        min-height: 100vh;
        position: relative;
    }

    .container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
    }

    /* Header Styles */
    .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
        border-radius: 16px;
        border: 2px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
        font-size: 2.8rem;
        margin-bottom: 12px;
        font-weight: 700;
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 25%, #06b6d4 50%, #0891b2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
    }

    .header p {
        color: #64748b;
        font-size: 1.1rem;
        font-weight: 500;
    }

    /* Main Grid Layout */
    .main-grid {
        display: grid;
        grid-template-columns: 400px 1fr 450px;
        gap: 25px;
        min-height: calc(100vh - 200px);
    }

    /* Panel Base Styles */
    .panel {
        background: #ffffff;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    /* Panel Header Styles */
    .panel-header {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        padding: 16px 20px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .panel-header:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
    }

    .panel-header.secondary {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }

    .panel-header.secondary:hover {
        background: linear-gradient(135deg, #475569 0%, #334155 100%);
    }

    .panel-toggle {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .panel-toggle.collapsed {
        transform: rotate(-90deg);
    }

    /* Panel Content */
    .panel-content {
        padding: 20px;
        overflow-y: auto;
        transition: all 0.3s ease;
    }

    .panel-content.collapsed {
        display: none;
    }

    /* Left Panel (Control Panel) */
    .control-panel {
        max-height: calc(100vh - 200px);
    }

    .control-panel .panel-content {
        max-height: calc(100vh - 280px);
    }

    /* Chat Panel */
    .chat-panel {
        display: flex;
        flex-direction: column;
    }

    .chat-panel .panel-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 280px);
        padding: 0;
    }

    /* Analysis Workspace */
    .analysis-workspace {
        display: flex;
        flex-direction: column;
    }

    .analysis-workspace .panel-content {
        flex: 1;
        height: calc(100vh - 280px);
    }

    /* Section Styles */
    .section {
        margin-bottom: 25px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .section-header {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        padding: 12px 16px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: between;
        align-items: center;
        font-weight: 600;
        color: #475569;
        border-bottom: 1px solid #e2e8f0;
    }

    .section-header:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
    }

    .section-content {
        padding: 16px;
        transition: all 0.3s ease;
    }

    .section-content.collapsed {
        display: none;
    }

    .section-title {
        color: #1e40af;
        font-size: 1.2rem;
        margin-bottom: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: #ffffff;
        color: #1f2937;
        font-size: 14px;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background: #fefefe;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
        color: #9ca3af;
    }

    /* Button Styles */
    .btn {
        display: inline-block;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        user-select: none;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-success:hover:not(:disabled) {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: white;
    }

    .btn-secondary:hover:not(:disabled) {
        background: linear-gradient(135deg, #475569 0%, #334155 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(100, 116, 139, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-danger:hover:not(:disabled) {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-full {
        width: 100%;
        margin-bottom: 12px;
    }

    /* API Status */
    .api-status {
        padding: 12px 16px;
        border-radius: 8px;
        margin-top: 12px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        border: 2px solid;
    }

    .api-status.connected {
        background: #f0fdf4;
        border-color: #16a34a;
        color: #166534;
    }

    .api-status.connecting {
        background: #fffbeb;
        border-color: #d97706;
        color: #92400e;
    }

    .api-status.disconnected {
        background: #fef2f2;
        border-color: #dc2626;
        color: #991b1b;
    }

    /* Component Suggestions */
    .component-suggestions {
        background: #ffffff;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 100;
        position: relative;
    }

    .suggestion-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.2s ease;
        font-size: 13px;
    }

    .suggestion-item:hover {
        background: #f8fafc;
        border-left: 3px solid #3b82f6;
        transform: translateX(2px);
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    /* Token Management */
    .token-info {
        background: #fffbeb;
        border: 2px solid #f59e0b;
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
        font-size: 12px;
    }

    .token-bar {
        background: #f3f4f6;
        height: 8px;
        border-radius: 4px;
        margin: 8px 0;
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }

    .token-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 4px;
    }

    .token-fill.safe {
        background: linear-gradient(90deg, #10b981, #059669);
    }

    .token-fill.warning {
        background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .token-fill.danger {
        background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    /* Upload Area */
    .upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 16px;
        background: #f8fafc;
    }

    .upload-area:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-2px);
    }

    .upload-area.drag-over {
        border-color: #10b981;
        background: #f0fdf4;
        transform: scale(1.02);
    }

    .upload-area h3 {
        color: #1e40af;
        margin-bottom: 8px;
        font-size: 1.2rem;
    }

    .upload-area p {
        color: #64748b;
        font-size: 14px;
    }

    /* File List */
    .file-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .file-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 2px;
    }

    .file-details {
        font-size: 11px;
        color: #64748b;
    }

    .file-remove {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .file-remove:hover {
        background: #dc2626;
    }

    /* Responsive Design */
    @media (max-width: 1400px) {
        .main-grid {
            grid-template-columns: 350px 1fr 400px;
        }
    }

    @media (max-width: 1200px) {
        .main-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .control-panel,
        .analysis-workspace,
        .chat-panel {
            max-height: none;
        }
        
        .panel-content {
            max-height: none;
        }
    }

    /* Loading Indicator */
    .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
    }

    .loading.show {
        display: flex;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading h3 {
        color: #1e40af;
        margin-bottom: 10px;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .loading p {
        color: #64748b;
        text-align: center;
        max-width: 400px;
        font-size: 1rem;
    }

    /* Message Types */
    .message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 14px 20px;
        border-radius: 8px;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .message.error {
        background: #fef2f2;
        color: #991b1b;
        border: 2px solid #fecaca;
    }

    .message.success {
        background: #f0fdf4;
        color: #166534;
        border: 2px solid #bbf7d0;
    }

    .message.warning {
        background: #fffbeb;
        color: #92400e;
        border: 2px solid #fed7aa;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-primary { color: #1e40af; }
    .text-success { color: #059669; }
    .text-danger { color: #dc2626; }
    .text-muted { color: #64748b; }
    .font-mono { font-family: 'Courier New', monospace; }
    .font-bold { font-weight: 600; }
    .mb-2 { margin-bottom: 8px; }
    .mb-3 { margin-bottom: 12px; }
    .mb-4 { margin-bottom: 16px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
</style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🔬 Enhanced Code Analyzer</h1>
            <p>Advanced mainframe analysis with LLM-powered field flow tracking and business rules</p>
        </div>
        <!-- Main Grid Layout -->
    <div class="main-grid">
        <!-- Left Panel: Control Panel -->
        <div class="control-panel panel">
            <div class="panel-header" onclick="togglePanel('control')">
                <span>🎛️ Control Panel</span>
                <span class="panel-toggle" id="control-toggle">▼</span>
            </div>
            <div class="panel-content" id="control-content">
            </div>
        </div>

        <!-- Center Panel: Analysis Workspace -->
        <div class="analysis-workspace panel">
            <div class="panel-header" onclick="togglePanel('analysis')">
                <span>📊 Analysis Results</span>
                <span class="panel-toggle" id="analysis-toggle">▼</span>
            </div>
            <div class="panel-content" id="analysis-content">
            </div>
        </div>

        <!-- Right Panel: Chat Panel -->
        <div class="chat-panel panel">
            <div class="panel-header" onclick="togglePanel('chat')">
                <span>💬 AI Assistant</span>
                <span class="panel-toggle" id="chat-toggle">▼</span>
            </div>
            <div class="panel-content" id="chat-content">
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator">
        <div class="spinner"></div>
        <h3>🤖 Analyzing Component</h3>
        <p id="loadingStatus">Processing component analysis...</p>
    </div>
</div>

<script>
    // Panel toggle functionality
    function togglePanel(panelName) {
        const content = document.getElementById(`${panelName}-content`);
        const toggle = document.getElementById(`${panelName}-toggle`);
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            toggle.classList.remove('collapsed');
            toggle.textContent = '▼';
        } else {
            content.classList.add('collapsed');
            toggle.classList.add('collapsed');
            toggle.textContent = '▶';
        }
    }

    // Section toggle functionality
    function toggleSection(sectionName) {
        const content = document.getElementById(`${sectionName}-section-content`);
        const toggle = document.getElementById(`${sectionName}-section-toggle`);
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            toggle.textContent = '▼';
        } else {
            content.classList.add('collapsed');
            toggle.textContent = '▶';
        }
    }
// This goes inside the control-content div
document.getElementById('control-content').innerHTML = `
    <!-- Component Analysis Section -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('component')">
            <span>🎯 Component Analysis</span>
            <span class="panel-toggle" id="component-section-toggle">▼</span>
        </div>
        <div class="section-content" id="component-section-content">
            <div class="form-group">
                <label for="componentName">Component Name:</label>
                <input type="text" id="componentName" class="component-input" 
                       placeholder="e.g., CUSTOMER-RECORD, ACCOUNT-COPY">
                <div id="componentSuggestions" class="component-suggestions"></div>
            </div>
            <div class="form-group">
            <label for="friendlyName">Display Name (Optional):</label>
            <input type="text" id="friendlyName" 
                   placeholder="e.g., Customer Master Record, Account Information">
            <small class="text-muted">Friendly name for display purposes</small>
        </div>
        
        <!-- Token Usage Display -->
        <div id="tokenInfo" class="token-info" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <span class="font-bold">Token Management</span>
                <span id="tokenCount">0 / 4000</span>
            </div>
            <div class="token-bar">
                <div id="tokenFill" class="token-fill safe" style="width: 0%"></div>
            </div>
            <div id="tokenWarning" style="font-size: 11px; margin-top: 5px;"></div>
        </div>
        
        <button class="btn btn-success btn-full" id="analyzeComponentBtn" disabled>
            🔍 Analyze Component
        </button>
    </div>
</div>

<!-- vLLM API Setup Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('api')">
        <span>🚀 LLM Server Setup</span>
        <span class="panel-toggle" id="api-section-toggle">▼</span>
    </div>
    <div class="section-content" id="api-section-content">
        <div class="form-group">
            <label for="vllmEndpoint">Server Endpoint:</label>
            <input type="text" id="vllmEndpoint" placeholder="http://localhost:8000" value="http://localhost:8000">
        </div>
        <div class="form-group">
            <label for="maxTokens">Max Tokens:</label>
            <input type="number" id="maxTokens" value="4000" min="1000" max="8000">
        </div>
        <button class="btn btn-primary btn-full" id="validateApiBtn">
            🔐 Test Connection
        </button>
        <div class="api-status disconnected" id="apiStatus">
            <span>🔴</span> Enter server details and test connection
        </div>
    </div>
</div>

<!-- File Upload Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('upload')">
        <span>📁 Upload Files</span>
        <span class="panel-toggle" id="upload-section-toggle">▼</span>
    </div>
    <div class="section-content" id="upload-section-content">
        <div class="upload-area" id="uploadArea">
            <h3>📤 Drop files here</h3>
            <p>COBOL (.cbl), Copybooks (.cpy), JCL (.jcl)</p>
        </div>
        <input type="file" id="fileInput" multiple accept=".cbl,.cob,.cpy,.copybook,.jcl,.txt,.proc" style="display: none;">
        <div id="uploadedFiles" class="file-list"></div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('actions')">
        <span>⚡ Quick Actions</span>
        <span class="panel-toggle" id="actions-section-toggle">▼</span>
    </div>
    <div class="section-content" id="actions-section-content">
        <button class="btn btn-secondary btn-full" id="bulkAnalyzeBtn" disabled>
            📊 Bulk Analyze
        </button>
        
        <div style="margin: 16px 0; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <h4 style="color: #1e40af; margin-bottom: 8px; font-size: 14px;">📤 Export Options</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button class="btn btn-primary" id="exportJsonBtn" disabled style="font-size: 12px; padding: 8px 12px;">
                    📋 JSON
                </button>
                <button class="btn btn-primary" id="exportMdBtn" disabled style="font-size: 12px; padding: 8px 12px;">
                    📝 Markdown
                </button>
            </div>
        </div>
        
        <button class="btn btn-danger btn-full" id="clearBtn">
            🗑️ Clear All Data
        </button>
    </div>
</div>`
// Continuing the analysis workspace content
document.getElementById('analysis-content').innerHTML += `
                        <p>📊 Analysis results will appear here after component analysis</p>
                        <div style="margin-top: 20px; padding: 16px; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                            <h4 style="color: #1e40af; margin-bottom: 8px;">Getting Started:</h4>
                            <ol style="color: #475569; font-size: 14px; margin-left: 20px;">
                                <li>Upload your mainframe files (COBOL, Copybooks, JCL)</li>
                                <li>Configure and test your LLM server connection</li>
                                <li>Enter a component name to analyze</li>
                                <li>Review the comprehensive analysis results</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Field Matrix Analysis -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('fieldmatrix')">
            <span>📋 Field Matrix</span>
            <span class="panel-toggle" id="fieldmatrix-section-toggle">▼</span>
        </div>
        <div class="section-content collapsed" id="fieldmatrix-section-content">
            <div id="fieldMatrixContent">
                <h3 style="color: #1e40af; margin-bottom: 16px;">📋 Field-Level Analysis Matrix</h3>
                <p style="margin-bottom: 20px; color: #64748b;">
                    Detailed field analysis with usage patterns and business context will appear here after component analysis.
                </p>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                    <p style="color: #64748b;">Field matrix analysis requires a copybook component to be analyzed first.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Patterns -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('usage')">
            <span>📈 Usage Patterns</span>
            <span class="panel-toggle" id="usage-section-toggle">▼</span>
        </div>
        <div class="section-content collapsed" id="usage-section-content">
            <div id="usageContent">
                <h3 style="color: #1e40af; margin-bottom: 16px;">📈 Component Usage Analysis</h3>
                <p style="margin-bottom: 20px; color: #64748b;">
                    Usage pattern analysis with lifecycle tracking will appear here after component analysis.
                </p>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                    <p style="color: #64748b;">Usage patterns will be displayed after analyzing a component.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependencies Analysis -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('dependencies')">
            <span>🔗 Dependencies</span>
            <span class="panel-toggle" id="dependencies-section-toggle">▼</span>
        </div>
        <div class="section-content collapsed" id="dependencies-section-content">
            <div id="dependenciesContent">
                <h3 style="color: #1e40af; margin-bottom: 16px;">🔗 Dependency Analysis</h3>
                <p style="margin-bottom: 20px; color: #64748b;">
                    Found vs missing dependency analysis will appear here after component analysis.
                </p>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                    <p style="color: #64748b;">Dependency mapping will be displayed after analyzing a component.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- File Lifecycle Flow -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('fileflow')">
            <span>🌊 File Lifecycle</span>
            <span class="panel-toggle" id="fileflow-section-toggle">▼</span>
        </div>
        <div class="section-content collapsed" id="fileflow-section-content">
            <div id="fileflowContent">
                <h3 style="color: #1e40af; margin-bottom: 16px;">🌊 Complete File Lifecycle Analysis</h3>
                <p style="margin-bottom: 20px; color: #64748b;">
                    End-to-end lifecycle tracking from creation through purge, including program usage patterns.
                </p>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center;">
                    <p style="color: #64748b;">File lifecycle flow will be displayed after analyzing a component.</p>
                </div>
            </div>
        </div>
    </div>

</div>`
// Chat panel content with expandable design
document.getElementById('chat-content').innerHTML = `
    <!-- Chat Header Info -->
    <div style="padding: 16px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; border-radius: 8px 8px 0 0;">
        <h3 style="margin-bottom: 8px; color: #1e40af; font-size: 1.1rem;">💬 AI Analysis Assistant</h3>
        <p style="font-size: 12px; color: #64748b; margin: 0;">
            Interactive chat with rich formatting and component-specific insights
        </p>
    </div>
    <!-- Chat Suggestions -->
<div class="section" style="margin: 0; border-radius: 0;">
    <div class="section-header" onclick="toggleSection('suggestions')" style="background: #f1f5f9; color: #475569; font-size: 14px; padding: 8px 16px;">
        <span>💡 Quick Questions</span>
        <span class="panel-toggle" id="suggestions-section-toggle">▼</span>
    </div>
    <div class="section-content" id="suggestions-section-content" style="padding: 12px;">
        <div id="chatSuggestions" style="display: none;">
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                <button class="chat-suggestion-btn" data-question="Explain the file lifecycle flow for this component">
                    📊 File Lifecycle
                </button>
                <button class="chat-suggestion-btn" data-question="What fields are updated by which programs?">
                    🔄 Field Updates
                </button>
                <button class="chat-suggestion-btn" data-question="Show me the creation and purge process">
                    🌊 Creation/Purge
                </button>
                <button class="chat-suggestion-btn" data-question="Which programs only read vs modify data?">
                    📖 Read/Write Patterns
                </button>
                <button class="chat-suggestion-btn" data-question="What are the key business rules in this component?">
                    ⚖️ Business Rules
                </button>
                <button class="chat-suggestion-btn" data-question="What dependencies are missing and why?">
                    🔗 Dependencies
                </button>
            </div>
        </div>
        <div id="chatSuggestionsDisabled" style="text-align: center; color: #9ca3af; font-size: 12px; padding: 16px;">
            💡 Quick questions will appear here after analyzing a component
        </div>
    </div>
</div>

<!-- Chat Messages Area -->
<div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
    <div class="chat-messages" id="chatMessages" style="
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: #ffffff;
        margin: 0;
        min-height: 300px;
        max-height: none;
        border-top: 1px solid #e2e8f0;
        border-bottom: 1px solid #e2e8f0;
    ">
        <div class="chat-message assistant" style="
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 12px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        ">
            <div class="sender" style="font-weight: 600; font-size: 12px; color: #059669; margin-bottom: 6px;">
                🤖 Analysis Assistant
            </div>
            <div class="content" style="font-size: 14px; line-height: 1.5; color: #1f2937;">
                👋 <strong style="color: #1e40af;">Welcome to Enhanced Mainframe Analysis!</strong>
                <br><br>
                I provide detailed analysis using advanced language models including:
                <br><br>
                🧠 <strong>Smart Field Analysis:</strong> Context-aware field lifecycle tracking
                <br>⚖️ <strong>Business Logic Extraction:</strong> Intelligent rule and validation discovery  
                <br>🔗 <strong>Dependency Mapping:</strong> Comprehensive relationship analysis
                <br>🌊 <strong>File Lifecycle Flow:</strong> Creation to purge tracking with program mapping
                <br>💡 <strong>Modernization Guidance:</strong> AI-powered optimization recommendations
                <br><br>
                <em style="color: #059669;">Upload files and analyze a component to unlock the full power of AI analysis!</em>
            </div>
            <div class="timestamp" style="font-size: 10px; color: #9ca3af; margin-top: 8px;">
                ${new Date().toLocaleTimeString()}
            </div>
        </div>
    </div>
    
    <!-- Chat Input Area -->
    <div class="chat-input-section" style="
        padding: 16px;
        background: #f8fafc;
        border-radius: 0 0 8px 8px;
        border-top: 1px solid #e2e8f0;
    ">
        <div style="display: flex; gap: 8px; align-items: flex-end;">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="Ask about field flows, program dependencies, lifecycle patterns..." 
                disabled 
                rows="2"
                style="
                    flex: 1;
                    min-height: 38px;
                    max-height: 120px;
                    padding: 10px 12px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    background: #ffffff;
                    color: #1f2937;
                    font-size: 14px;
                    resize: none;
                    font-family: inherit;
                    transition: all 0.2s ease;
                "
            ></textarea>
            <button 
                class="btn btn-success chat-send-btn" 
                id="chatSendBtn" 
                disabled
                style="
                    min-width: 70px;
                    padding: 10px 16px;
                    white-space: nowrap;
                "
            >
                Send
            </button>
        </div>
        <div style="margin-top: 8px; font-size: 11px; color: #9ca3af; text-align: center;">
            💡 Tip: Ask specific questions about the analyzed component for detailed insights
        </div>
    </div>
</div>`;
// Add chat-specific styles
const chatStyles = `
<style>
.chat-suggestion-btn {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border: 1px solid #cbd5e1;
    color: #475569;
    padding: 6px 10px;
    border-radius: 12px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    white-space: nowrap;
}

.chat-suggestion-btn:hover {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-color: #3b82f6;
    color: #1e40af;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

.chat-message {
    margin-bottom: 16px;
    padding: 16px;
    border-radius: 12px;
    max-width: 90%;
    word-wrap: break-word;
    line-height: 1.6;
    animation: fadeInUp 0.3s ease;
    position: relative;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.chat-message.user {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    margin-left: auto;
    text-align: right;
}

.chat-message.assistant {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
}

.chat-message .sender {
    font-weight: 600;
    font-size: 12px;
    margin-bottom: 6px;
}

.chat-message.user .sender {
    color: #1e40af;
}

.chat-message.assistant .sender {
    color: #059669;
}

.chat-message .content {
    font-size: 14px;
    line-height: 1.6;
    color: #1f2937;
}

.chat-message .timestamp {
    font-size: 10px;
    color: #9ca3af;
    margin-top: 8px;
}

.chat-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.chat-input:disabled {
    background: #f9fafb;
    color: #9ca3af;
    cursor: not-allowed;
}

@keyframes fadeInUp {
    from { 
        opacity: 0; 
        transform: translateY(10px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

/* Scrollbar styles for chat */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
`;

// Add the chat styles to the document
document.head.insertAdjacentHTML('beforeend', chatStyles);
// Enhanced Mainframe Analyzer - Core JavaScript Class with White/Blue Theme
class EnhancedMainframeAnalyzer {
    constructor() {
        // Core properties
        this.uploadedFiles = [];
        this.analysisResults = {};
        this.componentSuggestions = [];
        this.serverValidated = false;
        this.vllmEndpoint = 'http://localhost:8000';
        this.maxTokens = 4000;
        this.storageKey = 'enhanced_mainframe_analysis';
        this.currentAnalyzedComponent = null;
        this.chatHistory = [];
        // Component friendly names mapping
    this.componentFriendlyNames = {};
    
    // Token management
    this.averageCharsPerToken = 3;
    this.tokenSafetyMargin = 0.7;
    
    // LLM Analysis configuration
    this.llmConfig = {
        temperature: 0.1,
        maxRetries: 2,
        chunkSize: 2000,
        analysisTimeout: 90000
    };
    
    // File lifecycle patterns
    this.lifecyclePatterns = {
        creation: ['CREATE', 'WRITE', 'OUTPUT', 'OPEN OUTPUT', 'FD ', 'FILE-CONTROL'],
        reading: ['READ', 'INPUT', 'OPEN INPUT', 'SELECT'],
        updating: ['WRITE', 'REWRITE', 'UPDATE', 'MODIFY', 'OPEN I-O'],
        deletion: ['DELETE', 'PURGE', 'REMOVE'],
        cicsOperations: ['EXEC CICS', 'SEND MAP', 'RECEIVE MAP', 'READ TD', 'WRITE TD'],
        batchOperations: ['SORT', 'MERGE', 'COPY', '//EXEC PGM=']
    };
    
    this.initializeBasicEventListeners();
    this.loadStoredData();
    this.initializeTokenManagement();
    this.initializeChat();
    
    console.log('🚀 Enhanced Mainframe Analyzer with White/Blue Theme Initialized');
}

// === BASIC EVENT LISTENERS ===
initializeBasicEventListeners() {
    // API validation
    document.getElementById('validateApiBtn').addEventListener('click', () => this.validateConnection());
    document.getElementById('vllmEndpoint').addEventListener('input', () => this.onEndpointChange());
    document.getElementById('maxTokens').addEventListener('input', () => this.onSettingsChange());
    
    // File upload handlers
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    uploadArea.addEventListener('click', () => {
        if (this.serverValidated) fileInput.click();
    });
    uploadArea.addEventListener('drop', (e) => this.handleFileDrop(e));
    uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
    uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
    fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

    // Component analysis
    document.getElementById('componentName').addEventListener('input', () => this.onComponentInput());
    document.getElementById('analyzeComponentBtn').addEventListener('click', () => this.analyzeComponent());
    
    // Friendly name handling
    document.getElementById('friendlyName').addEventListener('input', () => this.onFriendlyNameChange());
    
    // Quick actions
    document.getElementById('bulkAnalyzeBtn').addEventListener('click', () => this.bulkAnalyze());
    document.getElementById('exportJsonBtn').addEventListener('click', () => this.exportResults('json'));
    document.getElementById('exportMdBtn').addEventListener('click', () => this.exportResults('markdown'));
    document.getElementById('clearBtn').addEventListener('click', () => this.clearAllData());

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.section')) {
            const suggestions = document.getElementById('componentSuggestions');
            if (suggestions) suggestions.style.display = 'none';
        }
    });
}

initializeTokenManagement() {
    this.updateTokenDisplay(0);
    this.showSuccess('🚀 Enhanced Mainframe Analyzer Ready!');
}

// === FRIENDLY NAME HANDLING ===
onFriendlyNameChange() {
    const componentName = document.getElementById('componentName').value.trim();
    const friendlyName = document.getElementById('friendlyName').value.trim();
    
    if (componentName && friendlyName) {
        this.componentFriendlyNames[componentName] = friendlyName;
        this.saveToStorage();
    }
}

getFriendlyName(componentName) {
    return this.componentFriendlyNames[componentName] || componentName;
}

// === TOKEN MANAGEMENT ===
estimateTokenCount(text) {
    if (!text) return 0;
    return Math.ceil(text.length / this.averageCharsPerToken);
}

updateTokenDisplay(currentTokens) {
    const tokenInfo = document.getElementById('tokenInfo');
    const tokenCount = document.getElementById('tokenCount');
    const tokenFill = document.getElementById('tokenFill');
    const tokenWarning = document.getElementById('tokenWarning');

    if (!tokenInfo) return;

    tokenInfo.style.display = 'block';
    tokenCount.textContent = `${currentTokens} / ${this.maxTokens}`;
    
    const percentage = (currentTokens / this.maxTokens) * 100;
    tokenFill.style.width = `${Math.min(percentage, 100)}%`;
    
    tokenFill.className = 'token-fill';
    if (percentage <= 50) {
        tokenFill.classList.add('safe');
        tokenWarning.textContent = '🟢 Optimal token usage - full analysis available';
    } else if (percentage <= 70) {
        tokenFill.classList.add('warning');
        tokenWarning.textContent = '🟡 Moderate usage - focused analysis active';
    } else {
        tokenFill.classList.add('danger');
        tokenWarning.textContent = '🔴 High usage - scope optimization required';
    }
}

// === API CONNECTION ===
async validateConnection() {
    const endpoint = document.getElementById('vllmEndpoint').value.trim();
    if (!endpoint) {
        this.showError('Please enter vLLM endpoint');
        return;
    }

    this.updateConnectionStatus('connecting', '🟡 Testing LLM connection...');

    try {
        const response = await fetch(`${endpoint}/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: "Test connection. Respond with 'Connected'",
                max_tokens: 10,
                temperature: 0.1
            }),
            signal: AbortSignal.timeout(10000)
        });

        if (response.ok) {
            const data = await response.json();
            this.serverValidated = true;
            this.vllmEndpoint = endpoint;
            this.updateConnectionStatus('connected', `🟢 LLM connection verified`);
            this.showSuccess('🚀 vLLM server connected successfully!');
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        this.serverValidated = false;
        this.updateConnectionStatus('disconnected', `🔴 Connection failed: ${error.message}`);
        this.showError(`LLM connection failed: ${error.message}`);
    }
    
    this.validateForm();
}

updateConnectionStatus(status, message) {
    const statusElement = document.getElementById('apiStatus');
    if (statusElement) {
        statusElement.className = `api-status ${status}`;
        statusElement.innerHTML = message;
    }
}

// === UTILITY METHODS ===
showMessage(type, message, duration = 3000) {
    // Remove existing messages
    document.querySelectorAll('.message').forEach(msg => msg.remove());
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, duration);
}

showError(message) { this.showMessage('error', message, 5000); }
showSuccess(message) { this.showMessage('success', message, 3000); }
showWarning(message) { this.showMessage('warning', message, 4000); }

showLoading() { 
    const loading = document.getElementById('loadingIndicator');
    if (loading) loading.classList.add('show'); 
}

hideLoading() { 
    const loading = document.getElementById('loadingIndicator');
    if (loading) loading.classList.remove('show'); 
}

updateLoadingStatus(status) { 
    const statusElement = document.getElementById('loadingStatus');
    if (statusElement) statusElement.textContent = status; 
}

sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

// === FORM VALIDATION ===
validateForm() {
    const hasFiles = this.uploadedFiles.length > 0;
    const hasComponent = document.getElementById('componentName') && 
                       document.getElementById('componentName').value.trim().length > 0;
    const hasConnection = this.serverValidated;
    
    const analyzeBtn = document.getElementById('analyzeComponentBtn');
    const bulkBtn = document.getElementById('bulkAnalyzeBtn');
    
    if (analyzeBtn) analyzeBtn.disabled = !(hasFiles && hasComponent && hasConnection);
    if (bulkBtn) bulkBtn.disabled = !(hasFiles && hasConnection);
    
    const hasResults = Object.keys(this.analysisResults).length > 0;
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const exportMdBtn = document.getElementById('exportMdBtn');
    
    if (exportJsonBtn) exportJsonBtn.disabled = !hasResults;
    if (exportMdBtn) exportMdBtn.disabled = !hasResults;
}

// === EVENT HANDLERS ===
onEndpointChange() {
    this.serverValidated = false;
    this.updateConnectionStatus('disconnected', '🔴 Connection not validated');
    this.validateForm();
}

onSettingsChange() {
    const maxTokensInput = document.getElementById('maxTokens');
    if (maxTokensInput) {
        this.maxTokens = parseInt(maxTokensInput.value) || 4000;
        this.saveToStorage();
    }
}

// === STORAGE MANAGEMENT ===
saveToStorage() {
    try {
        const data = {
            uploadedFiles: this.uploadedFiles,
            analysisResults: this.analysisResults,
            chatHistory: this.chatHistory,
            componentFriendlyNames: this.componentFriendlyNames,
            vllmEndpoint: this.vllmEndpoint,
            maxTokens: this.maxTokens,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(this.storageKey, JSON.stringify(data));
    } catch (error) {
        console.warn('Failed to save to storage:', error);
    }
}

loadStoredData() {
    try {
        const stored = localStorage.getItem(this.storageKey);
        if (stored) {
            const data = JSON.parse(stored);
            this.uploadedFiles = data.uploadedFiles || [];
            this.analysisResults = data.analysisResults || {};
            this.chatHistory = data.chatHistory || [];
            this.componentFriendlyNames = data.componentFriendlyNames || {};
            
            const endpointInput = document.getElementById('vllmEndpoint');
            const maxTokensInput = document.getElementById('maxTokens');
            
            if (data.vllmEndpoint && endpointInput) {
                endpointInput.value = data.vllmEndpoint;
                this.vllmEndpoint = data.vllmEndpoint;
            }
            
            if (data.maxTokens && maxTokensInput) {
                maxTokensInput.value = data.maxTokens;
                this.maxTokens = data.maxTokens;
            }
            
            this.displayUploadedFiles();
            this.updateComponentSuggestions();
            this.validateForm();
            
            console.log('📁 Stored analysis data loaded successfully');
        }
    } catch (error) {
        console.warn('Failed to load stored data:', error);
    }
}

clearAllData() {
    if (confirm('Are you sure you want to clear all analysis data? This cannot be undone.')) {
        this.uploadedFiles = [];
        this.analysisResults = {};
        this.componentSuggestions = [];
        this.componentFriendlyNames = {};
        this.currentAnalyzedComponent = null;
        this.chatHistory = [];
        
        localStorage.removeItem(this.storageKey);
        
        this.displayUploadedFiles();
        this.validateForm();
        
        // Reset chat area
        this.resetChatArea();
        
        this.showSuccess('🗑️ All analysis data cleared successfully');
    }
}

resetChatArea() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="chat-message assistant">
                <div class="sender">🤖 Analysis Assistant</div>
                <div class="content">
                    👋 <strong style="color: #1e40af;">Welcome to Enhanced Mainframe Analysis!</strong>
                    <br><br>Upload files and analyze a component to get started.
                </div>
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
            </div>
        `;
    }
    
    // Disable chat input
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatSuggestions = document.getElementById('chatSuggestions');
    const chatSuggestionsDisabled = document.getElementById('chatSuggestionsDisabled');
    
    if (chatInput) chatInput.disabled = true;
    if (chatSendBtn) chatSendBtn.disabled = true;
    if (chatSuggestions) chatSuggestions.style.display = 'none';
    if (chatSuggestionsDisabled) chatSuggestionsDisabled.style.display = 'block';
}
// Continue the EnhancedMainframeAnalyzer class - File Handling & Component Detection
// === FILE UPLOAD HANDLING ===
handleFileDrop(e) {
e.preventDefault();
e.stopPropagation();
const uploadArea = document.getElementById('uploadArea');
uploadArea.classList.remove('drag-over');

if (!this.serverValidated) {
    this.showError('Please validate LLM API connection first');
    return;
}

const files = Array.from(e.dataTransfer.files);
this.processFiles(files);
}
handleDragOver(e) {
e.preventDefault();
e.stopPropagation();
const uploadArea = document.getElementById('uploadArea');
if (uploadArea) uploadArea.classList.add('drag-over');
}
handleDragLeave(e) {
e.preventDefault();
e.stopPropagation();
const uploadArea = document.getElementById('uploadArea');
if (uploadArea) uploadArea.classList.remove('drag-over');
}
handleFileSelect(e) {
if (!this.serverValidated) {
this.showError('Please validate LLM API connection first');
return;
}
const files = Array.from(e.target.files);
this.processFiles(files);
}
async processFiles(files) {
for (const file of files) {
try {
const content = await this.readFile(file);
const fileType = this.detectFileType(file.name, content);
const fileObj = {
            name: file.name,
            content: content,
            size: file.size,
            type: fileType,
            uploadDate: new Date().toISOString(),
            id: Date.now() + Math.random(),
            components: this.extractComponentsFromFile(content, fileType)
        };
        
        this.uploadedFiles.push(fileObj);
        this.updateComponentSuggestions();
        
    } catch (error) {
        this.showError(`Failed to read ${file.name}: ${error.message}`);
    }
}

this.displayUploadedFiles();
this.validateForm();
this.saveToStorage();
this.showSuccess(`📁 ${files.length} files uploaded successfully!`);
}
readFile(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = e => resolve(e.target.result);
reader.onerror = e => reject(new Error('File read failed'));
reader.readAsText(file);
});
}
detectFileType(fileName, content) {
const name = fileName.toLowerCase();
const upperContent = content.toUpperCase();
if (name.includes('.cpy') || name.includes('copybook')) {
    return 'Copybook';
} else if (name.includes('.jcl') || upperContent.includes('//JOB ')) {
    return 'JCL Job';
} else if (name.includes('.cbl') || name.includes('.cob') || 
          upperContent.includes('IDENTIFICATION DIVISION') ||
          upperContent.includes('PROGRAM-ID')) {
    return 'COBOL Program';
} else if (name.includes('.proc')) {
    return 'JCL Procedure';
} else {
    return 'Text File';
}
}
// === EXTRACT COMPONENTS FROM FILES ===
extractComponentsFromFile(content, fileType) {
const components = [];
const lines = content.split('\n');
const upperContent = content.toUpperCase();
lines.forEach((line, index) => {
    const trimmed = line.trim().toUpperCase();
    
    // Extract COBOL 01-level fields (main focus)
    const field01Match = trimmed.match(/^\s*01\s+([A-Z][A-Z0-9\-_]{2,})/);
    if (field01Match) {
        components.push({
            name: field01Match[1],
            type: 'RECORD_LAYOUT',
            level: '01',
            lineNumber: index + 1,
            fileType: fileType,
            isMainComponent: true,
            friendlyName: this.generateFriendlyName(field01Match[1], 'RECORD_LAYOUT')
        });
    }
    
    // Extract copybook names
    const copyMatch = trimmed.match(/COPY\s+([A-Z][A-Z0-9\-_]{2,})/);
    if (copyMatch) {
        components.push({
            name: copyMatch[1],
            type: 'COPYBOOK',
            lineNumber: index + 1,
            fileType: fileType,
            isMainComponent: false,
            friendlyName: this.generateFriendlyName(copyMatch[1], 'COPYBOOK')
        });
    }
    
    // Extract program names
    const programMatch = trimmed.match(/PROGRAM-ID\.?\s+([A-Z][A-Z0-9\-_]{2,})/);
    if (programMatch) {
        components.push({
            name: programMatch[1],
            type: 'PROGRAM',
            lineNumber: index + 1,
            fileType: fileType,
            isMainComponent: true,
            friendlyName: this.generateFriendlyName(programMatch[1], 'PROGRAM')
        });
    }

    // Extract file names from FD statements
    const fileMatch = trimmed.match(/FD\s+([A-Z][A-Z0-9\-_]{2,})/);
    if (fileMatch) {
        components.push({
            name: fileMatch[1],
            type: 'FILE',
            lineNumber: index + 1,
            fileType: fileType,
            isMainComponent: false,
            friendlyName: this.generateFriendlyName(fileMatch[1], 'FILE')
        });
    }
});

return components;
}
// === GENERATE FRIENDLY NAMES ===
generateFriendlyName(technicalName, componentType) {
// Check if we already have a friendly name stored
if (this.componentFriendlyNames[technicalName]) {
return this.componentFriendlyNames[technicalName];
}
// Generate friendly name based on patterns
let friendlyName = technicalName.toLowerCase().replace(/-/g, ' ');

// Common patterns and their friendly equivalents
const patterns = {
    // Record layouts
    'customer record': 'Customer Master Record',
    'account record': 'Account Information Record',
    'employee record': 'Employee Master Record',
    'product record': 'Product Master Record',
    'order record': 'Order Information Record',
    'invoice record': 'Invoice Details Record',
    'payment record': 'Payment Transaction Record',
    
    // Programs
    'customer proc': 'Customer Processing Program',
    'account proc': 'Account Processing Program',
    'batch proc': 'Batch Processing Program',
    'online proc': 'Online Processing Program',
    'update proc': 'Update Processing Program',
    'report proc': 'Report Generation Program',
    
    // Files
    'master file': 'Master Data File',
    'trans file': 'Transaction File',
    'temp file': 'Temporary Work File',
    'backup file': 'Backup Data File',
    
    // Common abbreviations
    'cust': 'Customer',
    'acct': 'Account',
    'emp': 'Employee',
    'prod': 'Product',
    'ord': 'Order',
    'inv': 'Invoice',
    'pay': 'Payment',
    'addr': 'Address',
    'tel': 'Telephone',
    'desc': 'Description',
    'amt': 'Amount',
    'qty': 'Quantity',
    'num': 'Number',
    'id': 'Identifier',
    'cd': 'Code',
    'dt': 'Date',
    'tm': 'Time',
    'ind': 'Indicator',
    'flg': 'Flag',
    'sw': 'Switch'
};

// Apply pattern matching
for (const [pattern, replacement] of Object.entries(patterns)) {
    if (friendlyName.includes(pattern)) {
        friendlyName = friendlyName.replace(pattern, replacement);
    }
}

// Capitalize first letter of each word
friendlyName = friendlyName.split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');

// Add type suffix if not present
if (componentType === 'RECORD_LAYOUT' && !friendlyName.includes('Record')) {
    friendlyName += ' Record Layout';
} else if (componentType === 'PROGRAM' && !friendlyName.includes('Program')) {
    friendlyName += ' Program';
} else if (componentType === 'COPYBOOK' && !friendlyName.includes('Copybook')) {
    friendlyName += ' Copybook';
} else if (componentType === 'FILE' && !friendlyName.includes('File')) {
    friendlyName += ' File';
}

return friendlyName;
}

// === EXTRACT REAL LIFECYCLE FLOW ===
async extractRealLifecycleFlow(componentName, componentType, relevantFiles, llmAnalysis) {
    const lifecycleFlow = {
        componentName: componentName,
        componentType: componentType,
        scope: 'REAL_FILE_ANALYSIS',
        usagePattern: 'ANALYZED_FROM_FILES',
        creationSources: [],
        inputPrograms: [],
        updatePrograms: [],
        cicsScreens: [],
        batchJobs: [],
        primaryFields: llmAnalysis.primaryFields || []
    };

    // Extract real lifecycle patterns from file content
    relevantFiles.forEach(file => {
        const content = file.content.toUpperCase();
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            const trimmed = line.trim();
            
            // Look for creation patterns
            if (trimmed.includes('OPEN OUTPUT') || trimmed.includes('WRITE')) {
                lifecycleFlow.creationSources.push({
                    program: file.name.replace(/\.[^/.]+$/, ""), // Remove extension
                    operation: 'FILE_CREATE',
                    evidence: [{ line: index + 1, operation: 'WRITE/OUTPUT' }]
                });
            }
            
            // Look for read patterns
            if (trimmed.includes('READ') || trimmed.includes('OPEN INPUT')) {
                lifecycleFlow.inputPrograms.push({
                    program: file.name.replace(/\.[^/.]+$/, ""),
                    operation: 'FILE_READ',
                    evidence: [{ line: index + 1, operation: 'read' }]
                });
            }
            
            // Look for update patterns
            if (trimmed.includes('REWRITE') || trimmed.includes('UPDATE')) {
                lifecycleFlow.updatePrograms.push({
                    program: file.name.replace(/\.[^/.]+$/, ""),
                    operation: 'FILE_UPDATE',
                    evidence: [{ line: index + 1, operation: 'REWRITE/UPDATE' }]
                });
            }
        });
    });

    // Remove duplicates
    lifecycleFlow.creationSources = this.removeDuplicatePrograms(lifecycleFlow.creationSources);
    lifecycleFlow.inputPrograms = this.removeDuplicatePrograms(lifecycleFlow.inputPrograms);
    lifecycleFlow.updatePrograms = this.removeDuplicatePrograms(lifecycleFlow.updatePrograms);

    return lifecycleFlow;
}

// === UTILITY METHODS ===
removeDuplicatePrograms(programList) {
    const seen = new Set();
    return programList.filter(item => {
        if (seen.has(item.program)) {
            return false;
        }
        seen.add(item.program);
        return true;
    });
}

calculateQualityScore(llmAnalysis, dependencyAnalysis) {
    let score = 5; // Base score
    
    if (llmAnalysis.primaryFields && llmAnalysis.primaryFields.length > 0) score += 1;
    if (llmAnalysis.recommendations && llmAnalysis.recommendations.length > 3) score += 1;
    if (dependencyAnalysis && dependencyAnalysis.summary && dependencyAnalysis.summary.foundCount > dependencyAnalysis.summary.missingCount) score += 1;
    if (llmAnalysis.qualityScore && llmAnalysis.qualityScore > 6) score += 1;
    
    return Math.min(10, Math.max(1, score));
}

// === PARSE UNSTRUCTURED LLM RESPONSE ===
parseUnstructuredLLMResponse(response, componentName, componentType) {
    const recommendations = [];
    const lines = response.split('\n');
    
    lines.forEach(line => {
        if (line.includes('recommend') || line.includes('should') || line.includes('consider')) {
            recommendations.push(line.trim());
        }
    });

    return {
        componentName: componentName,
        componentType: componentType,
        analysisScope: "REAL_FILE_ANALYSIS",
        purpose: "Analysis based on uploaded files",
        keyElements: ["File structure", "Code patterns", "Dependencies"],
        recommendations: recommendations.slice(0, 5), // Limit to 5 recommendations
        qualityScore: 6
    };
}

// === CREATE BASIC ANALYSIS FROM FILE CONTENT ===
createBasicAnalysis(componentName, componentType, relevantFiles) {
    const analysis = {
        componentName: componentName,
        componentType: componentType,
        analysisScope: "FILE_CONTENT_ANALYSIS",
        recommendations: []
    };

    if (componentType === 'Copybook') {
        // Extract real fields from copybook
        const fields = [];
        relevantFiles.forEach(file => {
            const lines = file.content.split('\n');
            lines.forEach((line, index) => {
                const fieldMatch = line.trim().match(/^\s*(\d+)\s+([A-Z][A-Z0-9\-_]+)/);
                if (fieldMatch) {
                    fields.push({
                        name: fieldMatch[2],
                        level: parseInt(fieldMatch[1]),
                        isElementaryField: parseInt(fieldMatch[1]) > 1,
                        usagePattern: "FOUND_IN_FILE",
                        businessPurpose: `Field from ${file.name}`
                    });
                }
            });
        });
        
        analysis.primaryFields = fields.filter(f => f.level <= 10); // Reasonable field levels
        analysis.totalFields = fields.length;
        analysis.fieldCategories = {
            inputFields: fields.filter(f => f.name.includes('INPUT')).map(f => f.name),
            outputFields: fields.filter(f => f.name.includes('OUTPUT')).map(f => f.name),
            referenceFields: fields.filter(f => f.name.includes('ID') || f.name.includes('KEY')).map(f => f.name),
            staticFields: [],
            unusedFields: []
        };
        
        analysis.recommendations = [
            `Analyzed ${fields.length} fields in ${componentName}`,
            "Review field usage patterns across programs",
            "Consider field naming standards validation",
            "Validate field length requirements"
        ];
    } else if (componentType === 'COBOL Program') {
        // Extract real program structure
        analysis.programStructure = {
            divisions: [],
            paragraphs: [],
            sections: []
        };
        
        relevantFiles.forEach(file => {
            const content = file.content.toUpperCase();
            if (content.includes('IDENTIFICATION DIVISION')) analysis.programStructure.divisions.push('IDENTIFICATION');
            if (content.includes('ENVIRONMENT DIVISION')) analysis.programStructure.divisions.push('ENVIRONMENT');
            if (content.includes('DATA DIVISION')) analysis.programStructure.divisions.push('DATA');
            if (content.includes('PROCEDURE DIVISION')) analysis.programStructure.divisions.push('PROCEDURE');
        });
        
        analysis.recommendations = [
            `Analyzed COBOL program structure for ${componentName}`,
            "Review program complexity and modularity",
            "Consider error handling improvements",
            "Validate program documentation"
        ];
    }

    analysis.qualityScore = Math.min(8, Math.max(4, analysis.recommendations.length + 2));
    return analysis;
}

// === ENHANCED FIELD-WISE LIFECYCLE ANALYSIS ===
async analyzeFieldWiseLifecycle(componentName, relevantFiles) {
    const fieldLifecycle = {
        inputFields: [],     // Fields populated from external sources
        referenceFields: [], // Fields used for lookups/comparisons
        updatedFields: [],   // Fields modified during processing
        derivedFields: [],   // Fields calculated from other fields
        staticFields: [],    // Fields with constant values
        unusedFields: []     // Fields never referenced
    };
    
    // Extract all fields from copybook
    const extractedFields = this.extractCopybookFields(componentName, relevantFiles);
    const usingPrograms = this.findProgramsUsingCopybook(componentName);
    
    console.log(`Analyzing ${extractedFields.length} fields across ${usingPrograms.length} programs`);
    
    for (const field of extractedFields) {
        const fieldAnalysis = {
            name: field.name,
            level: field.level,
            picture: field.picture,
            usagePatterns: [],
            sourcePrograms: [],
            targetPrograms: [],
            operations: []
        };
        
        // Analyze field usage in each program
        for (const program of usingPrograms) {
            const usage = this.analyzeFieldUsageInProgram(field.name, program);
            
            if (usage.operations.length > 0) {
                fieldAnalysis.usagePatterns.push(usage);
                
                // Categorize based on operations
                const isInput = usage.isInput || usage.isWritten;
                const isOutput = usage.isDisplayed || usage.isRead;
                const isCalculated = usage.isCalculated;
                const isValidated = usage.isValidated;
                
                if (isInput && !isOutput) {
                    fieldAnalysis.category = 'INPUT';
                } else if (isOutput && !isInput) {
                    fieldAnalysis.category = 'OUTPUT';
                } else if (isCalculated) {
                    fieldAnalysis.category = 'DERIVED';
                } else if (isValidated) {
                    fieldAnalysis.category = 'REFERENCE';
                } else if (field.value) {
                    fieldAnalysis.category = 'STATIC';
                } else if (isInput && isOutput) {
                    fieldAnalysis.category = 'UPDATED';
                } else {
                    fieldAnalysis.category = 'UNUSED';
                }
            }
        }
        
        // If no usage found, mark as unused
        if (fieldAnalysis.usagePatterns.length === 0) {
            fieldAnalysis.category = 'UNUSED';
        }
        
        // Add to appropriate category
        switch (fieldAnalysis.category) {
            case 'INPUT':
                fieldLifecycle.inputFields.push(fieldAnalysis);
                break;
            case 'REFERENCE':
                fieldLifecycle.referenceFields.push(fieldAnalysis);
                break;
            case 'UPDATED':
                fieldLifecycle.updatedFields.push(fieldAnalysis);
                break;
            case 'DERIVED':
                fieldLifecycle.derivedFields.push(fieldAnalysis);
                break;
            case 'STATIC':
                fieldLifecycle.staticFields.push(fieldAnalysis);
                break;
            case 'UNUSED':
                fieldLifecycle.unusedFields.push(fieldAnalysis);
                break;
            default:
                fieldLifecycle.referenceFields.push(fieldAnalysis);
        }
    }
    
    return fieldLifecycle;
}

// === INTELLIGENT CONTENT CHUNKING ===
intelligentChunkContent(content, componentType) {
    const maxChars = this.maxTokens * this.averageCharsPerToken * 0.6;
    
    if (content.length <= maxChars) {
        return content;
    }
    
    if (componentType === 'Copybook') {
        // Focus on field definitions and structures
        const lines = content.split('\n');
        const importantLines = [];
        
        lines.forEach((line, index) => {
            const trimmed = line.trim().toUpperCase();
            
            // Include 01-level fields and their subordinates
            if (trimmed.match(/^\s*\d+\s+[A-Z]/)) {
                importantLines.push(line);
                
                // Include next few lines for complete field definition
                for (let i = 1; i <= 3 && (index + i) < lines.length; i++) {
                    const nextLine = lines[index + i].trim();
                    if (nextLine.includes('PIC ') || nextLine.includes('VALUE ') || 
                        nextLine.includes('OCCURS ') || nextLine.includes('REDEFINES ')) {
                        importantLines.push(lines[index + i]);
                    }
                }
            }
        });
        
        let result = importantLines.join('\n');
        return result.substring(0, maxChars);
        
    } else if (componentType === 'COBOL Program') {
        // Focus on working storage and procedure division
        const workingStorageIndex = content.toUpperCase().indexOf('WORKING-STORAGE');
        const procedureIndex = content.toUpperCase().indexOf('PROCEDURE DIVISION');
        
        let importantContent = '';
        
        if (workingStorageIndex > -1) {
            const wsContent = content.substring(workingStorageIndex, procedureIndex > -1 ? procedureIndex : content.length);
            importantContent += wsContent.substring(0, maxChars / 2);
        }
        
        if (procedureIndex > -1) {
            const procContent = content.substring(procedureIndex);
            importantContent += procContent.substring(0, maxChars / 2);
        }
        
        return importantContent || content.substring(0, maxChars);
    }
    
    return content.substring(0, maxChars);
}
// === COMPONENT SUGGESTIONS ===
updateComponentSuggestions() {
this.componentSuggestions = [];
this.uploadedFiles.forEach(file => {
    if (file.components) {
        file.components.forEach(component => {
            // Focus on main components (01-level fields, programs)
            if (component.isMainComponent) {
                this.componentSuggestions.push({
                    name: component.name,
                    type: component.type,
                    level: component.level,
                    file: file.name,
                    fileType: file.type,
                    lineNumber: component.lineNumber,
                    friendlyName: component.friendlyName || this.generateFriendlyName(component.name, component.type)
                });
            }
        });
    }
});

// Remove duplicates and sort by importance
this.componentSuggestions = this.componentSuggestions
    .filter((item, index, self) => 
        index === self.findIndex(t => t.name === item.name && t.type === item.type)
    )
    .sort((a, b) => {
        // Prioritize 01-level fields and programs
        if (a.type === 'RECORD_LAYOUT' && b.type !== 'RECORD_LAYOUT') return -1;
        if (b.type === 'RECORD_LAYOUT' && a.type !== 'RECORD_LAYOUT') return 1;
        if (a.type === 'PROGRAM' && b.type !== 'PROGRAM') return -1;
        if (b.type === 'PROGRAM' && a.type !== 'PROGRAM') return 1;
        return a.name.localeCompare(b.name);
    });
    }
onComponentInput() {
const input = document.getElementById('componentName');
const suggestions = document.getElementById('componentSuggestions');
if (!input || !suggestions) {
    this.validateForm();
    return;
}

const value = input.value.trim().toUpperCase();

if (value.length < 2) {
    suggestions.style.display = 'none';
    this.validateForm();
    return;
}

const filtered = this.componentSuggestions.filter(item => 
    item.name.includes(value) || 
    item.friendlyName.toUpperCase().includes(value)
).slice(0, 8);

if (filtered.length > 0) {
    let html = '';
    filtered.forEach(item => {
        const icon = this.getComponentIcon(item.type);
        const priority = item.type === 'RECORD_LAYOUT' ? '🎯' : 
                       item.type === 'PROGRAM' ? '💼' : '📁';
        
        html += `
            <div class="suggestion-item" onclick="analyzer.selectSuggestion('${item.name}', '${item.friendlyName}')">
                <div style="font-weight: 600; color: #1e40af;">
                    ${priority} ${item.friendlyName}
                </div>
                <div style="font-size: 11px; color: #64748b; margin-top: 2px;">
                    Technical: ${item.name} • ${item.type} in ${item.file}
                    ${item.level ? `<span style="margin-left: 8px; background: #fbbf24; color: #000; padding: 1px 4px; border-radius: 2px; font-size: 9px;">L${item.level}</span>` : ''}
                </div>
            </div>
        `;
    });
    suggestions.innerHTML = html;
    suggestions.style.display = 'block';
} else {
    suggestions.style.display = 'none';
}

this.validateForm();
}
getComponentIcon(type) {
const icons = {
'RECORD_LAYOUT': '🎯',
'PROGRAM': '💼',
'COPYBOOK': '📚',
'FILE': '📁'
};
return icons[type] || '📋';
}
selectSuggestion(componentName, friendlyName) {
const input = document.getElementById('componentName');
const friendlyInput = document.getElementById('friendlyName');
const suggestions = document.getElementById('componentSuggestions');
if (input) input.value = componentName;
if (friendlyInput && friendlyName) friendlyInput.value = friendlyName;
if (suggestions) suggestions.style.display = 'none';

// Store the friendly name
if (friendlyName) {
    this.componentFriendlyNames[componentName] = friendlyName;
    this.saveToStorage();
}

this.validateForm();
}
// === FILE DISPLAY ===
displayUploadedFiles() {
const container = document.getElementById('uploadedFiles');
if (!container) return;
if (this.uploadedFiles.length === 0) {
    container.innerHTML = '';
    return;
}

let html = '';
this.uploadedFiles.forEach(file => {
    const mainComponents = file.components ? 
        file.components.filter(c => c.isMainComponent).length : 0;
    const totalComponents = file.components ? file.components.length : 0;
    
    html += `
        <div class="file-item">
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-details">
                    ${file.type} • ${Math.round(file.size/1024)}KB
                    ${mainComponents > 0 ? ` • 🎯 ${mainComponents} main components` : ''}
                    ${totalComponents > mainComponents ? ` • 📁 ${totalComponents - mainComponents} references` : ''}
                </div>
            </div>
            <button class="file-remove" onclick="analyzer.removeFile('${file.id}')">🗑️</button>
        </div>
    `;
});

container.innerHTML = html;
}
removeFile(fileId) {
this.uploadedFiles = this.uploadedFiles.filter(f => f.id != fileId);
this.displayUploadedFiles();
this.updateComponentSuggestions();
this.validateForm();
this.saveToStorage();
}
// === COMPONENT HELPER METHODS ===
findRelevantFiles(componentName) {
return this.uploadedFiles.filter(file => {
// Check if file contains the component directly
if (file.content.toUpperCase().includes(componentName.toUpperCase()) ||
file.name.toUpperCase().includes(componentName.toUpperCase())) {
return true;
}
    // Check if any component in the file matches
    if (file.components) {
        return file.components.some(comp => 
            comp.name.toUpperCase() === componentName.toUpperCase()
        );
    }
    
    return false;
});
}
detectComponentType(componentName, files) {
// Check if it's a 01-level field (record layout)
for (const file of files) {
if (file.components) {
const component = file.components.find(c =>
c.name.toUpperCase() === componentName.toUpperCase()
);
if (component) {
if (component.type === 'RECORD_LAYOUT') return 'Copybook';
if (component.type === 'PROGRAM') return 'COBOL Program';
if (component.type === 'FILE') return 'File Definition';
}
}
}
// Fallback to file type detection
const copybookFile = files.find(f => f.type === 'Copybook');
if (copybookFile) return 'Copybook';

const programFile = files.find(f => f.type === 'COBOL Program');
if (programFile) return 'COBOL Program';

return 'Component';
}
// Continue in next part...

// Continue the EnhancedMainframeAnalyzer class - Chat Functionality
// === CHAT INITIALIZATION ===
initializeChat() {
this.initializeChatEventListeners();
}
initializeChatEventListeners() {
const chatSendBtn = document.getElementById('chatSendBtn');
const chatInput = document.getElementById('chatInput');
if (chatSendBtn && chatInput) {
    chatSendBtn.addEventListener('click', () => this.sendChatMessage());
    
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendChatMessage();
        }
    });
    
    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });
}

// Chat suggestions
document.querySelectorAll('.chat-suggestion-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const question = e.target.dataset.question;
        if (chatInput && question) {
            chatInput.value = question;
            this.sendChatMessage();
        }
    });
});
}
enableChat() {
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const chatSuggestions = document.getElementById('chatSuggestions');
const chatSuggestionsDisabled = document.getElementById('chatSuggestionsDisabled');
if (chatInput && chatSendBtn) {
    chatInput.disabled = false;
    chatSendBtn.disabled = false;
    
    if (chatSuggestions) {
        chatSuggestions.style.display = 'block';
    }
    if (chatSuggestionsDisabled) {
        chatSuggestionsDisabled.style.display = 'none';
    }
    
  const friendlyName = this.getFriendlyName(this.currentAnalyzedComponent);

this.addChatMessage('assistant', 
    `🎯 **Analysis complete for ${friendlyName}!**
I can now provide detailed insights about this component:
🧠 Field Analysis: Context-aware categorization with lifecycle tracking
⚖️ Business Logic: Extracted rules and validation patterns
🔗 Dependency Analysis: Found vs missing dependencies
🌊 Lifecycle Flow: Complete usage pattern mapping
Ask me about:

"Which fields are most important in this component?"
"What programs create vs update this data?"
"What dependencies are missing and why?"
"How can we optimize this component?"

Technical Reference: \`${this.currentAnalyzedComponent}\``
);

}
}
async sendChatMessage() {
const input = document.getElementById('chatInput');
const sendBtn = document.getElementById('chatSendBtn');
const message = input.value.trim();
if (!message) {
    this.showError('Please enter a message');
    return;
}

if (!this.currentAnalyzedComponent) {
    this.showError('Please analyze a component first');
    return;
}

input.disabled = true;
sendBtn.disabled = true;
sendBtn.textContent = 'Processing...';

this.addChatMessage('user', message);
input.value = '';
input.style.height = 'auto';

this.showChatTyping();

try {
    const response = await this.processEnhancedChatQuery(message);
    this.hideChatTyping();
    this.addChatMessage('assistant', response);
} catch (error) {
    console.error('Chat error:', error);
    this.hideChatTyping();
    this.addChatMessage('assistant', `I apologize, but I encountered an error: ${error.message}. Please try rephrasing your question or check the LLM server connection.`);
} finally {
    input.disabled = false;
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    input.focus();
}
}
async processEnhancedChatQuery(question) {
const analysisData = this.analysisResults[this.currentAnalyzedComponent];
const friendlyName = this.getFriendlyName(this.currentAnalyzedComponent);
let context = `MAINFRAME COMPONENT ANALYSIS CHAT
COMPONENT: ${this.currentAnalyzedComponent}
DISPLAY NAME: ${friendlyName}
COMPONENT TYPE: ${analysisData.componentType}
ANALYSIS METHOD: ${analysisData.analysisMethod}
FILES ANALYZED: ${analysisData.filesAnalyzed.join(', ')}
ANALYSIS RESULTS:
${JSON.stringify(analysisData.llmAnalysis, null, 2)}
LIFECYCLE FLOW:
${JSON.stringify(analysisData.lifecycleFlow, null, 2)}
DEPENDENCY ANALYSIS:
${JSON.stringify(analysisData.dependencyAnalysis, null, 2)}
USER QUESTION: "${question}"
Provide a detailed, helpful response based on the analysis data above. Use specific examples and data from the analysis. Format your response with clear sections and bullet points where appropriate.`;
try {
    const response = await this.callLLMAPI(context);
    
    if (typeof response === 'string') {
        return response;
    } else if (response.text) {
        return response.text;
    } else if (response.content) {
        return response.content;
    } else if (response.error) {
        return `Based on the available analysis data: ${response.fallbackData?.recommendations?.join('. ') || 'Please check the analysis results for more details.'}`;
    }
    
    return 'I can provide information based on the component analysis. What specific aspect would you like to know more about?';
} catch (error) {
    console.error('Chat LLM call failed:', error);
    
    // Provide intelligent fallback based on question content
    const questionLower = question.toLowerCase();
    
    if (questionLower.includes('field')) {
        const fieldCount = analysisData.llmAnalysis?.totalFields || 0;
        return `Based on the analysis, this component has ${fieldCount} fields. The analysis shows field categorization and usage patterns. Check the Field Matrix tab for detailed field-level information.`;
    } else if (questionLower.includes('program')) {
        const programCount = analysisData.lifecycleFlow?.inputPrograms?.length || 0;
        return `The analysis found ${programCount} programs that interact with this component. Check the Dependencies tab for program relationships and the Lifecycle tab for detailed program usage patterns.`;
    } else if (questionLower.includes('depend')) {
        const foundDeps = analysisData.dependencyAnalysis?.summary?.foundCount || 0;
        const missingDeps = analysisData.dependencyAnalysis?.summary?.missingCount || 0;
        return `Dependency analysis shows ${foundDeps} dependencies found and ${missingDeps} missing. Check the Dependencies tab for the complete dependency mapping.`;
    } else {
        return `I'm having trouble accessing the LLM server right now. You can find detailed information about ${friendlyName} in the analysis tabs above, or try asking a more specific question about fields, programs, or dependencies.`;
    }
}
}
addChatMessage(sender, content) {
    const messagesContainer = document.getElementById('chatMessages');
    if (!messagesContainer) return;
const messageId = 'msg_' + Date.now();
const messageDiv = document.createElement('div');
messageDiv.className = `chat-message ${sender}`;
messageDiv.id = messageId;

// ✅ FIXED - Proper template literal with backticks
messageDiv.innerHTML = `
    <div class="sender">${sender === 'user' ? '👤 You' : '🤖 Analysis Assistant'}</div>
    <div class="content">${this.formatChatMessage(content)}</div>
    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
    ${sender === 'assistant' ? `
        <button class="export-btn" onclick="analyzer.exportChatMessage('${messageId}')" 
                style="position: absolute; top: 8px; right: 8px; background: rgba(30, 58, 138, 0.1); 
                       border: 1px solid #3b82f6; border-radius: 4px; padding: 4px 8px; 
                       font-size: 10px; color: #1e40af; cursor: pointer; opacity: 0; 
                       transition: opacity 0.2s ease;">
            📋 Copy
        </button>
    ` : ''}
`;

messagesContainer.appendChild(messageDiv);
messagesContainer.scrollTop = messagesContainer.scrollHeight;

this.chatHistory.push({
    id: messageId,
    sender: sender,
    content: content,
    timestamp: new Date().toISOString()
});

this.saveToStorage();
}
// === CORRECTED formatChatMessage FUNCTION ===
formatChatMessage(content) {
return content
.replace(/\n/g, '<br>')
// ✅ FIXED - Proper regex for bold text text
.replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #1e40af;">$1</strong>')
// ✅ FIXED - Proper regex for code blocks code
.replace(/`([^`]+)`/g, '<code style="background: rgba(59, 130, 246, 0.1); padding: 2px 4px; border-radius: 3px; color: #1e40af; font-family: monospace; font-size: 13px;">$1</code>')
.replace(/^- /gm, '• ')
.replace(/^• /gm, '<span style="color: #10b981; font-weight: bold;">•</span> ')
.replace(/🧠|⚖️|🔗|💡|🎯|📊|🔍|🚀|🌊|⚙️|🖥️|📤|📋|🔄|📖|💼|📁/g, '<span style="font-size: 1.1em;">$&</span>');
}


showChatTyping() {
const messagesContainer = document.getElementById('chatMessages');
if (!messagesContainer) return;
this.hideChatTyping();

const typingDiv = document.createElement('div');
typingDiv.id = 'typingIndicator';
typingDiv.className = 'chat-message assistant';
typingDiv.style.opacity = '0.7';

typingDiv.innerHTML = `
    <div class="sender">🤖 Analysis Assistant</div>
    <div class="content">
        <span>🤖 Analyzing your question...</span>
        <span style="animation: blink 1.5s infinite; margin-left: 5px;">●●●</span>
    </div>
`;

messagesContainer.appendChild(typingDiv);
messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
hideChatTyping() {
const typingIndicator = document.getElementById('typingIndicator');
if (typingIndicator && typingIndicator.parentNode) {
typingIndicator.parentNode.removeChild(typingIndicator);
}
}
exportChatMessage(messageId) {
const message = this.chatHistory.find(m => m.id === messageId);
if (message) {
navigator.clipboard.writeText(message.content).then(() => {
this.showSuccess('💬 Message copied to clipboard');
}).catch(() => {
// Fallback for older browsers
const textArea = document.createElement('textarea');
textArea.value = message.content;
document.body.appendChild(textArea);
textArea.select();
document.execCommand('copy');
document.body.removeChild(textArea);
this.showSuccess('💬 Message copied to clipboard');
});
}

// Add CSS for export button hover effect
const additionalChatStyles = `
<style>
.chat-message:hover .export-btn {
    opacity: 1 !important;
}

.export-btn:hover {
    background: rgba(59, 130, 246, 0.2) !important;
    transform: translateY(-1px);
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}
</style>
`;
// Add the additional styles to the document
document.head.insertAdjacentHTML('beforeend', additionalChatStyles);
// === SIMPLE LLM API CALL FOR CHAT ===
}
async callLLMAPI(prompt) {
try {

        const response = await fetch(`${this.vllmEndpoint}/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                max_tokens: Math.min(this.maxTokens * 0.5, 2000), // Conservative for chat
                temperature: 0.3, // Slightly higher for more natural chat
                top_p: 0.9,
                stream: false
            }),
            signal: AbortSignal.timeout(30000) // 30 second timeout for chat
        });
    if (!response.ok) {
        throw new Error(`LLM API request failed: ${response.status}`);
    }

    const data = await response.json();
    
    // Extract text from various response formats
    if (data.text) {
        return data.text.trim();
    } else if (data.choices && data.choices.length > 0) {
        if (data.choices[0].text) {
            return data.choices[0].text.trim();
        } else if (data.choices[0].message && data.choices[0].message.content) {
            return data.choices[0].message.content.trim();
        }
    } else if (data.generated_text) {
        return data.generated_text.trim();
    } else if (data.response) {
        return data.response.trim();
    } else if (typeof data === 'string') {
        return data.trim();
    }

    throw new Error('No valid text content in LLM response');

} catch (error) {
    console.error('Chat LLM API call failed:', error);
    throw error;
}
}

// Continue the EnhancedMainframeAnalyzer class - Analysis Core & Display Methods
// === MAIN COMPONENT ANALYSIS METHOD ===
async analyzeComponent() {
const componentName = document.getElementById('componentName').value.trim();
const friendlyName = document.getElementById('friendlyName').value.trim();
if (!componentName) {
    this.showError('Please enter a component name');
    return;
}

if (!this.serverValidated) {
    this.showError('Please validate LLM server connection first');
    return;
}

// Store friendly name if provided
if (friendlyName) {
    this.componentFriendlyNames[componentName] = friendlyName;
    this.saveToStorage();
}

this.showLoading();
this.updateProgress(0);

try {
    console.log(`=== Starting Analysis for Component: ${componentName} ===`);
    this.updateLoadingStatus('🚀 Initializing focused component analysis...');
    
    // Check if component exists in uploaded files
    const relevantFiles = this.findRelevantFiles(componentName);
    if (relevantFiles.length === 0) {
        throw new Error(`Component "${componentName}" not found in uploaded files. Please check the component name and ensure related files are uploaded.`);
    }

    console.log(`Found ${relevantFiles.length} relevant files:`, relevantFiles.map(f => f.name));

    const results = await this.runLLMEnhancedAnalysisWithLifecycle(componentName);
    
    // Store results
    this.analysisResults[componentName] = results;
    this.currentAnalyzedComponent = componentName;
    
    // Update UI
    this.displayAnalysisResults(componentName, results);
    this.enableChat();
    this.saveToStorage();
    
    this.hideLoading();
    // Enhanced results with field analysis
if (results.componentType === 'Copybook' && results.lifecycleFlow?.fieldAnalysis) {
    // Store detailed field categorization
    this.currentFieldAnalysis = results.lifecycleFlow.fieldAnalysis;
    
    // Update chat context
    this.enableEnhancedChat(componentName, results);
} else {
    this.enableChat();
}
    // Show success with details
    const displayName = this.getFriendlyName(componentName);
    const successMessage = `✅ Analysis complete for ${displayName}! 
    Quality: ${results.qualityScore}/10 | 
    Files: ${results.filesAnalyzed.length} | 
    Dependencies: ${results.dependencyAnalysis?.summary?.foundCount || 0} found, ${results.dependencyAnalysis?.summary?.missingCount || 0} missing`;
    
    this.showSuccess(successMessage);
    
    console.log(`=== Analysis Complete for ${componentName} ===`);
    
} catch (error) {
    this.hideLoading();
    console.error('Component analysis failed:', error);
    this.showError(`Analysis failed: ${error.message}`);
}
}
updateProgress(percentage) {
// Simple progress update - can be enhanced with actual progress bar
console.log("Progress: ${percentage}%");
}


// === REAL LLM ANALYSIS METHOD ===
async runLLMEnhancedAnalysisWithLifecycle(componentName) {
    console.log(`Starting real LLM analysis for: ${componentName}`);
    
    try {
        // Stage 1: Find relevant files and component type
        this.updateLoadingStatus('🔍 Stage 1: Analyzing component scope...');
        
        const relevantFiles = this.findRelevantFiles(componentName);
        if (relevantFiles.length === 0) {
            throw new Error(`Component "${componentName}" not found in uploaded files`);
        }
        
        const componentType = this.detectComponentType(componentName, relevantFiles);
        console.log(`Component type: ${componentType}, Files: ${relevantFiles.length}`);

        // Stage 2: Extract real dependencies
        this.updateLoadingStatus('🔗 Stage 2: Extracting dependencies...');
        
        const dependencyAnalysis = await this.extractRealDependencies(componentName, relevantFiles);

        // Stage 3: Extract focused lifecycle flow
this.updateLoadingStatus('🌊 Stage 3: Analyzing component lifecycle...');
this.updateProgress(50);

const lifecycleFlow = await this.extractRealLifecycleFlow(componentName, relevantFiles);

// Add field-wise analysis for copybooks
if (componentType === 'Copybook') {
    this.updateLoadingStatus('🔍 Stage 3b: Analyzing field-wise lifecycle...');
    lifecycleFlow.fieldAnalysis = await this.analyzeFieldWiseLifecycle(componentName, relevantFiles);
}

// Stage 4: LLM analysis with focused scope
this.updateLoadingStatus('🤖 Stage 4: Real LLM analysis...');
this.updateProgress(75);

let llmAnalysis;
try {
    if (componentType === 'Copybook') {
        llmAnalysis = await this.performRealLLMAnalysis(componentName, componentType, relevantFiles);
    } else if (componentType === 'COBOL Program') {
        llmAnalysis = await this.performRealLLMAnalysis(componentName, componentType, relevantFiles);
    } else {
        llmAnalysis = await this.performRealLLMAnalysis(componentName, componentType, relevantFiles);
    }
} catch (llmError) {
    console.error('LLM analysis failed:', llmError);
    llmAnalysis = {
        error: true,
        message: llmError.message,
        fallbackData: this.createComponentFallback(componentName, componentType, lifecycleFlow)
    };
}

// Stage 5: Finalize results (KEEP AS STAGE 5)
this.updateLoadingStatus('📊 Stage 5: Finalizing enhanced analysis...');
this.updateProgress(90);

        
        
        const qualityScore = this.calculateQualityScore(llmAnalysis, dependencyAnalysis);
        
        const results = {
            componentName: componentName,
            timestamp: new Date().toISOString(),
            filesAnalyzed: relevantFiles.map(f => f.name),
            componentType: componentType,
            dependencyAnalysis: dependencyAnalysis,
            lifecycleFlow: lifecycleFlow,
            llmAnalysis: llmAnalysis,
            qualityScore: qualityScore,
            completeness: { score: 85, checkpoints: {}, completed: 5, total: 6 },
            analysisMethod: 'LLM-Enhanced-Real'
        };

        return results;

    } catch (error) {
        console.error('Real analysis failed:', error);
        throw new Error(`Analysis failed: ${error.message}`);
    }
}

// === REAL DEPENDENCY EXTRACTION ===
// === REAL LLM ANALYSIS WITH INTELLIGENT CHUNKING ===
async extractRealDependencies(componentName, relevantFiles) {
    const found = {
        copyStatements: [],
        callStatements: [],
        programIds: [],
        fileReferences: []
    };
    const missing = {
        copyStatements: [],
        callStatements: [],
        programIds: [],
        fileReferences: []
    };

    // Extract dependencies from actual file content
    for (const file of relevantFiles) {
        const content = file.content.toUpperCase();
        const lines = content.split('\n');
        
        lines.forEach(line => {
            const trimmed = line.trim();
            
            // Extract COPY statements
            const copyMatch = trimmed.match(/COPY\s+([A-Z][A-Z0-9\-_]+)/);
            if (copyMatch && !found.copyStatements.includes(copyMatch[1])) {
                // Check if copybook exists in uploaded files
                const exists = this.uploadedFiles.some(f => 
                    f.name.toUpperCase().includes(copyMatch[1]) || 
                    f.content.toUpperCase().includes(copyMatch[1])
                );
                
                if (exists) {
                    found.copyStatements.push(copyMatch[1]);
                } else {
                    missing.copyStatements.push(copyMatch[1]);
                }
            }
            
            // Extract CALL statements
            const callMatch = trimmed.match(/CALL\s+['"]*([A-Z][A-Z0-9\-_]+)['"]*/) || 
                            trimmed.match(/PERFORM\s+([A-Z][A-Z0-9\-_]+)/);
            if (callMatch && !found.callStatements.includes(callMatch[1])) {
                found.callStatements.push(callMatch[1]);
            }
            
            // Extract file references
            const fileMatch = trimmed.match(/FD\s+([A-Z][A-Z0-9\-_]+)/) ||
                            trimmed.match(/SELECT\s+([A-Z][A-Z0-9\-_]+)/);
            if (fileMatch && !found.fileReferences.includes(fileMatch[1])) {
                found.fileReferences.push(fileMatch[1]);
            }
        });
    }

    return {
        found: found,
        missing: missing,
        summary: {
            foundCount: found.copyStatements.length + found.callStatements.length + found.fileReferences.length,
            missingCount: missing.copyStatements.length + missing.callStatements.length + missing.fileReferences.length
        }
    };
}

// === INTELLIGENT CHUNKING FOR LLM ANALYSIS ===
async performRealLLMAnalysis(componentName, componentType, relevantFiles) {
    // Prepare context from actual files with intelligent chunking
    let fileContext = `COMPONENT ANALYSIS REQUEST
Component: ${componentName}
Type: ${componentType}

UPLOADED FILE CONTENTS:
`;

    relevantFiles.forEach(file => {
        fileContext += `\n--- FILE: ${file.name} (${file.type}) ---\n`;
        // Use intelligent chunking to get relevant parts
        const relevantContent = this.intelligentChunkContent(file.content, componentType);
        fileContext += relevantContent;
        fileContext += '\n';
    });

    const analysisPrompt = `${fileContext}

ANALYSIS REQUIREMENTS:
1. Analyze the actual component "${componentName}" found in the uploaded files
2. Extract real field information if it's a copybook (01-level fields)
3. Identify actual program structure if it's a COBOL program
4. Find real business logic, validations, and calculations
5. Provide specific recommendations based on the actual code

IMPORTANT: Only analyze what exists in the uploaded files. Do not create fictional data.

Respond with a JSON object containing:
{
  "componentName": "${componentName}",
  "componentType": "${componentType}",
  "analysisScope": "REAL_FILE_ANALYSIS",
  "primaryFields": [...real fields found...],
  "businessLogic": {...actual logic found...},
  "recommendations": [...specific to this component...],
  "qualityScore": <1-10 based on actual code quality>
}`;

    try {
        const response = await this.callLLMAPI(analysisPrompt);
        
        // Try to parse JSON response
        try {
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const parsed = JSON.parse(jsonMatch[0]);
                return parsed;
            }
        } catch (parseError) {
            console.warn('Failed to parse LLM JSON response, using fallback');
        }
        
        // Fallback: create structured response from LLM text
        return this.parseUnstructuredLLMResponse(response, componentName, componentType);
        
    } catch (error) {
        console.error('LLM analysis failed:', error);
        // Return basic analysis based on file content
        return this.createBasicAnalysis(componentName, componentType, relevantFiles);
    }
}

// === INTELLIGENT CONTENT CHUNKING ===
intelligentChunkContent(content, componentType) {
    const maxChars = this.maxTokens * this.averageCharsPerToken * 0.6;
    
    if (content.length <= maxChars) {
        return content;
    }
    
    if (componentType === 'Copybook') {
        // Focus on field definitions and structures
        const lines = content.split('\n');
        const importantLines = [];
        
        lines.forEach((line, index) => {
            const trimmed = line.trim().toUpperCase();
            
            // Include 01-level fields and their subordinates
            if (trimmed.match(/^\s*\d+\s+[A-Z]/)) {
                importantLines.push(line);
                
                // Include next few lines for complete field definition
                for (let i = 1; i <= 3 && (index + i) < lines.length; i++) {
                    const nextLine = lines[index + i].trim();
                    if (nextLine.includes('PIC ') || nextLine.includes('VALUE ') || 
                        nextLine.includes('OCCURS ') || nextLine.includes('REDEFINES ')) {
                        importantLines.push(lines[index + i]);
                    }
                }
            }
        });
        
        let result = importantLines.join('\n');
        return result.substring(0, maxChars);
        
    } else if (componentType === 'COBOL Program') {
        // Focus on working storage and procedure division
        const workingStorageIndex = content.toUpperCase().indexOf('WORKING-STORAGE');
        const procedureIndex = content.toUpperCase().indexOf('PROCEDURE DIVISION');
        
        let importantContent = '';
        
        if (workingStorageIndex > -1) {
            const wsContent = content.substring(workingStorageIndex, procedureIndex > -1 ? procedureIndex : content.length);
            importantContent += wsContent.substring(0, maxChars / 2);
        }
        
        if (procedureIndex > -1) {
            const procContent = content.substring(procedureIndex);
            importantContent += procContent.substring(0, maxChars / 2);
        }
        
        return importantContent || content.substring(0, maxChars);
    }
    
    return content.substring(0, maxChars);
}

// === ENHANCED FIELD-WISE LIFECYCLE ANALYSIS ===
async analyzeFieldWiseLifecycle(componentName, relevantFiles) {
    const fieldLifecycle = {
        inputFields: [],     // Fields populated from external sources
        referenceFields: [], // Fields used for lookups/comparisons
        updatedFields: [],   // Fields modified during processing
        derivedFields: [],   // Fields calculated from other fields
        staticFields: [],    // Fields with constant values
        unusedFields: []     // Fields never referenced
    };
    
    // Extract all fields from copybook
    const extractedFields = this.extractCopybookFields(componentName, relevantFiles);
    const usingPrograms = this.findProgramsUsingCopybook(componentName);
    
    console.log(`Analyzing ${extractedFields.length} fields across ${usingPrograms.length} programs`);
    
    for (const field of extractedFields) {
        const fieldAnalysis = {
            name: field.name,
            level: field.level,
            picture: field.picture,
            usagePatterns: [],
            sourcePrograms: [],
            targetPrograms: [],
            operations: []
        };
        
        // Analyze field usage in each program
        for (const program of usingPrograms) {
            const usage = this.analyzeFieldUsageInProgram(field.name, program);
            
            if (usage.operations.length > 0) {
                fieldAnalysis.usagePatterns.push(usage);
                
                // Categorize based on operations
                const isInput = usage.isInput || usage.isWritten;
                const isOutput = usage.isDisplayed || usage.isRead;
                const isCalculated = usage.isCalculated;
                const isValidated = usage.isValidated;
                
                if (isInput && !isOutput) {
                    fieldAnalysis.category = 'INPUT';
                } else if (isOutput && !isInput) {
                    fieldAnalysis.category = 'OUTPUT';
                } else if (isCalculated) {
                    fieldAnalysis.category = 'DERIVED';
                } else if (isValidated) {
                    fieldAnalysis.category = 'REFERENCE';
                } else if (field.value) {
                    fieldAnalysis.category = 'STATIC';
                } else if (isInput && isOutput) {
                    fieldAnalysis.category = 'UPDATED';
                } else {
                    fieldAnalysis.category = 'UNUSED';
                }
            }
        }
        
        // If no usage found, mark as unused
        if (fieldAnalysis.usagePatterns.length === 0) {
            fieldAnalysis.category = 'UNUSED';
        }
        
        // Add to appropriate category
        switch (fieldAnalysis.category) {
            case 'INPUT':
                fieldLifecycle.inputFields.push(fieldAnalysis);
                break;
            case 'REFERENCE':
                fieldLifecycle.referenceFields.push(fieldAnalysis);
                break;
            case 'UPDATED':
                fieldLifecycle.updatedFields.push(fieldAnalysis);
                break;
            case 'DERIVED':
                fieldLifecycle.derivedFields.push(fieldAnalysis);
                break;
            case 'STATIC':
                fieldLifecycle.staticFields.push(fieldAnalysis);
                break;
            case 'UNUSED':
                fieldLifecycle.unusedFields.push(fieldAnalysis);
                break;
            default:
                fieldLifecycle.referenceFields.push(fieldAnalysis);
        }
    }
    
    return fieldLifecycle;
}



// === DISPLAY ANALYSIS RESULTS ===
// === ENHANCED FILE LIFECYCLE FLOW DIAGRAM ===
displayFileLifecycleDetails(lifecycleFlow) {
    const creationSources = lifecycleFlow.creationSources || [];
    const inputPrograms = lifecycleFlow.inputPrograms || [];
    const updatePrograms = lifecycleFlow.updatePrograms || [];
    const cicsScreens = lifecycleFlow.cicsScreens || [];
    const batchJobs = lifecycleFlow.batchJobs || [];
    
    return `
        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
            <h4 style="color: #8b5cf6; margin-bottom: 15px;">🌊 Complete Lifecycle Flow</h4>
            
            <!-- Flow Diagram -->
            <div style="margin-bottom: 25px;">
                <h5 style="color: #FFD700; margin-bottom: 15px;">📊 Visual Flow Diagram</h5>
                ${this.createLifecycleFlowDiagram(lifecycleFlow)}
            </div>
            
            <!-- Detailed Field Summary -->
            ${this.displayFieldLifecycleSummary(lifecycleFlow)}
            
            <!-- Program Flow Summary -->
            ${this.displayProgramFlowSummary(lifecycleFlow)}
        </div>
    `;
}

// === CREATE LIFECYCLE FLOW DIAGRAM ===
createLifecycleFlowDiagram(lifecycleFlow) {
    const stages = [
        { name: 'Creation', programs: lifecycleFlow.creationSources || [], color: '#22c55e', icon: '🌱' },
        { name: 'Input', programs: lifecycleFlow.inputPrograms || [], color: '#3b82f6', icon: '📥' },
        { name: 'Processing', programs: lifecycleFlow.updatePrograms || [], color: '#f59e0b', icon: '⚙️' },
        { name: 'Output', programs: [], color: '#8b5cf6', icon: '📤' }
    ];
    
    return `
        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; position: relative;">
            <!-- Flow Stages -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                ${stages.map((stage, index) => `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <!-- Stage Circle -->
                        <div style="
                            width: 80px; 
                            height: 80px; 
                            background: ${stage.color}; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 24px; 
                            margin-bottom: 8px;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                        ">
                            ${stage.icon}
                        </div>
                        
                        <!-- Stage Name -->
                        <div style="font-weight: bold; color: ${stage.color}; margin-bottom: 5px;">
                            ${stage.name}
                        </div>
                        
                        <!-- Program Count -->
                        <div style="font-size: 12px; opacity: 0.8;">
                            ${stage.programs.length} programs
                        </div>
                        
                        <!-- Arrow to next stage -->
                        ${index < stages.length - 1 ? `
                            <div style="
                                position: absolute; 
                                top: 40px; 
                                left: ${(index + 1) * 25 - 2}%; 
                                width: 0; 
                                height: 0; 
                                border-left: 10px solid transparent; 
                                border-right: 10px solid transparent; 
                                border-top: 15px solid #64748b;
                                transform: rotate(90deg);
                            "></div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
            
            <!-- Component in Center -->
            <div style="text-align: center; margin: 20px 0;">
                <div style="
                    display: inline-block; 
                    background: linear-gradient(135deg, #FFD700, #FFA500); 
                    color: #000; 
                    padding: 12px 24px; 
                    border-radius: 25px; 
                    font-weight: bold; 
                    font-size: 16px;
                    box-shadow: 0 6px 12px rgba(255, 215, 0, 0.3);
                ">
                    📋 ${lifecycleFlow.componentName}
                </div>
            </div>
        </div>
    `;
}

// === FIELD LIFECYCLE SUMMARY ===
displayFieldLifecycleSummary(lifecycleFlow) {
    if (!lifecycleFlow.fieldAnalysis) {
        return '';
    }
    
    const fieldAnalysis = lifecycleFlow.fieldAnalysis;
    
    return `
        <div style="margin-top: 25px;">
            <h5 style="color: #4CAF50; margin-bottom: 15px;">📋 Field Lifecycle Summary</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                
                <!-- Input Fields -->
                <div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <h6 style="color: #22c55e; margin-bottom: 10px;">📥 Input Fields (${fieldAnalysis.inputFields?.length || 0})</h6>
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${(fieldAnalysis.inputFields || []).slice(0, 5).map(field => `
                            <div style="font-size: 10px; font-family: monospace; padding: 2px 4px; margin: 2px 0; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                ${field.name} (${field.level})
                            </div>
                        `).join('')}
                        ${(fieldAnalysis.inputFields?.length || 0) > 5 ? `<div style="font-size: 9px; opacity: 0.7;">+${(fieldAnalysis.inputFields?.length || 0) - 5} more</div>` : ''}
                    </div>
                </div>
                
                <!-- Reference Fields -->
                <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h6 style="color: #f59e0b; margin-bottom: 10px;">🔍 Reference Fields (${fieldAnalysis.referenceFields?.length || 0})</h6>
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${(fieldAnalysis.referenceFields || []).slice(0, 5).map(field => `
                            <div style="font-size: 10px; font-family: monospace; padding: 2px 4px; margin: 2px 0; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                ${field.name} (${field.level})
                            </div>
                        `).join('')}
                        ${(fieldAnalysis.referenceFields?.length || 0) > 5 ? `<div style="font-size: 9px; opacity: 0.7;">+${(fieldAnalysis.referenceFields?.length || 0) - 5} more</div>` : ''}
                    </div>
                </div>
                
                <!-- Updated Fields -->
                <div style="background: rgba(156, 39, 176, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                    <h6 style="color: #9C27B0; margin-bottom: 10px;">✏️ Updated Fields (${fieldAnalysis.updatedFields?.length || 0})</h6>
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${(fieldAnalysis.updatedFields || []).slice(0, 5).map(field => `
                            <div style="font-size: 10px; font-family: monospace; padding: 2px 4px; margin: 2px 0; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                ${field.name} (${field.level})
                            </div>
                        `).join('')}
                        ${(fieldAnalysis.updatedFields?.length || 0) > 5 ? `<div style="font-size: 9px; opacity: 0.7;">+${(fieldAnalysis.updatedFields?.length || 0) - 5} more</div>` : ''}
                    </div>
                </div>
                
                <!-- Derived Fields -->
                <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h6 style="color: #3b82f6; margin-bottom: 10px;">🧮 Derived Fields (${fieldAnalysis.derivedFields?.length || 0})</h6>
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${(fieldAnalysis.derivedFields || []).slice(0, 5).map(field => `
                            <div style="font-size: 10px; font-family: monospace; padding: 2px 4px; margin: 2px 0; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                ${field.name} (${field.level})
                            </div>
                        `).join('')}
                        ${(fieldAnalysis.derivedFields?.length || 0) > 5 ? `<div style="font-size: 9px; opacity: 0.7;">+${(fieldAnalysis.derivedFields?.length || 0) - 5} more</div>` : ''}
                    </div>
                </div>
                
                <!-- Static Fields -->
                <div style="background: rgba(107, 114, 128, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #6b7280;">
                    <h6 style="color: #6b7280; margin-bottom: 10px;">🔒 Static Fields (${fieldAnalysis.staticFields?.length || 0})</h6>
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${(fieldAnalysis.staticFields || []).slice(0, 5).map(field => `
                            <div style="font-size: 10px; font-family: monospace; padding: 2px 4px; margin: 2px 0; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                ${field.name} (${field.level})
                            </div>
                        `).join('')}
                        ${(fieldAnalysis.staticFields?.length || 0) > 5 ? `<div style="font-size: 9px; opacity: 0.7;">+${(fieldAnalysis.staticFields?.length || 0) - 5} more</div>` : ''}
                    </div>
                </div>
                
                <!-- Unused Fields -->
                <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                    <h6 style="color: #ef4444; margin-bottom: 10px;">❌ Unused Fields (${fieldAnalysis.unusedFields?.length || 0})</h6>
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${(fieldAnalysis.unusedFields || []).slice(0, 5).map(field => `
                            <div style="font-size: 10px; font-family: monospace; padding: 2px 4px; margin: 2px 0; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                ${field.name} (${field.level})
                            </div>
                        `).join('')}
                        ${(fieldAnalysis.unusedFields?.length || 0) > 5 ? `<div style="font-size: 9px; opacity: 0.7;">+${(fieldAnalysis.unusedFields?.length || 0) - 5} more</div>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// === DISPLAY MAIN ANALYSIS ===
displayMainAnalysis(componentName, results) {
const container = document.getElementById('lifecycleContent');
if (!container) return;
const friendlyName = this.getFriendlyName(componentName);

let html = `
    <div style="margin-bottom: 20px;">
        <h3 style="color: #1e40af; margin-bottom: 8px;">🤖 Analysis: ${friendlyName}</h3>
        <div style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
            <strong>Technical Name:</strong> <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">${componentName}</code> • 
            <strong>Type:</strong> ${results.componentType} • 
            <strong>Method:</strong> ${results.analysisMethod} • 
            <strong>Files:</strong> ${results.filesAnalyzed.length} • 
            <strong>Completed:</strong> ${new Date(results.timestamp).toLocaleString()}
        </div>
    </div>
    
    <!-- Quality Metrics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
        <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #10b981;">
            <div style="font-size: 1.4rem; font-weight: bold; color: #059669;">${results.qualityScore}/10</div>
            <div style="font-size: 11px; color: #064e3b;">Analysis Quality</div>
        </div>
        <div style="background: #eff6ff; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #3b82f6;">
            <div style="font-size: 1.4rem; font-weight: bold; color: #1d4ed8;">${results.completeness.score}%</div>
            <div style="font-size: 11px; color: #1e3a8a;">Completeness</div>
        </div>
        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #f59e0b;">
            <div style="font-size: 1.4rem; font-weight: bold; color: #d97706;">${results.filesAnalyzed.length}</div>
            <div style="font-size: 11px; color: #92400e;">Files Analyzed</div>
        </div>
        <div style="background: #f3e8ff; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #8b5cf6;">
            <div style="font-size: 1.2rem; font-weight: bold; color: #7c3aed;">${results.lifecycleFlow ? results.lifecycleFlow.scope : 'N/A'}</div>
            <div style="font-size: 11px; color: #5b21b6;">Analysis Scope</div>
        </div>
    </div>
`;

// Display dependency analysis
if (results.dependencyAnalysis) {
    html += this.displayDependencyAnalysis(results.dependencyAnalysis);
}

// Display LLM analysis results
if (results.llmAnalysis) {
    html += this.displayLLMResults(results.llmAnalysis, results.componentType);
}

// Display lifecycle flow summary
if (results.lifecycleFlow) {
    html += this.displayLifecycleFlowSummary(results.lifecycleFlow);
}

container.innerHTML = html;
}
// === DISPLAY DEPENDENCY ANALYSIS ===
displayDependencyAnalysis(dependencyAnalysis) {
const found = dependencyAnalysis.found || {};
const missing = dependencyAnalysis.missing || {};
const summary = dependencyAnalysis.summary || { foundCount: 0, missingCount: 0 };
return `
    <div style="background: #eff6ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 20px;">
        <h4 style="color: #1e40af; margin-bottom: 12px;">🔗 Dependency Analysis</h4>
        
        <!-- Summary -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div style="text-align: center; background: #f0fdf4; padding: 10px; border-radius: 6px; border: 1px solid #bbf7d0;">
                <div style="font-size: 1.3rem; font-weight: bold; color: #059669;">${summary.foundCount}</div>
                <div style="font-size: 11px; color: #064e3b;">✅ Dependencies Found</div>
            </div>
            <div style="text-align: center; background: #fef2f2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca;">
                <div style="font-size: 1.3rem; font-weight: bold; color: #dc2626;">${summary.missingCount}</div>
                <div style="font-size: 11px; color: #991b1b;">❌ Dependencies Missing</div>
            </div>
        </div>

        <!-- Detailed Dependencies -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="background: #f0fdf4; padding: 12px; border-radius: 6px; border: 1px solid #bbf7d0;">
                <div style="font-weight: 600; color: #059669; font-size: 12px; margin-bottom: 8px;">✅ Available Dependencies</div>
                <div style="font-size: 11px;">
                    <div><strong>Copybooks:</strong> ${(found.copyStatements || []).join(', ') || 'None'}</div>
                    <div><strong>Programs:</strong> ${(found.callStatements || []).join(', ') || 'None'}</div>
                    <div><strong>Files:</strong> ${(found.fileReferences || []).join(', ') || 'None'}</div>
                </div>
            </div>
            <div style="background: #fef2f2; padding: 12px; border-radius: 6px; border: 1px solid #fecaca;">
                <div style="font-weight: 600; color: #dc2626; font-size: 12px; margin-bottom: 8px;">❌ Missing Dependencies</div>
                <div style="font-size: 11px;">
                    <div><strong>Copybooks:</strong> ${(missing.copyStatements || []).join(', ') || 'None'}</div>
                    <div><strong>Programs:</strong> ${(missing.callStatements || []).join(', ') || 'None'}</div>
                    <div><strong>Files:</strong> ${(missing.fileReferences || []).join(', ') || 'None'}</div>
                </div>
            </div>
        </div>
    </div>
`;
}

// Continue the EnhancedMainframeAnalyzer class - Display Methods & Export Functionality
// === DISPLAY LLM RESULTS ===
displayLLMResults(llmAnalysis, componentType) {
if (componentType === 'Copybook') {
return this.displayCopybookLLMResults(llmAnalysis);
} else if (componentType === 'COBOL Program') {
return this.displayProgramLLMResults(llmAnalysis);
} else {
return this.displayGenericLLMResults(llmAnalysis);
}
}
// === DISPLAY COPYBOOK LLM RESULTS ===
displayCopybookLLMResults(llmAnalysis) {
let html =      `   <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 20px;">             <h4 style="color: #059669; margin-bottom: 12px;">🤖 Copybook Analysis Results</h4>    </div>`;
// Component info
if (llmAnalysis.componentName || llmAnalysis.totalFields) {
    html += `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 16px;">
            ${llmAnalysis.componentName ? `
                <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 4px;">
                    <div style="font-size: 12px; font-weight: bold; color: #059669;">${this.getFriendlyName(llmAnalysis.componentName)}</div>
                    <div style="font-size: 9px; color: #064e3b;">Component</div>
                </div>
            ` : ''}
            ${llmAnalysis.totalFields ? `
                <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 4px;">
                    <div style="font-size: 12px; font-weight: bold; color: #1d4ed8;">${llmAnalysis.totalFields}</div>
                    <div style="font-size: 9px; color: #1e3a8a;">Total Fields</div>
                </div>
            ` : ''}
            ${llmAnalysis.analysisScope ? `
                <div style="text-align: center; background: rgba(139, 92, 246, 0.1); padding: 8px; border-radius: 4px;">
                    <div style="font-size: 12px; font-weight: bold; color: #7c3aed;">${llmAnalysis.analysisScope}</div>
                    <div style="font-size: 9px; color: #5b21b6;">Scope</div>
                </div>
            ` : ''}
        </div>
        
    `
    
}


// Primary fields
if ((llmAnalysis.primaryFields && llmAnalysis.primaryFields.length) > 0) {
    html += `
        <div style="margin-bottom: 16px;">
            <h5 style="color: #059669; margin-bottom: 8px; font-size: 14px;">📋 Field Analysis (${llmAnalysis.primaryFields.length} fields):</h5>
            <div style="background: rgba(255,255,255,0.5); padding: 12px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                ${llmAnalysis.primaryFields.map(field => `
                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(16, 185, 129, 0.05); border-radius: 4px; border-left: 3px solid #10b981;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="font-family: monospace; color: #1e40af; font-size: 13px;">${field.name}</strong>
                            <span style="font-size: 10px; background: #10b981; color: white; padding: 2px 6px; border-radius: 3px;">
                                ${field.usagePattern || 'ANALYZED'}
                            </span>
                        </div>
                        ${field.businessPurpose ? `
                            <div style="font-size: 11px; margin-top: 4px; color: #374151;">${field.businessPurpose}</div>
                        ` : ''}
                        ${field.picture ? `
                            <div style="font-size: 10px; margin-top: 2px; color: #6b7280; font-family: monospace;">PIC: ${field.picture}</div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// Field categories
if (llmAnalysis.fieldCategories) {
    html += this.displayFieldCategories(llmAnalysis.fieldCategories);
}

// Program usage
if (llmAnalysis.programUsage) {
    html += `
        <div style="margin-bottom: 16px;">
            <h5 style="color: #059669; margin-bottom: 8px; font-size: 14px;">🖥️ Program Usage:</h5>
            <div style="background: rgba(255,255,255,0.5); padding: 10px; border-radius: 6px;">
                <div style="font-size: 12px;"><strong>Total Programs:</strong> ${llmAnalysis.programUsage.totalPrograms}</div>
                <div style="font-size: 11px; margin-top: 4px; color: #6b7280;">
                    ${(llmAnalysis.programUsage.programNames || []).join(', ') || 'No programs listed'}
                </div>
            </div>
        </div>
    `;
}

// Recommendations
if (llmAnalysis.recommendations && llmAnalysis.recommendations.length > 0) {
    html += `
        <div>
            <h5 style="color: #d97706; margin-bottom: 8px; font-size: 14px;">💡 Recommendations:</h5>
            <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 6px;">
                ${llmAnalysis.recommendations.map((rec, index) => `
                    <div style="margin-bottom: 6px; padding: 6px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 11px;">
                        <strong style="color: #d97706;">💡 ${index + 1}.</strong> ${rec}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

html += '</div>';
return html;
}
// === DISPLAY FIELD CATEGORIES ===
displayFieldCategories(fieldCategories) {
return `
<div style="margin-bottom: 16px;">
<h5 style="color: #059669; margin-bottom: 8px; font-size: 14px;">📊 Field Categorization:</h5>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
            <!-- Input Fields -->
            <div style="background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.2);">
                <h6 style="color: #059669; margin-bottom: 4px; font-size: 11px;">📥 Input (${(fieldCategories.inputFields || []).length})</h6>
                <div style="max-height: 60px; overflow-y: auto; font-size: 9px; font-family: monospace;">
                    ${(fieldCategories.inputFields || []).map(field => `
                        <div style="padding: 1px; color: #374151;">${field}</div>
                    `).join('') || '<div style="color: #9ca3af;">None</div>'}
                </div>
            </div>
            
            <!-- Output Fields -->
            <div style="background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <h6 style="color: #1d4ed8; margin-bottom: 4px; font-size: 11px;">📤 Output (${(fieldCategories.outputFields || []).length})</h6>
                <div style="max-height: 60px; overflow-y: auto; font-size: 9px; font-family: monospace;">
                    ${(fieldCategories.outputFields || []).map(field => `
                        <div style="padding: 1px; color: #374151;">${field}</div>
                    `).join('') || '<div style="color: #9ca3af;">None</div>'}
                </div>
            </div>
            
            <!-- Reference Fields -->
            <div style="background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.2);">
                <h6 style="color: #d97706; margin-bottom: 4px; font-size: 11px;">📋 Reference (${(fieldCategories.referenceFields || []).length})</h6>
                <div style="max-height: 60px; overflow-y: auto; font-size: 9px; font-family: monospace;">
                    ${(fieldCategories.referenceFields || []).map(field => `
                        <div style="padding: 1px; color: #374151;">${field}</div>
                   

`).join('') || '<div style="color: #9ca3af;">None</div>'}
</div>
</div>
            <!-- Unused Fields -->
            ${(fieldCategories.unusedFields || []).length > 0 ? `
                <div style="background: rgba(107, 114, 128, 0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(107, 114, 128, 0.2);">
                    <h6 style="color: #6b7280; margin-bottom: 4px; font-size: 11px;">❌ Unused (${fieldCategories.unusedFields.length})</h6>
                    <div style="max-height: 60px; overflow-y: auto; font-size: 9px; font-family: monospace;">
                        ${fieldCategories.unusedFields.map(field => `
                            <div style="padding: 1px; color: #374151;">${field}</div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    </div>
`;
}
// === DISPLAY PROGRAM LLM RESULTS ===
displayProgramLLMResults(llmAnalysis) {
let html = `        <div style="background: #eff6ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 20px;">             <h4 style="color: #1d4ed8; margin-bottom: 12px;">🤖 COBOL Program Analysis Results</h4>    `;
// Program info
if (llmAnalysis.componentName) {
    html += `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 16px;">
            <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; font-weight: bold; color: #1d4ed8;">${this.getFriendlyName(llmAnalysis.componentName)}</div>
                <div style="font-size: 9px; color: #1e3a8a;">Program</div>
            </div>
            ${llmAnalysis.complexity ? `
                <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: 4px;">
                    <div style="font-size: 12px; font-weight: bold; color: #d97706;">${llmAnalysis.complexity}</div>
                    <div style="font-size: 9px; color: #92400e;">Complexity</div>
                </div>
            ` : ''}
            ${llmAnalysis.lifecycleRole?.primaryFunction ? `
                <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 4px;">
                    <div style="font-size: 12px; font-weight: bold; color: #059669;">${llmAnalysis.lifecycleRole.primaryFunction}</div>
                    <div style="font-size: 9px; color: #064e3b;">Function</div>
                </div>
            ` : ''}
        </div>
    `;
}

// Program structure
if (llmAnalysis.programStructure) {
    html += `
        <div style="margin-bottom: 16px;">
            <h5 style="color: #1d4ed8; margin-bottom: 8px; font-size: 14px;">🏗️ Program Structure:</h5>
            <div style="background: rgba(255,255,255,0.5); padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 11px;">
                    ${llmAnalysis.programStructure.divisions ? `
                        <div><strong style="color: #059669;">Divisions:</strong><br>${Array.isArray(llmAnalysis.programStructure.divisions) ? llmAnalysis.programStructure.divisions.join(', ') : llmAnalysis.programStructure.divisions}</div>
                    ` : ''}
                    ${llmAnalysis.programStructure.paragraphs && llmAnalysis.programStructure.paragraphs.length > 0 ? `
                        <div><strong style="color: #d97706;">Paragraphs:</strong><br>${llmAnalysis.programStructure.paragraphs.length} found</div>
                    ` : ''}
                    ${llmAnalysis.programStructure.sections && llmAnalysis.programStructure.sections.length > 0 ? `
                        <div><strong style="color: #7c3aed;">Sections:</strong><br>${llmAnalysis.programStructure.sections.length} found</div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// Business logic
if (llmAnalysis.businessLogic) {
    html += `
        <div style="margin-bottom: 16px;">
            <h5 style="color: #d97706; margin-bottom: 8px; font-size: 14px;">⚖️ Business Logic:</h5>
            <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 11px;">
                    ${llmAnalysis.businessLogic.validationRules && llmAnalysis.businessLogic.validationRules.length > 0 ? `
                        <div><strong>Validations:</strong> ${llmAnalysis.businessLogic.validationRules.length} rules</div>
                    ` : ''}
                    ${llmAnalysis.businessLogic.calculations && llmAnalysis.businessLogic.calculations.length > 0 ? `
                        <div><strong>Calculations:</strong> ${llmAnalysis.businessLogic.calculations.length} operations</div>
                    ` : ''}
                    ${llmAnalysis.businessLogic.decisionPoints && llmAnalysis.businessLogic.decisionPoints.length > 0 ? `
                        <div><strong>Decisions:</strong> ${llmAnalysis.businessLogic.decisionPoints.length} points</div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// Dependencies
if (llmAnalysis.dependencies) {
    html += this.displayProgramDependencies(llmAnalysis.dependencies);
}

// Recommendations
if (llmAnalysis.recommendations && llmAnalysis.recommendations.length > 0) {
    html += `
        <div>
            <h5 style="color: #d97706; margin-bottom: 8px; font-size: 14px;">💡 Recommendations:</h5>
            <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 6px;">
                ${llmAnalysis.recommendations.map((rec, index) => `
                    <div style="margin-bottom: 6px; padding: 6px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 11px;">
                        <strong style="color: #d97706;">💡 ${index + 1}.</strong> ${rec}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

html += '</div>';
return html;
}
// === DISPLAY PROGRAM DEPENDENCIES ===
displayProgramDependencies(dependencies) {
return         `<div style="margin-bottom: 16px;">             <h5 style="color: #1d4ed8; margin-bottom: 8px; font-size: 14px;">🔗 Program Dependencies:</h5>             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">                 <div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.2);">                     <div style="font-weight: bold; color: #059669; font-size: 12px; margin-bottom: 5px;">✅ Available</div>                     <div style="font-size: 10px;">                         <div><strong>Copybooks:</strong> ${(dependencies.copybooks || []).slice(0, 3).join(', ') || 'None'}</div>                         <div><strong>Programs:</strong> ${(dependencies.calledPrograms || []).slice(0, 3).join(', ') || 'None'}</div>                     </div>                 </div>                 <div style="background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.2);">                     <div style="font-weight: bold; color: #dc2626; font-size: 12px; margin-bottom: 5px;">❌ Missing</div>                     <div style="font-size: 10px;">                         <div><strong>Copybooks:</strong> ${(dependencies.missingCopybooks || []).slice(0, 3).join(', ') || 'None'}</div>                         <div><strong>Programs:</strong> ${(dependencies.missingPrograms || []).slice(0, 3).join(', ') || 'None'}</div>                     </div>                 </div>             </div>         </div>    `;
}
// === DISPLAY GENERIC LLM RESULTS ===
displayGenericLLMResults(llmAnalysis) {
let html =         `<div style="background: #f3e8ff; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6; margin-bottom: 20px;">             <h4 style="color: #7c3aed; margin-bottom: 12px;">🤖 Component Analysis Results</h4>    `;
// Component info
if (llmAnalysis.componentName) {
    html += `
        <div style="margin-bottom: 16px;">
            <div style="text-align: center; background: rgba(139, 92, 246, 0.1); padding: 10px; border-radius: 6px;">
                <div style="font-size: 14px; font-weight: bold; color: #7c3aed;">${this.getFriendlyName(llmAnalysis.componentName)}</div>
                <div style="font-size: 10px; color: #5b21b6;">Component Analysis</div>
            </div>
        </div>
    `;
}

// Purpose and key elements
if (llmAnalysis.purpose || llmAnalysis.keyElements) {
    html += `
        <div style="background: rgba(255,255,255,0.5); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
            ${llmAnalysis.purpose ? `
                <div style="margin-bottom: 10px;">
                    <h5 style="color: #7c3aed; margin-bottom: 4px; font-size: 13px;">🎯 Purpose:</h5>
                    <p style="font-size: 12px; margin: 0; color: #374151;">${llmAnalysis.purpose}</p>
                </div>
            ` : ''}
            ${llmAnalysis.keyElements && llmAnalysis.keyElements.length > 0 ? `
                <div>
                    <h5 style="color: #7c3aed; margin-bottom: 4px; font-size: 13px;">🔑 Key Elements:</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                        ${llmAnalysis.keyElements.map(element => `
                            <span style="background: rgba(139, 92, 246, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; border: 1px solid rgba(139, 92, 246, 0.2);">
                                ${element}
                            </span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// Recommendations
if (llmAnalysis.recommendations && llmAnalysis.recommendations.length > 0) {
    html += `
        <div>
            <h5 style="color: #d97706; margin-bottom: 8px; font-size: 14px;">💡 Recommendations:</h5>
            <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 6px;">
                ${llmAnalysis.recommendations.map((rec, index) => `
                    <div style="margin-bottom: 6px; padding: 6px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 11px;">
                        <strong style="color: #d97706;">💡 ${index + 1}.</strong> ${rec}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

html += '</div>';
return html;
}
// === DISPLAY LIFECYCLE FLOW SUMMARY ===
displayLifecycleFlowSummary(lifecycleFlow) {
if (!lifecycleFlow) return '';
const creationCount = (lifecycleFlow.creationSources && Array.isArray(lifecycleFlow.creationSources)) 
    ? lifecycleFlow.creationSources.length : 0;
const inputCount = (lifecycleFlow.inputPrograms && Array.isArray(lifecycleFlow.inputPrograms)) 
    ? lifecycleFlow.inputPrograms.length : 0;
const updateCount = (lifecycleFlow.updatePrograms && Array.isArray(lifecycleFlow.updatePrograms)) 
    ? lifecycleFlow.updatePrograms.length : 0;
const primaryFieldCount = (lifecycleFlow.primaryFields && Array.isArray(lifecycleFlow.primaryFields)) 
    ? lifecycleFlow.primaryFields.length : 0;

return `
    <div style="background: #f3e8ff; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6; margin-bottom: 20px;">
        <h4 style="color: #7c3aed; margin-bottom: 12px;">🌊 Component Lifecycle Summary</h4>
        
        <div style="margin-bottom: 12px; text-align: center;">
            <span style="background: ${this.getUsagePatternColor(lifecycleFlow.usagePattern || 'UNKNOWN')}; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">
                ${(lifecycleFlow.usagePattern || 'UNKNOWN').replace(/_/g, ' ')}
            </span>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
            ${primaryFieldCount > 0 ? `
                <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: 6px;">
                    <div style="font-size: 1.1rem; font-weight: bold; color: #d97706;">${primaryFieldCount}</div>
                    <div style="font-size: 9px; color: #92400e;">📋 Fields</div>
                </div>
            ` : ''}
            <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 6px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: #059669;">${creationCount}</div>
                <div style="font-size: 9px; color: #064e3b;">🌱 Creation</div>
            </div>
            <div style="text-align: center; background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 6px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: #1d4ed8;">${inputCount}</div>
                <div style="font-size: 9px; color: #1e3a8a;">📖 Reading</div>
            </div>
            <div style="text-align: center; background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: 6px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: #d97706;">${updateCount}</div>
                <div style="font-size: 9px; color: #92400e;">⚙️ Updating</div>
            </div>
        </div>
    </div>
`;
}
getUsagePatternColor(pattern) {
const colors = {
'ONLINE_TRANSACTIONAL': '#059669',
'BATCH_PROCESSING': '#1d4ed8',
'READ_ONLY': '#6b7280',
'CREATION_ONLY': '#d97706',
'UPDATE_ONLY': '#dc2626',
'FULL_LIFECYCLE': '#7c3aed',
'REFERENCE_ONLY': '#64748b'
};
return colors[pattern] || '#64748b';
}
// === OTHER TAB DISPLAY METHODS ===
displayFieldMatrix(componentName, results) {
const container = document.getElementById('fieldMatrixContent');
if (!container) return;
const friendlyName = this.getFriendlyName(componentName);

let html = `
    <h3 style="color: #1e40af; margin-bottom: 8px;">📋 Field Matrix: ${friendlyName}</h3>
    <p style="margin-bottom: 16px; color: #64748b;">
        Field-level analysis with usage patterns and business context.
    </p>
`;

if (results.componentType === 'Copybook' && results.llmAnalysis?.primaryFields) {
    html += this.displayDetailedFieldMatrix(results.llmAnalysis.primaryFields);
} else {
    html += `
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
            <p style="color: #64748b;">
                ${results.componentType === 'Copybook' ? 
                    'Field matrix requires copybook field analysis. The analysis may need to be re-run.' : 
                    'Field matrix analysis is available for copybook components.'}
            </p>
        </div>
    `;
}

container.innerHTML = html;
}
displayDetailedFieldMatrix(primaryFields) {
if (!primaryFields || !Array.isArray(primaryFields) || primaryFields.length === 0) {
return             `<div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">                 <p style="color: #64748b;">No field data available for matrix display.</p>             </div>        `;
}
return `
    <div style="background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h4 style="color: #1e40af; margin-bottom: 12px;">🤖 Field Analysis Matrix (${primaryFields.length} fields)</h4>
        
        <div style="overflow-x: auto; margin-bottom: 16px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; color: #1e40af; font-weight: 600;">Field Name</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #e2e8f0; color: #059669; font-weight: 600;">Level</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #e2e8f0; color: #1d4ed8; font-weight: 600;">Usage Pattern</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #e2e8f0; color: #d97706; font-weight: 600;">Picture</th>
                        <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; color: #7c3aed; font-weight: 600;">Business Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    ${primaryFields.map(field => `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 6px 8px; font-family: monospace; font-weight: 600; color: #1e40af;">
                                ${field.name || field.fieldName || 'Unknown'}
                            </td>
                            <td style="padding: 6px 8px; text-align: center; color: #059669;">
                                ${field.level || '05'}
                            </td>
                            <td style="padding: 6px 8px; text-align: center;">
                                <span style="padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; color: white; background: ${this.getUsagePatternColor(field.usagePattern || 'UNKNOWN')};">
                                    ${field.usagePattern || 'UNKNOWN'}
                                </span>
                            </td>
                            <td style="padding: 6px 8px; text-align: center; font-family: monospace; font-size: 10px; color: #d97706;">
                                ${field.picture || field.pic || '-'}
                            </td>
                            <td style="padding: 6px 8px; font-size: 10px; max-width: 200px; word-wrap: break-word; color: #374151;">
                                ${field.businessPurpose || field.purpose || field.description || 'Business field'}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    </div>
`;
}
displayUsagePatterns(componentName, results) {
const container = document.getElementById('usageContent');
if (!container) return;
const friendlyName = this.getFriendlyName(componentName);

let html = `
    <h3 style="color: #1e40af; margin-bottom: 8px;">📈 Usage Patterns: ${friendlyName}</h3>
    <p style="margin-bottom: 16px; color: #64748b;">Component usage pattern analysis with lifecycle tracking.</p>
`;

if (results.lifecycleFlow) {
    html += this.displayUsagePatternDetails(results.lifecycleFlow);
} else {
    html += `
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
            <p style="color: #64748b;">Usage patterns will appear here after analysis.</p>
        </div>
    `;
}

container.innerHTML = html;
}
displayUsagePatternDetails(lifecycleFlow) {
return `
<div style="background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
<h4 style="color: #1e40af; margin-bottom: 12px;">📊 Usage Pattern Analysis</h4>
        <div style="margin-bottom: 16px;">
            <h5 style="color: #7c3aed; margin-bottom: 8px;">Pattern: ${lifecycleFlow.usagePattern}</h5>
            <div style="background: ${this.getUsagePatternColor(lifecycleFlow.usagePattern)}; color: white; padding: 8px; border-radius: 6px; text-align: center; font-weight: 600;">
                ${lifecycleFlow.usagePattern.replace(/_/g, ' ')}
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
            <div style="background: #f0fdf4; padding: 12px; border-radius: 6px; border: 1px solid #bbf7d0;">
                <h6 style="color: #059669; margin-bottom: 8px; font-size: 13px;">🌱 Creation Sources</h6>
                <div style="font-size: 12px; font-weight: 600;">${lifecycleFlow.creationSources.length} programs</div>
                ${lifecycleFlow.creationSources.slice(0, 3).map(s => `
                    <div style="font-size: 10px; margin-top: 4px; color: #064e3b;">${s.program}</div>
                `).join('')}
            </div>
            
            <div style="background: #eff6ff; padding: 12px; border-radius: 6px; border: 1px solid #bfdbfe;">
                <h6 style="color: #1d4ed8; margin-bottom: 8px; font-size: 13px;">📖 Reading Programs</h6>
                <div style="font-size: 12px; font-weight: 600;">${lifecycleFlow.inputPrograms.length} programs</div>
                ${lifecycleFlow.inputPrograms.slice(0, 3).map(p => `
                    <div style="font-size: 10px; margin-top: 4px; color: #1e3a8a;">${p.program}</div>
                `).join('')}
            </div>
            
            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 1px solid #fed7aa;">
                <h6 style="color: #d97706; margin-bottom: 8px; font-size: 13px;">⚙️ Update Programs</h6>
                <div style="font-size: 12px; font-weight: 600;">${lifecycleFlow.updatePrograms.length} programs</div>
                ${lifecycleFlow.updatePrograms.slice(0, 3).map(u => `
                    <div style="font-size: 10px; margin-top: 4px; color: #92400e;">${u.program}</div>
                `).join('')}
            </div>
        </div>
    </div>
`;
}
displayDependencies(componentName, results) {
const container = document.getElementById('dependenciesContent');
if (!container) return;
const friendlyName = this.getFriendlyName(componentName);

let html = `
    <h3 style="color: #1e40af; margin-bottom: 8px;">🔗 Dependencies: ${friendlyName}</h3>
    <p style="margin-bottom: 16px; color: #64748b;">Found vs missing dependency analysis.</p>
`;

if (results.dependencyAnalysis) {
    html += this.displayDependencyAnalysis(results.dependencyAnalysis);
} else {
    html += `
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
            <p style="color: #64748b;">Dependency analysis will appear here after component analysis.</p>
        </div>
    `;
}

container.innerHTML = html;
}
displayFileLifecycle(componentName, results) {
const container = document.getElementById('fileflowContent');
if (!container) return;
const friendlyName = this.getFriendlyName(componentName);

let html = `
    <h3 style="color: #1e40af; margin-bottom: 8px;">🌊 File Lifecycle: ${friendlyName}</h3>
    <p style="margin-bottom: 16px; color: #64748b;">Complete lifecycle from creation through usage patterns.</p>
`;

if (results.lifecycleFlow) {
    html += this.displayFileLifecycleDetails(results.lifecycleFlow);
} else {
    html += `
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
            <p style="color: #64748b;">Lifecycle flow analysis will appear here after component analysis.</p>
        </div>
    `;
}

container.innerHTML = html;
}
displayFileLifecycleDetails(lifecycleFlow) {
const creationSources = lifecycleFlow.creationSources || [];
const inputPrograms = lifecycleFlow.inputPrograms || [];
const updatePrograms = lifecycleFlow.updatePrograms || [];
const cicsScreens = lifecycleFlow.cicsScreens || [];
const batchJobs = lifecycleFlow.batchJobs || [];
return `
    <div style="background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h4 style="color: #7c3aed; margin-bottom: 12px;">🌊 Complete Lifecycle Flow</h4>
        
        <div style="margin-bottom: 16px; text-align: center;">
            <span style="background: ${this.getUsagePatternColor(lifecycleFlow.usagePattern)}; color: white; padding: 6px 12px; border-radius: 6px; font-weight:RetryHContinueEdit <artifact identifier="mainframe-analyzer-part12" type="text/html" title="Enhanced Mainframe Analyzer - Part 12: Export & Final Initialization">

// Continue the EnhancedMainframeAnalyzer class - Final methods and initialization
// Continue displayFileLifecycleDetails method
<span style="background: ${this.getUsagePatternColor(lifecycleFlow.usagePattern)}; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 600;">
${(lifecycleFlow.usagePattern || 'UNKNOWN').replace(/_/g, ' ')}
</span>
</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px;">
            
            <!-- Creation Stage -->
            <div style="background: #f0fdf4; padding: 12px; border-radius: 6px; border-left: 4px solid #10b981;">
                <h5 style="color: #059669; margin-bottom: 8px; font-size: 13px;">🌱 Creation Sources (${creationSources.length})</h5>
                ${creationSources.length > 0 ? `
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${creationSources.map(source => `
                            <div style="margin-bottom: 6px; padding: 4px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 10px;">
                                <div style="font-weight: 600; color: #1e40af;">${source.program}</div>
                                <div style="color: #6b7280;">${source.operation}</div>
                                ${source.evidence && source.evidence.length > 0 ? `
                                    <div style="font-size: 8px; color: #059669;">Line ${source.evidence[0].line}</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : '<div style="font-size: 11px; color: #9ca3af;">No creation sources identified</div>'}
            </div>
            
            <!-- Reading Stage -->
            <div style="background: #eff6ff; padding: 12px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                <h5 style="color: #1d4ed8; margin-bottom: 8px; font-size: 13px;">📖 Reading Programs (${inputPrograms.length})</h5>
                ${inputPrograms.length > 0 ? `
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${inputPrograms.map(input => `
                            <div style="margin-bottom: 6px; padding: 4px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 10px;">
                                <div style="font-weight: 600; color: #1e40af;">${input.program}</div>
                                <div style="color: #6b7280;">${input.operation}</div>
                                ${input.evidence && input.evidence.length > 0 ? `
                                    <div style="font-size: 8px; color: #1d4ed8;">Line ${input.evidence[0].line}</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : '<div style="font-size: 11px; color: #9ca3af;">No reading programs identified</div>'}
            </div>
            
            <!-- Update Stage -->
            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                <h5 style="color: #d97706; margin-bottom: 8px; font-size: 13px;">⚙️ Update Programs (${updatePrograms.length})</h5>
                ${updatePrograms.length > 0 ? `
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${updatePrograms.map(update => `
                            <div style="margin-bottom: 6px; padding: 4px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 10px;">
                                <div style="font-weight: 600; color: #1e40af;">${update.program}</div>
                                <div style="color: #6b7280;">${update.operation}</div>
                                ${update.evidence && update.evidence.length > 0 ? `
                                    <div style="font-size: 8px; color: #d97706;">Line ${update.evidence[0].line}</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : '<div style="font-size: 11px; color: #9ca3af;">No update programs identified</div>'}
            </div>
        </div>
        
        <!-- CICS and Batch Processing -->
        ${(cicsScreens.length > 0 || batchJobs.length > 0) ? `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div style="background: #f3e8ff; padding: 12px; border-radius: 6px; border: 1px solid #d8b4fe;">
                    <h5 style="color: #7c3aed; margin-bottom: 8px; font-size: 13px;">💻 CICS Screens (${cicsScreens.length})</h5>
                    ${cicsScreens.length > 0 ? 
                        cicsScreens.map(screen => `
                            <div style="font-size: 10px; margin-bottom: 4px; color: #5b21b6;">
                                <strong>${screen.screen || 'Screen'}</strong> - ${screen.operation}
                            </div>
                        `).join('') : 
                        '<div style="font-size: 11px; color: #9ca3af;">No CICS screen operations</div>'
                    }
                </div>
                
                <div style="background: #fef2f2; padding: 12px; border-radius: 6px; border: 1px solid #fecaca;">
                    <h5 style="color: #dc2626; margin-bottom: 8px; font-size: 13px;">⚡ Batch Jobs (${batchJobs.length})</h5>
                    ${batchJobs.length > 0 ? 
                        batchJobs.map(job => `
                            <div style="font-size: 10px; margin-bottom: 4px; color: #991b1b;">
                                <strong>${job.job || 'Job'}</strong> - ${job.operation}
                            </div>
                        `).join('') : 
                        '<div style="font-size: 11px; color: #9ca3af;">No batch job operations</div>'
                    }
                </div>
            </div>
        ` : ''}
    </div>
`;
}
// === BULK ANALYSIS AND EXPORT ===
async bulkAnalyze() {
if (this.uploadedFiles.length === 0) {
this.showError('No files uploaded for bulk analysis');
return;
}
this.showLoading();
this.updateLoadingStatus('🔄 Starting bulk analysis...');

const components = this.componentSuggestions
    .filter(c => c.type === 'RECORD_LAYOUT' || c.type === 'PROGRAM')
    .slice(0, 5);
let completed = 0;

try {
    for (const component of components) {
        this.updateLoadingStatus(`Analyzing ${component.friendlyName || component.name} (${completed + 1}/${components.length})...`);
        
        try {
            document.getElementById('componentName').value = component.name;
            if (component.friendlyName) {
                document.getElementById('friendlyName').value = component.friendlyName;
            }
            
            const results = await this.runLLMEnhancedAnalysisWithLifecycle(component.name);
            this.analysisResults[component.name] = results;
            completed++;
            
            await this.sleep(2000);
        } catch (error) {
            console.warn(`Failed to analyze ${component.name}:`, error);
        }
    }

    this.hideLoading();
    this.saveToStorage();
    this.showSuccess(`✨ Bulk analysis complete! ${completed}/${components.length} components analyzed`);

} catch (error) {
    this.hideLoading();
    this.showError(`Bulk analysis failed: ${error.message}`);
}
}
async exportResults(format) {
if (Object.keys(this.analysisResults).length === 0) {
this.showError('No analysis results to export');
return;
}
try {
    if (format === 'json') {
        await this.exportAsJSON();
    } else if (format === 'markdown') {
        await this.exportAsMarkdown();
    }
} catch (error) {
    this.showError(`Export failed: ${error.message}`);
}
}
async exportAsJSON() {
const exportData = {
metadata: {
timestamp: new Date().toISOString(),
totalComponents: Object.keys(this.analysisResults).length,
totalFiles: this.uploadedFiles.length,
analysisMethod: 'LLM-Enhanced-Focused',
version: '5.0.0-white-theme'
},
componentFriendlyNames: this.componentFriendlyNames,
analysisResults: this.analysisResults,
chatHistory: this.chatHistory
};
const dataStr = JSON.stringify(exportData, null, 2);
const filename = `mainframe-analysis-${new Date().toISOString().split('T')[0]}.json`;

this.downloadTextFile(dataStr, filename);
this.showSuccess(`📋 Analysis results exported as ${filename}`);
}
async exportAsMarkdown() {
    try {
        // Check if there are results to export
        if (!this.analysisResults || Object.keys(this.analysisResults).length === 0) {
            throw new Error('No analysis results available for export');
        }
    let markdown = `# Mainframe Component Analysis Report\n\n`;
    markdown += `**Generated:** ${new Date().toLocaleString()}\n`;
    markdown += `**Analysis Method:** LLM-Enhanced Focused Analysis with White Theme\n\n`;

    // Process each component
    for (const [componentName, results] of Object.entries(this.analysisResults)) {
        // Ensure componentName exists and is valid
        if (!componentName || typeof componentName !== 'string') {
            console.warn('Invalid component name found, skipping:', componentName);
            continue;
        }

        // Ensure results object exists
        if (!results || typeof results !== 'object') {
            console.warn('Invalid results for component, skipping:', componentName);
            continue;
        }

        const friendlyName = this.getFriendlyName(componentName);
        
        markdown += `## ${friendlyName}\n\n`;
        markdown += `**Technical Name:** \`${componentName}\`\n`;
        markdown += `**Type:** ${results.componentType || 'Unknown'}\n`;
        markdown += `**Quality Score:** ${results.qualityScore || 'N/A'}/10\n`;
        markdown += `**Usage Pattern:** ${results.lifecycleFlow?.usagePattern || 'N/A'}\n\n`;
        
        // Safe check for recommendations
        if (results.llmAnalysis?.recommendations && Array.isArray(results.llmAnalysis.recommendations)) {
            markdown += `**Recommendations:**\n`;
            results.llmAnalysis.recommendations.forEach((rec, index) => {
                // Ensure rec is a string and escape any special characters
                const recommendation = typeof rec === 'string' ? rec : String(rec);
                markdown += `- ${recommendation.replace(/\n/g, ' ')}\n`;
            });
            markdown += `\n`;
        }
        
        // Safe check for dependency analysis
        if (results.dependencyAnalysis?.summary && typeof results.dependencyAnalysis.summary === 'object') {
            markdown += `**Dependencies:**\n`;
            markdown += `- Found: ${results.dependencyAnalysis.summary.foundCount || 0}\n`;
            markdown += `- Missing: ${results.dependencyAnalysis.summary.missingCount || 0}\n`;
            markdown += `\n`;
        }
        
        // Add fields information for copybooks
        if (results.componentType === 'Copybook' && results.llmAnalysis?.totalFields) {
            markdown += `**Field Analysis:**\n`;
            markdown += `- Total Fields: ${results.llmAnalysis.totalFields}\n`;
            
            if (results.llmAnalysis.fieldCategories) {
                const categories = results.llmAnalysis.fieldCategories;
                markdown += `- Input Fields: ${categories.inputFields?.length || 0}\n`;
                markdown += `- Output Fields: ${categories.outputFields?.length || 0}\n`;
                markdown += `- Reference Fields: ${categories.referenceFields?.length || 0}\n`;
                markdown += `- Unused Fields: ${categories.unusedFields?.length || 0}\n`;
            }
            markdown += `\n`;
        }
        
        markdown += `---\n\n`;
    }
    
    // Generate filename with current date
    const currentDate = new Date().toISOString().split('T')[0];
    const filename = `mainframe-analysis-report-${currentDate}.md`;
    
    // Download the file
    this.downloadTextFile(markdown, filename);
    this.showSuccess(`📝 Analysis report exported as ${filename}`);
    
} catch (error) {
    console.error('Export to Markdown failed:', error);
    this.showError(`Failed to export markdown: ${error.message}`);
}
}
// Helper method to ensure downloadTextFile works correctly
downloadTextFile(content, filename) {
try {
// Validate inputs
if (!content || typeof content !== 'string') {
throw new Error('Invalid content for file download');
}
    if (!filename || typeof filename !== 'string') {
        throw new Error('Invalid filename for file download');
    }
    
    // Create blob and download
    const blob = new Blob([content], { 
        type: 'text/markdown;charset=utf-8' 
    });
    
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    
    // Add to DOM, click, and cleanup
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Clean up the URL object
    setTimeout(() => {
        URL.revokeObjectURL(url);
    }, 100);
    
} catch (error) {
    console.error('File download failed:', error);
    throw new Error(`Failed to download file: ${error.message}`);
}
}

} // End of class
// === INITIALIZATION ===
document.addEventListener('DOMContentLoaded', function() {
window.analyzer = new EnhancedMainframeAnalyzer();
console.log('🚀 Enhanced Mainframe Analyzer with White/Blue Theme Ready!');
console.log('✅ Key Features:');
console.log('   • White background with blue/grey color scheme');
console.log('   • Collapsible left panel and chat sections');
console.log('   • Friendly names for display with technical names for analysis');
console.log('   • Expandable chat interface with full-height display');
console.log('   • Collapsible analysis result tabs');
console.log('   • Improved component suggestions with friendly names');
console.log('   • Enhanced file upload with better file type detection');
console.log('🎯 Ready for comprehensive mainframe analysis!');
});
// Fallback initialization for browsers that load content before DOM
if (document.readyState === 'loading') {
// Document still loading, wait for DOMContentLoaded
} else {
// Document already loaded
window.analyzer = new EnhancedMainframeAnalyzer();
console.log('🚀 Enhanced Mainframe Analyzer initialized (fallback)');
}
// === GLOBAL UTILITY FUNCTIONS ===

// Alternative version using string concatenation (if you prefer)
function togglePanel(panelName) {
const content = document.getElementById(panelName + '-content');
const toggle = document.getElementById(panelName + '-toggle');
if (content && toggle) {
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.classList.remove('collapsed');
        toggle.textContent = '▼';
    } else {
        content.classList.add('collapsed');
        toggle.classList.add('collapsed');
        toggle.textContent = '▶';
    }
}
}
function toggleSection(sectionName) {
const content = document.getElementById(sectionName + '-section-content');
const toggle = document.getElementById(sectionName + '-section-toggle');
if (content && toggle) {
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.textContent = '▼';
    } else {
        content.classList.add('collapsed');
        toggle.textContent = '▶';
    }
}
}

// Enhanced error handling for production
window.addEventListener('error', function(e) {
console.error('Global error caught:', e.error);
// Show user-friendly error message
if (window.analyzer) {
    window.analyzer.showError('An unexpected error occurred. Please refresh the page and try again.');
}

return false;
});
// Handle unhandled promise rejections
window.addEventListener('unhandledrejection', function(e) {
console.error('Unhandled promise rejection:', e.reason);
if (window.analyzer) {
    window.analyzer.showError('A background operation failed. Please check your LLM server connection.');
}

e.preventDefault();
});
console.log('🎨 Enhanced Mainframe Analyzer with White/Blue Theme - All modules loaded successfully!');
</script>
</body>
</html>
