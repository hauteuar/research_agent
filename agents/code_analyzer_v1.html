<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Code Analyzer - Powered by Opulence</title>
    <style>
        /* ============================================
           ENHANCED CODE ANALYZER - POWERED BY OPULENCE
           Complete CSS Styles and Layout System
           ============================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Enhanced Color Palette */
            --primary-blue: #2563eb;
            --primary-blue-dark: #1e40af;
            --primary-blue-light: #3b82f6;
            --secondary-blue: #60a5fa;
            --accent-blue: #93c5fd;
            
            --grey-50: #f9fafb;
            --grey-100: #f3f4f6;
            --grey-200: #e5e7eb;
            --grey-300: #d1d5db;
            --grey-400: #9ca3af;
            --grey-500: #6b7280;
            --grey-600: #4b5563;
            --grey-700: #374151;
            --grey-800: #1f2937;
            --grey-900: #111827;
            
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --error-red: #ef4444;
            --info-blue: #3b82f6;
            --purple: #8b5cf6;
            --indigo: #6366f1;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            background: #ffffff;
            color: var(--grey-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--grey-50);
        }

        /* Enhanced Header */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-left: 3rem;
            font-weight: 400;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.85rem;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            display: block;
        }

        .header-stat-label {
            opacity: 0.8;
            font-size: 0.75rem;
        }

        /* Content Layout */
        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Enhanced Collapsible Panels */
        .panel {
            background: white;
            position: relative;
            transition: all var(--transition-normal);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--grey-200);
            box-shadow: var(--shadow-sm);
        }

        .panel.left {
            width: 420px;
            min-width: 60px;
        }

        .panel.left.collapsed {
            width: 60px;
        }

        .panel.right {
            width: 500px;
            min-width: 60px;
            border-left: 1px solid var(--grey-200);
            border-right: none;
        }

        .panel.right.collapsed {
            width: 60px;
        }

        .panel-header {
            padding: 1rem;
            background: linear-gradient(135deg, var(--grey-50) 0%, var(--grey-100) 100%);
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--grey-700);
            font-size: 0.95rem;
        }

        .panel-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
        }

        .collapse-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--grey-600);
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .collapse-btn:hover {
            background: var(--primary-blue);
            color: white;
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            transition: opacity var(--transition-normal);
        }

        .panel.collapsed .panel-content {
            opacity: 0;
            pointer-events: none;
            padding: 0;
        }

        .panel.collapsed .panel-title span {
            display: none;
        }

        /* Enhanced Component Cards */
        .component-card {
            background: white;
            border: 1px solid var(--grey-200);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .component-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        .component-card.selected {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
            box-shadow: var(--shadow-md);
        }

        .component-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .component-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .component-card-icon.program {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
        }

        .component-card-icon.copybook {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: white;
        }

        .component-card-icon.file {
            background: linear-gradient(135deg, var(--warning-yellow) 0%, #d97706 100%);
            color: white;
        }

        .component-card-info {
            flex: 1;
            min-width: 0;
        }

        .component-card-name {
            font-weight: 600;
            color: var(--grey-800);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .component-card-friendly {
            font-size: 0.8rem;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .component-card-description {
            font-size: 0.8rem;
            color: var(--grey-600);
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .component-card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .component-metric {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--grey-600);
        }

        .component-metric-icon {
            width: 14px;
            height: 14px;
            color: var(--grey-500);
        }

        .component-grid-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .component-grid-row:hover {
            background-color: var(--grey-50);
        }

        .file-list-compact {
            max-width: 150px;
            line-height: 1.4;
        }

        .component-detail-row {
            background-color: var(--grey-25) !important;
        }

        .component-detail-row td {
            border-top: none !important;
        }
        /* Enhanced Collapsible Sections */
        .collapsible-section {
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--grey-200);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .collapsible-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--grey-50) 0%, var(--grey-100) 100%);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-fast);
            user-select: none;
            border-bottom: 1px solid var(--grey-200);
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: var(--grey-700);
        }

        .collapsible-header:hover .collapsible-title {
            color: white;
        }

        .collapsible-icon {
            width: 20px;
            height: 20px;
        }

        .expand-icon {
            width: 20px;
            height: 20px;
            color: var(--grey-400);
            transition: transform var(--transition-fast);
        }

        .collapsible-header:hover .expand-icon {
            color: white;
        }

        .collapsible-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
            background: white;
        }

        .collapsible-section.expanded .collapsible-content {
            max-height: 3000px;
        }

        .collapsible-body {
            padding: 1.5rem;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        /* Enhanced Tabs */
        .tabs-container {
            background: linear-gradient(135deg, white 0%, var(--grey-50) 100%);
            border-bottom: 1px solid var(--grey-200);
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            min-height: 60px;
            box-shadow: var(--shadow-sm);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--grey-600);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 8px;
            margin-right: 0.5rem;
        }

        .tab:hover {
            color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.1);
        }

        .tab.active {
            color: white;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            box-shadow: var(--shadow-md);
        }

        .tab-icon {
            width: 18px;
            height: 18px;
        }

        /* Tab Content */
        .tab-content-container {
            flex: 1;
            overflow-y: auto;
            background: var(--grey-50);
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            min-height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhanced Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-red) 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-block {
            width: 100%;
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-primary {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-blue);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-green);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-yellow);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-red);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-blue);
        }

        .badge-grey {
            background: var(--grey-100);
            color: var(--grey-600);
        }

        /* Form Elements */
        .form-section {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--grey-200);
            box-shadow: var(--shadow-sm);
        }

        .form-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--grey-700);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--grey-700);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all var(--transition-fast);
            background: white;
            color: var(--grey-800);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--grey-300);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--grey-50);
            margin-bottom: 1rem;
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .upload-area.drag-over {
            border-color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.1);
            transform: scale(0.98);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary-blue);
        }

        .upload-text {
            color: var(--grey-700);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .upload-subtext {
            color: var(--grey-500);
            font-size: 0.9rem;
        }

        /* Status Indicators */
        .status-indicator {
            padding: 0.75rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .status-indicator.connected {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success-green);
        }

        .status-indicator.connecting {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning-yellow);
        }

        .status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--grey-200);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--grey-200);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--grey-800);
            margin-bottom: 0.5rem;
        }

        .loading-status {
            font-size: 0.9rem;
            color: var(--grey-600);
            margin-bottom: 1rem;
        }

        .loading-progress {
            width: 250px;
            height: 6px;
            background: var(--grey-200);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Alert Messages */
        .alert {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            z-index: 10000;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: var(--success-green);
            color: white;
        }

        .alert-error {
            background: var(--error-red);
            color: white;
        }

        .alert-warning {
            background: var(--warning-yellow);
            color: white;
        }

        .alert-info {
            background: var(--info-blue);
            color: white;
        }

        .alert-icon {
            font-size: 1.25rem;
        }

        .alert-message {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .panel.left {
                width: 350px;
            }
            .panel.right {
                width: 400px;
            }
        }

        @media (max-width: 768px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .panel {
                width: 100% !important;
                min-height: 200px;
            }
            
            .panel.left.collapsed,
            .panel.right.collapsed {
                min-height: 60px;
            }
            
            .header-stats {
                display: none;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header-subtitle {
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--grey-200);
            margin-bottom: 1rem;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--grey-50);
        }

        .data-table th {
            padding: 0.75rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 1px solid var(--grey-200);
        }

        .data-table td {
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--grey-800);
            border-bottom: 1px solid var(--grey-100);
        }

        .data-table tbody tr:hover {
            background: var(--grey-50);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--grey-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--grey-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--grey-500);
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-mono { font-family: 'Courier New', monospace; }
        .font-bold { font-weight: bold; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }

        .badge-purple {
    background: rgba(139, 92, 246, 0.1);
    color: var(--purple);
}

:root {
    --purple: #8b5cf6;
}

/* Enhanced animation for interface nodes */
@keyframes interfacePulse {
    0%, 100% { 
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3); 
    }
    50% { 
        box-shadow: 0 0 0 6px rgba(139, 92, 246, 0.1), 0 0 0 2px rgba(139, 92, 246, 0.3); 
    }
}

.interface-node {
    animation: interfacePulse 3s infinite;
}

/* Fix for missing dependencies display */
.dependency-status-fixed {
    background: linear-gradient(45deg, var(--warning-yellow), var(--success-green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Enhanced connection lines */
.connection-line {
    position: relative;
    overflow: hidden;
}

.connection-line::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: flowAnimation 2s infinite;
}

@keyframes flowAnimation {
    0% { left: -100%; }
    100% { left: 100%; }
}
            </style>

        <!-- Load all JavaScript parts -->
        <script>
            // ============================================
            // ENHANCED CODE ANALYZER - COMPLETE INTEGRATION
            // Loading all parts and initializing the system
            // ============================================
            
            // This will load all the JavaScript parts from the artifacts
            // Part 2: Core Classes and Database
            // Part 3: File Processing and Component Discovery  
            // Part 4: LLM Integration and Analysis
            // Part 5: Chat System and Final Integration
            
            console.log('üöÄ Enhanced Code Analyzer - Starting initialization...');
        </script>
        
        <!-- Load SQL.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
        
        <!-- JavaScript will be injected here by copying from the parts -->
        <script>
            // Copy the complete JavaScript from Parts 2-5 here
            // This ensures all functionality is available in a single file
            
            // Note: In implementation, you would copy the complete JavaScript code 
            // from all the parts (2-5) into this script tag to have a working system
            
            // The system includes:
            // - Database management with SQLite stored in Downloads folder
            // - File upload and processing for COBOL/JCL/Copybook files
            // - Component auto-discovery and analysis
            // - LLM integration with 6000 token limit and fallback handling
            // - Business intelligence chat system
            // - Dependency mapping and field matrix analysis
            // - Export functionality for JSON and Markdown reports
            
            console.log('üìù JavaScript loading complete - copy Parts 2-5 code here');
        </script>
    </head>
<body>
    <div class="main-container">
        <!-- Enhanced Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>
                        <div class="header-icon">üîç</div>
                        Enhanced Code Analyzer
                    </h1>
                    <div class="header-subtitle">Powered by Opulence - Intelligent Mainframe Analysis & Business Intelligence</div>
                </div>
                <div class="header-stats">
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerComponents">0</span>
                        <span class="header-stat-label">Components</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerPrograms">0</span>
                        <span class="header-stat-label">Programs</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerCopybooks">0</span>
                        <span class="header-stat-label">Copybooks</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerFields">0</span>
                        <span class="header-stat-label">Fields</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerLinesOfCode">0</span>
                        <span class="header-stat-label">Lines of Code</span>
                    </div>
                    <div class="header-stat">
                        <span class="header-stat-value" id="headerFileSize">0 KB</span>
                        <span class="header-stat-label">Total Size</span>
                    </div>

                </div>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="content-wrapper" id="contentWrapper">
            <!-- Left Panel - Component Dashboard -->
            <div class="panel left" id="leftPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">üìä</div>
                        <span>Component Dashboard</span>
                    </div>
                    <button class="collapse-btn" onclick="togglePanel('left')">
                        ‚óÄ
                    </button>
                </div>
                <div class="panel-content" id="leftPanelContent">
                    <!-- LLM Server Setup -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span style="color: var(--success-green);">üöÄ</span>
                            LLM Server Setup
                        </div>

                        <div class="form-group">
                            <label class="form-label">Server Endpoint</label>
                            <input type="text" 
                                   id="vllmEndpoint" 
                                   class="form-input" 
                                   placeholder="http://localhost:8000" 
                                   value="http://localhost:8000">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" 
                                   id="maxTokens" 
                                   class="form-input" 
                                   value="6000" 
                                   min="1000" 
                                   max="8000">
                        </div>

                        <button id="validateApiBtn" class="btn btn-success btn-block">
                            <span>üîê</span>
                            Test Connection
                        </button>

                        <div id="apiStatus" class="status-indicator disconnected">
                            <span class="status-dot"></span>
                            <span>Enter server details and test connection</span>
                        </div>
                    </div>

                    <!-- File Upload Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span style="color: var(--info-blue);">üìÅ</span>
                            Upload & Auto-Analyze
                        </div>

                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">üì§</div>
                            <div class="upload-text">Drop files here or click to browse</div>
                            <div class="upload-subtext">COBOL (.cbl), Copybooks (.cpy), JCL (.jcl) - Auto-analysis starts immediately</div>
                            <input type="file" 
                                   id="fileInput" 
                                   multiple 
                                   accept=".cbl,.cob,.cpy,.copybook,.jcl,.txt,.proc" 
                                   style="display: none;">
                        </div>

                        <button id="autoAnalyzeBtn" class="btn btn-primary btn-block" disabled>
                            <span>ü§ñ</span>
                            Start Auto-Analysis
                        </button>
                    </div>

                    <!-- Discovered Components -->
                    <div class="collapsible-section expanded" id="discoveredComponents">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <span class="collapsible-icon">üéØ</span>
                                Discovered Components (<span id="componentCount">0</span>)
                            </div>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-body" id="componentsList">
                                <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                                    Upload files to auto-discover components
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Database Management -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span style="color: var(--info-blue);">üíæ</span>
                            Database Management
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <button class="btn btn-primary" onclick="analyzer.saveToDownloadsWithName()">
                                <span>üíæ</span>
                                Manual Save
                            </button>
                            <button class="btn btn-primary" onclick="analyzer.loadFromDownloadsFolder()">
                                <span>üìÅ</span>
                                Load Database
                            </button>
                        </div>
                        
                        <div class="storage-info" style="font-size: 0.75rem; color: var(--grey-500); padding: 0.5rem; background: var(--grey-50); border-radius: 6px; text-align: center;">
                            üìÅ Data auto-saved to Downloads folder every 30 seconds
                            <br>
                            üí° Look for "enhanced_code_analyzer_data.db" file
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <span style="color: var(--warning-yellow);">‚ö°</span>
                            Actions
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <button id="exportJsonBtn" class="btn btn-primary" disabled>
                                <span>üìã</span>
                                Export JSON
                            </button>
                            <button id="exportMdBtn" class="btn btn-primary" disabled>
                                <span>üìù</span>
                                Export MD
                            </button>
                        </div>

                        <button id="clearBtn" class="btn btn-danger btn-block">
                            <span>üóëÔ∏è</span>
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Enhanced Tabs -->
                <div class="tabs-container">
                    <button class="tab active" data-tab="dashboard">
                        <span class="tab-icon">üìä</span>
                        Dashboard Overview
                    </button>
                    <button class="tab" data-tab="components">
                        <span class="tab-icon">üìö</span>
                        Components Library
                    </button>
                    <button class="tab" data-tab="dependencies">
                        <span class="tab-icon">üîó</span>
                        Dependencies Flow
                    </button>
                    <button class="tab" data-tab="fieldmatrix">
                        <span class="tab-icon">üìã</span>
                        Field Matrix
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content-container">
                    <!-- Dashboard Overview Tab -->
                    <div id="dashboard" class="tab-content active">
                        <div id="dashboardContent">
                            <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                                Upload your mainframe files to start analysis
                            </p>
                        </div>
                    </div>
                    <!-- Components Library Tab -->
                    <div id="components" class="tab-content">
                        <div id="componentsContent">
                            <!-- Empty State -->
                            <div id="componentsEmptyState" style="text-align: center; padding: 3rem; background: var(--grey-50); border-radius: 12px;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                                <h3 style="color: var(--grey-700); margin-bottom: 1rem;">Components Library</h3>
                                <p style="color: var(--grey-600); margin-bottom: 2rem;">
                                    Upload COBOL, JCL, or Copybook files to explore your component library.<br>
                                    Each file will be analyzed to discover components, records, and business logic.
                                </p>
                                <div style="display: flex; justify-content: center; gap: 1rem;">
                                    <div style="padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--grey-200);">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üíº</div>
                                        <div style="font-size: 0.8rem; color: var(--grey-600);">COBOL Programs</div>
                                    </div>
                                    <div style="padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--grey-200);">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìö</div>
                                        <div style="font-size: 0.8rem; color: var(--grey-600);">Copybooks</div>
                                    </div>
                                    <div style="padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--grey-200);">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚öôÔ∏è</div>
                                        <div style="font-size: 0.8rem; color: var(--grey-600);">JCL Jobs</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Library Content (Hidden initially) -->
                            <div id="componentsLibraryContent" style="display: none;">
                                <!-- Library Header -->
                                <div id="libraryHeader" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                                    <h3 style="margin: 0 0 0.5rem 0; color: white;">üìö Components Library</h3>
                                    <p id="librarySubtitle" style="margin: 0; opacity: 0.9; font-size: 0.9rem;">
                                        0 files uploaded ‚Ä¢ 0 components discovered
                                    </p>
                                </div>

                                <!-- Library Statistics -->
                                <div id="libraryStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue); margin-bottom: 0.25rem;" id="statUploadedFiles">0</div>
                                        <div style="font-size: 0.8rem; color: var(--grey-600);">Uploaded Files</div>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green); margin-bottom: 0.25rem;" id="statDiscoveredComponents">0</div>
                                        <div style="font-size: 0.8rem; color: var(--grey-600);">Components Found</div>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning-yellow); margin-bottom: 0.25rem;" id="statAnalyzedComponents">0</div>
                                        <div style="font-size: 0.8rem; color: var(--grey-600);">Analyzed Components</div>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--info-blue); margin-bottom: 0.25rem;" id="statLinesOfCode">0</div>
                                        <div style="font-size: 0.8rem; color: var(--grey-600);">Lines of Code</div>
                                    </div>
                                </div>

                                <!-- Search and Filters -->
                                <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--grey-200);">
                                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center;">
                                        <div style="position: relative;">
                                            <input type="text" id="librarySearchInput" placeholder="Search files and components..." style="width: 100%; padding: 0.5rem 2.5rem 0.5rem 1rem; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 0.9rem;">
                                            <div style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--grey-400);">üîç</div>
                                        </div>
                                        <select id="libraryFileTypeFilter" style="padding: 0.5rem; border: 1px solid var(--grey-300); border-radius: 6px;">
                                            <option value="all">All File Types</option>
                                            <option value="COBOL Program">COBOL Programs</option>
                                            <option value="Copybook">Copybooks</option>
                                            <option value="JCL Job">JCL Jobs</option>
                                            <option value="JCL Procedure">JCL Procedures</option>
                                        </select>
                                        <select id="libraryAnalysisFilter" style="padding: 0.5rem; border: 1px solid var(--grey-300); border-radius: 6px;">
                                            <option value="all">All Components</option>
                                            <option value="analyzed">Analyzed Only</option>
                                            <option value="pending">Pending Analysis</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Files and Components List -->
                                <div style="background: white; border-radius: 12px; overflow: hidden; border: 1px solid var(--grey-200);">
                                    <div style="background: var(--grey-50); padding: 1rem; border-bottom: 1px solid var(--grey-200);">
                                        <h4 style="margin: 0; color: var(--grey-800);">üìÅ Uploaded Files & Discovered Components</h4>
                                        <p style="margin: 0.5rem 0 0 0; color: var(--grey-600); font-size: 0.9rem;">Click on any file to expand and view its discovered components</p>
                                    </div>
                                    
                                    <!-- Files Container -->
                                    <div id="filesComponentsList">
                                        <!-- Files will be dynamically inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Dependencies Flow Tab -->
                    <div id="dependencies" class="tab-content">
                        <div id="dependenciesContent">
                            <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                                Dependencies will appear after analysis
                            </p>
                        </div>
                    </div>

                    <!-- Field Matrix Tab -->
                    <div id="fieldmatrix" class="tab-content">
                        <div id="fieldMatrixContent">
                            <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                                Select a component to view field matrix
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Enhanced Chat -->
            <div class="panel right" id="rightPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">üí¨</div>
                        <span>Business Intelligence Chat</span>
                    </div>
                    <button class="collapse-btn" onclick="togglePanel('right')">
                        ‚ñ∂
                    </button>
                </div>
                <div class="panel-content" id="rightPanelContent">
                    <!-- Chat will be loaded in Part 3 -->
                    <div id="chatContainer">
                        <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                            Chat system loading...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingIndicator">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-title">ü§ñ Processing Analysis</div>
                <div class="loading-status" id="loadingStatus">Initializing system...</div>
                <div class="loading-progress">
                    <div class="loading-progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Chat Styles -->
        <style>
            /* Chat Container */
            .chat-container {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            /* Chat Messages Area */
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                background: var(--grey-50);
                border-radius: 8px;
                margin-bottom: 1rem;
                min-height: 400px;
                max-height: calc(100vh - 400px);
                border: 1px solid var(--grey-200);
            }

            .chat-message {
                margin-bottom: 1rem;
                animation: fadeInUp 0.3s ease;
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .chat-message.user {
                display: flex;
                justify-content: flex-end;
            }

            .chat-message.assistant {
                display: flex;
                justify-content: flex-start;
            }

            /* Chat Bubbles */
            .chat-bubble {
                max-width: 95%;
                padding: 1rem;
                border-radius: 12px;
                position: relative;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.6;
            }

            .user .chat-bubble {
                background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
                color: white;
                border-bottom-right-radius: 4px;
            }

            .assistant .chat-bubble {
                background: white;
                color: var(--grey-800);
                border: 1px solid var(--grey-200);
                border-bottom-left-radius: 4px;
                box-shadow: var(--shadow-sm);
            }

            .chat-message-header {
                font-size: 0.7rem;
                font-weight: 600;
                margin-bottom: 0.25rem;
                opacity: 0.7;
            }

            .chat-message-content {
                font-size: 0.9rem;
                line-height: 1.6;
                white-space: pre-wrap;
            }

            .chat-message-time {
                font-size: 0.65rem;
                opacity: 0.5;
                margin-top: 0.25rem;
            }

            /* Chat Input Section */
            .chat-input-section {
                padding: 1rem;
                background: white;
                border-radius: 8px;
                border: 1px solid var(--grey-200);
                box-shadow: var(--shadow-sm);
            }

            .chat-input-group {
                display: flex;
                gap: 0.75rem;
                align-items: flex-end;
            }

            .chat-input {
                flex: 1;
                padding: 1rem;
                border: 1px solid var(--grey-300);
                border-radius: 8px;
                resize: none;
                min-height: 80px;
                max-height: 160px;
                font-size: 0.95rem;
                transition: all var(--transition-fast);
                font-family: inherit;
                line-height: 1.4;
            }

            .chat-input:focus {
                outline: none;
                border-color: var(--primary-blue);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }

            .chat-send-btn {
                padding: 1rem 1.5rem;
                background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all var(--transition-fast);
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 600;
                font-size: 0.9rem;
                min-height: 80px;
            }

            .chat-send-btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .chat-send-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* Typing Indicator */
            .typing-indicator {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 1rem;
                background: var(--grey-100);
                border-radius: 12px;
                margin-bottom: 1rem;
                opacity: 0.8;
            }

            .typing-dots {
                display: flex;
                gap: 0.25rem;
            }

            .typing-dot {
                width: 8px;
                height: 8px;
                background: var(--grey-500);
                border-radius: 50%;
                animation: typingBounce 1.4s infinite ease-in-out;
            }

            .typing-dot:nth-child(1) { animation-delay: -0.32s; }
            .typing-dot:nth-child(2) { animation-delay: -0.16s; }
            .typing-dot:nth-child(3) { animation-delay: 0s; }

            @keyframes typingBounce {
                0%, 80%, 100% {
                    transform: scale(0.8);
                    opacity: 0.5;
                }
                40% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            /* Chat Suggestions */
            .chat-suggestions {
                padding: 0.75rem;
                background: var(--grey-50);
                border-radius: 8px;
                margin-bottom: 0.75rem;
                border: 1px solid var(--grey-200);
            }

            .chat-suggestions-title {
                font-size: 0.75rem;
                font-weight: 600;
                color: var(--grey-700);
                margin-bottom: 0.5rem;
            }

            .chat-suggestion-chips {
                display: flex;
                flex-wrap: wrap;
                gap: 0.25rem;
            }

            .chat-suggestion-btn {
                padding: 0.375rem 0.75rem;
                background: white;
                border: 1px solid var(--grey-300);
                border-radius: 20px;
                font-size: 0.7rem;
                color: var(--grey-700);
                cursor: pointer;
                transition: all var(--transition-fast);
            }

            .chat-suggestion-btn:hover {
                background: var(--primary-blue);
                color: white;
                border-color: var(--primary-blue);
                transform: translateY(-1px);
            }
            .dependency-node:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.field-row:hover {
    background-color: var(--grey-50);
    transform: translateX(4px);
}

.field-row:hover td {
    color: var(--primary-blue);
}

.dependency-node {
    transition: all 0.3s ease;
}

.dependency-node::before {
    content: '';
    position: absolute;
    top: -1px;
    left: -1px;
    right: -1px;
    bottom: -1px;
    background: linear-gradient(45deg, transparent, rgba(37, 99, 235, 0.1), transparent);
    border-radius: 10px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: -1;
}

.dependency-node:hover::before {
    opacity: 1;
}

/* Components Tab Specific Styles */
.file-row {
    transition: background-color 0.2s ease;
}

.file-row:hover {
    background-color: var(--grey-50) !important;
}

.file-components {
    transition: max-height 0.3s ease;
}

.expand-icon {
    transition: transform 0.3s ease, color 0.3s ease;
}
        </style>
        <script>

        // ============================================
// ENHANCED CODE ANALYZER - PART 2
// Core JavaScript Classes and Database Management
// ============================================

class EnhancedCodeAnalyzer {
    constructor() {
        // Core properties
        this.uploadedFiles = [];
        this.analysisResults = {};
        this.discoveredComponents = new Map();
        this.serverValidated = false;
        this.vllmEndpoint = 'http://localhost:8000';
        this.maxTokens = 6000;
        this.currentSelectedComponent = null;
        this.chatHistory = [];
        this.chatContext = 'general';
        
        // Business intelligence properties
        this.friendlyNameCache = new Map();
        this.businessContextCache = new Map();
        this.componentMetrics = new Map();
        
        // SQLite Database (stored in Downloads folder)
        this.db = null;
        this.dbInitialized = false;
        this.dbPath = null;
        
        // Auto-analysis state
        this.autoAnalysisInProgress = false;
        this.analysisQueue = [];
        
        // Initialize
        this.initializeDatabase();
        this.initializeEventListeners();
        this.setupDownloadsFolderStorage();
        
        console.log('üöÄ Enhanced Code Analyzer - Powered by Opulence - Initialized');
    }

    // ============================================
    // DATABASE INITIALIZATION AND MANAGEMENT
    // ============================================

    async initializeDatabase() {
        try {
            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
            
            // Initialize new database in memory
            this.db = new SQL.Database();
            this.dbInitialized = true;
            
            // Create tables
            this.createTables();
            
            console.log('‚úÖ SQLite database initialized');
            this.updateDbStatus('initialized', '‚úÖ Database ready (Downloads folder storage)');
            
            // Check for existing database and prompt user
            this.promptForExistingDatabase();
            
        } catch (error) {
            console.error('Failed to initialize SQLite database:', error);
            this.dbInitialized = false;
            this.updateDbStatus('error', '‚ùå Database initialization failed');
        }
    }

    createTables() {
        if (!this.db) return;
        
        try {
            // Uploaded Files table
            this.db.run(`
                CREATE TABLE IF NOT EXISTS uploaded_files (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    file_id TEXT UNIQUE,
                    name TEXT,
                    content TEXT,
                    size INTEGER,
                    type TEXT,
                    upload_date TEXT,
                    components TEXT,
                    metrics TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Discovered Components table
            this.db.run(`
                CREATE TABLE IF NOT EXISTS discovered_components (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    component_name TEXT UNIQUE,
                    friendly_name TEXT,
                    component_type TEXT,
                    business_purpose TEXT,
                    file_source TEXT,
                    line_count INTEGER,
                    complexity_score INTEGER,
                    input_files TEXT,
                    output_files TEXT,
                    field_count INTEGER,
                    analyzed BOOLEAN DEFAULT 0,
                    quality_score INTEGER,
                    selected BOOLEAN DEFAULT 0,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Analysis Results table
            this.db.run(`
                CREATE TABLE IF NOT EXISTS analysis_results (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    component_name TEXT UNIQUE,
                    friendly_name TEXT,
                    component_type TEXT,
                    results_data TEXT,
                    quality_score INTEGER,
                    business_context TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Chat History table
            this.db.run(`
                CREATE TABLE IF NOT EXISTS chat_history (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    component_name TEXT,
                    context_type TEXT,
                    sender TEXT,
                    content TEXT,
                    timestamp TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);

            // System Settings table
            this.db.run(`
                CREATE TABLE IF NOT EXISTS system_settings (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    setting_key TEXT UNIQUE,
                    setting_value TEXT,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);

            console.log('‚úÖ Database tables created successfully');
        } catch (error) {
            console.error('Failed to create database tables:', error);
        }
    }

    setupDownloadsFolderStorage() {
        // Save database every 30 seconds
        this.saveInterval = setInterval(() => {
            this.saveToDownloadsFolder();
        }, 30000);

        // Save on page unload
        window.addEventListener('beforeunload', () => {
            this.saveToDownloadsFolder();
        });

        // Save on visibility change (when user switches tabs)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                this.saveToDownloadsFolder();
            }
        });
    }

    async saveToDownloadsFolder() {
        if (!this.db || !this.dbInitialized) return;

        try {
            const data = this.db.export();
            const blob = new Blob([data], { type: 'application/octet-stream' });
            
            // Use consistent filename for automatic loading
            const filename = 'enhanced_code_analyzer_data.db';
            
            // Create download link
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            
            // Hide the download from user (automatic save)
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            // Update status indicator
            const now = new Date().toLocaleTimeString();
            this.updateDbStatus('initialized', `‚úÖ Auto-saved to Downloads (${now})`);
            
            console.log(`üíæ Database auto-saved to Downloads folder at ${now}`);
            
        } catch (error) {
            console.error('Failed to save database to Downloads folder:', error);
            this.updateDbStatus('error', '‚ùå Failed to save to Downloads');
        }
    }

    // Manual Save with Custom Name
    async saveToDownloadsWithName(customName = null) {
        if (!this.db || !this.dbInitialized) {
            this.showError('Database not initialized');
            return;
        }

        try {
            const data = this.db.export();
            const blob = new Blob([data], { type: 'application/octet-stream' });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 16);
            const filename = customName || `enhanced_code_analyzer_backup_${timestamp}.db`;
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            this.showSuccess(`üìÅ Database saved: ${filename}`);
            
        } catch (error) {
            console.error('Failed to save database:', error);
            this.showError('Failed to save database');
        }
    }

    // Prompt User to Load Existing Database
    promptForExistingDatabase() {
        // Create a subtle notification asking if user wants to load existing data
        const notification = document.createElement('div');
        notification.className = 'load-existing-notification';
        notification.innerHTML = `
            <div style="
                position: fixed; 
                top: 80px; 
                right: 20px; 
                background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); 
                color: white; 
                padding: 1rem 1.5rem; 
                border-radius: 12px; 
                box-shadow: var(--shadow-xl); 
                max-width: 400px; 
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            ">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">üìÇ Load Previous Data?</div>
                <div style="font-size: 0.9rem; margin-bottom: 1rem; opacity: 0.9;">
                    Do you have a previous database file in your Downloads folder to load?
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="analyzer.loadFromDownloadsFolder()" style="
                        flex: 1; 
                        padding: 0.5rem 1rem; 
                        background: white; 
                        color: var(--primary-blue); 
                        border: none; 
                        border-radius: 6px; 
                        font-weight: 600; 
                        cursor: pointer;
                    ">
                        üìÅ Load File
                    </button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        flex: 1; 
                        padding: 0.5rem 1rem; 
                        background: rgba(255,255,255,0.2); 
                        color: white; 
                        border: 1px solid rgba(255,255,255,0.3); 
                        border-radius: 6px; 
                        font-weight: 600; 
                        cursor: pointer;
                    ">
                        Start Fresh
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 10000);
    }

    // Load Database from Downloads Folder
    loadFromDownloadsFolder() {
        // Create file input for user to select database file
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.db';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                await this.loadDatabaseFromFile(e.target.files[0]);
            }
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
        
        // Remove the notification
        const notification = document.querySelector('.load-existing-notification');
        if (notification) {
            notification.remove();
        }
    }

    // Load Database from File
    async loadDatabaseFromFile(file) {
        try {
            this.showLoading();
            this.updateLoadingStatus('üìÇ Loading database from file...');
            
            const arrayBuffer = await file.arrayBuffer();
            const uInt8Array = new Uint8Array(arrayBuffer);
            
            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
            
            // Close existing database
            if (this.db) {
                this.db.close();
            }
            
            this.db = new SQL.Database(uInt8Array);
            this.dbInitialized = true;
            
            // Load data from imported database
            this.updateLoadingStatus('üìä Loading components and analysis data...');
            await this.loadDataFromDatabase();
            
            this.hideLoading();
            
            this.showSuccess(`üìÅ Database loaded from: ${file.name}`);
            this.updateDbStatus('initialized', '‚úÖ Database loaded from Downloads folder');
            
            // Update UI with loaded data
            this.updateDashboardStats();
            this.displayDiscoveredComponents();
            this.updateDashboardWithResults();
            
            // Enable chat if we have analysis results
            if (Object.keys(this.analysisResults).length > 0) {
                this.enableChat();
            }
            
        } catch (error) {
            this.hideLoading();
            console.error('Failed to load database:', error);
            this.showError(`Failed to load database: ${error.message}`);
        }
    }

    // Save to Database with Auto-save
    saveToDatabase() {
    if (!this.db || !this.dbInitialized) return;

    try {
        // Save uploaded files
        this.uploadedFiles.forEach(file => {
            this.db.run(`
                INSERT OR REPLACE INTO uploaded_files 
                (file_id, name, content, size, type, upload_date, components, metrics)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            `, [
                file.id || '',
                file.name || '',
                file.content || '',
                file.size || 0,
                file.type || '',
                file.uploadDate || new Date().toISOString(),
                JSON.stringify(file.components || []),
                JSON.stringify(file.metrics || {})
            ]);
        });

        // Save discovered components with null checks
        this.discoveredComponents.forEach((component, name) => {
            this.db.run(`
                INSERT OR REPLACE INTO discovered_components 
                (component_name, friendly_name, component_type, business_purpose, 
                 file_source, line_count, complexity_score, input_files, output_files, 
                 field_count, analyzed, quality_score, selected)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            `, [
                name || '',
                component.friendlyName || '',
                component.type || '',
                component.businessPurpose || '',
                component.fileSource || '',
                component.lineCount || 0,
                component.complexityScore || 0,
                JSON.stringify(component.inputFiles || []),
                JSON.stringify(component.outputFiles || []),
                component.fieldCount || 0,
                component.analyzed ? 1 : 0,
                component.qualityScore || null,
                component.selected ? 1 : 0
            ]);
        });

        // Save analysis results with null checks
        Object.entries(this.analysisResults).forEach(([name, result]) => {
            this.db.run(`
                INSERT OR REPLACE INTO analysis_results 
                (component_name, friendly_name, component_type, results_data, 
                 quality_score, business_context, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            `, [
                name || '',
                result.friendlyName || '',
                result.componentType || '',
                JSON.stringify(result),
                result.qualityScore || null,
                (result.llmAnalysis && result.llmAnalysis.businessPurpose) || ''
            ]);
        });

        // Save system settings
        this.db.run(`
            INSERT OR REPLACE INTO system_settings (setting_key, setting_value, updated_at)
            VALUES ('vllm_endpoint', ?, CURRENT_TIMESTAMP)
        `, [this.vllmEndpoint || 'http://localhost:8000']);

        this.db.run(`
            INSERT OR REPLACE INTO system_settings (setting_key, setting_value, updated_at)
            VALUES ('max_tokens', ?, CURRENT_TIMESTAMP)
        `, [this.maxTokens ? this.maxTokens.toString() : '6000']);

        console.log('üíæ Data saved to database');

    } catch (error) {
        console.error('Failed to save to database:', error);
    }
}


    // Load Data from Database
    async loadDataFromDatabase() {
        if (!this.db || !this.dbInitialized) return;

        try {
            // Clear existing data
            this.uploadedFiles = [];
            this.discoveredComponents.clear();
            this.analysisResults = {};

            // Load uploaded files
            const filesStmt = this.db.prepare('SELECT * FROM uploaded_files ORDER BY created_at DESC');
            while (filesStmt.step()) {
                const row = filesStmt.getAsObject();
                const file = {
                    id: row.file_id,
                    name: row.name,
                    content: row.content,
                    size: row.size,
                    type: row.type,
                    uploadDate: row.upload_date,
                    components: JSON.parse(row.components || '[]'),
                    metrics: JSON.parse(row.metrics || '{}')
                };
                this.uploadedFiles.push(file);
            }
            filesStmt.free();

            // Load discovered components
            const componentsStmt = this.db.prepare('SELECT * FROM discovered_components ORDER BY created_at DESC');
            while (componentsStmt.step()) {
                const row = componentsStmt.getAsObject();
                const component = {
                    name: row.component_name,
                    friendlyName: row.friendly_name,
                    type: row.component_type,
                    businessPurpose: row.business_purpose,
                    fileSource: row.file_source,
                    lineCount: row.line_count,
                    complexityScore: row.complexity_score,
                    inputFiles: JSON.parse(row.input_files || '[]'),
                    outputFiles: JSON.parse(row.output_files || '[]'),
                    fieldCount: row.field_count,
                    analyzed: row.analyzed === 1,
                    qualityScore: row.quality_score,
                    selected: row.selected === 1,
                    timestamp: row.created_at
                };
                this.discoveredComponents.set(row.component_name, component);
            }
            componentsStmt.free();

            // Load analysis results
            const resultsStmt = this.db.prepare('SELECT * FROM analysis_results ORDER BY updated_at DESC');
            while (resultsStmt.step()) {
                const row = resultsStmt.getAsObject();
                try {
                    this.analysisResults[row.component_name] = JSON.parse(row.results_data);
                } catch (error) {
                    console.warn(`Failed to parse analysis result for ${row.component_name}:`, error);
                }
            }
            resultsStmt.free();

            // Load system settings
            const settingsStmt = this.db.prepare('SELECT * FROM system_settings');
            while (settingsStmt.step()) {
                const row = settingsStmt.getAsObject();
                if (row.setting_key === 'vllm_endpoint') {
                    this.vllmEndpoint = row.setting_value;
                    const endpointInput = document.getElementById('vllmEndpoint');
                    if (endpointInput) endpointInput.value = row.setting_value;
                } else if (row.setting_key === 'max_tokens') {
                    this.maxTokens = parseInt(row.setting_value);
                    const maxTokensInput = document.getElementById('maxTokens');
                    if (maxTokensInput) maxTokensInput.value = row.setting_value;
                }
            }
            settingsStmt.free();

            console.log(`üìä Data loaded: ${this.uploadedFiles.length} files, ${this.discoveredComponents.size} components, ${Object.keys(this.analysisResults).length} analyses`);

        } catch (error) {
            console.error('Failed to load from database:', error);
        }
    }

    // Update Database Status Indicator
    updateDbStatus(status, message) {
        // Create status indicator if it doesn't exist
        let indicator = document.getElementById('dbStatusIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'dbStatusIndicator';
            indicator.className = `status-indicator ${status}`;
            indicator.innerHTML = `
                <span class="status-dot"></span>
                <span>${message}</span>
            `;
            
            // Find a good place to insert it
            const leftPanel = document.getElementById('leftPanelContent');
            if (leftPanel) {
                leftPanel.insertBefore(indicator, leftPanel.firstChild);
            }
        } else {
            indicator.className = `status-indicator ${status}`;
            indicator.innerHTML = `
                <span class="status-dot"></span>
                <span>${message}</span>
            `;
        }
    }

    // ============================================
    // EVENT LISTENERS AND UI INTERACTIONS
    // ============================================

    initializeEventListeners() {
        // API Validation
        const validateBtn = document.getElementById('validateApiBtn');
        if (validateBtn) {
            validateBtn.addEventListener('click', () => this.validateConnection());
        }
        
        // File Upload
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', () => {
                if (this.serverValidated) fileInput.click();
            });
            uploadArea.addEventListener('drop', (e) => this.handleFileDrop(e));
            uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
            uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
            fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
        }
        
        // Auto Analysis
        const autoAnalyzeBtn = document.getElementById('autoAnalyzeBtn');
        if (autoAnalyzeBtn) {
            autoAnalyzeBtn.addEventListener('click', () => this.startAutoAnalysis());
        }
        
        // Export buttons
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const exportMdBtn = document.getElementById('exportMdBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        if (exportJsonBtn) exportJsonBtn.addEventListener('click', () => this.exportResults('json'));
        if (exportMdBtn) exportMdBtn.addEventListener('click', () => this.exportResults('markdown'));
        if (clearBtn) clearBtn.addEventListener('click', () => this.clearAllData());
        
        // Settings
        const endpointInput = document.getElementById('vllmEndpoint');
        const maxTokensInput = document.getElementById('maxTokens');
        
        if (endpointInput) {
            endpointInput.addEventListener('input', () => this.onEndpointChange());
        }
        
        if (maxTokensInput) {
            maxTokensInput.addEventListener('input', () => this.onSettingsChange());
        }

        // Initialize tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active to clicked tab
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                const tabContent = document.getElementById(tabId);
                if (tabContent) {
                    tabContent.classList.add('active');
                }
            });
        });
    }

    // ============================================
    // UI HELPER FUNCTIONS
    // ============================================

    // Basic UI Functions
    togglePanel(side) {
        const panel = document.getElementById(side + 'Panel');
        if (!panel) return;
        
        panel.classList.toggle('collapsed');
        
        // Update button icon
        const btn = panel.querySelector('.collapse-btn');
        if (btn) {
            if (side === 'left') {
                btn.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
            } else {
                btn.textContent = panel.classList.contains('collapsed') ? '‚óÄ' : '‚ñ∂';
            }
        }
        
        // Save state to database
        if (this.db && this.dbInitialized) {
            try {
                this.db.run(`
                    INSERT OR REPLACE INTO system_settings (setting_key, setting_value, updated_at)
                    VALUES (?, ?, CURRENT_TIMESTAMP)
                `, [`${side}_panel_collapsed`, panel.classList.contains('collapsed') ? '1' : '0']);
            } catch (error) {
                console.warn('Could not save panel state:', error);
            }
        }
    }

    toggleCollapsible(header) {
        if (!header || !header.parentElement) return;
        
        const section = header.parentElement;
        section.classList.toggle('expanded');
        
        // Update expand icon rotation
        const expandIcon = header.querySelector('.expand-icon');
        if (expandIcon) {
            if (section.classList.contains('expanded')) {
                expandIcon.style.transform = 'rotate(180deg)';
            } else {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }

    // Show/Hide Loading
    showLoading() {
        const loading = document.getElementById('loadingIndicator');
        if (loading) loading.classList.add('show');
    }

    hideLoading() {
        const loading = document.getElementById('loadingIndicator');
        if (loading) loading.classList.remove('show');
    }

    updateLoadingStatus(status) {
        const statusEl = document.getElementById('loadingStatus');
        if (statusEl) statusEl.textContent = status;
    }

    updateProgress(percentage) {
        const progressFill = document.getElementById('progressFill');
        if (progressFill) progressFill.style.width = `${percentage}%`;
    }

    // Alert Messages
    showMessage(type, message, duration = 3000) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `
            <span class="alert-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
            <span class="alert-message">${message}</span>
        `;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => alert.remove(), 300);
            }
        }, duration);
    }

    showSuccess(message) { this.showMessage('success', message); }
    showError(message) { this.showMessage('error', message, 5000); }
    showWarning(message) { this.showMessage('warning', message, 4000); }
    showInfo(message) { this.showMessage('info', message); }

    // ============================================
    // LLM CONNECTION AND VALIDATION
    // ============================================

    // Validate LLM Connection
    async validateConnection() {
        const endpoint = document.getElementById('vllmEndpoint').value.trim();
        if (!endpoint) {
            this.showError('Please enter vLLM endpoint');
            return;
        }

        this.updateConnectionStatus('connecting', 'Testing LLM connection...');

        try {
            const response = await fetch(`${endpoint}/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: "Test connection. Respond with 'Connected'",
                    max_tokens: 10,
                    temperature: 0.1
                }),
                signal: AbortSignal.timeout(10000)
            });

            if (response.ok) {
                this.serverValidated = true;
                this.vllmEndpoint = endpoint;
                this.updateConnectionStatus('connected', `‚úÖ LLM connection verified`);
                this.showSuccess('üöÄ vLLM server connected successfully!');
                
                // Enable file upload and auto-analysis
                this.enableFileUpload();
                
                // Save to database
                this.saveToDatabase();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            this.serverValidated = false;
            this.updateConnectionStatus('disconnected', `‚ùå Connection failed: ${error.message}`);
            this.showError(`LLM connection failed: ${error.message}`);
        }
    }

    // Enable File Upload
    enableFileUpload() {
        const uploadArea = document.getElementById('uploadArea');
        const autoAnalyzeBtn = document.getElementById('autoAnalyzeBtn');
        
        if (uploadArea) {
            uploadArea.style.opacity = '1';
            uploadArea.style.cursor = 'pointer';
        }
        
        // Enable auto-analysis if files are already uploaded
        if (this.uploadedFiles.length > 0 && autoAnalyzeBtn) {
            autoAnalyzeBtn.disabled = false;
        }
    }

    // Update Connection Status
    updateConnectionStatus(status, message) {
        const statusEl = document.getElementById('apiStatus');
        if (statusEl) {
            statusEl.className = `status-indicator ${status}`;
            statusEl.innerHTML = `
                <span class="status-dot"></span>
                <span>${message}</span>
            `;
        }
    }

    // Settings Change Handlers
    onEndpointChange() {
        this.serverValidated = false;
        this.updateConnectionStatus('disconnected', 'Connection not validated');
    }

    onSettingsChange() {
        const maxTokensInput = document.getElementById('maxTokens');
        if (maxTokensInput) {
            this.maxTokens = parseInt(maxTokensInput.value) || 6000;
            this.saveToDatabase();
        }
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    // Utility function
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Clear All Data
    clearAllData() {
        if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
            return;
        }
        
        // Clear in-memory data
        this.uploadedFiles = [];
        this.analysisResults = {};
        this.discoveredComponents.clear();
        this.currentSelectedComponent = null;
        this.chatHistory = [];
        
        // Clear database
        if (this.db && this.dbInitialized) {
            try {
                this.db.run('DELETE FROM uploaded_files');
                this.db.run('DELETE FROM discovered_components');
                this.db.run('DELETE FROM analysis_results');
                this.db.run('DELETE FROM chat_history');
            } catch (error) {
                console.error('Failed to clear database:', error);
            }
        }
        
        // Reset UI
        this.updateDashboardStats();
        this.displayDiscoveredComponents();
        
        // Disable features
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const exportMdBtn = document.getElementById('exportMdBtn');
        
        if (chatInput) chatInput.disabled = true;
        if (chatSendBtn) chatSendBtn.disabled = true;
        if (exportJsonBtn) exportJsonBtn.disabled = true;
        if (exportMdBtn) exportMdBtn.disabled = true;
        
        this.showSuccess('üóëÔ∏è All data cleared successfully');
    }

    // Cleanup on page unload
    cleanup() {
        if (this.saveInterval) {
            clearInterval(this.saveInterval);
        }
        
        if (this.db) {
            // Save one final time before closing
            this.saveToDownloadsFolder();
            this.db.close();
        }
    }
}

// ============================================
// GLOBAL FUNCTIONS FOR HTML ONCLICK HANDLERS
// ============================================

// Global functions for HTML onclick handlers
function togglePanel(side) {
    if (window.analyzer) {
        window.analyzer.togglePanel(side);
    }
}

function toggleCollapsible(header) {
    if (window.analyzer) {
        window.analyzer.toggleCollapsible(header);
    }
}

// Make sure these global functions are available immediately
window.togglePanel = togglePanel;
window.toggleCollapsible = toggleCollapsible;
// ============================================
// ENHANCED CODE ANALYZER - PART 3
// File Processing and Component Discovery
// ============================================

// Extend the EnhancedCodeAnalyzer class with file processing methods
Object.assign(EnhancedCodeAnalyzer.prototype, {

    // ============================================
    // FILE HANDLING AND PROCESSING
    // ============================================

    // File Upload Handling
    async handleFileDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.classList.remove('drag-over');
        
        if (!this.serverValidated) {
            this.showError('Please validate LLM API connection first');
            return;
        }
        
        const files = Array.from(e.dataTransfer.files);
        await this.processFiles(files);
    },

    async handleFileSelect(e) {
        if (!this.serverValidated) {
            this.showError('Please validate LLM API connection first');
            return;
        }
        
        const files = Array.from(e.target.files);
        await this.processFiles(files);
    },

    handleDragOver(e) {
        e.preventDefault();
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) uploadArea.classList.add('drag-over');
    },

    handleDragLeave(e) {
        e.preventDefault();
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) uploadArea.classList.remove('drag-over');
    },

    // Process Files with Auto-Discovery
    async processFiles(files) {
    this.showLoading();
    this.updateLoadingStatus('üìÅ Processing uploaded files...');
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        this.updateProgress((i / files.length) * 50); // First 50% for file processing
        
        try {
            const content = await this.readFile(file);
            const fileType = this.detectFileType(file.name, content);
            
            const fileObj = {
                name: file.name,
                content: content,
                size: file.size,
                type: fileType,
                uploadDate: new Date().toISOString(),
                id: Date.now() + Math.random(),
                components: this.extractComponentsFromFile(content, fileType),
                metrics: this.calculateFileMetrics(content, fileType)
            };
            
            this.uploadedFiles.push(fileObj);
            
            // Auto-discover components
            this.updateLoadingStatus(`üîç Auto-discovering components in ${file.name}...`);
            await this.autoDiscoverComponents(fileObj);
            
        } catch (error) {
            this.showError(`Failed to read ${file.name}: ${error.message}`);
        }
    }
    
    this.updateProgress(100);
    this.hideLoading();
    
    // **FIX: Force UI updates after processing**
    this.updateDashboardStats();
    this.displayDiscoveredComponents();
    this.updateComponentsLibrary(); // **ADDED: Update Components tab**
    this.enableAutoAnalysis();
    this.saveToDatabase();
    
    this.showSuccess(`üìÅ ${files.length} files uploaded and ${this.discoveredComponents.size} components auto-discovered!`);
},
updateComponentsLibrary() {
    // Show the library content if components exist
    const componentsEmptyState = document.getElementById('componentsEmptyState');
    const componentsLibraryContent = document.getElementById('componentsLibraryContent');
    
    if (this.uploadedFiles.length > 0) {
        if (componentsEmptyState) componentsEmptyState.style.display = 'none';
        if (componentsLibraryContent) componentsLibraryContent.style.display = 'block';
        
        // Update library statistics
        this.updateLibraryStats();
        
        // Update files and components list
        this.updateFilesComponentsList();
        
        // Attach search listeners
        this.attachLibrarySearchListeners();
    } else {
        if (componentsEmptyState) componentsEmptyState.style.display = 'block';
        if (componentsLibraryContent) componentsLibraryContent.style.display = 'none';
    }
},
updateLibraryStats() {
    const analyzedCount = Object.keys(this.analysisResults).length;
    
    // Update stat elements
    const statElements = {
        'statUploadedFiles': this.uploadedFiles.length,
        'statDiscoveredComponents': this.discoveredComponents.size,
        'statAnalyzedComponents': analyzedCount,
        'statLinesOfCode': this.uploadedFiles.reduce((sum, file) => sum + (file.metrics?.codeLines || 0), 0)
    };
    
    Object.entries(statElements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value.toLocaleString();
        }
    });
    
    // Update subtitle
    const librarySubtitle = document.getElementById('librarySubtitle');
    if (librarySubtitle) {
        librarySubtitle.textContent = `${this.uploadedFiles.length} files uploaded ‚Ä¢ ${this.discoveredComponents.size} components discovered`;
    }
},
updateFilesComponentsList() {
    const container = document.getElementById('filesComponentsList');
    if (!container) return;
    
    if (this.uploadedFiles.length === 0) {
        container.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: var(--grey-500);">
                <div style="font-size: 2rem; margin-bottom: 1rem;">üìÅ</div>
                <h4>No files uploaded yet</h4>
                <p>Upload COBOL, JCL, or Copybook files to see them here</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = this.generateFilesComponentsList();
    
    // Attach event listeners
    setTimeout(() => {
        this.attachFileExpansionListeners();
    }, 100);
},

generateFilesComponentsList() {
    let html = '';
    
    this.uploadedFiles.forEach((file, index) => {
        const fileComponents = file.components || [];
        const mainComponents = fileComponents.filter(comp => comp.isMainComponent);
        const otherComponents = fileComponents.filter(comp => !comp.isMainComponent);
        
        const fileTypeIcon = this.getFileTypeIcon(file.type);
        const fileTypeColor = this.getFileTypeColor(file.type);
        
        html += `
            <!-- File Row -->
            <div class="file-row" data-file-index="${index}" style="
                border-bottom: 1px solid var(--grey-200);
                cursor: pointer;
                transition: background-color 0.2s ease;
            " onclick="analyzer.toggleFileExpansion(${index})">
                <div style="padding: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <!-- File Icon -->
                        <div style="
                            width: 48px; 
                            height: 48px; 
                            background: ${fileTypeColor}; 
                            color: white; 
                            border-radius: 8px; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 1.25rem;
                        ">
                            ${fileTypeIcon}
                        </div>
                        
                        <!-- File Info -->
                        <div>
                            <div style="font-weight: bold; font-size: 1rem; color: var(--grey-800); margin-bottom: 0.25rem;">
                                ${file.name}
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--grey-600);">
                                <span>üìã ${file.type}</span>
                                <span>üìè ${(file.size / 1024).toFixed(1)} KB</span>
                                <span>üìä ${file.metrics?.codeLines || 0} lines</span>
                                <span>üéØ ${fileComponents.length} components</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expand/Collapse Indicator -->
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; font-weight: 600; color: var(--primary-blue);">
                                ${mainComponents.length} Main
                            </div>
                            <div style="font-size: 0.75rem; color: var(--grey-500);">
                                ${otherComponents.length} Other
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-icon-${index}" style="
                            width: 24px; 
                            height: 24px; 
                            color: var(--grey-400); 
                            transition: transform 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            ‚ñº
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Expandable Components Section -->
            <div class="file-components" id="file-components-${index}" style="
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                background: var(--grey-50);
            ">
                <div style="padding: 1.5rem;">
                    ${this.generateFileComponentsContent(file, fileComponents)}
                </div>
            </div>
        `;
    });
    
    return html;
},

// **FIX 6: ADD generateFileComponentsContent method if missing**
// Location: Add this method

generateFileComponentsContent(file, components) {
    if (components.length === 0) {
        return `
            <div style="text-align: center; padding: 2rem; color: var(--grey-500);">
                <div style="font-size: 1.5rem; margin-bottom: 1rem;">üì¶</div>
                <h5>No components found</h5>
                <p>This file doesn't contain recognizable COBOL components</p>
            </div>
        `;
    }
    
    const mainComponents = components.filter(comp => comp.isMainComponent);
    const otherComponents = components.filter(comp => !comp.isMainComponent);
    
    let html = '';
    
    // Main Components Section
    if (mainComponents.length > 0) {
        html += `
            <div style="margin-bottom: 2rem;">
                <h5 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üéØ</span>
                    Main Components (${mainComponents.length})
                </h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    ${mainComponents.map(comp => this.generateComponentCard(comp, file)).join('')}
                </div>
            </div>
        `;
    }
    
    // Other Components Section (show first 10, then collapse)
    if (otherComponents.length > 0) {
        const showCount = 10;
        const hiddenCount = Math.max(0, otherComponents.length - showCount);
        
        html += `
            <div>
                <h5 style="color: var(--grey-600); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìã</span>
                    Other Components (${otherComponents.length})
                </h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;">
                    ${otherComponents.slice(0, showCount).map(comp => this.generateSmallComponentCard(comp, file)).join('')}
                </div>
                ${hiddenCount > 0 ? `
                    <div style="text-align: center; margin-top: 1rem;">
                        <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="analyzer.showAllComponents('${file.name}')">
                            Show ${hiddenCount} more components
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    return html;
},

// **FIX 7: ADD attachFileExpansionListeners method if missing**
// Location: Add this method

attachFileExpansionListeners() {
    // File expansion listeners are handled by onclick in the HTML
    // But we can add additional listeners here if needed
    
    document.querySelectorAll('.file-row').forEach((row, index) => {
        row.addEventListener('mouseover', function() {
            this.style.backgroundColor = 'var(--grey-50)';
        });
        
        row.addEventListener('mouseout', function() {
            this.style.backgroundColor = 'white';
        });
    });
},

// **FIX 8: ENSURE enableAutoAnalysis works properly**
// Location: Find and replace the enableAutoAnalysis method

enableAutoAnalysis() {
    const autoAnalyzeBtn = document.getElementById('autoAnalyzeBtn');
    const hasComponents = this.discoveredComponents.size > 0;
    const isServerValidated = this.serverValidated;
    
    console.log(`enableAutoAnalysis: components=${hasComponents}, server=${isServerValidated}`);
    
    if (autoAnalyzeBtn) {
        if (hasComponents && isServerValidated) {
            autoAnalyzeBtn.disabled = false;
            autoAnalyzeBtn.innerHTML = `
                <span>ü§ñ</span>
                Start Auto-Analysis (${this.discoveredComponents.size} components)
            `;
        } else {
            autoAnalyzeBtn.disabled = true;
            if (!isServerValidated) {
                autoAnalyzeBtn.innerHTML = `
                    <span>üîí</span>
                    Connect LLM Server First
                `;
            } else if (!hasComponents) {
                autoAnalyzeBtn.innerHTML = `
                    <span>üìÅ</span>
                    Upload Files First
                `;
            }
        }
    }
    
    // **ALSO UPDATE EXPORT BUTTONS**
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const exportMdBtn = document.getElementById('exportMdBtn');
    
    if (exportJsonBtn) exportJsonBtn.disabled = !hasComponents;
    if (exportMdBtn) exportMdBtn.disabled = !hasComponents;
},
    // Read File
    readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(new Error('File read failed'));
            reader.readAsText(file);
        });
    },

    // Detect File Type
    detectFileType(fileName, content) {
        const name = fileName.toLowerCase();
        const upperContent = content.toUpperCase();
        
        if (name.includes('.cpy') || name.includes('copybook')) {
            return 'Copybook';
        } else if (name.includes('.jcl') || upperContent.includes('//JOB ')) {
            return 'JCL Job';
        } else if (name.includes('.cbl') || name.includes('.cob') || 
                  upperContent.includes('IDENTIFICATION DIVISION') ||
                  upperContent.includes('PROGRAM-ID')) {
            return 'COBOL Program';
        } else if (name.includes('.proc')) {
            return 'JCL Procedure';
        } else {
            return 'Text File';
        }
    },

    // Calculate File Metrics
    calculateFileMetrics(content, fileType) {
        const lines = content.split('\n');
        const totalLines = lines.length;
        const codeLines = lines.filter(line => {
            const trimmed = line.trim();
            return trimmed.length > 0 && !trimmed.startsWith('*') && !trimmed.startsWith('//');
        }).length;
        
        const complexity = this.calculateComplexity(content, fileType);
        
        return {
            totalLines,
            codeLines,
            commentLines: totalLines - codeLines,
            complexity,
            fileSize: content.length
        };
    },

    // Calculate Complexity Score
    calculateComplexity(content, fileType) {
        const upperContent = content.toUpperCase();
        let complexity = 1;
        
        if (fileType === 'COBOL Program') {
            // Count decision points
            const ifCount = (upperContent.match(/\bIF\b/g) || []).length;
            const performCount = (upperContent.match(/\bPERFORM\b/g) || []).length;
            const evaluateCount = (upperContent.match(/\bEVALUATE\b/g) || []).length;
            
            complexity = 1 + ifCount + performCount + evaluateCount;
        } else if (fileType === 'Copybook') {
            // Count field definitions
            const fieldCount = (upperContent.match(/^\s*\d{2}\s+/gm) || []).length;
            complexity = Math.ceil(fieldCount / 10);
        }
        
        return Math.min(complexity, 10);
    },

    // ============================================
    // COMPONENT EXTRACTION AND DISCOVERY
    // ============================================

    // Extract Components from Files
  extractComponentsFromFile(content, fileType) {
    const components = [];
    const lines = content.split('\n');
    const foundComponents = new Set(); // Prevent duplicates

    lines.forEach((line, index) => {
        const trimmed = line.trim().toUpperCase();
        const originalLine = line.trim(); // Keep original case
        
        // **ENHANCED: Extract ALL 01-level fields as components**
        const field01Match = trimmed.match(/^\s*01\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (field01Match) {
            const componentName = field01Match[1];
            
            // **FIX: Prevent duplicates**
            if (!foundComponents.has(componentName)) {
                foundComponents.add(componentName);
                
                const fieldCount = this.calculateIndividualFieldCount(componentName, lines, index);
                
                components.push({
                    name: componentName,
                    type: 'RECORD_LAYOUT',
                    level: '01',
                    lineNumber: index + 1,
                    fileType: fileType,
                    isMainComponent: true, // **ALL 01-levels are main components**
                    businessPurpose: this.generateBusinessPurpose(componentName),
                    individualFieldCount: fieldCount, // **INDIVIDUAL field count**
                    hasSubFields: this.checkIfHasSubFields(lines, index),
                    section: this.detectSection(lines, index)
                });
            }
        }
        
        // **ENHANCED: Extract ALL field levels for detailed analysis**
        const fieldMatch = trimmed.match(/^\s*(\d{2})\s+([A-Z][A-Z0-9\-_]*)/);
        if (fieldMatch) {
            const level = parseInt(fieldMatch[1]);
            const fieldName = fieldMatch[2];
            
            if (level !== 88 && fieldName && level <= 49 && level > 1) {
                components.push({
                    name: fieldName,
                    type: 'FIELD',
                    level: level,
                    lineNumber: index + 1,
                    fileType: fileType,
                    isMainComponent: false, // Sub-fields are not main components
                    businessPurpose: this.generateFieldPurpose(fieldName),
                    parentRecord: this.findParentRecord(lines, index)
                });
            }
        }
        
        // **EXTRACT: COBOL Program Names**
        const programMatch = trimmed.match(/PROGRAM-ID\.?\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (programMatch) {
            const programName = programMatch[1];
            
            if (!foundComponents.has(programName)) {
                foundComponents.add(programName);
                
                // **COUNT: All 01-levels in the entire program**
                const programFieldCount = this.countAllO1LevelsInProgram(lines);
                
                components.push({
                    name: programName,
                    type: 'PROGRAM',
                    lineNumber: index + 1,
                    fileType: fileType,
                    isMainComponent: true,
                    businessPurpose: this.generateBusinessPurpose(programName),
                    individualFieldCount: programFieldCount,
                    isProgramComponent: true
                });
            }
        }
        
        // **EXTRACT: Copybook references (but don't duplicate if already found as 01-level)**
        const copyMatch = trimmed.match(/COPY\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (copyMatch) {
            const copybookName = copyMatch[1];
            
            if (!foundComponents.has(copybookName)) {
                foundComponents.add(copybookName);
                
                components.push({
                    name: copybookName,
                    type: 'COPYBOOK',
                    lineNumber: index + 1,
                    fileType: fileType,
                    isMainComponent: false, // Referenced, not defined
                    businessPurpose: this.generateBusinessPurpose(copybookName),
                    individualFieldCount: 0, // Will be counted when actual copybook is uploaded
                    isReference: true
                });
            }
        }
        
        // **EXTRACT: File references**
        const fileMatch = trimmed.match(/FD\s+([A-Z][A-Z0-9\-_]{2,})/);
        if (fileMatch) {
            const fileName = fileMatch[1];
            
            if (!foundComponents.has(fileName)) {
                foundComponents.add(fileName);
                
                components.push({
                    name: fileName,
                    type: 'FILE',
                    lineNumber: index + 1,
                    fileType: fileType,
                    isMainComponent: false,
                    businessPurpose: this.generateBusinessPurpose(fileName),
                    individualFieldCount: 0
                });
            }
        }
    });
    
    console.log(`üìã Extracted ${components.length} components from ${fileType} file (${foundComponents.size} unique)`);
    return components;
},

// **FIX 2: ADD calculateIndividualFieldCount method**
// Location: Add this new method

calculateIndividualFieldCount(componentName, lines, startIndex) {
    let fieldCount = 1; // Count the 01-level itself
    let i = startIndex + 1;
    const componentUpper = componentName.toUpperCase();
    
    // Look ahead from the 01-level to count its subordinate fields
    while (i < lines.length) {
        const line = lines[i].trim().toUpperCase();
        const fieldMatch = line.match(/^\s*(\d{2})\s+([A-Z][A-Z0-9\-_]*)/);
        
        if (fieldMatch) {
            const level = parseInt(fieldMatch[1]);
            const fieldName = fieldMatch[2];
            
            if (level === 1) {
                // Found another 01-level, stop counting
                break;
            } else if (level > 1 && level !== 88 && fieldName !== 'FILLER') {
                // Count subordinate fields (exclude 88-level condition names and FILLER)
                fieldCount++;
            }
        }
        i++;
    }
    
    return fieldCount;
},

// **FIX 3: ADD countAllO1LevelsInProgram method**
// Location: Add this new method

countAllO1LevelsInProgram(lines) {
    let count = 0;
    
    lines.forEach(line => {
        const trimmed = line.trim().toUpperCase();
        const field01Match = trimmed.match(/^\s*01\s+([A-Z][A-Z0-9\-_]+)/);
        
        if (field01Match) {
            const fieldName = field01Match[1];
            if (fieldName !== 'FILLER') {
                count++;
            }
        }
    });
    
    return count;
},

// **FIX 4: ADD checkIfHasSubFields method**
// Location: Add this new method

checkIfHasSubFields(lines, currentIndex) {
    // Look ahead to see if there are subordinate levels
    for (let i = currentIndex + 1; i < Math.min(currentIndex + 20, lines.length); i++) {
        const nextLine = lines[i].trim().toUpperCase();
        const levelMatch = nextLine.match(/^\s*(\d{2})\s+/);
        
        if (levelMatch) {
            const nextLevel = parseInt(levelMatch[1]);
            if (nextLevel > 1 && nextLevel < 50) {
                return true; // Has sub-fields
            } else if (nextLevel === 1) {
                return false; // Next 01-level, no sub-fields
            }
        }
    }
    return false;
},

// **FIX 5: ADD detectSection method**
// Location: Add this new method

detectSection(lines, currentIndex) {
    // Look backwards to find which section we're in
    for (let i = currentIndex; i >= 0; i--) {
        const line = lines[i].trim().toUpperCase();
        
        if (line.includes('WORKING-STORAGE SECTION')) {
            return 'WORKING-STORAGE';
        } else if (line.includes('LINKAGE SECTION')) {
            return 'LINKAGE';
        } else if (line.includes('FILE SECTION')) {
            return 'FILE';
        } else if (line.includes('LOCAL-STORAGE SECTION')) {
            return 'LOCAL-STORAGE';
        } else if (line.includes('PROCEDURE DIVISION')) {
            return 'UNKNOWN'; // We're past data sections
        }
    }
    return 'UNKNOWN';
},

    // Generate Business Purpose based on naming patterns
    generateBusinessPurpose(componentName) {
        const name = componentName.toUpperCase();
        
        // Customer-related
        if (name.includes('CUST') || name.includes('CUSTOMER')) {
            if (name.includes('MASTER') || name.includes('MAST')) {
                return 'Customer Master Data Management';
            } else if (name.includes('TRANS') || name.includes('TXN')) {
                return 'Customer Transaction Processing';
            } else if (name.includes('VALID') || name.includes('CHECK')) {
                return 'Customer Data Validation';
            } else {
                return 'Customer Information Processing';
            }
        }
        
        // Account-related
        else if (name.includes('ACCT') || name.includes('ACCOUNT')) {
            if (name.includes('BAL') || name.includes('BALANCE')) {
                return 'Account Balance Management';
            } else if (name.includes('TRANS') || name.includes('TXN')) {
                return 'Account Transaction Processing';
            } else if (name.includes('MAINT') || name.includes('UPD')) {
                return 'Account Maintenance Operations';
            } else {
                return 'Account Management System';
            }
        }
        
        // Financial/Payment
        else if (name.includes('PAY') || name.includes('PAYMENT')) {
            return 'Payment Processing System';
        } else if (name.includes('INVOICE') || name.includes('INV')) {
            return 'Invoice Management System';
        } else if (name.includes('BILLING') || name.includes('BILL')) {
            return 'Billing Operations System';
        }
        
        // Transaction-related
        else if (name.includes('TRANS') || name.includes('TXN')) {
            if (name.includes('LOG') || name.includes('HIST')) {
                return 'Transaction History & Logging';
            } else if (name.includes('PROC') || name.includes('PROCESS')) {
                return 'Transaction Processing Engine';
            } else {
                return 'Transaction Management System';
            }
        }
        
        // Data management
        else if (name.includes('MASTER') || name.includes('MAST')) {
            return 'Master Data Management';
        } else if (name.includes('COPY') || name.includes('CPY')) {
            return 'Data Structure Definition';
        } else if (name.includes('VALID') || name.includes('CHECK')) {
            return 'Data Validation & Quality Control';
        }
        
        // Reports
        else if (name.includes('REPORT') || name.includes('RPT')) {
            return 'Report Generation System';
        } else if (name.includes('EXTRACT') || name.includes('EXT')) {
            return 'Data Extraction & ETL';
        }
        
        // Maintenance
        else if (name.includes('MAINT') || name.includes('UPD')) {
            return 'Data Maintenance Operations';
        } else if (name.includes('DELETE') || name.includes('DEL')) {
            return 'Data Deletion & Cleanup';
        }
        
        // Generic based on type indicators
        else if (name.includes('PROC') || name.includes('PROCESS')) {
            return 'Business Process Automation';
        } else if (name.includes('UTIL') || name.includes('UTILITY')) {
            return 'System Utility Functions';
        } else if (name.includes('BATCH') || name.includes('JOB')) {
            return 'Batch Processing System';
        } else if (name.includes('ONLINE') || name.includes('CICS')) {
            return 'Online Transaction Processing';
        }
        
        // Fallback based on common patterns
        else if (name.endsWith('-RECORD') || name.endsWith('-REC')) {
            return 'Data Record Structure';
        } else if (name.endsWith('-FILE') || name.endsWith('-FL')) {
            return 'File Management System';
        } else if (name.endsWith('-PROG') || name.endsWith('-PGM')) {
            return 'Business Logic Program';
        } else {
            return 'Mainframe Business Component';
        }
    },

    // ============================================
    // AUTO-DISCOVERY AND COMPONENT ANALYSIS
    // ============================================

    // Auto-Discover Components
    async autoDiscoverComponents(fileObj) {
    console.log(`üîç Auto-discovering components in: ${fileObj.name}`);
    console.log(`File has ${fileObj.components.length} extracted components`);
    
    // **PROCESS ALL MAIN COMPONENTS (including all 01-levels)**
    const mainComponents = fileObj.components.filter(comp => comp.isMainComponent);
    console.log(`üìã Found ${mainComponents.length} main components to process`);
    
    for (const component of mainComponents) {
        const existingComponent = this.discoveredComponents.get(component.name);
        
        if (existingComponent) {
            console.log(`üîÑ Updating existing component: ${component.name}`);
            
            // **UPDATE: Use individual field count**
            const newFieldCount = component.individualFieldCount || 0;
            existingComponent.fieldCount = Math.max(existingComponent.fieldCount || 0, newFieldCount);
            
            // Update other properties
            existingComponent.inputFiles = this.mergeUniqueArrays(
                existingComponent.inputFiles || [], 
                this.extractInputFiles(fileObj.content)
            );
            existingComponent.outputFiles = this.mergeUniqueArrays(
                existingComponent.outputFiles || [], 
                this.extractOutputFiles(fileObj.content)
            );
            
            if (fileObj.metrics.codeLines > (existingComponent.lineCount || 0)) {
                existingComponent.lineCount = fileObj.metrics.codeLines;
                existingComponent.complexityScore = fileObj.metrics.complexity;
                existingComponent.fileSource = fileObj.name;
            }
            
            existingComponent.analyzed = false;
            existingComponent.needsReanalysis = true;
            
        } else {
            console.log(`‚ú® Creating new component: ${component.name} (Type: ${component.type})`);
            
            // **CREATE: Use individual field count**
            const componentFieldCount = component.individualFieldCount || 0;
            console.log(`   üìä Individual field count: ${componentFieldCount}`);
            
            const discoveredComponent = {
                name: component.name,
                friendlyName: await this.generateFriendlyName(component.name),
                type: component.type,
                businessPurpose: component.businessPurpose,
                fileSource: fileObj.name,
                lineNumber: component.lineNumber,
                section: component.section,
                hasSubFields: component.hasSubFields,
                lineCount: fileObj.metrics.codeLines,
                complexityScore: fileObj.metrics.complexity,
                inputFiles: this.extractInputFiles(fileObj.content),
                outputFiles: this.extractOutputFiles(fileObj.content),
                fieldCount: componentFieldCount, // **USE INDIVIDUAL COUNT**
                analyzed: false,
                selected: false,
                timestamp: new Date().toISOString(),
                isProgramComponent: component.isProgramComponent || false
            };
            
            this.discoveredComponents.set(component.name, discoveredComponent);
            console.log(`‚úÖ Added component: ${component.name} with ${componentFieldCount} fields`);
        }
    }
    
    console.log(`üìä Total discovered components now: ${this.discoveredComponents.size}`);
    this.invalidateAnalysesWithMissingDependencies();
},

// **DEBUGGING: Add console logging to verify component discovery**
// Location: Add this method for debugging
async analyzeProgramFields(componentName, relevantFiles) {
    console.log(`üîç Analyzing program fields for: ${componentName}`);
    
    const fieldAnalysis = {
        fields: [],
        sections: {
            workingStorage: [],
            linkageSection: [],
            fileSection: [],
            localStorage: []
        },
        inputFields: [],
        outputFields: [],
        referenceFields: [],
        businessLogicSummary: {
            totalSections: 0,
            total01Levels: 0,
            hasWorkingStorage: false,
            hasLinkageSection: false,
            hasFileSection: false
        }
    };
    
    for (const file of relevantFiles) {
        const content = file.content;
        const lines = content.split('\n');
        
        let currentSection = 'unknown';
        let inDataDivision = false;
        const foundFields = new Set(); // **PREVENT DUPLICATES**
        
        lines.forEach((line, index) => {
            const trimmed = line.trim().toUpperCase();
            
            // Detect COBOL divisions and sections
            if (trimmed.includes('DATA DIVISION')) {
                inDataDivision = true;
                return;
            }
            
            if (trimmed.includes('PROCEDURE DIVISION')) {
                inDataDivision = false;
                return;
            }
            
            if (!inDataDivision) return;
            
            // Detect sections within Data Division
            if (trimmed.includes('WORKING-STORAGE SECTION')) {
                currentSection = 'workingStorage';
                fieldAnalysis.businessLogicSummary.hasWorkingStorage = true;
                return;
            } else if (trimmed.includes('LINKAGE SECTION')) {
                currentSection = 'linkageSection';
                fieldAnalysis.businessLogicSummary.hasLinkageSection = true;
                return;
            } else if (trimmed.includes('FILE SECTION')) {
                currentSection = 'fileSection';
                fieldAnalysis.businessLogicSummary.hasFileSection = true;
                return;
            } else if (trimmed.includes('LOCAL-STORAGE SECTION')) {
                currentSection = 'localStorage';
                return;
            }
            
            // **EXTRACT ALL 01-LEVEL FIELDS** for program view
            const field01Match = trimmed.match(/^\s*01\s+([A-Z][A-Z0-9\-_]+)(?:\s+(.*))?/);
            if (field01Match && currentSection !== 'unknown') {
                const fieldName = field01Match[1];
                const restOfLine = field01Match[2] || '';
                
                // **SKIP: FILLER and duplicates**
                if (fieldName === 'FILLER' || foundFields.has(fieldName)) return;
                foundFields.add(fieldName);
                
                const field = {
                    name: fieldName,
                    level: 1,
                    section: currentSection,
                    sectionDisplay: this.getSectionDisplayName(currentSection),
                    lineNumber: index + 1,
                    fileName: file.name,
                    picClause: this.extractPictureClause(restOfLine),
                    hasSubFields: this.checkForSubFields(lines, index),
                    individualFieldCount: this.calculateIndividualFieldCount(fieldName, lines, index),
                    businessLogic: {
                        businessMeaning: this.generateFieldPurpose(fieldName),
                        validationRules: [],
                        calculations: []
                    },
                    usage: this.determineProgramFieldUsage(fieldName, content, currentSection)
                };
                
                fieldAnalysis.fields.push(field);
                fieldAnalysis.sections[currentSection].push(field);
                fieldAnalysis.businessLogicSummary.total01Levels++;
                
                // Categorize field usage for program context
                this.categorizeFieldUsage(field, fieldAnalysis);
            }
        });
    }
    
    // Calculate section count
    fieldAnalysis.businessLogicSummary.totalSections = 
        Object.values(fieldAnalysis.sections).filter(section => section.length > 0).length;
    
    console.log(`‚úÖ Program field analysis complete: ${fieldAnalysis.fields.length} 01-level fields found`);
    console.log(`   üìä Working Storage: ${fieldAnalysis.sections.workingStorage.length}`);
    console.log(`   üìä Linkage Section: ${fieldAnalysis.sections.linkageSection.length}`);
    console.log(`   üìä File Section: ${fieldAnalysis.sections.fileSection.length}`);
    
    return fieldAnalysis;
},
debugComponentDiscovery() {
    console.log('=== COMPONENT DISCOVERY DEBUG ===');
    console.log(`Total uploaded files: ${this.uploadedFiles.length}`);
    console.log(`Total discovered components: ${this.discoveredComponents.size}`);
    
    this.uploadedFiles.forEach((file, index) => {
        console.log(`File ${index + 1}: ${file.name}`);
        console.log(`  - Type: ${file.type}`);
        console.log(`  - Components extracted: ${file.components.length}`);
        console.log(`  - Main components: ${file.components.filter(c => c.isMainComponent).length}`);
        
        file.components.filter(c => c.isMainComponent).forEach(comp => {
            console.log(`    * ${comp.name} (${comp.type})`);
        });
    });
    
    console.log('Discovered components in Map:');
    Array.from(this.discoveredComponents.entries()).forEach(([name, comp]) => {
        console.log(`  - ${name}: ${comp.friendlyName} (${comp.type})`);
    });
    console.log('=== END DEBUG ===');
},
// **NEW METHOD: Calculate Component Field Count**
calculateComponentFieldCount(componentName, fileObj) {
    console.log(`üîç Calculating field count for component: ${componentName}`);
    
    if (!fileObj.components || fileObj.components.length === 0) {
        return 0;
    }
    
    const componentUpperName = componentName.toUpperCase();
    
    // **FIX: Use individualFieldCount if available**
    const component = fileObj.components.find(c => c.name.toUpperCase() === componentUpperName);
    if (component && component.individualFieldCount !== undefined) {
        console.log(`‚úÖ Using individual field count for ${componentName}: ${component.individualFieldCount}`);
        return component.individualFieldCount;
    }
    
    // **FALLBACK: Calculate from file content**
    if (fileObj.type === 'COBOL Program') {
        // For programs, count all 01-levels
        const programFieldCount = this.countAllO1LevelsInProgram(fileObj.content.split('\n'));
        console.log(`üìä Program ${componentName} has ${programFieldCount} 01-level fields`);
        return programFieldCount;
    }
    
    // For copybooks, count fields in the specific record
    const fieldCount = this.countFieldsInCopybook(componentName, fileObj);
    console.log(`üìã Copybook ${componentName} has ${fieldCount} fields`);
    return fieldCount;
},

// **NEW METHOD: Count Fields in Copybook**
countFieldsInCopybook(componentName, fileObj) {
    const lines = fileObj.content.split('\n');
    const componentUpperName = componentName.toUpperCase();
    
    let fieldCount = 0;
    let inTargetRecord = false;
    let currentLevel = 0;
    let targetLevel = 0;
    
    lines.forEach((line, index) => {
        const trimmed = line.trim().toUpperCase();
        
        // Check for the target component (01-level record)
        const recordMatch = trimmed.match(/^\s*(\d{2})\s+([A-Z][A-Z0-9\-_]*)/);
        if (recordMatch) {
            const level = parseInt(recordMatch[1]);
            const recordName = recordMatch[2];
            
            if (level === 1 && recordName === componentUpperName) {
                inTargetRecord = true;
                targetLevel = 1;
                fieldCount = 1; // Count the 01-level itself
                return;
            } else if (level === 1 && inTargetRecord) {
                // Found another 01-level, stop counting
                inTargetRecord = false;
                return;
            }
        }
        
        // If we're in the target record, count subordinate fields
        if (inTargetRecord && recordMatch) {
            const level = parseInt(recordMatch[1]);
            
            // Only count fields that are subordinate to our target record
            if (level > targetLevel && level !== 88) { // Exclude condition names (88-level)
                fieldCount++;
            } else if (level <= targetLevel && level !== targetLevel) {
                // We've moved to a peer or higher level, stop counting
                inTargetRecord = false;
            }
        }
    });
    
    return fieldCount;
},

// **NEW METHOD: Calculate Record Field Count**
calculateRecordFieldCount(recordName, lines, startIndex) {
    let fieldCount = 1; // Count the 01-level itself
    let i = startIndex + 1;
    
    while (i < lines.length) {
        const line = lines[i].trim().toUpperCase();
        const fieldMatch = line.match(/^\s*(\d{2})\s+([A-Z][A-Z0-9\-_]*)/);
        
        if (fieldMatch) {
            const level = parseInt(fieldMatch[1]);
            
            if (level === 1) {
                // Found another 01-level, stop counting
                break;
            } else if (level > 1 && level !== 88) {
                // Count subordinate fields (exclude 88-level condition names)
                fieldCount++;
            }
        }
        i++;
    }
    
    return fieldCount;
},

// **NEW METHOD: Find Parent Record**
findParentRecord(lines, currentIndex) {
    // Look backwards to find the parent 01-level record
    for (let i = currentIndex - 1; i >= 0; i--) {
        const line = lines[i].trim().toUpperCase();
        const recordMatch = line.match(/^\s*01\s+([A-Z][A-Z0-9\-_]*)/);
        if (recordMatch) {
            return recordMatch[1];
        }
    }
    return null;
},

// **NEW METHOD: Merge Unique Arrays**
mergeUniqueArrays(arr1, arr2) {
    const combined = [...(arr1 || []), ...(arr2 || [])];
    return [...new Set(combined)]; // Remove duplicates
},

// **NEW METHOD: Invalidate Analyses with Missing Dependencies**
invalidateAnalysesWithMissingDependencies() {
    const newlyAvailableComponents = Array.from(this.discoveredComponents.keys());
    
    Object.entries(this.analysisResults).forEach(([componentName, result]) => {
        if (result.dependencyAnalysis && result.dependencyAnalysis.missing) {
            // Check if any previously missing dependencies are now available
            const stillMissing = {
                copybooks: result.dependencyAnalysis.missing.copybooks.filter(name => 
                    !newlyAvailableComponents.includes(name)
                ),
                programs: result.dependencyAnalysis.missing.programs.filter(name => 
                    !newlyAvailableComponents.includes(name)
                ),
                files: result.dependencyAnalysis.missing.files.filter(name => 
                    !newlyAvailableComponents.includes(name)
                )
            };
            
            const originalMissingCount = 
                result.dependencyAnalysis.missing.copybooks.length + 
                result.dependencyAnalysis.missing.programs.length + 
                result.dependencyAnalysis.missing.files.length;
                
            const currentMissingCount = 
                stillMissing.copybooks.length + 
                stillMissing.programs.length + 
                stillMissing.files.length;
            
            // If missing count changed, mark for re-analysis
            if (currentMissingCount !== originalMissingCount) {
                const component = this.discoveredComponents.get(componentName);
                if (component) {
                    component.analyzed = false;
                    component.needsReanalysis = true;
                }
                console.log(`üîÑ Marked ${componentName} for re-analysis - dependencies changed`);
            }
        }
    });
},

    // Extract Input/Output Files
    extractInputFiles(content) {
        const files = [];
        const lines = content.split('\n');
        
        lines.forEach(line => {
            const trimmed = line.trim().toUpperCase();
            
            // Look for INPUT file patterns
            const inputPatterns = [
                /SELECT\s+([A-Z][A-Z0-9\-_]+)\s+ASSIGN/,
                /OPEN\s+INPUT\s+([A-Z][A-Z0-9\-_]+)/,
                /READ\s+([A-Z][A-Z0-9\-_]+)/
            ];
            
            for (const pattern of inputPatterns) {
                const match = trimmed.match(pattern);
                if (match && !files.includes(match[1])) {
                    files.push(match[1]);
                }
            }
        });
        
        return files.slice(0, 10); // Limit to top 10
    },

    extractOutputFiles(content) {
        const files = [];
        const lines = content.split('\n');
        
        lines.forEach(line => {
            const trimmed = line.trim().toUpperCase();
            
            // Look for OUTPUT file patterns
            const outputPatterns = [
                /OPEN\s+OUTPUT\s+([A-Z][A-Z0-9\-_]+)/,
                /WRITE\s+([A-Z][A-Z0-9\-_]+)/,
                /DISPLAY\s+.*\s+UPON\s+([A-Z][A-Z0-9\-_]+)/
            ];
            
            for (const pattern of outputPatterns) {
                const match = trimmed.match(pattern);
                if (match && !files.includes(match[1])) {
                    files.push(match[1]);
                }
            }
        });
        
        return files.slice(0, 10); // Limit to top 10
    },

    // Generate Friendly Name using patterns
    async generateFriendlyName(componentName) {
    // Check cache first
    if (this.friendlyNameCache.has(componentName.toUpperCase())) {
        return this.friendlyNameCache.get(componentName.toUpperCase());
    }
    
    // Try LLM generation if available and validated
    if (this.serverValidated) {
        try {
            const llmName = await this.getLLMBusinessName(componentName);
            if (llmName && llmName.length > 0 && llmName.length < 100) {
                this.friendlyNameCache.set(componentName.toUpperCase(), llmName);
                return llmName;
            }
        } catch (error) {
            console.warn('LLM business name generation failed:', error);
        }
    }
    
    // Fallback to pattern-based generation
    const patternName = this.generateFriendlyNameFromPattern(componentName);
    this.friendlyNameCache.set(componentName.toUpperCase(), patternName);
    return patternName;
},

// **NEW METHOD: Get LLM Business Name**
async getLLMBusinessName(componentName) {
    const prompt = `Generate a business-friendly name for this mainframe component: "${componentName}"

Context: This is a mainframe component name that needs a clear business description.

Examples:
- CUST-MASTER ‚Üí "Customer Master File"
- ACCT-VALIDATE ‚Üí "Account Validation Program" 
- TRANS-LOG ‚Üí "Transaction Log Handler"
- PAY-PROCESS ‚Üí "Payment Processing System"
- INV-REPORT ‚Üí "Invoice Report Generator"

Rules:
- Return ONLY the business-friendly name
- Maximum 50 characters
- No technical jargon
- Focus on business purpose
- Use proper capitalization

Business Name:`;

    try {
        const response = await this.callLLMAPI(prompt);
        
        // Handle different response formats
        let businessName = '';
        if (typeof response === 'string') {
            businessName = response.trim();
        } else if (response && response.businessPurpose) {
            businessName = response.businessPurpose.trim();
        } else if (response && response.rawResponse) {
            businessName = response.rawResponse.trim();
        }
        
        // Clean up the response
        businessName = businessName.replace(/^["']|["']$/g, ''); // Remove quotes
        businessName = businessName.split('\n')[0]; // Take first line only
        
        return businessName.length > 0 && businessName.length < 100 ? businessName : null;
        
    } catch (error) {
        console.warn('LLM business name failed:', error);
        return null;
    }
},

    // Pattern-based friendly name generation
    generateFriendlyNameFromPattern(componentName) {
        const name = componentName.toUpperCase();
        
        // Common mainframe patterns to friendly names
        const patterns = [
            { pattern: /CUST.*MASTER/, replacement: 'Customer Master File' },
            { pattern: /CUST.*MAINT/, replacement: 'Customer Maintenance Program' },
            { pattern: /CUST.*VALID/, replacement: 'Customer Validation Program' },
            { pattern: /ACCT.*MASTER/, replacement: 'Account Master File' },
            { pattern: /ACCT.*TRANS/, replacement: 'Account Transaction Program' },
            { pattern: /ACCT.*BAL/, replacement: 'Account Balance Program' },
            { pattern: /PAY.*PROC/, replacement: 'Payment Processing System' },
            { pattern: /TRANS.*LOG/, replacement: 'Transaction Log Handler' },
            { pattern: /INVOICE.*PROC/, replacement: 'Invoice Processing System' },
            { pattern: /REPORT.*GEN/, replacement: 'Report Generation Program' },
            { pattern: /.*MASTER.*/, replacement: `${name.split('-')[0]} Master Data` },
            { pattern: /.*COPY.*/, replacement: `${name.split('-')[0]} Data Structure` },
            { pattern: /.*VALID.*/, replacement: `${name.split('-')[0]} Validation Program` },
            { pattern: /.*PROC.*/, replacement: `${name.split('-')[0]} Processing System` }
        ];
        
        for (const { pattern, replacement } of patterns) {
            if (pattern.test(name)) {
                return replacement;
            }
        }
        
        // Final fallback
        const parts = name.split('-');
        if (parts.length > 1) {
            return `${parts[0]} ${parts[1]} System`;
        } else {
            return `${name} Component`;
        }
    },

    // Enable Auto Analysis
    enableAutoAnalysis() {
        const autoAnalyzeBtn = document.getElementById('autoAnalyzeBtn');
        if (autoAnalyzeBtn && this.discoveredComponents.size > 0 && this.serverValidated) {
            autoAnalyzeBtn.disabled = false;
        }
    },

    // ============================================
    // DISPLAY AND UI UPDATE METHODS
    // ============================================

    // Display Discovered Components
    displayDiscoveredComponents() {
    const container = document.getElementById('componentsList');
    if (!container) return;

    const components = Array.from(this.discoveredComponents.values());
    
    console.log(`displayDiscoveredComponents: ${components.length} components to display`);
    
    if (components.length === 0) {
        container.innerHTML = `
            <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                Upload files to auto-discover components
            </p>
        `;
        return;
    }

    // Sort components by type and name
    components.sort((a, b) => {
        if (a.type !== b.type) {
            const typeOrder = { 'PROGRAM': 1, 'RECORD_LAYOUT': 2, 'COPYBOOK': 3, 'FILE': 4 };
            return (typeOrder[a.type] || 5) - (typeOrder[b.type] || 5);
        }
        return a.friendlyName.localeCompare(b.friendlyName);
    });

    let html = '';
    
    components.forEach(component => {
        const iconClass = this.getComponentIconClass(component.type);
        const analysisStatus = component.analyzed ? 
            '<span class="badge badge-success">Analyzed</span>' : 
            '<span class="badge badge-warning">Pending</span>';
        
        const selectedClass = component.selected ? 'selected' : '';
        
        html += `
            <div class="component-card ${selectedClass}" onclick="analyzer.selectComponent('${component.name}')" data-component="${component.name}">
                <div class="component-card-header">
                    <div class="component-card-icon ${iconClass}">
                        ${this.getComponentIcon(component.type)}
                    </div>
                    <div class="component-card-info">
                        <div class="component-card-name">${component.name}</div>
                        <div class="component-card-friendly">${component.friendlyName}</div>
                        <div class="component-card-description">${component.businessPurpose}</div>
                    </div>
                </div>
                <div class="component-card-metrics">
                    <div class="component-metric">
                        <span class="component-metric-icon">üìÅ</span>
                        <span>${component.fileSource}</span>
                    </div>
                    <div class="component-metric">
                        <span class="component-metric-icon">üìã</span>
                        <span>${component.fieldCount} fields</span>
                    </div>
                    <div class="component-metric">
                        <span class="component-metric-icon">üìä</span>
                        <span>Complexity: ${component.complexityScore}</span>
                    </div>
                    <div class="component-metric">
                        ${analysisStatus}
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    
    // Update count
    const countElement = document.getElementById('componentCount');
    if (countElement) {
        countElement.textContent = components.length;
    }
    
    console.log(`‚úÖ Displayed ${components.length} components in left panel`);
},

    // Get Component Icon Class
    getComponentIconClass(type) {
        switch(type) {
            case 'PROGRAM': return 'program';
            case 'COPYBOOK': 
            case 'RECORD_LAYOUT': return 'copybook';
            case 'FILE': return 'file';
            default: return 'file';
        }
    },

    // Get Component Icon
    getComponentIcon(type) {
        switch(type) {
            case 'PROGRAM': return 'üíº';
            case 'COPYBOOK': 
            case 'RECORD_LAYOUT': return 'üìö';
            case 'FILE': return 'üìÑ';
            default: return 'üìã';
        }
    },

    // Update Dashboard Stats
    
updateDashboardStats() {
        // Counts
        const totalComponents = this.discoveredComponents.size;
        const totalFiles = this.uploadedFiles.length;
        const totalFields = Array.from(this.discoveredComponents.values())
            .reduce((sum, c) => sum + (c.fieldCount || 0), 0);

        // **NEW: Code Metrics**
        const totalLinesOfCode = this.uploadedFiles.reduce((sum, file) => sum + (file.metrics?.codeLines || 0), 0);
        const totalFileSize = this.uploadedFiles.reduce((sum, file) => sum + (file.size || 0), 0);
        const avgComplexity = Array.from(this.discoveredComponents.values())
            .reduce((sum, c) => sum + (c.complexityScore || 0), 0) / Math.max(totalComponents, 1);

        const programs = Array.from(this.discoveredComponents.values())
            .filter(c => (c.type || '').toUpperCase().includes('PROGRAM')).length;
        const copybooks = Array.from(this.discoveredComponents.values())
            .filter(c => (c.type || '').toUpperCase().includes('COPY') || (c.type || '').toUpperCase().includes('RECORD')).length;

        // Quality average (only analyzed comps with numeric score)
        const scored = Array.from(this.discoveredComponents.values())
            .map(c => Number(c.qualityScore))
            .filter(v => Number.isFinite(v));
        const avgQuality = scored.length ? (scored.reduce((a,b)=>a+b,0) / scored.length).toFixed(1) : '-';

        // Header stats
        const setText = (id, val) => { 
            const el = document.getElementById(id); 
            if (el) el.textContent = String(val); 
        };
        
        setText('headerComponents', totalComponents);
        setText('headerPrograms', programs);
        setText('headerCopybooks', copybooks);
        setText('headerFields', totalFields);

        // **NEW: Additional metrics in header**
        setText('headerLinesOfCode', totalLinesOfCode.toLocaleString());
        setText('headerFileSize', this.formatFileSize(totalFileSize));

        // Component count in left panel
        setText('componentCount', totalComponents);

        // **NEW: Update dashboard cards with enhanced metrics**
        this.updateDashboardMetricsCards(totalComponents, totalFiles, totalFields, totalLinesOfCode, avgComplexity, avgQuality);
        
        // **NEW: Update Components Library whenever stats change**
        this.updateComponentsLibrary();
    },

// **NEW METHOD: Update Dashboard Metrics Cards**
updateDashboardMetricsCards(totalComponents, totalFiles, totalFields, totalLinesOfCode, avgComplexity, avgQuality) {
    const dashboardGrid = document.getElementById('dashboardGrid');
    if (!dashboardGrid) return;

    dashboardGrid.innerHTML = `
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="dashboard-card-icon">üìä</div>
                <div>
                    <div class="dashboard-card-title">System Overview</div>
                    <div class="dashboard-card-subtitle">Complete mainframe analysis</div>
                </div>
            </div>
            <div class="dashboard-card-content">
                <p>Comprehensive analysis of your mainframe system components with business intelligence insights.</p>
            </div>
            <div class="dashboard-card-metrics">
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${totalComponents}</span>
                    <span class="dashboard-metric-label">Components</span>
                </div>
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${totalFiles}</span>
                    <span class="dashboard-metric-label">Files</span>
                </div>
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${totalFields}</span>
                    <span class="dashboard-metric-label">Fields</span>
                </div>
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${avgQuality}</span>
                    <span class="dashboard-metric-label">Avg Quality</span>
                </div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="dashboard-card-icon">üíª</div>
                <div>
                    <div class="dashboard-card-title">Code Metrics</div>
                    <div class="dashboard-card-subtitle">Lines of code and complexity</div>
                </div>
            </div>
            <div class="dashboard-card-content">
                <p>Analysis of code volume, complexity, and maintainability across all uploaded files.</p>
            </div>
            <div class="dashboard-card-metrics">
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${totalLinesOfCode.toLocaleString()}</span>
                    <span class="dashboard-metric-label">Lines of Code</span>
                </div>
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${avgComplexity.toFixed(1)}</span>
                    <span class="dashboard-metric-label">Avg Complexity</span>
                </div>
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${this.getAnalyzedComponentsCount()}</span>
                    <span class="dashboard-metric-label">Analyzed</span>
                </div>
                <div class="dashboard-metric">
                    <span class="dashboard-metric-value">${this.formatFileSize(this.uploadedFiles.reduce((sum, file) => sum + (file.size || 0), 0))}</span>
                    <span class="dashboard-metric-label">Total Size</span>
                </div>
            </div>
        </div>
    `;
},

// **NEW HELPER METHODS**
formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
},

getAnalyzedComponentsCount() {
    return Object.keys(this.analysisResults).length;
},

    // Select Component
    selectComponent(componentName) {
    console.log(`Selecting component: ${componentName}`);
    
    // Clear previous selections
    Array.from(this.discoveredComponents.values()).forEach(comp => {
        comp.selected = false;
    });
    
    // Set new selection
    const component = this.discoveredComponents.get(componentName);
    if (component) {
        component.selected = true;
        this.currentSelectedComponent = componentName;
    }
    
    // Update UI
    this.displayDiscoveredComponents();
    this.persistSelection(componentName);
    this.updateDashboardStats();
    
    // **SYNC ALL TABS**
    this.syncAllTabsForComponent(componentName);
    
    // Update chat context
    this.updateChatContext('component', componentName);
    
    this.showInfo(`Selected component: ${component ? component.friendlyName : componentName}`);
},

// **NEW METHOD: Sync All Tabs for Component**
syncAllTabsForComponent(componentName) {
    const result = this.analysisResults[componentName];
    const component = this.discoveredComponents.get(componentName);
    
    if (!result) {
        // Component not analyzed yet - show pending analysis message
        this.showPendingAnalysisMessage(componentName);
        return;
    }
    
    // Update Dependencies Tab
    this.displayDependencyFlow(componentName, result);
    
    // Update Field Matrix Tab
    if (result.fieldAnalysis && result.fieldAnalysis.fields && result.fieldAnalysis.fields.length > 0) {
        this.displayFieldMatrix(componentName, result);
    } else {
        this.showNoFieldsMessage(componentName);
    }
    
    // Update Dashboard with component focus
    this.updateDashboardWithComponentFocus(componentName, result);
    
    console.log(`‚úÖ All tabs synchronized for component: ${componentName}`);
},

// **NEW METHOD: Show Pending Analysis Message**
showPendingAnalysisMessage(componentName) {
    const component = this.discoveredComponents.get(componentName);
    const displayName = component?.friendlyName || componentName;
    const isAnalyzed = component?.analyzed;
    
    // Dependencies tab
    const dependenciesContainer = document.getElementById('dependenciesContent');
    if (dependenciesContainer) {
        dependenciesContainer.innerHTML = `
            <div style="text-align: center; padding: 3rem; background: var(--grey-50); border-radius: 12px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">${isAnalyzed ? 'üîÑ' : '‚è≥'}</div>
                <h3 style="color: var(--grey-700); margin-bottom: 1rem;">
                    ${isAnalyzed ? 'Re-analysis Available' : 'Analysis Pending'}
                </h3>
                <p style="color: var(--grey-600); margin-bottom: 2rem;">
                    ${isAnalyzed ? 
                        `Component "${displayName}" can be re-analyzed to refresh dependency information with newly uploaded files.` :
                        `Component "${displayName}" needs to be analyzed to view dependency information.`
                    }
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" onclick="analyzer.analyzeSpecificComponent('${componentName}')">
                        <span>ü§ñ</span>
                        ${isAnalyzed ? 'Re-analyze Component' : 'Analyze Component'}
                    </button>
                    ${isAnalyzed ? `
                        <button class="btn btn-success" onclick="analyzer.refreshDependencies('${componentName}')">
                            <span>üîÑ</span>
                            Quick Refresh Dependencies
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Field Matrix tab
    const fieldMatrixContainer = document.getElementById('fieldMatrixContent');
    if (fieldMatrixContainer) {
        fieldMatrixContainer.innerHTML = `
            <div style="text-align: center; padding: 3rem; background: var(--grey-50); border-radius: 12px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                <h3 style="color: var(--grey-700); margin-bottom: 1rem;">
                    ${isAnalyzed ? 'Re-analysis Available' : 'Field Analysis Pending'}
                </h3>
                <p style="color: var(--grey-600); margin-bottom: 2rem;">
                    ${isAnalyzed ? 
                        `Component "${displayName}" can be re-analyzed to refresh field information.` :
                        `Component "${displayName}" needs to be analyzed to view field matrix information.`
                    }
                </p>
                <button class="btn btn-primary" onclick="analyzer.analyzeSpecificComponent('${componentName}')">
                    <span>ü§ñ</span>
                    ${isAnalyzed ? 'Re-analyze for Latest Fields' : 'Analyze This Component'}
                </button>
            </div>
        `;
    }
},
updateDashboardWithComponentFocus(componentName, result) {
    const dashboardContent = document.getElementById('dashboardContent');
    if (!dashboardContent) return;

    const component = this.discoveredComponents.get(componentName);
    const displayName = component?.friendlyName || componentName;
    
    // Create focused dashboard view
    let html = `
        <!-- Focused Component Overview -->
        <div class="collapsible-section expanded">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <div class="collapsible-title">
                    <span class="collapsible-icon">üéØ</span>
                    Component Focus: ${displayName}
                </div>
                <span class="expand-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-body">
                    ${this.generateComponentFocusView(componentName, result, component)}
                </div>
            </div>
        </div>

        <!-- Quick Actions for Component -->
        <div class="collapsible-section expanded">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <div class="collapsible-title">
                    <span class="collapsible-icon">‚ö°</span>
                    Quick Actions
                </div>
                <span class="expand-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-body">
                    ${this.generateQuickActions(componentName, component)}
                </div>
            </div>
        </div>

        <!-- Related Components -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <div class="collapsible-title">
                    <span class="collapsible-icon">üîó</span>
                    Related Components
                </div>
                <span class="expand-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-body">
                    ${this.generateRelatedComponents(componentName, result)}
                </div>
            </div>
        </div>
    `;

    dashboardContent.innerHTML = html;
},

// **NEW METHOD: Generate Component Focus View**
generateComponentFocusView(componentName, result, component) {
    const qualityColor = result ? this.getQualityColor(result.qualityScore) : 'var(--grey-400)';
    const riskColor = result ? this.getRiskColor(result.llmAnalysis?.riskAssessment) : 'var(--grey-400)';
    
    return `
        <div style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h3 style="margin: 0 0 0.5rem 0; color: white;">${component?.friendlyName || componentName}</h3>
                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 1rem;">
                        ${component?.businessPurpose || 'Business purpose pending analysis'}
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <span class="badge" style="background: rgba(255,255,255,0.2); color: white;">
                            ${component?.type || 'Unknown Type'}
                        </span>
                        <span class="badge" style="background: rgba(255,255,255,0.2); color: white;">
                            üìÅ ${component?.fileSource || 'Unknown Source'}
                        </span>
                    </div>
                </div>
                <div style="text-align: right;">
                    ${result ? `
                        <div style="margin-bottom: 0.5rem;">
                            <span class="badge" style="background: ${qualityColor}; color: white;">
                                Quality: ${result.qualityScore}/10
                            </span>
                        </div>
                        <div>
                            <span class="badge" style="background: ${riskColor}; color: white;">
                                ${(result.llmAnalysis?.riskAssessment || 'Unknown').toUpperCase()} Risk
                            </span>
                        </div>
                    ` : `
                        <span class="badge" style="background: rgba(245, 158, 11, 0.8); color: white;">
                            Analysis Pending
                        </span>
                    `}
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.25rem; font-weight: bold; color: var(--primary-blue);">${component?.lineCount || 0}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Lines of Code</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.25rem; font-weight: bold; color: var(--success-green);">${component?.fieldCount || 0}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Fields</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.25rem; font-weight: bold; color: var(--warning-yellow);">${component?.complexityScore || 0}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Complexity</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.25rem; font-weight: bold; color: var(--info-blue);">
                    ${result ? (result.dependencyAnalysis?.summary?.foundCount + result.dependencyAnalysis?.summary?.missingCount || 0) : 0}
                </div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Dependencies</div>
            </div>
        </div>

        ${result && result.llmAnalysis ? `
            <div style="margin-top: 1rem; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                <h5 style="margin: 0 0 0.5rem 0; color: var(--grey-800);">üß† Business Intelligence Summary</h5>
                <p style="margin: 0; color: var(--grey-700); font-size: 0.9rem; line-height: 1.5;">
                    ${result.llmAnalysis.businessPurpose?.substring(0, 300)}${result.llmAnalysis.businessPurpose?.length > 300 ? '...' : ''}
                </p>
                ${result.llmAnalysis.recommendations && result.llmAnalysis.recommendations.length > 0 ? `
                    <div style="margin-top: 0.75rem;">
                        <strong>Top Recommendations:</strong>
                        <ul style="margin: 0.25rem 0 0 1rem; font-size: 0.85rem;">
                            ${result.llmAnalysis.recommendations.slice(0, 3).map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        ` : ''}
    `;
},

// **NEW METHOD: Generate Quick Actions**
generateQuickActions(componentName, component) {
    const isAnalyzed = component?.analyzed;
    
    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <button class="btn btn-primary btn-block" onclick="analyzer.analyzeSpecificComponent('${componentName}')">
                <span>ü§ñ</span>
                ${isAnalyzed ? 'Re-analyze Component' : 'Analyze Component'}
            </button>
            
            ${isAnalyzed ? `
                <button class="btn btn-success btn-block" onclick="analyzer.refreshDependencies('${componentName}')">
                    <span>üîÑ</span>
                    Refresh Dependencies
                </button>
            ` : ''}
            
            <button class="btn btn-info btn-block" onclick="document.querySelector('.tab[data-tab=\\"dependencies\\"]').click()">
                <span>üîó</span>
                View Dependencies
            </button>
            
            <button class="btn btn-info btn-block" onclick="document.querySelector('.tab[data-tab=\\"fieldmatrix\\"]').click()">
                <span>üìã</span>
                View Field Matrix
            </button>
            
            <button class="btn btn-primary btn-block" onclick="analyzer.startComponentChat('${componentName}')">
                <span>üí¨</span>
                Ask AI About This
            </button>
            
            <button class="btn btn-warning btn-block" onclick="analyzer.exportComponentReport('${componentName}')">
                <span>üìÑ</span>
                Export Report
            </button>
        </div>
    `;
},

// **NEW METHOD: Generate Related Components**
generateRelatedComponents(componentName, result) {
    if (!result || !result.dependencyAnalysis) {
        return '<p style="color: var(--grey-500); text-align: center;">No dependency information available</p>';
    }
    
    const related = [
        ...result.dependencyAnalysis.found.copybooks,
        ...result.dependencyAnalysis.found.programs,
        ...result.dependencyAnalysis.found.files
    ];
    
    if (related.length === 0) {
        return '<p style="color: var(--grey-500); text-align: center;">No related components found</p>';
    }
    
    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            ${related.slice(0, 6).map(name => {
                const relatedComponent = this.discoveredComponents.get(name);
                return `
                    <div style="background: white; border: 1px solid var(--grey-200); border-radius: 8px; padding: 1rem; cursor: pointer;" onclick="analyzer.selectComponent('${name}')">
                        <div style="font-weight: 600; color: var(--grey-800); margin-bottom: 0.25rem;">${relatedComponent?.friendlyName || name}</div>
                        <div style="font-size: 0.8rem; color: var(--grey-500); margin-bottom: 0.5rem;">${name}</div>
                        <div style="font-size: 0.8rem; color: var(--grey-600);">
                            ${relatedComponent?.businessPurpose?.substring(0, 80) || 'Click to analyze'}...
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span class="badge badge-primary">${relatedComponent?.type || 'Unknown'}</span>
                            ${relatedComponent?.analyzed ? '<span class="badge badge-success" style="margin-left: 0.25rem;">Analyzed</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        
        ${related.length > 6 ? `
            <div style="text-align: center; margin-top: 1rem;">
                <span style="color: var(--grey-500);">+${related.length - 6} more components</span>
            </div>
        ` : ''}
    `;
},

// **NEW METHOD: Start Component Chat**
startComponentChat(componentName) {
    const component = this.discoveredComponents.get(componentName);
    const chatInput = document.getElementById('chatInput');
    
    if (chatInput) {
        chatInput.value = `Tell me about the business purpose and functionality of ${component?.friendlyName || componentName}. What does this component do in the system?`;
        this.updateChatContext('component', componentName);
        
        // Switch to chat panel if collapsed
        const rightPanel = document.getElementById('rightPanel');
        if (rightPanel && rightPanel.classList.contains('collapsed')) {
            this.togglePanel('right');
        }
        
        // Send the message
        this.sendChatMessage();
    }
},

// **NEW METHOD: Export Component Report**
exportComponentReport(componentName) {
    const component = this.discoveredComponents.get(componentName);
    const result = this.analysisResults[componentName];
    
    if (!component) {
        this.showError('Component not found');
        return;
    }
    
    const reportData = {
        componentName: componentName,
        friendlyName: component.friendlyName,
        businessPurpose: component.businessPurpose,
        type: component.type,
        fileSource: component.fileSource,
        metrics: {
            lineCount: component.lineCount,
            complexityScore: component.complexityScore,
            fieldCount: component.fieldCount,
            qualityScore: result?.qualityScore
        },
        analysis: result || null,
        exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
    this.downloadFile(blob, `${componentName}_report.json`);
    
    this.showSuccess(`üìÑ Component report exported for ${component.friendlyName || componentName}`);
},

// **NEW METHOD: Quick Refresh Dependencies**
async refreshDependencies(componentName) {
    const component = this.discoveredComponents.get(componentName);
    if (!component) {
        this.showError('Component not found');
        return;
    }
    
    this.showLoading();
    this.updateLoadingStatus(`üîÑ Refreshing dependencies for ${component.friendlyName || componentName}...`);
    
    try {
        const relevantFiles = this.findRelevantFiles(componentName);
        
        // Quick dependency extraction without full LLM analysis
        const dependencyAnalysis = await this.extractDependencies(relevantFiles);
        
        // Update existing analysis result
        if (this.analysisResults[componentName]) {
            this.analysisResults[componentName].dependencyAnalysis = dependencyAnalysis;
            this.analysisResults[componentName].timestamp = new Date().toISOString();
        }
        
        // Refresh the dependency flow display
        this.displayDependencyFlow(componentName, this.analysisResults[componentName]);
        
        // Save to database
        this.saveToDatabase();
        
        this.hideLoading();
        this.showSuccess(`üîÑ Dependencies refreshed for ${component.friendlyName || componentName}`);
        
        // Switch to dependencies tab to show results
        const dependenciesTab = document.querySelector('.tab[data-tab="dependencies"]');
        if (dependenciesTab) dependenciesTab.click();
        
    } catch (error) {
        this.hideLoading();
        this.showError(`Dependency refresh failed: ${error.message}`);
        console.error('Dependency refresh failed:', error);
    }
},

// **NEW METHOD: Show No Fields Message**
showNoFieldsMessage(componentName) {
    const component = this.discoveredComponents.get(componentName);
    const displayName = component?.friendlyName || componentName;
    
    const fieldMatrixContainer = document.getElementById('fieldMatrixContent');
    if (fieldMatrixContainer) {
        fieldMatrixContainer.innerHTML = `
            <div style="text-align: center; padding: 3rem; background: var(--grey-50); border-radius: 12px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                <h3 style="color: var(--grey-700); margin-bottom: 1rem;">No Field Data Available</h3>
                <p style="color: var(--grey-600); margin-bottom: 1rem;">
                    Component "${displayName}" doesn't contain field definitions or is not a copybook/record layout.
                </p>
                <div style="background: white; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <strong>Component Type:</strong> ${component?.type || 'Unknown'}<br>
                    <strong>Business Purpose:</strong> ${component?.businessPurpose || 'Not defined'}
                </div>
            </div>
        `;
    }
},

// **NEW METHOD: Analyze Specific Component**
async analyzeSpecificComponent(componentName) {
    if (this.autoAnalysisInProgress) {
        this.showWarning('Analysis already in progress');
        return;
    }
    
    const component = this.discoveredComponents.get(componentName);
    if (!component) {
        this.showError('Component not found');
        return;
    }
    
    this.showLoading();
    this.updateLoadingStatus(`üîç Analyzing ${component.friendlyName || componentName}...`);
    
    try {
        const relevantFiles = this.findRelevantFiles(componentName);
        const analysisResult = await this.runComponentAnalysis(componentName, relevantFiles);
        
        this.analysisResults[componentName] = analysisResult;
        component.analyzed = true;
        component.qualityScore = analysisResult.qualityScore;
        
        // Sync all tabs with new analysis
        this.syncAllTabsForComponent(componentName);
        
        // Save to database
        this.saveToDatabase();
        
        this.hideLoading();
        this.showSuccess(`‚ú® Analysis complete for ${component.friendlyName || componentName}`);
        
        // Switch to dependencies tab to show results
        const dependenciesTab = document.querySelector('.tab[data-tab="dependencies"]');
        if (dependenciesTab) dependenciesTab.click();
        
    } catch (error) {
        this.hideLoading();
        this.showError(`Analysis failed: ${error.message}`);
        console.error('Component analysis failed:', error);
    }
},

    // Persist Selection in Database
    persistSelection(selectedName) {
        if (!this.db || !this.dbInitialized) return;
        try {
            // Clear previous selection flags
            this.db.run(`UPDATE discovered_components SET selected = 0`);
            // Set current
            this.db.run(`UPDATE discovered_components SET selected = 1 WHERE component_name = ?`, [selectedName]);
        } catch (e) {
            console.error('Failed to persist selection:', e);
        }
    },

    // Get Display Name (friendly name if available)
    getDisplayName(componentName) {
        const component = this.discoveredComponents.get(componentName);
        return component?.friendlyName || componentName;
    },

    // Export Results
    exportResults(format) {
        const data = {
            timestamp: new Date().toISOString(),
            summary: {
                totalComponents: this.discoveredComponents.size,
                totalFiles: this.uploadedFiles.length,
                analyzedComponents: Object.keys(this.analysisResults).length
            },
            components: Array.from(this.discoveredComponents.entries()).map(([name, comp]) => ({
                name,
                friendlyName: comp.friendlyName,
                type: comp.type,
                businessPurpose: comp.businessPurpose,
                analyzed: comp.analyzed,
                analysis: this.analysisResults[name] || null
            }))
        };

        if (format === 'json') {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            this.downloadFile(blob, 'mainframe_analysis_results.json');
        } else if (format === 'markdown') {
            const markdown = this.generateMarkdownReport(data);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            this.downloadFile(blob, 'mainframe_analysis_report.md');
        }
        
        this.showSuccess(`üìÑ Results exported as ${format.toUpperCase()}`);
    },

    // Generate Markdown Report
    generateMarkdownReport(data) {
        let markdown = `# Mainframe Analysis Report

Generated: ${new Date(data.timestamp).toLocaleString()}

## Summary

- **Total Components:** ${data.summary.totalComponents}
- **Total Files:** ${data.summary.totalFiles}
- **Analyzed Components:** ${data.summary.analyzedComponents}

## Components

`;

        data.components.forEach(comp => {
            markdown += `### ${comp.friendlyName} (${comp.name})

- **Type:** ${comp.type}
- **Business Purpose:** ${comp.businessPurpose}
- **Status:** ${comp.analyzed ? '‚úÖ Analyzed' : '‚è≥ Pending Analysis'}

`;
            
            if (comp.analysis && comp.analysis.llmAnalysis) {
                markdown += `**Analysis:**
${comp.analysis.llmAnalysis.businessPurpose || 'No detailed analysis available'}

`;
            }
        });

        return markdown;
    },

    // Download File Helper
    downloadFile(blob, filename) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }
});

// ============================================
// ENHANCED CODE ANALYZER - PART 4
// LLM Integration and Analysis Engine
// ============================================

// Extend the EnhancedCodeAnalyzer class with analysis methods
Object.assign(EnhancedCodeAnalyzer.prototype, {

    // ============================================
    // AUTO-ANALYSIS ORCHESTRATION
    // ============================================

    // Start Auto Analysis
    async startAutoAnalysis() {
    if (this.autoAnalysisInProgress) {
        this.showWarning('Auto-analysis already in progress');
        return;
    }
    
    if (this.discoveredComponents.size === 0) {
        this.showError('No components discovered for analysis');
        return;
    }
    
    this.autoAnalysisInProgress = true;
    this.showLoading();
    this.updateLoadingStatus('üöÄ Starting auto-analysis of discovered components...');
    
    try {
        // **INCLUDE COMPONENTS THAT NEED RE-ANALYSIS**
        const components = Array.from(this.discoveredComponents.values())
            .filter(comp => !comp.analyzed || comp.needsReanalysis)
            .slice(0, 15); // Increased limit to handle re-analysis
        
        if (components.length === 0) {
            this.hideLoading();
            this.showInfo('All components are already analyzed. Upload new files or clear data to re-analyze.');
            return;
        }
        
        let completed = 0;
        const reanalysisCount = components.filter(c => c.needsReanalysis).length;
        
        if (reanalysisCount > 0) {
            this.showInfo(`üîÑ Re-analyzing ${reanalysisCount} components with updated dependencies...`);
        }
        
        for (const component of components) {
            try {
                this.updateLoadingStatus(`Analyzing ${component.friendlyName || component.name} (${completed + 1}/${components.length})...`);
                this.updateProgress((completed / components.length) * 100);
                
                const relevantFiles = this.findRelevantFiles(component.name);
                const analysisResult = await this.runComponentAnalysis(component.name, relevantFiles);
                
                this.analysisResults[component.name] = analysisResult;
                component.analyzed = true;
                component.needsReanalysis = false; // Clear re-analysis flag
                component.qualityScore = analysisResult.qualityScore;
                
                completed++;
                
                // Brief pause between analyses
                await this.sleep(1000);
                
            } catch (error) {
                console.warn(`Failed to analyze ${component.name}:`, error);
                component.analyzed = false;
            }
        }
        
        this.hideLoading();
        this.updateDashboardWithResults();
        this.enableExportButtons();
        this.enableChat();
        this.saveToDatabase();
        
        // **REFRESH CURRENT COMPONENT VIEW** if one is selected
        if (this.currentSelectedComponent) {
            this.syncAllTabsForComponent(this.currentSelectedComponent);
        }
        
        this.showSuccess(`‚ú® Auto-analysis complete! ${completed}/${components.length} components analyzed (${reanalysisCount} re-analyzed)`);
        
        // Switch to dashboard to show results
        document.querySelector('.tab[data-tab="dashboard"]').click();
        
    } catch (error) {
        this.hideLoading();
        this.showError(`Auto-analysis failed: ${error.message}`);
    } finally {
        this.autoAnalysisInProgress = false;
    }
},

    // Find Relevant Files for Component
    findRelevantFiles(componentName) {
        const componentUpper = componentName.toUpperCase();
        const componentBase = componentUpper.replace(/\.(CPY|COPYBOOK|COP)$/, '');
        
        return this.uploadedFiles.filter(file => {
            const fileNameUpper = file.name.toUpperCase();
            const fileNameBase = fileNameUpper.replace(/\.(CPY|COPYBOOK|COP)$/, '');
            
            // Direct name match
            if (fileNameUpper.includes(componentUpper) || 
                fileNameBase === componentBase ||
                componentBase === fileNameBase) {
                return true;
            }
            
            // Content-based matching
            const contentUpper = file.content.toUpperCase();
            if (contentUpper.includes(componentUpper) ||
                contentUpper.includes(componentBase) ||
                contentUpper.includes(`COPY ${componentBase}`) ||
                contentUpper.includes(`"${componentBase}"`) ||
                contentUpper.includes(`'${componentBase}'`)) {
                return true;
            }
            
            // Component-based matching
            if (file.components) {
                return file.components.some(comp => {
                    const compNameUpper = comp.name.toUpperCase();
                    const compNameBase = compNameUpper.replace(/\.(CPY|COPYBOOK|COP)$/, '');
                    return compNameUpper === componentUpper || 
                           compNameBase === componentBase ||
                           componentBase === compNameBase;
                });
            }
            
            return false;
        });
    },

    // Run Component Analysis
    async runComponentAnalysis(componentName, relevantFiles) {
        console.log(`Running analysis for: ${componentName}`);
        
        const component = this.discoveredComponents.get(componentName);
        const friendlyName = component?.friendlyName || componentName;
        
        try {
            // Stage 1: Basic component analysis
            const componentType = this.detectComponentType(componentName, relevantFiles);
            
            // Stage 2: Extract dependencies
            const dependencyAnalysis = await this.extractDependencies(relevantFiles);
            
            // Stage 3: Field analysis (for copybooks)
            let fieldAnalysis = null;
            if (componentType === 'Copybook' || componentType === 'RECORD_LAYOUT') {
                fieldAnalysis = await this.analyzeFieldsInComponent(componentName, relevantFiles);
            }
            
            // Stage 4: LLM-enhanced analysis
            let llmAnalysis = null;
            try {
                llmAnalysis = await this.getBusinessIntelligenceFromLLM(
                    componentName, friendlyName, componentType, relevantFiles, dependencyAnalysis, fieldAnalysis
                );
            } catch (llmError) {
                console.warn('LLM analysis failed:', llmError);
                llmAnalysis = {
                    error: true,
                    message: llmError.message,
                    businessPurpose: component?.businessPurpose || 'Business purpose analysis failed',
                    recommendations: ['Check LLM server connection', 'Verify component data', 'Try manual analysis'],
                    fallbackUsed: true
                };
            }
            
            const results = {
                componentName: componentName,
                friendlyName: friendlyName,
                timestamp: new Date().toISOString(),
                filesAnalyzed: relevantFiles.map(f => f.name),
                componentType: componentType,
                dependencyAnalysis: dependencyAnalysis,
                fieldAnalysis: fieldAnalysis,
                llmAnalysis: llmAnalysis,
                totalFields: fieldAnalysis?.fields?.length || 0,
                qualityScore: this.calculateQualityScore(llmAnalysis, fieldAnalysis),
                analysisMethod: 'Auto-Discovery-Enhanced'
            };
            
            return results;
            
        } catch (error) {
            console.error(`Analysis failed for ${componentName}:`, error);
            throw new Error(`Analysis failed: ${error.message}`);
        }
    },

    // Detect Component Type
    detectComponentType(componentName, relevantFiles) {
        const component = this.discoveredComponents.get(componentName);
        if (component?.type) {
            return component.type;
        }
        
        // Analyze files to determine type
        for (const file of relevantFiles) {
            if (file.type === 'Copybook') return 'Copybook';
            if (file.type === 'COBOL Program') return 'Program';
            if (file.type === 'JCL Job') return 'Job';
        }
        
        return 'Unknown';
    },

    // Extract Dependencies
     async extractDependencies(relevantFiles) {
        const dependencies = {
            found: { copybooks: [], programs: [], files: [], interfaces: [] },
            missing: { copybooks: [], programs: [], files: [], interfaces: [] },
            systemInterfaces: [],
            summary: { foundCount: 0, missingCount: 0, interfaceCount: 0 }
        };
        
        for (const file of relevantFiles) {
            const content = file.content.toUpperCase();
            const lines = content.split('\n');
            
            lines.forEach((line, lineNumber) => {
                const trimmed = line.trim();
                
                // **ENHANCED: Extract COPY statements with better matching**
                const copyMatches = [
                    /COPY\s+([A-Z][A-Z0-9\-_]+)/g,
                    /COPY\s+"([A-Z][A-Z0-9\-_]+)"/g,
                    /COPY\s+'([A-Z][A-Z0-9\-_]+)'/g,
                    /%INCLUDE\s+([A-Z][A-Z0-9\-_]+)/g
                ];
                
                copyMatches.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(trimmed)) !== null) {
                        const copybook = match[1];
                        this.categorizeDependency(copybook, 'copybook', dependencies);
                    }
                });
                
                // **ENHANCED: Extract CALL statements with better patterns**
                const callMatches = [
                    /CALL\s+['"]([A-Z][A-Z0-9\-_]+)['"]/g,
                    /CALL\s+([A-Z][A-Z0-9\-_]+)/g,
                    /LINK\s+([A-Z][A-Z0-9\-_]+)/g,
                    /XCTL\s+([A-Z][A-Z0-9\-_]+)/g
                ];
                
                callMatches.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(trimmed)) !== null) {
                        const program = match[1];
                        this.categorizeDependency(program, 'program', dependencies);
                    }
                });
                
                // **NEW: Extract File References with enhanced patterns**
                const fileMatches = [
                    /SELECT\s+([A-Z][A-Z0-9\-_]+)\s+ASSIGN/g,
                    /FD\s+([A-Z][A-Z0-9\-_]+)/g,
                    /FILE-CONTROL\.\s*SELECT\s+([A-Z][A-Z0-9\-_]+)/g
                ];
                
                fileMatches.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(trimmed)) !== null) {
                        const fileName = match[1];
                        this.categorizeDependency(fileName, 'file', dependencies);
                    }
                });
                
                // **NEW: Detect System Interfaces**
                this.detectSystemInterfacesInLine(trimmed, lineNumber, dependencies);
            });
        }
        
        // Calculate summary with interfaces
        dependencies.summary.foundCount = 
            dependencies.found.copybooks.length + 
            dependencies.found.programs.length + 
            dependencies.found.files.length;
            
        dependencies.summary.missingCount = 
            dependencies.missing.copybooks.length + 
            dependencies.missing.programs.length + 
            dependencies.missing.files.length;
            
        dependencies.summary.interfaceCount = dependencies.systemInterfaces.length;
        
        return dependencies;
    },

    // **NEW: Categorize Dependency (Found vs Missing)**
    categorizeDependency(name, type, dependencies) {
        // Check if component exists in our discovered components
        const exists = this.discoveredComponents.has(name);
        
        // Also check for fuzzy matches (case insensitive, partial matches)
        const fuzzyMatch = Array.from(this.discoveredComponents.keys()).find(comp => 
            comp.toUpperCase() === name.toUpperCase() ||
            comp.toUpperCase().includes(name.toUpperCase()) ||
            name.toUpperCase().includes(comp.toUpperCase())
        );
        
        if (exists || fuzzyMatch) {
            const actualName = fuzzyMatch || name;
            if (!dependencies.found[type + 's'].includes(actualName)) {
                dependencies.found[type + 's'].push(actualName);
            }
        } else {
            if (!dependencies.missing[type + 's'].includes(name)) {
                dependencies.missing[type + 's'].push(name);
            }
        }
    },

    // **NEW: Detect System Interfaces in Line**
    detectSystemInterfacesInLine(line, lineNumber, dependencies) {
        // SQL/DB2 Interface Detection
        if (line.includes('EXEC SQL') || line.includes('EXEC SQLIMS')) {
            this.addSystemInterface(dependencies, 'SQL-DATABASE', 'database', 
                'SQL Database Interface', lineNumber, 'EXEC SQL operations detected');
        }
        
        // CICS Interface Detection
        if (line.includes('EXEC CICS')) {
            const cicsCommands = line.match(/EXEC CICS\s+(\w+)/);
            const command = cicsCommands ? cicsCommands[1] : 'GENERAL';
            this.addSystemInterface(dependencies, `CICS-${command}`, 'transaction', 
                `CICS ${command} Interface`, lineNumber, line.substring(0, 60));
        }
        
        // MQ Interface Detection
        if (line.includes('MQOPEN') || line.includes('MQPUT') || line.includes('MQGET') || line.includes('MQCLOSE')) {
            const mqCommand = line.match(/(MQ\w+)/)?.[1] || 'MQ';
            this.addSystemInterface(dependencies, `MQ-${mqCommand}`, 'queue', 
                'Message Queue Interface', lineNumber, line.substring(0, 60));
        }
        
        // File System Interface Detection
        if (line.includes('OPEN INPUT') || line.includes('OPEN OUTPUT') || line.includes('OPEN I-O')) {
            const openType = line.match(/OPEN\s+(INPUT|OUTPUT|I-O)\s+([A-Z][A-Z0-9\-_]+)/);
            if (openType) {
                this.addSystemInterface(dependencies, `FILE-${openType[2]}`, 'file', 
                    `File System Interface (${openType[1]})`, lineNumber, line.substring(0, 60));
            }
        }
        
        // Web Service/API Interface Detection
        if (line.includes('HTTP') || line.includes('SOAP') || line.includes('REST') || line.includes('XML')) {
            const apiType = line.includes('SOAP') ? 'SOAP' : line.includes('REST') ? 'REST' : 'HTTP';
            this.addSystemInterface(dependencies, `${apiType}-SERVICE`, 'api', 
                `${apiType} Web Service Interface`, lineNumber, line.substring(0, 60));
        }
        
        // VSAM Interface Detection
        if (line.includes('VSAM') || line.includes('KSDS') || line.includes('ESDS') || line.includes('RRDS')) {
            const vsamType = line.match(/(KSDS|ESDS|RRDS|VSAM)/)?.[1] || 'VSAM';
            this.addSystemInterface(dependencies, `VSAM-${vsamType}`, 'database', 
                `VSAM ${vsamType} Interface`, lineNumber, line.substring(0, 60));
        }
    },

    // **NEW: Add System Interface**
    addSystemInterface(dependencies, name, type, description, lineNumber, context) {
        // Avoid duplicates
        const existing = dependencies.systemInterfaces.find(iface => iface.name === name);
        if (!existing) {
            dependencies.systemInterfaces.push({
                name: name,
                type: type,
                description: description,
                lineNumber: lineNumber,
                context: context,
                detectedAt: new Date().toISOString()
            });
        }
    },

    // Analyze Fields in Component
    async analyzeFieldsInComponent(componentName, relevantFiles) {
        const fieldAnalysis = {
            fields: [],
            inputFields: [],
            outputFields: [],
            referenceFields: [],
            unusedFields: [],
            businessLogicSummary: {
                totalValidationRules: 0,
                totalCalculations: 0,
                fieldsWithBusinessLogic: 0
            }
        };
        
        for (const file of relevantFiles) {
            const content = file.content;
            const lines = content.split('\n');
            
            lines.forEach((line, index) => {
                const trimmed = line.trim().toUpperCase();
                
                // Extract field definitions
                const fieldMatch = trimmed.match(/^\s*(\d{2})\s+([A-Z][A-Z0-9\-_]+)(?:\s+PIC\s+([X9VS\(\)]+))?/);
                if (fieldMatch) {
                    const level = parseInt(fieldMatch[1]);
                    const fieldName = fieldMatch[2];
                    const picture = fieldMatch[3] || '';
                    
                    if (level !== 88 && fieldName && level <= 49) {
                        const field = {
                            name: fieldName,
                            level: level,
                            picture: picture,
                            lineNumber: index + 1,
                            fileName: file.name,
                            businessLogic: {
                                businessMeaning: this.generateFieldPurpose(fieldName),
                                validationRules: [],
                                calculations: []
                            }
                        };
                        
                        fieldAnalysis.fields.push(field);
                        
                        // Determine usage pattern
                        if (this.isInputField(fieldName, content)) {
                            fieldAnalysis.inputFields.push(fieldName);
                        } else if (this.isOutputField(fieldName, content)) {
                            fieldAnalysis.outputFields.push(fieldName);
                        } else if (this.isReferenceField(fieldName, content)) {
                            fieldAnalysis.referenceFields.push(fieldName);
                        } else {
                            fieldAnalysis.unusedFields.push(fieldName);
                        }
                    }
                }
            });
        }
        
        return fieldAnalysis;
    },

    // Field Usage Detection Methods
    isInputField(fieldName, content) {
        const patterns = [
            new RegExp(`MOVE\\s+\\w+\\s+TO\\s+${fieldName}`, 'i'),
            new RegExp(`ACCEPT\\s+${fieldName}`, 'i'),
            new RegExp(`READ\\s+\\w+\\s+INTO\\s+${fieldName}`, 'i')
        ];
        
        return patterns.some(pattern => pattern.test(content));
    },

    isOutputField(fieldName, content) {
        const patterns = [
            new RegExp(`DISPLAY\\s+${fieldName}`, 'i'),
            new RegExp(`WRITE\\s+${fieldName}`, 'i'),
            new RegExp(`MOVE\\s+${fieldName}\\s+TO`, 'i')
        ];
        
        return patterns.some(pattern => pattern.test(content));
    },

    isReferenceField(fieldName, content) {
        const patterns = [
            new RegExp(`IF\\s+${fieldName}`, 'i'),
            new RegExp(`WHEN\\s+${fieldName}`, 'i'),
            new RegExp(`COMPUTE\\s+\\w+\\s*=.*${fieldName}`, 'i')
        ];
        
        return patterns.some(pattern => pattern.test(content));
    },

    // Generate Field Purpose
    generateFieldPurpose(fieldName) {
        const name = fieldName.toUpperCase();
        
        if (name.includes('RECORD') || name.includes('REC')) {
            return `Main record structure for ${fieldName.toLowerCase().replace(/-/g, ' ')} data`;
        } else if (name.includes('ID') || name.includes('KEY')) {
            return `Unique identifier for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
        } else if (name.includes('DATE') || name.includes('TIME')) {
            return `Date/time field for ${fieldName.toLowerCase().replace(/-/g, ' ')} tracking`;
        } else if (name.includes('AMT') || name.includes('AMOUNT')) {
            return `Monetary amount for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
        } else if (name.includes('DESC') || name.includes('NAME')) {
            return `Descriptive text for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
        } else if (name.includes('FLAG') || name.includes('IND')) {
            return `Status indicator for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
        } else if (name.includes('CODE') || name.includes('CD')) {
            return `Coded value for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
        } else if (name.includes('COUNT') || name.includes('CNT')) {
            return `Counter/number field for ${fieldName.toLowerCase().replace(/-/g, ' ')}`;
        } else {
            return `Business data field for ${fieldName.toLowerCase().replace(/-/g, ' ')} processing`;
        }
    },

    // Calculate Quality Score
    calculateQualityScore(llmAnalysis, fieldAnalysis) {
        let score = 5; // Base score
        
        // LLM analysis quality factors
        if (llmAnalysis && !llmAnalysis.error) {
            score += 2;
            
            if (llmAnalysis.businessPurpose && llmAnalysis.businessPurpose.length > 50) {
                score += 1;
            }
            
            if (llmAnalysis.recommendations && llmAnalysis.recommendations.length > 0) {
                score += 1;
            }
        }
        
        // Field analysis quality factors
        if (fieldAnalysis) {
            if (fieldAnalysis.fields && fieldAnalysis.fields.length > 0) {
                score += 1;
            }
            
            if (fieldAnalysis.inputFields && fieldAnalysis.inputFields.length > 0) {
                score += 0.5;
            }
            
            if (fieldAnalysis.outputFields && fieldAnalysis.outputFields.length > 0) {
                score += 0.5;
            }
        }
        
        return Math.min(Math.round(score), 10);
    },

    // ============================================
    // LLM API INTEGRATION WITH FALLBACK
    // ============================================

    // Enhanced LLM API Call with 6000 token limit
    async callLLMAPI(prompt, retries = 2) {
        console.log('ü§ñ Enhanced LLM API call initiated');
        
        try {
            // Validate token limits (6000 max)
            const promptTokens = this.estimateTokens(prompt);
            const maxPromptTokens = this.maxTokens - 1500; // Reserve 1500 for response
            
            if (promptTokens > maxPromptTokens) {
                console.warn(`Prompt too large (${promptTokens} tokens), truncating...`);
                prompt = this.truncatePrompt(prompt, maxPromptTokens);
            }
            
            return await this.makeSingleLLMRequest(prompt, 1500, retries);
            
        } catch (error) {
            console.error('Enhanced LLM call failed:', error);
            
            // Return structured fallback response instead of throwing
            return {
                error: true,
                message: error.message,
                businessPurpose: 'LLM analysis failed - manual review recommended',
                recommendations: ['Check LLM connection', 'Verify component data', 'Try manual analysis'],
                qualityScore: 3,
                fallbackUsed: true
            };
        }
    },

    // Estimate Tokens
    estimateTokens(text) {
        if (!text || typeof text !== 'string') return 0;
        
        // More accurate token estimation for mainframe content
        // COBOL and technical content tends to have more tokens per character
        const baseEstimate = Math.ceil(text.length / 3.2);
        
        // Adjust for technical content density
        const technicalWords = (text.match(/\b[A-Z][A-Z0-9\-_]{3,}\b/g) || []).length;
        const codeLines = (text.match(/^\s*\d{2}\s+/gm) || []).length;
        
        // Technical content adjustment
        const adjustment = Math.floor((technicalWords + codeLines) * 0.1);
        
        return baseEstimate + adjustment;
    },

    // Truncate Prompt to Fit Token Limit
    truncatePrompt(prompt, maxTokens) {
        const lines = prompt.split('\n');
        let truncated = '';
        let tokenCount = 0;
        
        // Keep the header and instructions
        const headerEndIndex = lines.findIndex(line => line.includes('FILE CONTENTS:'));
        if (headerEndIndex !== -1) {
            const header = lines.slice(0, headerEndIndex + 1).join('\n');
            truncated = header + '\n';
            tokenCount = this.estimateTokens(truncated);
        }
        
        // Add content until we reach the limit
        for (let i = headerEndIndex + 1; i < lines.length; i++) {
            const line = lines[i] + '\n';
            const lineTokens = this.estimateTokens(line);
            
            if (tokenCount + lineTokens > maxTokens - 100) { // Leave buffer
                truncated += '\n[Content truncated to fit token limit]';
                break;
            }
            
            truncated += line;
            tokenCount += lineTokens;
        }
        
        return truncated;
    },

    // Single LLM Request
    async makeSingleLLMRequest(prompt, maxResponseTokens, retries = 2) {
        for (let attempt = 0; attempt <= retries; attempt++) {
            try {
                console.log(`LLM API call attempt ${attempt + 1}/${retries + 1}`);
                
                const response = await fetch(`${this.vllmEndpoint}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        max_tokens: maxResponseTokens,
                        temperature: 0.1,
                        top_p: 0.9,
                        stop: [],
                        stream: false,
                        frequency_penalty: 0.1,
                        presence_penalty: 0.0
                    }),
                    signal: AbortSignal.timeout(90000) // 90 second timeout
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const resultText = this.extractTextFromResponse(data);
                
                if (!resultText) {
                    throw new Error('No valid text content in LLM response');
                }

                // Try to parse as JSON, fallback to plain text
                const parseResult = this.parseJSONResponse(resultText);
                
                if (parseResult.success) {
                    console.log('‚úÖ LLM request successful with JSON response');
                    return parseResult.data;
                } else {
                    console.log('‚ö†Ô∏è JSON parsing failed, using fallback structure');
                    return {
                        businessPurpose: resultText.substring(0, 500),
                        recommendations: ['Manual review recommended'],
                        qualityScore: 5,
                        rawResponse: resultText,
                        fallbackUsed: true
                    };
                }

            } catch (error) {
                console.error(`LLM attempt ${attempt + 1} failed:`, error);
                
                if (attempt < retries) {
                    const delay = 2000 * (attempt + 1); // Exponential backoff
                    console.log(`Retrying in ${delay}ms...`);
                    await this.sleep(delay);
                } else {
                    throw error;
                }
            }
        }
    },

    // Extract Text from LLM Response
    extractTextFromResponse(data) {
        if (typeof data === 'string') return data.trim();
        if (data.text) return data.text.trim();
        if (data.choices && data.choices[0]) {
            if (data.choices[0].text) return data.choices[0].text.trim();
            if (data.choices[0].message?.content) return data.choices[0].message.content.trim();
        }
        if (data.generated_text) return data.generated_text.trim();
        if (data.response) return data.response.trim();
        
        return null;
    },

    // Parse JSON Response with Fallback
    parseJSONResponse(text) {
    // First, try to parse as JSON
    try {
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            const parsed = JSON.parse(jsonMatch[0]);
            return { success: true, data: parsed };
        }
    } catch (error) {
        console.warn('JSON parsing failed:', error);
    }
    
    // If JSON parsing fails, extract structured information from text
    return {
        success: false,
        error: 'Using text parsing fallback',
        data: this.parseTextResponse(text)
    };
},

// **NEW METHOD: Parse Text Response**
parseTextResponse(text) {
    // Extract business purpose
    const businessPurpose = this.extractBusinessPurpose(text);
    const recommendations = this.extractRecommendations(text);
    const riskAssessment = this.extractRiskAssessment(text);
    const businessRules = this.extractBusinessRules(text);
    
    return {
        businessPurpose: businessPurpose,
        businessLogic: {
            validationRules: this.extractValidationRules(text),
            businessRules: businessRules,
            dataProcessing: this.extractDataProcessing(text)
        },
        recommendations: recommendations,
        modernizationSuggestions: this.extractModernizationSuggestions(text),
        riskAssessment: riskAssessment,
        qualityScore: this.extractQualityScore(text),
        rawResponse: text,
        fallbackUsed: true
    };
},

// **NEW HELPER METHODS for Text Parsing**
extractBusinessPurpose(text) {
    const patterns = [
        /business purpose[:\s]+([^\.!?]*[\.!?])/i,
        /purpose[:\s]+([^\.!?]*[\.!?])/i,
        /this component[:\s]+([^\.!?]*[\.!?])/i,
        /system[:\s]+([^\.!?]*[\.!?])/i
    ];
    
    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            return match[1].trim();
        }
    }
    
    // Fallback: take first meaningful sentence
    const sentences = text.split(/[\.!?]+/);
    for (const sentence of sentences) {
        if (sentence.trim().length > 20) {
            return sentence.trim() + '.';
        }
    }
    
    return 'Business purpose analysis available in full response';
},

extractRecommendations(text) {
    const recommendations = [];
    const patterns = [
        /recommend[a-z]*[:\s]+([^\.!?]*[\.!?])/gi,
        /suggest[a-z]*[:\s]+([^\.!?]*[\.!?])/gi,
        /should[:\s]+([^\.!?]*[\.!?])/gi,
        /consider[:\s]+([^\.!?]*[\.!?])/gi
    ];
    
    patterns.forEach(pattern => {
        const matches = text.matchAll(pattern);
        for (const match of matches) {
            if (match[1] && match[1].trim().length > 10) {
                recommendations.push(match[1].trim());
            }
        }
    });
    
    return recommendations.slice(0, 5); // Limit to 5 recommendations
},

extractRiskAssessment(text) {
    const riskPatterns = [
        /high.{0,20}risk/i,
        /medium.{0,20}risk/i,
        /low.{0,20}risk/i,
        /risk.{0,20}high/i,
        /risk.{0,20}medium/i,
        /risk.{0,20}low/i
    ];
    
    for (const pattern of riskPatterns) {
        const match = text.match(pattern);
        if (match) {
            if (match[0].toLowerCase().includes('high')) return 'high';
            if (match[0].toLowerCase().includes('medium')) return 'medium';
            if (match[0].toLowerCase().includes('low')) return 'low';
        }
    }
    
    return 'medium'; // Default risk level
},

extractValidationRules(text) {
    const rules = [];
    const patterns = [
        /validat[a-z]*[:\s]+([^\.!?]*[\.!?])/gi,
        /check[a-z]*[:\s]+([^\.!?]*[\.!?])/gi,
        /verif[a-z]*[:\s]+([^\.!?]*[\.!?])/gi
    ];
    
    patterns.forEach(pattern => {
        const matches = text.matchAll(pattern);
        for (const match of matches) {
            if (match[1] && match[1].trim().length > 10) {
                rules.push(match[1].trim());
            }
        }
    });
    
    return rules.slice(0, 3);
},

extractBusinessRules(text) {
    const rules = [];
    const patterns = [
        /business rule[:\s]+([^\.!?]*[\.!?])/gi,
        /rule[:\s]+([^\.!?]*[\.!?])/gi,
        /logic[:\s]+([^\.!?]*[\.!?])/gi
    ];
    
    patterns.forEach(pattern => {
        const matches = text.matchAll(pattern);
        for (const match of matches) {
            if (match[1] && match[1].trim().length > 10) {
                rules.push(match[1].trim());
            }
        }
    });
    
    return rules.slice(0, 3);
},

extractDataProcessing(text) {
    const patterns = [
        /process[a-z]*[:\s]+([^\.!?]*[\.!?])/i,
        /data[:\s]+([^\.!?]*[\.!?])/i,
        /transform[a-z]*[:\s]+([^\.!?]*[\.!?])/i
    ];
    
    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1] && match[1].trim().length > 20) {
            return match[1].trim();
        }
    }
    
    return 'Data processing logic analysis available in full response';
},

extractModernizationSuggestions(text) {
    const suggestions = [];
    const patterns = [
        /modern[a-z]*[:\s]+([^\.!?]*[\.!?])/gi,
        /upgrad[a-z]*[:\s]+([^\.!?]*[\.!?])/gi,
        /improv[a-z]*[:\s]+([^\.!?]*[\.!?])/gi,
        /optim[a-z]*[:\s]+([^\.!?]*[\.!?])/gi
    ];
    
    patterns.forEach(pattern => {
        const matches = text.matchAll(pattern);
        for (const match of matches) {
            if (match[1] && match[1].trim().length > 10) {
                suggestions.push(match[1].trim());
            }
        }
    });
    
    return suggestions.slice(0, 3);
},

extractQualityScore(text) {
    const scorePatterns = [
        /quality[:\s]+(\d+)/i,
        /score[:\s]+(\d+)/i,
        /rating[:\s]+(\d+)/i,
        /(\d+)\/10/,
        /(\d+)\s*out\s*of\s*10/i
    ];
    
    for (const pattern of scorePatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            const score = parseInt(match[1]);
            if (score >= 1 && score <= 10) {
                return score;
            }
        }
    }
    
    return 6; // Default quality score
},

    // Get Business Intelligence from LLM
    async getBusinessIntelligenceFromLLM(componentName, friendlyName, componentType, relevantFiles, dependencyAnalysis, fieldAnalysis) {
        const fileContents = relevantFiles.map(f => `=== ${f.name} (${f.type}) ===\n${f.content}`).join('\n\n');
        
        // Truncate file contents if too long
        const maxFileContentLength = 4000;
        const truncatedContents = fileContents.length > maxFileContentLength ? 
            fileContents.substring(0, maxFileContentLength) + '\n[Content truncated...]' : 
            fileContents;
        
        const prompt = `MAINFRAME COMPONENT BUSINESS INTELLIGENCE ANALYSIS

Component: ${componentName}
Friendly Name: ${friendlyName}
Type: ${componentType}

FILE CONTENTS:
${truncatedContents}

DEPENDENCY ANALYSIS:
Found Dependencies: ${JSON.stringify(dependencyAnalysis.found)}
Missing Dependencies: ${JSON.stringify(dependencyAnalysis.missing)}

${fieldAnalysis ? `FIELD ANALYSIS:
Total Fields: ${fieldAnalysis.fields.length}
Input Fields: ${fieldAnalysis.inputFields.length}
Output Fields: ${fieldAnalysis.outputFields.length}
Unused Fields: ${fieldAnalysis.unusedFields.length}` : ''}

TASK: Provide comprehensive business intelligence analysis for this mainframe component.

Return ONLY a JSON object with this exact structure:
{
  "componentName": "${componentName}",
  "friendlyName": "${friendlyName}",
  "businessPurpose": "detailed business purpose and role in the system",
  "businessLogic": {
    "validationRules": ["rule1", "rule2"],
    "businessRules": ["rule1", "rule2"],
    "dataProcessing": "description of data processing logic"
  },
  "qualityScore": 8,
  "recommendations": ["rec1", "rec2", "rec3"],
  "modernizationSuggestions": ["suggestion1", "suggestion2"],
  "riskAssessment": "low/medium/high risk assessment with reasoning"
}`;

        return await this.callLLMAPI(prompt);
    },

    // ============================================
    // DASHBOARD AND RESULTS DISPLAY
    // ============================================

    // Update Dashboard with Results
    updateDashboardWithResults() {
        const dashboardContent = document.getElementById('dashboardContent');
        if (!dashboardContent) return;

        const analyzedComponents = Object.keys(this.analysisResults);
        
        if (analyzedComponents.length === 0) {
            dashboardContent.innerHTML = `
                <p style="color: var(--grey-500); text-align: center; padding: 2rem;">
                    Run auto-analysis to see detailed component insights
                </p>
            `;
            return;
        }

        let html = `
            <!-- System Overview Card -->
            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">üìä</span>
                        System Overview (${analyzedComponents.length} components analyzed)
                    </div>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        ${this.generateSystemOverview()}
                    </div>
                </div>
            </div>

            <!-- Component Analysis Results -->
            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">üéØ</span>
                        Component Analysis Results
                    </div>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        ${this.generateComponentResults()}
                    </div>
                </div>
            </div>

            <!-- Dependencies Summary -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">üîó</span>
                        Dependencies Summary
                    </div>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        ${this.generateDependenciesSummary()}
                    </div>
                </div>
            </div>
        `;

        dashboardContent.innerHTML = html;
    },

    // Generate System Overview
    generateSystemOverview() {
        const analyzedComponents = Object.values(this.analysisResults);
        const avgQuality = analyzedComponents.length > 0 ? 
            (analyzedComponents.reduce((sum, comp) => sum + (comp.qualityScore || 0), 0) / analyzedComponents.length).toFixed(1) : 
            0;

        const riskLevels = analyzedComponents.reduce((acc, comp) => {
            const risk = comp.llmAnalysis?.riskAssessment || 'unknown';
            acc[risk.toLowerCase()] = (acc[risk.toLowerCase()] || 0) + 1;
            return acc;
        }, {});

        return `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: var(--grey-50); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">${analyzedComponents.length}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Components Analyzed</div>
                </div>
                <div style="background: var(--grey-50); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">${avgQuality}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Average Quality Score</div>
                </div>
                <div style="background: var(--grey-50); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning-yellow);">${riskLevels.high || 0}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">High Risk Components</div>
                </div>
                <div style="background: var(--grey-50); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--info-blue);">${this.discoveredComponents.size}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Total Components</div>
                </div>
            </div>
            <p style="color: var(--grey-600); font-size: 0.9rem;">
                üìà <strong>Business Intelligence:</strong> Your mainframe system has been analyzed for business purpose, dependencies, and modernization opportunities. 
                Click on any component below to drill down into detailed analysis.
            </p>
        `;
    },

    // Generate Component Results
    generateComponentResults() {
    const analyzedComponents = Object.entries(this.analysisResults);
    
    if (analyzedComponents.length === 0) {
        return '<p style="color: var(--grey-500); text-align: center; padding: 2rem;">No components analyzed yet. Run auto-analysis to see results.</p>';
    }

    let html = `
        <div style="margin-bottom: 1rem;">
            <h4 style="margin: 0 0 1rem 0;">üìã Components Grid</h4>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Type</th>
                            <th>Input Files</th>
                            <th>Output Files</th>
                            <th>Operations</th>
                            <th>Quality</th>
                            <th>Risk</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    analyzedComponents.forEach(([name, result]) => {
        const component = this.discoveredComponents.get(name);
        const displayName = component?.friendlyName || name;
        const qualityColor = this.getQualityColor(result.qualityScore);
        const riskColor = this.getRiskColor(result.llmAnalysis?.riskAssessment);
        
        // Determine file operations
        const operations = this.determineFileOperations(result);
        
        html += `
            <tr class="component-grid-row" data-component="${name}">
                <td>
                    <div style="font-weight: 600; color: var(--grey-800);">${displayName}</div>
                    <div style="font-size: 0.75rem; color: var(--grey-500); font-family: monospace;">${name}</div>
                </td>
                <td>
                    <span class="badge badge-primary">${result.componentType || 'Unknown'}</span>
                </td>
                <td>
                    <div class="file-list-compact">
                        ${(component?.inputFiles || []).slice(0, 2).map(file => 
                            `<span class="badge badge-success" style="margin: 0.1rem; font-size: 0.7rem;">${file}</span>`
                        ).join('')}
                        ${(component?.inputFiles || []).length > 2 ? `<span class="badge badge-grey">+${(component?.inputFiles || []).length - 2}</span>` : ''}
                        ${(component?.inputFiles || []).length === 0 ? '<span style="color: var(--grey-400);">None</span>' : ''}
                    </div>
                </td>
                <td>
                    <div class="file-list-compact">
                        ${(component?.outputFiles || []).slice(0, 2).map(file => 
                            `<span class="badge badge-info" style="margin: 0.1rem; font-size: 0.7rem;">${file}</span>`
                        ).join('')}
                        ${(component?.outputFiles || []).length > 2 ? `<span class="badge badge-grey">+${(component?.outputFiles || []).length - 2}</span>` : ''}
                        ${(component?.outputFiles || []).length === 0 ? '<span style="color: var(--grey-400);">None</span>' : ''}
                    </div>
                </td>
                <td>
                    <div style="font-size: 0.8rem;">
                        ${operations.map(op => `<span class="badge badge-warning" style="margin: 0.1rem; font-size: 0.7rem;">${op}</span>`).join('')}
                    </div>
                </td>
                <td>
                    <span class="badge" style="background: ${qualityColor}; color: white;">
                        ${result.qualityScore}/10
                    </span>
                </td>
                <td>
                    <span class="badge" style="background: ${riskColor}; color: white;">
                        ${(result.llmAnalysis?.riskAssessment || 'Unknown').toUpperCase()}
                    </span>
                </td>
                <td>
                    <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="analyzer.selectComponent('${name}')">
                        View Details
                    </button>
                </td>
            </tr>
            <tr class="component-detail-row" id="detail-${name}" style="display: none;">
                <td colspan="8">
                    <div style="background: var(--grey-50); padding: 1rem; border-radius: 4px;">
                        ${this.generateComponentDetailView(name, result, component)}
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // Add click handlers for expandable rows
    setTimeout(() => {
        document.querySelectorAll('.component-grid-row').forEach(row => {
            row.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    const componentName = row.getAttribute('data-component');
                    const detailRow = document.getElementById(`detail-${componentName}`);
                    if (detailRow) {
                        detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
                    }
                }
            });
        });
    }, 100);

    return html;
},

// **NEW METHOD: Determine File Operations**
determineFileOperations(result) {
    const operations = [];
    
    if (result.fieldAnalysis) {
        if (result.fieldAnalysis.inputFields && result.fieldAnalysis.inputFields.length > 0) {
            operations.push('READ');
        }
        if (result.fieldAnalysis.outputFields && result.fieldAnalysis.outputFields.length > 0) {
            operations.push('WRITE');
        }
    }
    
    // Check for specific operations in LLM analysis
    if (result.llmAnalysis?.businessLogic?.dataProcessing) {
        const processing = result.llmAnalysis.businessLogic.dataProcessing.toLowerCase();
        if (processing.includes('update') || processing.includes('modify')) {
            operations.push('UPDATE');
        }
        if (processing.includes('validate') || processing.includes('check')) {
            operations.push('VALIDATE');
        }
        if (processing.includes('transform') || processing.includes('convert')) {
            operations.push('TRANSFORM');
        }
    }
    
    return operations.length > 0 ? operations : ['PROCESS'];
},

// **NEW METHOD: Generate Component Detail View**
generateComponentDetailView(name, result, component) {
    return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <h5 style="margin: 0 0 0.5rem 0; color: var(--grey-800);">üìã Component Details</h5>
                <div style="font-size: 0.85rem; line-height: 1.6;">
                    <strong>Business Purpose:</strong><br>
                    ${result.llmAnalysis?.businessPurpose || component?.businessPurpose || 'Not available'}
                </div>
                
                <h6 style="margin: 1rem 0 0.5rem 0; color: var(--grey-700);">üìä Metrics</h6>
                <div style="font-size: 0.8rem;">
                    ‚Ä¢ <strong>Lines of Code:</strong> ${component?.lineCount || 'N/A'}<br>
                    ‚Ä¢ <strong>Complexity Score:</strong> ${component?.complexityScore || 'N/A'}<br>
                    ‚Ä¢ <strong>Field Count:</strong> ${component?.fieldCount || 'N/A'}<br>
                    ‚Ä¢ <strong>Quality Score:</strong> ${result.qualityScore || 'N/A'}/10
                </div>
            </div>
            
            <div>
                <h5 style="margin: 0 0 0.5rem 0; color: var(--grey-800);">üîó Dependencies</h5>
                <div style="font-size: 0.8rem;">
                    <strong>Found:</strong> ${result.dependencyAnalysis?.summary?.foundCount || 0}<br>
                    <strong>Missing:</strong> ${result.dependencyAnalysis?.summary?.missingCount || 0}
                </div>
                
                <h6 style="margin: 1rem 0 0.5rem 0; color: var(--grey-700);">üí° Recommendations</h6>
                <div style="font-size: 0.8rem;">
                    ${(result.llmAnalysis?.recommendations || []).slice(0, 3).map(rec => 
                        `‚Ä¢ ${rec}`
                    ).join('<br>') || 'No recommendations available'}
                </div>
            </div>
        </div>
    `;
},

    // Generate Dependencies Summary
    generateDependenciesSummary() {
        const allDependencies = Object.values(this.analysisResults).reduce((acc, result) => {
            if (result.dependencyAnalysis) {
                acc.foundCount += result.dependencyAnalysis.summary.foundCount;
                acc.missingCount += result.dependencyAnalysis.summary.missingCount;
                
                // Collect missing items
                result.dependencyAnalysis.missing.copybooks.forEach(cb => {
                    if (!acc.missingItems.includes(cb)) acc.missingItems.push(cb);
                });
                result.dependencyAnalysis.missing.programs.forEach(pg => {
                    if (!acc.missingItems.includes(pg)) acc.missingItems.push(pg);
                });
                result.dependencyAnalysis.missing.files.forEach(fl => {
                    if (!acc.missingItems.includes(fl)) acc.missingItems.push(fl);
                });
            }
            return acc;
        }, { foundCount: 0, missingCount: 0, missingItems: [] });

        return `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">${allDependencies.foundCount}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Dependencies Found</div>
                </div>
                <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--error-red);">${allDependencies.missingCount}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Dependencies Missing</div>
                </div>
            </div>
            ${allDependencies.missingItems.length > 0 ? `
                <div style="background: var(--grey-50); padding: 1rem; border-radius: 8px;">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--error-red);">‚ö†Ô∏è Missing Dependencies</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                        ${allDependencies.missingItems.slice(0, 10).map(item => 
                            `<span class="badge badge-danger">${item}</span>`
                        ).join('')}
                        ${allDependencies.missingItems.length > 10 ? `<span class="badge badge-grey">+${allDependencies.missingItems.length - 10} more</span>` : ''}
                    </div>
                </div>
            ` : ''}
        `;
    },

    // Helper methods for colors
    getQualityColor(score) {
        if (score >= 8) return 'var(--success-green)';
        if (score >= 6) return 'var(--warning-yellow)';
        return 'var(--error-red)';
    },

    getRiskColor(risk) {
        const riskLevel = (risk || '').toLowerCase();
        if (riskLevel.includes('high')) return 'var(--error-red)';
        if (riskLevel.includes('medium')) return 'var(--warning-yellow)';
        return 'var(--success-green)';
    },

    // Enable Export Buttons
    enableExportButtons() {
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const exportMdBtn = document.getElementById('exportMdBtn');
        
        if (exportJsonBtn) exportJsonBtn.disabled = false;
        if (exportMdBtn) exportMdBtn.disabled = false;
    },

    // Enable Chat
    enableChat() {
        // This will be implemented in Part 5
        console.log('‚úÖ Chat system ready for activation');
    },

    
// Attach Chat Event Listeners
    attachChatEventListeners() {
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const chatContext = document.getElementById('chatContext');
        
        if (chatInput && chatSendBtn) {
            // Chat input event handlers
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendChatMessage();
                }
            });
            
            chatSendBtn.addEventListener('click', () => this.sendChatMessage());
            
            // Auto-resize chat input
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 160) + 'px';
            });
        }

        // Chat context change
        if (chatContext) {
            chatContext.addEventListener('change', () => this.onChatContextChange());
        }

        // Chat suggestion buttons - use event delegation
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('chat-suggestion-btn')) {
                const question = e.target.getAttribute('data-question');
                if (question && chatInput) {
                    chatInput.value = question;
                    this.sendChatMessage();
                }
            }
        });
    },

    // Display Welcome Message
    displayWelcomeMessage() {
        this.addChatMessage('assistant', `üëã **Welcome to Business Intelligence Chat!**

I provide contextual analysis and can drill down into:

üéØ **Business Purpose:** What each component does in business terms
üìä **Program Analysis:** Detailed program structure and logic  
üìã **Field Analysis:** Field lifecycle, usage, and business meaning
üìÅ **File Analysis:** Data flow and file relationships
üîó **Dependency Impact:** How changes affect the system
‚öñÔ∏è **Business Rules:** Logic validation and business constraints
üöÄ **Modernization:** Optimization and migration recommendations

*Upload files and start auto-analysis to unlock intelligent conversations!*`);
    },

    // Enable Chat
    enableChat() {
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const chatContextSection = document.getElementById('chatContextSection');
        const chatSuggestions = document.getElementById('chatSuggestions');
        
        if (chatInput) chatInput.disabled = false;
        if (chatSendBtn) chatSendBtn.disabled = false;
        if (chatContextSection) chatContextSection.style.display = 'block';
        if (chatSuggestions) chatSuggestions.style.display = 'block';
        
        // Show analysis ready message
        this.addChatMessage('assistant', `üéâ **Analysis Complete!**

I can now provide intelligent insights about your ${this.discoveredComponents.size} discovered components.

**Available Analysis:**
‚Ä¢ ${Object.keys(this.analysisResults).length} components fully analyzed
‚Ä¢ Business purpose and logic understanding
‚Ä¢ Dependency mapping and impact analysis
‚Ä¢ Field-level insights and relationships
‚Ä¢ Modernization recommendations

**Try asking:**
"What's the business purpose of [component name]?"
"Show me missing dependencies"
"Which components are most critical?"
"How can we optimize this system?"

Select any component from the dashboard to get contextual suggestions!`);
    },

    // ============================================
    // CHAT MESSAGE HANDLING
    // ============================================

    // Send Chat Message
    async sendChatMessage() {
        const chatInput = document.getElementById('chatInput');
        const message = chatInput.value.trim();
        
        if (!message) return;
        
        // Clear input and add user message
        chatInput.value = '';
        chatInput.style.height = 'auto';
        this.addChatMessage('user', message);
        
        // Show typing indicator
        this.showTypingIndicator();
        
        try {
            // Get contextual response
            const response = await this.getChatResponse(message);
            
            // Remove typing indicator and add response
            this.hideTypingIndicator();
            this.addChatMessage('assistant', response);
            
            // Save chat to database
            this.saveChatToDatabase(message, response);
            
        } catch (error) {
            this.hideTypingIndicator();
            this.addChatMessage('assistant', `‚ùå **Error:** ${error.message}\n\nPlease check your LLM connection and try again.`);
        }
    },

    // Add Chat Message to UI
    addChatMessage(sender, content) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        
        if (sender === 'assistant') {
            bubble.innerHTML = `
                <div class="chat-message-header">Business Intelligence Assistant</div>
                <div class="chat-message-content">${content}</div>
                <div class="chat-message-time">${new Date().toLocaleTimeString()}</div>
            `;
        } else {
            bubble.innerHTML = `
                <div class="chat-message-content">${content}</div>
                <div class="chat-message-time">${new Date().toLocaleTimeString()}</div>
            `;
        }
        
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    },

    // Show/Hide Typing Indicator
    showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <span>ü§ñ Assistant is thinking...</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    },

    hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    },

    // Get Chat Response
    async getChatResponse(message) {
        const context = this.buildChatContext(message);
        
        const prompt = `BUSINESS INTELLIGENCE CHAT ASSISTANT

CONTEXT:
${context}

USER QUESTION: "${message}"

INSTRUCTIONS:
- Provide intelligent, business-focused insights based on the analysis data
- Use specific component names, statistics, and recommendations from the context
- Format response in markdown for readability with **bold** text for emphasis
- Be conversational but professional
- If asked about specific components, reference their analysis data
- For dependency questions, highlight critical missing items
- For optimization questions, provide concrete modernization suggestions
- If information is not available in the context, say so clearly

RESPONSE:`;

        try {
            const response = await this.callLLMAPI(prompt);
            
            // Handle different response types
            if (typeof response === 'string') {
                return response;
            } else if (response && response.businessPurpose) {
                return response.businessPurpose;
            } else if (response && response.rawResponse) {
                return response.rawResponse;
            } else {
                return this.generateFallbackResponse(message);
            }
            
        } catch (error) {
            console.error('Chat response failed:', error);
            return this.generateFallbackResponse(message);
        }
    },

    // Build Chat Context
    buildChatContext(message) {
        let context = `SYSTEM OVERVIEW:
- Total Components: ${this.discoveredComponents.size}
- Analyzed Components: ${Object.keys(this.analysisResults).length}
- Files Uploaded: ${this.uploadedFiles.length}
- Current Selection: ${this.currentSelectedComponent || 'None'}

`;

        // Add component summaries
        if (Object.keys(this.analysisResults).length > 0) {
            context += `ANALYZED COMPONENTS:\n`;
            Object.entries(this.analysisResults).slice(0, 5).forEach(([name, result]) => {
                const comp = this.discoveredComponents.get(name);
                context += `- ${name} (${comp?.friendlyName || name}): ${result.componentType}\n`;
                context += `  Purpose: ${result.llmAnalysis?.businessPurpose?.substring(0, 150) || 'Not available'}...\n`;
                if (result.qualityScore) {
                    context += `  Quality Score: ${result.qualityScore}/10\n`;
                }
                if (result.llmAnalysis?.riskAssessment) {
                    context += `  Risk Level: ${result.llmAnalysis.riskAssessment}\n`;
                }
            });
            context += '\n';
        }

        // Add dependency summary
        const totalMissing = Object.values(this.analysisResults).reduce((sum, result) => 
            sum + (result.dependencyAnalysis?.summary?.missingCount || 0), 0);
        if (totalMissing > 0) {
            context += `DEPENDENCIES:\n- Total Missing Dependencies: ${totalMissing}\n\n`;
        }

        // Add specific component context if selected
        if (this.currentSelectedComponent && this.analysisResults[this.currentSelectedComponent]) {
            const selectedResult = this.analysisResults[this.currentSelectedComponent];
            context += `CURRENT COMPONENT FOCUS: ${this.currentSelectedComponent}\n`;
            context += `Analysis: ${JSON.stringify(selectedResult, null, 2).substring(0, 1500)}\n\n`;
        }

        return context;
    },

    // Generate Fallback Response
    generateFallbackResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        if (lowerMessage.includes('business purpose') || lowerMessage.includes('what does')) {
            return `üìä **Business Purpose Analysis**

Based on the analyzed components:

${Object.entries(this.analysisResults).slice(0, 3).map(([name, result]) => {
    const comp = this.discoveredComponents.get(name);
    return `‚Ä¢ **${comp?.friendlyName || name}**: ${result.llmAnalysis?.businessPurpose?.substring(0, 100) || result.componentType + ' component'}...`;
}).join('\n')}

*Select a specific component from the dashboard for detailed analysis.*`;
        }
        
        if (lowerMessage.includes('dependencies') || lowerMessage.includes('missing')) {
            const totalMissing = Object.values(this.analysisResults).reduce((sum, result) => 
                sum + (result.dependencyAnalysis?.summary?.missingCount || 0), 0);
            
            return `üîó **Dependency Analysis**

**System Health:**
‚Ä¢ Total Missing Dependencies: ${totalMissing}
‚Ä¢ Critical Impact Assessment: ${totalMissing > 10 ? 'HIGH' : totalMissing > 5 ? 'MEDIUM' : 'LOW'}

**Recommendations:**
‚Ä¢ Review missing copybooks and programs
‚Ä¢ Validate file references
‚Ä¢ Consider impact on system functionality

*Ask about specific components for detailed dependency maps.*`;
        }
        
        if (lowerMessage.includes('risk') || lowerMessage.includes('critical')) {
            const highRiskComponents = Object.entries(this.analysisResults)
                .filter(([_, result]) => (result.llmAnalysis?.riskAssessment || '').toLowerCase().includes('high'))
                .map(([name, _]) => this.discoveredComponents.get(name)?.friendlyName || name);
            
            return `üìä **Risk Analysis**

**High Risk Components:** ${highRiskComponents.length}
${highRiskComponents.length > 0 ? highRiskComponents.slice(0, 5).map(name => `‚Ä¢ ${name}`).join('\n') : '‚Ä¢ No high-risk components identified'}

**Quality Assessment:**
‚Ä¢ Components analyzed: ${Object.keys(this.analysisResults).length}
‚Ä¢ Average quality score: ${Object.values(this.analysisResults).reduce((sum, r) => sum + (r.qualityScore || 0), 0) / Object.keys(this.analysisResults).length || 0}

*Select components to view detailed risk assessments.*`;
        }
        
        if (lowerMessage.includes('optimize') || lowerMessage.includes('modernize')) {
            return `üöÄ **Modernization Recommendations**

**System Optimization Opportunities:**
‚Ä¢ Legacy code refactoring candidates identified
‚Ä¢ Dependency simplification possibilities  
‚Ä¢ Data structure optimization potential

**Next Steps:**
‚Ä¢ Review high-complexity components first
‚Ä¢ Address missing dependencies
‚Ä¢ Consider microservices decomposition
‚Ä¢ Implement automated testing coverage

*Ask about specific components for targeted modernization strategies.*`;
        }
        
        return `ü§ñ **I'm here to help with your mainframe analysis!**

**What I can assist with:**
‚Ä¢ Business purpose explanations
‚Ä¢ Dependency analysis and impact assessment
‚Ä¢ Risk assessment and quality evaluation
‚Ä¢ Modernization recommendations
‚Ä¢ Component-specific insights

**Try asking:**
‚Ä¢ "What's the purpose of [component name]?"
‚Ä¢ "Show me missing dependencies"
‚Ä¢ "Which components need attention?"
‚Ä¢ "How can we optimize this system?"

*Select any component from the dashboard for focused analysis.*`;
    },

    // Update Chat Context
    updateChatContext(contextType, selectedItem) {
        const chatContext = document.getElementById('chatContext');
        const chatSelectedItem = document.getElementById('chatSelectedItem');
        
        if (chatContext) chatContext.value = contextType;
        if (chatSelectedItem) chatSelectedItem.value = selectedItem || '';
        
        this.chatContext = contextType;
        this.currentSelectedComponent = contextType === 'component' ? selectedItem : null;
    },

    // Save Chat to Database
    saveChatToDatabase(userMessage, assistantResponse) {
        if (!this.db || !this.dbInitialized) return;
        
        try {
            const timestamp = new Date().toISOString();
            
            // Save user message
            this.db.run(`
                INSERT INTO chat_history 
                (component_name, context_type, sender, content, timestamp)
                VALUES (?, ?, ?, ?, ?)
            `, [
                this.currentSelectedComponent || '',
                this.chatContext,
                'user',
                userMessage,
                timestamp
            ]);
            
            // Save assistant response
            this.db.run(`
                INSERT INTO chat_history 
                (component_name, context_type, sender, content, timestamp)
                VALUES (?, ?, ?, ?, ?)
            `, [
                this.currentSelectedComponent || '',
                this.chatContext,
                'assistant',
                assistantResponse,
                timestamp
            ]);
            
        } catch (error) {
            console.error('Failed to save chat to database:', error);
        }
    },

    // Chat context change handler
    onChatContextChange() {
        const chatContext = document.getElementById('chatContext');
        if (chatContext) {
            this.chatContext = chatContext.value;
        }
    },

    // ============================================
    // DEPENDENCY AND FIELD MATRIX DISPLAY
    // ============================================

    // Display Component Analysis
    displayComponentAnalysis(componentName) {
        const result = this.analysisResults[componentName];
        if (!result) return;

        // Update dependencies tab
        this.displayDependencyFlow(componentName, result);
        
        // Update field matrix tab if applicable
        if (result.fieldAnalysis) {
            this.displayFieldMatrix(componentName, result);
        }
    },

    // Display Dependency Flow
    displayDependencyFlow(componentName, result) {
        const container = document.getElementById('dependenciesContent');
        if (!container) return;

        const component = this.discoveredComponents.get(componentName);
        const displayName = component?.friendlyName || componentName;

        let html = `
            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">üéØ</span>
                        ${displayName} - Dependency Analysis
                    </div>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        ${this.generateDependencyFlowChart(result.dependencyAnalysis)}
                    </div>
                </div>
            </div>

            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">üìã</span>
                        Detailed Dependency Breakdown
                    </div>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        ${this.generateDependencyTable(result.dependencyAnalysis)}
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;
    },

    // Generate Dependency Flow Chart
    // System Analysis Helper Methods
identifyDatabaseConnections(architecturalFlow) {
    const databases = [];
    this.discoveredComponents.forEach((component, name) => {
        const upperName = name.toUpperCase();
        if (upperName.includes('DB2') || upperName.includes('DATABASE') || upperName.includes('TABLE')) {
            databases.push({ name, type: 'DB2' });
        } else if (upperName.includes('VSAM') || upperName.includes('KSDS') || upperName.includes('ESDS')) {
            databases.push({ name, type: 'VSAM' });
        } else if (upperName.includes('SEQUENTIAL') || upperName.includes('SEQ')) {
            databases.push({ name, type: 'Sequential' });
        }
    });
    return databases;
},

identifyMessageQueues(architecturalFlow) {
    const queues = [];
    this.discoveredComponents.forEach((component, name) => {
        const upperName = name.toUpperCase();
        if (upperName.includes('MQ') || upperName.includes('QUEUE') || upperName.includes('MSG')) {
            const direction = upperName.includes('INPUT') || upperName.includes('IN') ? 'Inbound' : 
                            upperName.includes('OUTPUT') || upperName.includes('OUT') ? 'Outbound' : 'Bidirectional';
            queues.push({ name, direction });
        }
    });
    return queues;
},

identifyExternalAPIs(architecturalFlow) {
    const apis = [];
    this.discoveredComponents.forEach((component, name) => {
        const upperName = name.toUpperCase();
        if (upperName.includes('API') || upperName.includes('WS') || upperName.includes('SERVICE') || upperName.includes('REST')) {
            const protocol = upperName.includes('REST') ? 'REST' : 
                           upperName.includes('SOAP') ? 'SOAP' : 
                           upperName.includes('WS') ? 'Web Service' : 'API';
            apis.push({ name, protocol });
        }
    });
    return apis;
},

identifyBatchInterfaces(architecturalFlow) {
    const batches = [];
    this.discoveredComponents.forEach((component, name) => {
        const upperName = name.toUpperCase();
        if (upperName.includes('BATCH') || upperName.includes('JOB') || upperName.includes('DAILY') || upperName.includes('MONTHLY')) {
            const schedule = upperName.includes('DAILY') ? 'Daily' : 
                           upperName.includes('MONTHLY') ? 'Monthly' : 
                           upperName.includes('WEEKLY') ? 'Weekly' : 'On Demand';
            batches.push({ name, schedule });
        }
    });
    return batches;
},

// Architecture Metrics Calculation
calculateArchitectureMetrics(architecturalFlow) {
    const totalComponents = this.discoveredComponents.size;
    const totalConnections = architecturalFlow.moduleToModule.length;
    
    // Coupling: Average connections per component
    const coupling = totalComponents > 0 ? totalConnections / totalComponents : 0;
    
    // Cohesion: Based on layer distribution and component organization
    const layerDistribution = {
        presentation: architecturalFlow.layers.presentation.length,
        business: architecturalFlow.layers.business.length,
        data: architecturalFlow.layers.data.length,
        integration: architecturalFlow.layers.integration.length
    };
    
    const maxLayer = Math.max(...Object.values(layerDistribution));
    const minLayer = Math.min(...Object.values(layerDistribution));
    const cohesion = maxLayer > 0 ? (10 - (maxLayer - minLayer) / maxLayer * 10) : 5;
    
    // Complexity: Based on component interdependencies and missing deps
    const missingDeps = Object.values(this.analysisResults).reduce((sum, result) => 
        sum + (result.dependencyAnalysis?.summary?.missingCount || 0), 0);
    const complexity = coupling + (missingDeps / totalComponents) * 2;
    
    // Stability: Based on missing dependencies and pattern issues
    const stabilityIssues = missingDeps + architecturalFlow.patterns.circular.length * 2;
    const stability = Math.max(0, 10 - (stabilityIssues / totalComponents) * 5);
    
    // Critical Issues
    const criticalIssues = [];
    if (coupling > 8) criticalIssues.push('High coupling detected - consider decoupling strategies');
    if (cohesion < 3) criticalIssues.push('Low cohesion - components are poorly organized');
    if (missingDeps > totalComponents * 0.2) criticalIssues.push('Too many missing dependencies - system integrity at risk');
    if (architecturalFlow.patterns.circular.length > 0) criticalIssues.push('Circular dependencies detected - refactoring needed');
    
    return {
        coupling: Math.min(coupling, 10),
        cohesion: Math.max(cohesion, 0),
        complexity: Math.min(complexity, 10),
        stability: Math.min(stability, 10),
        criticalIssues
    };
},

// Color Helper Methods
getCouplingColor(score) {
    return score < 3 ? 'var(--success-green)' : score < 6 ? 'var(--warning-yellow)' : 'var(--error-red)';
},

getCohesionColor(score) {
    return score > 7 ? 'var(--success-green)' : score > 4 ? 'var(--warning-yellow)' : 'var(--error-red)';
},

getComplexityColor(score) {
    return score < 5 ? 'var(--success-green)' : score < 8 ? 'var(--warning-yellow)' : 'var(--error-red)';
},

getStabilityColor(score) {
    return score > 7 ? 'var(--success-green)' : score > 4 ? 'var(--warning-yellow)' : 'var(--error-red)';
},

// Detect Architecture Patterns
detectArchitecturePatterns(architecturalFlow) {
    const patterns = [];
    
    // Layered Architecture
    const hasLayers = Object.values(architecturalFlow.layers).some(layer => layer.length > 0);
    if (hasLayers) {
        patterns.push({ name: 'Layered Architecture', type: 'structural' });
    }
    
    // Hub and Spoke (components with many connections)
    const hubComponents = architecturalFlow.moduleToModule.reduce((hubs, connection) => {
        hubs[connection.from] = (hubs[connection.from] || 0) + 1;
        return hubs;
    }, {});
    
    const majorHubs = Object.entries(hubComponents).filter(([_, count]) => count > 5);
    if (majorHubs.length > 0) {
        patterns.push({ name: 'Hub and Spoke', type: 'connectivity' });
    }
    
    // Data Flow Pipeline (sequential data processing)
    if (architecturalFlow.moduleToData.length > architecturalFlow.moduleToModule.length * 0.6) {
        patterns.push({ name: 'Data Pipeline', type: 'processing' });
    }
    
    // Service-Oriented (external connections)
    if (architecturalFlow.externalConnections.length > 2) {
        patterns.push({ name: 'Service-Oriented', type: 'integration' });
    }
    
    // Monolithic (high coupling, single layer dominance)
    const businessLayer = architecturalFlow.layers.business.length;
    const totalComponents = this.discoveredComponents.size;
    if (businessLayer > totalComponents * 0.7) {
        patterns.push({ name: 'Monolithic', type: 'structural' });
    }
    
    // Event-Driven (message queues present)
    const hasMessageQueues = this.identifyMessageQueues(architecturalFlow).length > 0;
    if (hasMessageQueues) {
        patterns.push({ name: 'Event-Driven', type: 'messaging' });
    }
    
    return patterns;
},

getPatternBadgeClass(patternType) {
    switch (patternType) {
        case 'structural': return 'badge-primary';
        case 'connectivity': return 'badge-info';
        case 'processing': return 'badge-warning';
        case 'integration': return 'badge-success';
        case 'messaging': return 'badge-purple';
        default: return 'badge-grey';
    }
},

// Build System-Wide Flow Map
buildSystemWideFlowMap() {
    const systemFlow = {
        districts: {
            core: [],
            interface: [],
            data: [],
            external: []
        },
        highways: [],
        healthMetrics: {
            totalComponents: this.discoveredComponents.size,
            totalConnections: 0,
            missingDependencies: 0,
            circularDependencies: 0
        }
    };
    
    // Classify all components into districts
    this.discoveredComponents.forEach((component, name) => {
        const archType = this.classifyComponentArchitecturally(component);
        const connections = this.getComponentConnections(name);
        
        const componentInfo = {
            name,
            component,
            connections,
            analyzed: this.analysisResults[name] ? true : false
        };
        
        switch (archType) {
            case 'data':
                systemFlow.districts.data.push(componentInfo);
                break;
            case 'external':
                systemFlow.districts.external.push(componentInfo);
                break;
            case 'presentation':
            case 'integration':
                systemFlow.districts.interface.push(componentInfo);
                break;
            default:
                systemFlow.districts.core.push(componentInfo);
        }
        
        systemFlow.healthMetrics.totalConnections += connections.total;
    });
    
    // Calculate missing dependencies
    Object.values(this.analysisResults).forEach(result => {
        if (result.dependencyAnalysis) {
            systemFlow.healthMetrics.missingDependencies += result.dependencyAnalysis.summary.missingCount;
        }
    });
    
    // Identify major highways (high-traffic routes)
    systemFlow.highways = this.identifySystemHighways();
    
    return systemFlow;
},

// Generate System Districts
generateSystemDistricts(systemFlow) {
    return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
            <!-- Core Business District -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--grey-200);">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-blue);">üè¢ Core Business District</h4>
                <div style="margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">${systemFlow.districts.core.length}</span>
                    <span style="color: var(--grey-600); margin-left: 0.5rem;">components</span>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${systemFlow.districts.core.slice(0, 10).map(comp => `
                        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--grey-50); border-radius: 6px; cursor: pointer;" onclick="analyzer.selectComponent('${comp.name}')">
                            <div style="font-weight: bold; font-size: 0.85rem;">${comp.name}</div>
                            <div style="font-size: 0.75rem; color: var(--grey-600);">üîó ${comp.connections.total} connections</div>
                        </div>
                    `).join('')}
                    ${systemFlow.districts.core.length > 10 ? `<div style="text-align: center; color: var(--grey-500); font-size: 0.8rem;">+${systemFlow.districts.core.length - 10} more</div>` : ''}
                </div>
            </div>
            
            <!-- Interface District -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--grey-200);">
                <h4 style="margin: 0 0 1rem 0; color: var(--info-blue);">üåâ Interface District</h4>
                <div style="margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem; font-weight: bold; color: var(--info-blue);">${systemFlow.districts.interface.length}</span>
                    <span style="color: var(--grey-600); margin-left: 0.5rem;">components</span>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${systemFlow.districts.interface.slice(0, 10).map(comp => `
                        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--grey-50); border-radius: 6px; cursor: pointer;" onclick="analyzer.selectComponent('${comp.name}')">
                            <div style="font-weight: bold; font-size: 0.85rem;">${comp.name}</div>
                            <div style="font-size: 0.75rem; color: var(--grey-600);">üîó ${comp.connections.total} connections</div>
                        </div>
                    `).join('')}
                    ${systemFlow.districts.interface.length > 10 ? `<div style="text-align: center; color: var(--grey-500); font-size: 0.8rem;">+${systemFlow.districts.interface.length - 10} more</div>` : ''}
                </div>
            </div>
            
            <!-- Data District -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--grey-200);">
                <h4 style="margin: 0 0 1rem 0; color: var(--warning-yellow);">üè¶ Data District</h4>
                <div style="margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem; font-weight: bold; color: var(--warning-yellow);">${systemFlow.districts.data.length}</span>
                    <span style="color: var(--grey-600); margin-left: 0.5rem;">components</span>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${systemFlow.districts.data.slice(0, 10).map(comp => `
                        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--grey-50); border-radius: 6px; cursor: pointer;" onclick="analyzer.selectComponent('${comp.name}')">
                            <div style="font-weight: bold; font-size: 0.85rem;">${comp.name}</div>
                            <div style="font-size: 0.75rem; color: var(--grey-600);">üíæ Data Store</div>
                        </div>
                    `).join('')}
                    ${systemFlow.districts.data.length > 10 ? `<div style="text-align: center; color: var(--grey-500); font-size: 0.8rem;">+${systemFlow.districts.data.length - 10} more</div>` : ''}
                </div>
            </div>
            
            <!-- External District -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--grey-200);">
                <h4 style="margin: 0 0 1rem 0; color: var(--success-green);">üåê External District</h4>
                <div style="margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">${systemFlow.districts.external.length}</span>
                    <span style="color: var(--grey-600); margin-left: 0.5rem;">components</span>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${systemFlow.districts.external.slice(0, 10).map(comp => `
                        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--grey-50); border-radius: 6px; cursor: pointer;" onclick="analyzer.selectComponent('${comp.name}')">
                            <div style="font-weight: bold; font-size: 0.85rem;">${comp.name}</div>
                            <div style="font-size: 0.75rem; color: var(--grey-600);">üîå External System</div>
                        </div>
                    `).join('')}
                    ${systemFlow.districts.external.length > 10 ? `<div style="text-align: center; color: var(--grey-500); font-size: 0.8rem;">+${systemFlow.districts.external.length - 10} more</div>` : ''}
                </div>
            </div>
        </div>
    `;
},

// Generate Major Highways
generateMajorHighways(systemFlow) {
    return `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--grey-200);">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üõ£Ô∏è Major Data Highways</h4>
            <p style="margin: 0 0 1rem 0; color: var(--grey-600); font-size: 0.9rem;">
                High-traffic dependency routes connecting different districts
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                ${systemFlow.highways.slice(0, 6).map((highway, index) => `
                    <div style="padding: 1rem; background: var(--grey-50); border-radius: 8px; border-left: 4px solid ${this.getHighwayColor(highway.traffic)};">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                            <h5 style="margin: 0; color: ${this.getHighwayColor(highway.traffic)};">
                                ${highway.type === 'major' ? 'üõ£Ô∏è' : highway.type === 'arterial' ? 'üõ§Ô∏è' : 'üö∂'} ${highway.name}
                            </h5>
                            <span class="badge badge-info">${highway.traffic} connections</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--grey-700);">
                            Hub: <strong>${highway.hub}</strong>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--grey-600); margin-top: 0.25rem;">
                            ${highway.type === 'major' ? 'Critical system pathway' : 
                              highway.type === 'arterial' ? 'Important connection route' : 'Local component link'}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
},

// Generate System Health Dashboard
generateSystemHealthDashboard(systemFlow) {
    const healthScore = this.calculateSystemHealthScore(systemFlow);
    
    return `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--grey-200);">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üìä System Health Dashboard</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <!-- Overall Health Score -->
                <div style="text-align: center; padding: 1.5rem; background: ${this.getHealthScoreBackground(healthScore)}; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: ${this.getHealthScoreColor(healthScore)};">
                        ${healthScore.toFixed(1)}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--grey-600); margin-bottom: 0.5rem;">Overall Health</div>
                    <div style="font-size: 0.75rem; color: var(--grey-500);">
                        ${healthScore >= 8 ? 'Excellent' : healthScore >= 6 ? 'Good' : healthScore >= 4 ? 'Fair' : 'Needs Attention'}
                    </div>
                </div>
                
                <!-- Component Coverage -->
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">
                        ${systemFlow.healthMetrics.totalComponents}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Total Components</div>
                </div>
                
                <!-- Connection Health -->
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">
                        ${Math.round(systemFlow.healthMetrics.totalConnections / systemFlow.healthMetrics.totalComponents * 10) / 10}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Avg Connections</div>
                </div>
                
                <!-- Missing Dependencies -->
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${systemFlow.healthMetrics.missingDependencies > 10 ? 'var(--error-red)' : 'var(--warning-yellow)'};">
                        ${systemFlow.healthMetrics.missingDependencies}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Missing Deps</div>
                </div>
            </div>
            
            <!-- System Recommendations -->
            <div style="background: var(--grey-50); border-radius: 8px; padding: 1rem;">
                <h5 style="margin: 0 0 0.75rem 0; color: var(--grey-800);">üéØ Architecture Recommendations</h5>
                ${this.generateSystemRecommendations(systemFlow, healthScore)}
            </div>
        </div>
    `;
},

// Helper Methods for System Analysis
identifySystemHighways() {
    const highways = [];
    const connectionCounts = new Map();
    
    // Count connections for each component
    Object.entries(this.analysisResults).forEach(([name, result]) => {
        if (result.dependencyAnalysis) {
            const totalDeps = result.dependencyAnalysis.summary.foundCount;
            connectionCounts.set(name, totalDeps);
        }
    });
    
    // Find downstream connections
    connectionCounts.forEach((count, name) => {
        const downstreamCount = Object.values(this.analysisResults).filter(result => {
            if (!result.dependencyAnalysis) return false;
            return [...(result.dependencyAnalysis.found?.copybooks || []),
                    ...(result.dependencyAnalysis.found?.programs || []),
                    ...(result.dependencyAnalysis.found?.files || [])].includes(name);
        }).length;
        
        connectionCounts.set(name, count + downstreamCount);
    });
    
    // Create highways from high-traffic components
    Array.from(connectionCounts.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .forEach(([name, traffic], index) => {
            highways.push({
                name: `Highway ${String.fromCharCode(65 + index)}`, // A, B, C, etc.
                hub: name,
                traffic: traffic,
                type: traffic > 15 ? 'major' : traffic > 8 ? 'arterial' : 'local'
            });
        });
    
    return highways;
},

getHighwayColor(traffic) {
    if (traffic > 15) return 'var(--error-red)';
    if (traffic > 8) return 'var(--warning-yellow)';
    return 'var(--success-green)';
},

calculateSystemHealthScore(systemFlow) {
    let score = 10;
    
    // Deduct for missing dependencies
    const missingRatio = systemFlow.healthMetrics.missingDependencies / systemFlow.healthMetrics.totalComponents;
    score -= missingRatio * 5;
    
    // Deduct for poor distribution across districts
    const districts = Object.values(systemFlow.districts);
    const maxDistrict = Math.max(...districts.map(d => d.length));
    const minDistrict = Math.min(...districts.map(d => d.length));
    if (maxDistrict > 0) {
        const imbalance = (maxDistrict - minDistrict) / maxDistrict;
        score -= imbalance * 2;
    }
    
    // Deduct for analysis coverage
    const analyzedCount = Object.keys(this.analysisResults).length;
    const coverageRatio = analyzedCount / systemFlow.healthMetrics.totalComponents;
    score -= (1 - coverageRatio) * 3;
    
    return Math.max(0, Math.min(10, score));
},

getHealthScoreColor(score) {
    if (score >= 8) return 'var(--success-green)';
    if (score >= 6) return 'var(--warning-yellow)';
    return 'var(--error-red)';
},

getHealthScoreBackground(score) {
    if (score >= 8) return 'rgba(16, 185, 129, 0.1)';
    if (score >= 6) return 'rgba(245, 158, 11, 0.1)';
    return 'rgba(239, 68, 68, 0.1)';
},

generateSystemRecommendations(systemFlow, healthScore) {
    const recommendations = [];
    
    if (systemFlow.healthMetrics.missingDependencies > systemFlow.healthMetrics.totalComponents * 0.1) {
        recommendations.push('üîß Upload missing dependencies to improve system integrity');
    }
    
    const businessDominance = systemFlow.districts.core.length / systemFlow.healthMetrics.totalComponents;
    if (businessDominance > 0.8) {
        recommendations.push('üèóÔ∏è Consider separating concerns into distinct architectural layers');
    }
    
    if (systemFlow.districts.external.length === 0) {
        recommendations.push('üåê System appears isolated - consider integration opportunities');
    }
    
    if (systemFlow.highways.filter(h => h.type === 'major').length > 3) {
        recommendations.push('‚ö° Multiple high-traffic hubs detected - consider load balancing');
    }
    
    const analyzedRatio = Object.keys(this.analysisResults).length / systemFlow.healthMetrics.totalComponents;
    if (analyzedRatio < 0.5) {
        recommendations.push('ü§ñ Run auto-analysis on remaining components for complete insights');
    }
    
    if (recommendations.length === 0) {
        recommendations.push('‚úÖ System architecture shows good structural health');
        recommendations.push('üìà Consider modernization opportunities for legacy components');
        recommendations.push('üîÑ Regular dependency audits recommended');
    }
    
    return recommendations.map(rec => `<div style="margin-bottom: 0.5rem; color: var(--grey-700); font-size: 0.9rem;">${rec}</div>`).join('');
},

// Additional helper methods for data operations and relationship analysis
determineDataOperation(moduleName, fileName) {
    // This would analyze the actual code to determine READ, WRITE, UPDATE operations
    // For now, provide a reasonable default
    return 'ACCESSES';
},

calculateRelationshipStrength(fromComponent, toComponent) {
    // Calculate based on frequency of references, shared data, etc.
    // For now, return a default strength
    return Math.random() * 5 + 1; // 1-6 scale
},

guessExternalProtocol(componentName) {
    const upperName = componentName.toUpperCase();
    if (upperName.includes('REST') || upperName.includes('API')) return 'REST';
    if (upperName.includes('SOAP') || upperName.includes('WS')) return 'SOAP';
    if (upperName.includes('MQ') || upperName.includes('QUEUE')) return 'MQ';
    if (upperName.includes('TCP') || upperName.includes('SOCKET')) return 'TCP';
    return 'HTTP';
},

identifyArchitecturalPatterns(architecturalFlow) {
    // Detect circular dependencies
    this.detectCircularDependencies(architecturalFlow);
    
    // Detect tight vs loose coupling patterns
    this.detectCouplingPatterns(architecturalFlow);
    
    // Detect orphaned components
    this.detectOrphanedComponents(architecturalFlow);
},

detectCircularDependencies(architecturalFlow) {
    // Simplified circular dependency detection
    const visited = new Set();
    const recursionStack = new Set();
    
    const hasCycle = (node, adjacencyList) => {
        if (recursionStack.has(node)) return true;
        if (visited.has(node)) return false;
        
        visited.add(node);
        recursionStack.add(node);
        
        const neighbors = adjacencyList[node] || [];
        for (const neighbor of neighbors) {
            if (hasCycle(neighbor, adjacencyList)) {
                architecturalFlow.patterns.circular.push([node, neighbor]);
                return true;
            }
        }
        
        recursionStack.delete(node);
        return false;
    };
    
    // Build adjacency list from module relationships
    const adjacencyList = {};
    architecturalFlow.moduleToModule.forEach(relation => {
        if (!adjacencyList[relation.from]) adjacencyList[relation.from] = [];
        adjacencyList[relation.from].push(relation.to);
    });
    
    // Check for cycles
    Object.keys(adjacencyList).forEach(node => {
        if (!visited.has(node)) {
            hasCycle(node, adjacencyList);
        }
    });
},

detectCouplingPatterns(architecturalFlow) {
    // Analyze coupling strength between components
    architecturalFlow.moduleToModule.forEach(relation => {
        if (relation.strength > 4) {
            architecturalFlow.patterns.tightCoupling.push(relation);
        } else if (relation.strength < 2) {
            architecturalFlow.patterns.looseCoupling.push(relation);
        }
    });
},

detectOrphanedComponents(architecturalFlow) {
    // Find components with no connections
    this.discoveredComponents.forEach((component, name) => {
        const connections = this.getComponentConnections(name);
        if (connections.total === 0) {
            architecturalFlow.patterns.orphaned.push(name);
        }
    });
},
// **NEW METHOD: Generate Main Architectural Flow**
generateMainArchitecturalFlow(architecturalFlow) {
    return `
        <div style="min-height: 500px; position: relative;">
            <!-- Presentation Layer -->
            ${this.generateArchitecturalLayer('presentation', architecturalFlow.layers.presentation, '#3b82f6', 'üñ•Ô∏è Presentation Layer')}
            
            <!-- Business Layer -->
            ${this.generateArchitecturalLayer('business', architecturalFlow.layers.business, '#10b981', 'üíº Business Logic Layer')}
            
            <!-- Data Layer -->
            ${this.generateArchitecturalLayer('data', architecturalFlow.layers.data, '#f59e0b', 'üíæ Data Access Layer')}
            
            <!-- Integration Layer -->
            ${this.generateArchitecturalLayer('integration', architecturalFlow.layers.integration, '#8b5cf6', 'üîó Integration Layer')}
            
            <!-- Connection Highways -->
            ${this.generateConnectionHighways(architecturalFlow)}
        </div>
    `;
},

// **NEW METHOD: Generate Architectural Layer**
generateArchitecturalLayer(layerName, layerComponents, color, title) {
    if (layerComponents.length === 0) return '';
    
    const layerPositions = {
        'presentation': 'top: 20px;',
        'business': 'top: 150px;',
        'data': 'top: 280px;',
        'integration': 'top: 410px;'
    };
    
    return `
        <div style="position: absolute; left: 0; right: 0; ${layerPositions[layerName]} height: 100px; background: rgba(${this.hexToRgb(color)}, 0.1); border-left: 4px solid ${color}; border-radius: 8px; padding: 1rem;">
            <h5 style="margin: 0 0 0.75rem 0; color: ${color}; font-size: 0.9rem;">${title}</h5>
            <div style="display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 0.5rem;">
                ${layerComponents.map(comp => this.generateLayerComponent(comp, color)).join('')}
            </div>
        </div>
    `;
},

// **NEW METHOD: Generate Layer Component**
generateLayerComponent(componentData, layerColor) {
    const { name, component, type, connections } = componentData;
    const isSelected = name === this.currentSelectedComponent;
    const displayName = component?.friendlyName || name;
    
    return `
        <div style="
            min-width: 180px;
            max-width: 200px;
            background: white;
            border: 2px solid ${isSelected ? layerColor : '#e5e7eb'};
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            ${isSelected ? `box-shadow: 0 0 0 3px rgba(${this.hexToRgb(layerColor)}, 0.3);` : ''}
        " onclick="analyzer.selectComponent('${name}')"
        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            
            <!-- Component Type Icon -->
            <div style="position: absolute; top: -8px; right: -8px; background: ${layerColor}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 2px solid white;">
                ${this.getComponentIcon(type)}
            </div>
            
            <!-- Component Info -->
            <div style="margin-bottom: 0.5rem;">
                <div style="font-weight: bold; font-size: 0.85rem; color: var(--grey-800); margin-bottom: 0.25rem;">
                    ${name}
                </div>
                <div style="font-size: 0.75rem; color: ${layerColor}; font-weight: 500;">
                    ${displayName}
                </div>
            </div>
            
            <!-- Connection Count -->
            <div style="display: flex; justify-content: between; align-items: center; font-size: 0.7rem; color: var(--grey-600);">
                <span>üîó ${connections?.total || 0} connections</span>
                ${component?.analyzed ? '<span class="badge badge-success" style="font-size: 0.6rem;">‚úì</span>' : ''}
            </div>
            
            <!-- Connection indicators -->
            ${connections?.upstream > 0 ? `<div style="position: absolute; top: 50%; left: -8px; width: 6px; height: 6px; background: var(--info-blue); border-radius: 50%; border: 2px solid white;"></div>` : ''}
            ${connections?.downstream > 0 ? `<div style="position: absolute; top: 50%; right: -8px; width: 6px; height: 6px; background: var(--success-green); border-radius: 50%; border: 2px solid white;"></div>` : ''}
        </div>
    `;
},

// **NEW METHOD: Generate Connection Highways**
generateConnectionHighways(architecturalFlow) {
    const highways = this.identifyMajorHighways(architecturalFlow);
    
    return `
        <!-- Major Data Highways -->
        <div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: var(--primary-blue); opacity: 0.3; z-index: 0;"></div>
        <div style="position: absolute; left: 75%; top: 0; bottom: 0; width: 2px; background: var(--success-green); opacity: 0.3; z-index: 0;"></div>
        <div style="position: absolute; left: 25%; top: 0; bottom: 0; width: 2px; background: var(--warning-yellow); opacity: 0.3; z-index: 0;"></div>
        
        <!-- Highway Labels -->
        <div style="position: absolute; bottom: -30px; left: 45%; font-size: 0.7rem; color: var(--grey-500);">Main Data Flow</div>
        <div style="position: absolute; bottom: -30px; left: 70%; font-size: 0.7rem; color: var(--grey-500);">Integration Bus</div>
        <div style="position: absolute; bottom: -30px; left: 20%; font-size: 0.7rem; color: var(--grey-500);">Control Flow</div>
        
        ${highways.map((highway, index) => this.generateHighwayConnection(highway, index)).join('')}
    `;
},

// **NEW HELPER METHODS for Architecture Analysis**

// Classify Component Architecturally
classifyComponentArchitecturally(component) {
    const name = component.name.toUpperCase();
    const type = component.type?.toUpperCase() || '';
    
    // Data-related components
    if (name.includes('FILE') || name.includes('TABLE') || name.includes('DB') || 
        name.includes('MASTER') || name.includes('DATA') || type.includes('FILE')) {
        return 'data';
    }
    
    // External system interfaces
    if (name.includes('API') || name.includes('WS') || name.includes('SERVICE') || 
        name.includes('EXTERNAL') || name.includes('INTERFACE')) {
        return 'external';
    }
    
    // Presentation layer
    if (name.includes('SCREEN') || name.includes('DISPLAY') || name.includes('UI') || 
        name.includes('CICS') || name.includes('ONLINE')) {
        return 'presentation';
    }
    
    // Integration layer
    if (name.includes('MQ') || name.includes('QUEUE') || name.includes('MSG') || 
        name.includes('BROKER') || name.includes('ADAPTER')) {
        return 'integration';
    }
    
    // Default to business logic
    return 'business';
},

// Determine Architectural Layer
determineArchitecturalLayer(component) {
    const componentType = this.classifyComponentArchitecturally(component);
    const name = component.name.toUpperCase();
    
    // Presentation layer
    if (componentType === 'presentation' || name.includes('SCREEN') || name.includes('CICS')) {
        return 'presentation';
    }
    
    // Data layer
    if (componentType === 'data' || name.includes('FILE') || name.includes('DB')) {
        return 'data';
    }
    
    // Integration layer
    if (componentType === 'integration' || componentType === 'external') {
        return 'integration';
    }
    
    // Default to business layer
    return 'business';
},

// Get Component Connections
getComponentConnections(componentName) {
    const result = this.analysisResults[componentName];
    
    if (!result || !result.dependencyAnalysis) {
        return { total: 0, upstream: 0, downstream: 0 };
    }
    
    const upstream = result.dependencyAnalysis.summary.foundCount;
    
    // Calculate downstream connections
    const downstream = Object.values(this.analysisResults).filter(otherResult => {
        if (!otherResult.dependencyAnalysis || !otherResult.dependencyAnalysis.found) return false;
        return [...otherResult.dependencyAnalysis.found.copybooks,
                ...otherResult.dependencyAnalysis.found.programs,
                ...otherResult.dependencyAnalysis.found.files].includes(componentName);
    }).length;
    
    return {
        total: upstream + downstream,
        upstream: upstream,
        downstream: downstream
    };
},

// Map Module Relationships
mapModuleRelationships(architecturalFlow) {
    this.discoveredComponents.forEach((component, name) => {
        const result = this.analysisResults[name];
        if (!result || !result.dependencyAnalysis) return;
        
        // Map module-to-module relationships
        [...result.dependencyAnalysis.found.programs, ...result.dependencyAnalysis.found.copybooks]
            .forEach(targetName => {
                if (this.discoveredComponents.has(targetName)) {
                    architecturalFlow.moduleToModule.push({
                        from: name,
                        to: targetName,
                        type: 'dependency',
                        strength: this.calculateRelationshipStrength(name, targetName)
                    });
                }
            });
    });
},

// Map Data Flows
mapDataFlows(architecturalFlow) {
    this.discoveredComponents.forEach((component, name) => {
        const result = this.analysisResults[name];
        if (!result || !result.dependencyAnalysis) return;
        
        // Map module-to-data relationships
        result.dependencyAnalysis.found.files.forEach(fileName => {
            architecturalFlow.moduleToData.push({
                from: name,
                to: fileName,
                operation: this.determineDataOperation(name, fileName),
                description: `${name} accesses ${fileName}`
            });
        });
    });
},

// Map External Connections
mapExternalConnections(architecturalFlow) {
    // This would be enhanced with actual external system detection
    this.discoveredComponents.forEach((component, name) => {
        if (this.classifyComponentArchitecturally(component) === 'external') {
            architecturalFlow.externalConnections.push({
                name: name,
                type: 'external_system',
                protocol: this.guessExternalProtocol(name),
                direction: 'bidirectional'
            });
        }
    });
},

// Calculate Impact Zones
calculateImpactZones(focusComponent, architecturalFlow) {
    // Immediate impact: direct dependencies
    const result = this.analysisResults[focusComponent];
    if (result && result.dependencyAnalysis) {
        [...result.dependencyAnalysis.found.copybooks,
         ...result.dependencyAnalysis.found.programs,
         ...result.dependencyAnalysis.found.files].forEach(name => {
            architecturalFlow.impactZones.immediate.add(name);
        });
    }
    
    // Secondary impact: components that depend on immediate impact components
    Array.from(architecturalFlow.impactZones.immediate).forEach(immediateName => {
        Object.entries(this.analysisResults).forEach(([compName, compResult]) => {
            if (compResult.dependencyAnalysis && compResult.dependencyAnalysis.found) {
                const depends = [...compResult.dependencyAnalysis.found.copybooks,
                               ...compResult.dependencyAnalysis.found.programs,
                               ...compResult.dependencyAnalysis.found.files];
                if (depends.includes(immediateName)) {
                    architecturalFlow.impactZones.secondary.add(compName);
                }
            }
        });
    });
    
    // Tertiary impact: components that depend on secondary impact components
    Array.from(architecturalFlow.impactZones.secondary).forEach(secondaryName => {
        Object.entries(this.analysisResults).forEach(([compName, compResult]) => {
            if (compResult.dependencyAnalysis && compResult.dependencyAnalysis.found) {
                const depends = [...compResult.dependencyAnalysis.found.copybooks,
                               ...compResult.dependencyAnalysis.found.programs,
                               ...compResult.dependencyAnalysis.found.files];
                if (depends.includes(secondaryName)) {
                    architecturalFlow.impactZones.tertiary.add(compName);
                }
            }
        });
    });
},

// Classify System Layers
classifySystemLayers(architecturalFlow) {
    // This is already handled in the layer building process
},

// Helper method to convert hex to RGB
hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? 
        `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
        '59, 130, 246'; // Default blue
},

// Get Impact Severity
getImpactSeverity(architecturalFlow) {
    const totalImpact = architecturalFlow.impactZones.immediate.size + 
                       architecturalFlow.impactZones.secondary.size + 
                       architecturalFlow.impactZones.tertiary.size;
    
    if (totalImpact > 20) return 'CRITICAL';
    if (totalImpact > 10) return 'HIGH';
    if (totalImpact > 5) return 'MEDIUM';
    return 'LOW';
},

// Get Impact Recommendation
getImpactRecommendation(architecturalFlow) {
    const severity = this.getImpactSeverity(architecturalFlow);
    
    switch (severity) {
        case 'CRITICAL':
            return 'Extensive testing and staged rollout recommended. Consider breaking changes into smaller pieces.';
        case 'HIGH':
            return 'Comprehensive integration testing required. Coordinate with multiple teams.';
        case 'MEDIUM':
            return 'Standard testing protocols should suffice. Monitor dependent components.';
        default:
            return 'Low risk change. Standard testing and deployment processes apply.';
    }
},

// Identify Major Highways
identifyMajorHighways(architecturalFlow) {
    // Identify the most trafficked dependency paths
    const highways = [];
    
    // Find components with highest connection counts
    const connectionCounts = new Map();
    architecturalFlow.moduleToModule.forEach(connection => {
        connectionCounts.set(connection.from, (connectionCounts.get(connection.from) || 0) + 1);
        connectionCounts.set(connection.to, (connectionCounts.get(connection.to) || 0) + 1);
    });
    
    // Sort by connection count and take top highways
    const sortedComponents = Array.from(connectionCounts.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    sortedComponents.forEach(([componentName, count], index) => {
        highways.push({
            name: `Highway ${index + 1}`,
            hub: componentName,
            traffic: count,
            type: count > 10 ? 'major' : count > 5 ? 'arterial' : 'local'
        });
    });
    
    return highways;
},

// Generate Highway Connection
generateHighwayConnection(highway, index) {
    const positions = ['15%', '35%', '55%', '75%', '85%'];
    const position = positions[index] || '50%';
    
    return `
        <div style="position: absolute; left: ${position}; top: 50%; transform: translateX(-50%); background: var(--primary-blue); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; z-index: 10;">
            ${highway.hub}
            <div style="font-size: 0.6rem; opacity: 0.8;">${highway.traffic} connections</div>
        </div>
    `;
},
  

// **NEW METHOD: Generate External Connections Section**
generateExternalConnectionsSection(architecturalFlow) {
    return `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--grey-200);">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üîå External System Connections</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                <!-- Database Connections -->
                <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid var(--success-green);">
                    <h5 style="margin: 0 0 0.75rem 0; color: var(--success-green);">üóÑÔ∏è Database Systems</h5>
                    <div style="font-size: 0.8rem; color: var(--grey-700);">
                        ${this.identifyDatabaseConnections(architecturalFlow).map(db => 
                            `‚Ä¢ ${db.name} (${db.type})`
                        ).join('<br>') || 'No database connections identified'}
                    </div>
                </div>
                
                <!-- Message Queues -->
                <div style="padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 4px solid var(--purple);">
                    <h5 style="margin: 0 0 0.75rem 0; color: var(--purple);">üì® Message Queues</h5>
                    <div style="font-size: 0.8rem; color: var(--grey-700);">
                        ${this.identifyMessageQueues(architecturalFlow).map(mq => 
                            `‚Ä¢ ${mq.name} (${mq.direction})`
                        ).join('<br>') || 'No message queues identified'}
                    </div>
                </div>
                
                <!-- External APIs -->
                <div style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid var(--info-blue);">
                    <h5 style="margin: 0 0 0.75rem 0; color: var(--info-blue);">üåê External APIs</h5>
                    <div style="font-size: 0.8rem; color: var(--grey-700);">
                        ${this.identifyExternalAPIs(architecturalFlow).map(api => 
                            `‚Ä¢ ${api.name} (${api.protocol})`
                        ).join('<br>') || 'No external APIs identified'}
                    </div>
                </div>
                
                <!-- Batch Interfaces -->
                <div style="padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--warning-yellow);">
                    <h5 style="margin: 0 0 0.75rem 0; color: var(--warning-yellow);">‚öôÔ∏è Batch Interfaces</h5>
                    <div style="font-size: 0.8rem; color: var(--grey-700);">
                        ${this.identifyBatchInterfaces(architecturalFlow).map(batch => 
                            `‚Ä¢ ${batch.name} (${batch.schedule})`
                        ).join('<br>') || 'No batch interfaces identified'}
                    </div>
                </div>
            </div>
        </div>
    `;
},

// **NEW METHOD: Generate Architecture Health Metrics**
generateArchitectureHealthMetrics(architecturalFlow) {
    const metrics = this.calculateArchitectureMetrics(architecturalFlow);
    
    return `
        <div style="background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--grey-200);">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üìä Architecture Health Metrics</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <!-- Coupling Metric -->
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${this.getCouplingColor(metrics.coupling)};">
                        ${metrics.coupling.toFixed(1)}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 0.5rem;">Coupling Score</div>
                    <div style="font-size: 0.7rem; color: var(--grey-500);">
                        ${metrics.coupling < 3 ? 'Low - Good' : metrics.coupling < 6 ? 'Medium - Acceptable' : 'High - Needs Attention'}
                    </div>
                </div>
                
                <!-- Cohesion Metric -->
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${this.getCohesionColor(metrics.cohesion)};">
                        ${metrics.cohesion.toFixed(1)}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 0.5rem;">Cohesion Score</div>
                    <div style="font-size: 0.7rem; color: var(--grey-500);">
                        ${metrics.cohesion > 7 ? 'High - Excellent' : metrics.cohesion > 4 ? 'Medium - Good' : 'Low - Needs Improvement'}
                    </div>
                </div>
                
                <!-- Complexity Metric -->
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${this.getComplexityColor(metrics.complexity)};">
                        ${metrics.complexity.toFixed(1)}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 0.5rem;">Complexity Index</div>
                    <div style="font-size: 0.7rem; color: var(--grey-500);">
                        ${metrics.complexity < 5 ? 'Simple - Maintainable' : metrics.complexity < 8 ? 'Moderate - Manageable' : 'Complex - Consider Refactoring'}
                    </div>
                </div>
                
                <!-- Stability Metric -->
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${this.getStabilityColor(metrics.stability)};">
                        ${metrics.stability.toFixed(1)}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 0.5rem;">Stability Score</div>
                    <div style="font-size: 0.7rem; color: var(--grey-500);">
                        ${metrics.stability > 7 ? 'Very Stable' : metrics.stability > 4 ? 'Moderately Stable' : 'Unstable - High Change Risk'}
                    </div>
                </div>
            </div>
            
            <!-- Architecture Patterns Detected -->
            <div style="background: var(--grey-50); border-radius: 8px; padding: 1rem;">
                <h5 style="margin: 0 0 0.75rem 0; color: var(--grey-800);">üèóÔ∏è Architecture Patterns Detected</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${this.detectArchitecturePatterns(architecturalFlow).map(pattern => 
                        `<span class="badge ${this.getPatternBadgeClass(pattern.type)}">${pattern.name}</span>`
                    ).join('')}
                </div>
                
                <!-- Critical Issues -->
                ${metrics.criticalIssues.length > 0 ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 4px solid var(--error-red);">
                        <strong style="color: var(--error-red);">‚ö†Ô∏è Critical Architecture Issues:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; color: var(--grey-700);">
                            ${metrics.criticalIssues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                ` : `
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 4px solid var(--success-green);">
                        <strong style="color: var(--success-green);">‚úÖ Architecture Health Good:</strong>
                        <span style="color: var(--grey-700); margin-left: 0.5rem;">
                            No critical architecture issues detected. System shows good structural health.
                        </span>
                    </div>
                `}
            </div>
        </div>
    `;
},
// **NEW METHOD: Generate Visual Flow Chart - High-Level Structural View**
generateVisualFlowChart(dependencyAnalysis) {
        const currentComponent = this.currentSelectedComponent;
        const component = this.discoveredComponents.get(currentComponent);
        
        if (!currentComponent || !component) {
            return '<p style="text-align: center; color: var(--grey-500); padding: 2rem;">Select a component to view its dependency flow</p>';
        }

        // Build enhanced flow structure
        const flowData = this.buildFlowData(currentComponent, dependencyAnalysis);
        
        return `
            <div style="display: flex; flex-direction: column; gap: 2rem; min-width: 800px; align-items: center;">
                
                <!-- **ENHANCED: Interface Layer Display** -->
                ${flowData.interfaces.apis.length > 0 || flowData.interfaces.databases.length > 0 || 
                  flowData.interfaces.queues.length > 0 || flowData.interfaces.files.length > 0 ? `
                    <div style="text-align: center; width: 100%;">
                        <h5 style="color: var(--purple); margin-bottom: 1rem;">üîå SYSTEM INTERFACES</h5>
                        <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 1rem;">External systems and interfaces connected to ${component.friendlyName}</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            ${this.generateInterfaceNodes(flowData.interfaces)}
                        </div>
                        <!-- Interface connection lines -->
                        <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                            <div style="width: 2px; height: 30px; background: var(--purple);"></div>
                        </div>
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.5rem; color: var(--purple);">‚¨áÔ∏è</div>
                            <div style="font-size: 0.8rem; color: var(--grey-600);">interface connections</div>
                        </div>
                    </div>
                ` : ''}

                <!-- UPSTREAM DEPENDENCIES -->
                ${flowData.upstream.length > 0 ? `
                    <div style="text-align: center;">
                        <h5 style="color: var(--info-blue); margin-bottom: 1rem;">‚¨ÜÔ∏è UPSTREAM DEPENDENCIES</h5>
                        <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 1rem;">Components that ${component.friendlyName} depends on</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
                            ${flowData.upstream.map(dep => this.createEnhancedFlowNode(dep, 'upstream')).join('')}
                        </div>
                        <!-- Connection lines -->
                        <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                            ${flowData.upstream.map(() => '<div style="width: 2px; height: 30px; background: var(--info-blue); margin: 0 2rem;"></div>').join('')}
                        </div>
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.5rem; color: var(--info-blue);">‚¨áÔ∏è</div>
                            <div style="font-size: 0.8rem; color: var(--grey-600);">feeds into</div>
                        </div>
                    </div>
                ` : ''}

                <!-- CURRENT COMPONENT (Center) -->
                <div style="text-align: center; margin: 2rem 0;">
                    <div style="position: relative;">
                        ${this.createCenterComponentNode(currentComponent, component)}
                    </div>
                </div>

                <!-- DOWNSTREAM DEPENDENCIES -->
                ${flowData.downstream.length > 0 ? `
                    <div style="text-align: center;">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.5rem; color: var(--success-green);">‚¨áÔ∏è</div>
                            <div style="font-size: 0.8rem; color: var(--grey-600);">flows to</div>
                        </div>
                        <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                            ${flowData.downstream.map(() => '<div style="width: 2px; height: 30px; background: var(--success-green); margin: 0 2rem;"></div>').join('')}
                        </div>
                        <h5 style="color: var(--success-green); margin-bottom: 1rem;">‚¨áÔ∏è DOWNSTREAM DEPENDENCIES</h5>
                        <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 1rem;">Components that depend on ${component.friendlyName}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                            ${flowData.downstream.map(dep => this.createEnhancedFlowNode(dep, 'downstream')).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- **ENHANCED: Missing Dependencies with Better Classification** -->
                ${flowData.missing.length > 0 ? `
                    <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 2px dashed var(--error-red);">
                        <h5 style="color: var(--error-red); margin-bottom: 1rem;">‚ö†Ô∏è MISSING DEPENDENCIES</h5>
                        <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 1rem;">Components referenced but not available</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                            ${flowData.missing.map(dep => this.createEnhancedFlowNode(dep, 'missing')).join('')}
                        </div>
                        <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 6px;">
                            <strong style="color: var(--error-red);">‚ö†Ô∏è Resolution Actions:</strong>
                            <div style="color: var(--grey-700); font-size: 0.9rem; margin-top: 0.5rem;">
                                ‚Ä¢ Upload missing files to complete dependencies<br>
                                ‚Ä¢ Remove unused COPY/CALL statements<br>
                                ‚Ä¢ Update file assignment statements<br>
                                ‚Ä¢ Verify external interface configurations
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- **NEW: Interface Legend** -->
                <div style="margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--grey-200);">
                    <h6 style="margin: 0 0 0.75rem 0; color: var(--grey-800);">üìã Enhanced Flow Legend</h6>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: var(--purple); border-radius: 50%;"></div>
                            <span>System Interfaces (APIs, DB, MQ)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: var(--info-blue); border-radius: 50%;"></div>
                            <span>Upstream: Dependencies required</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: var(--primary-blue); border-radius: 50%;"></div>
                            <span>Current: Selected component</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: var(--success-green); border-radius: 50%;"></div>
                            <span>Downstream: Dependent components</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: var(--error-red); border-radius: 50%; border: 2px dashed white;"></div>
                            <span>Missing: Unavailable dependencies</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: var(--warning-yellow); border-radius: 50%;"></div>
                            <span>Auto-detected: System interfaces</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },
    createEnhancedFlowNode(dependency, flowType) {
        const { name, component, result, type, status, interfaceType, isInterface, wasMissingButFound, isSystemDetected } = dependency;
        const displayName = component?.friendlyName || this.generateFriendlyNameFromPattern(name);
        const businessPurpose = component?.businessPurpose || this.generateBusinessPurpose(name);
        
        // Enhanced styling for interfaces
        let borderColor, bgColor, iconColor, statusIcon, connectionColor, typeIcon;
        
        if (isInterface) {
            // Special styling for interfaces
            switch (interfaceType) {
                case 'api':
                case 'external':
                    borderColor = 'var(--info-blue)';
                    bgColor = 'rgba(59, 130, 246, 0.1)';
                    iconColor = 'var(--info-blue)';
                    typeIcon = 'üåê';
                    break;
                case 'database':
                    borderColor = 'var(--success-green)';
                    bgColor = 'rgba(16, 185, 129, 0.1)';
                    iconColor = 'var(--success-green)';
                    typeIcon = 'üóÑÔ∏è';
                    break;
                case 'queue':
                    borderColor = 'var(--purple)';
                    bgColor = 'rgba(139, 92, 246, 0.1)';
                    iconColor = 'var(--purple)';
                    typeIcon = 'üì®';
                    break;
                case 'file':
                    borderColor = 'var(--warning-yellow)';
                    bgColor = 'rgba(245, 158, 11, 0.1)';
                    iconColor = 'var(--warning-yellow)';
                    typeIcon = 'üìÑ';
                    break;
                default:
                    borderColor = 'var(--grey-400)';
                    bgColor = 'var(--grey-50)';
                    iconColor = 'var(--grey-600)';
                    typeIcon = 'üîå';
            }
        } else {
            // Regular component styling
            switch (flowType) {
                case 'upstream':
                    borderColor = status === 'found' ? 'var(--info-blue)' : 'var(--error-red)';
                    bgColor = status === 'found' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                    iconColor = 'var(--info-blue)';
                    typeIcon = type === 'Copybook' ? 'üìö' : type === 'Program' ? 'üíº' : 'üìÑ';
                    break;
                case 'downstream':
                    borderColor = 'var(--success-green)';
                    bgColor = 'rgba(16, 185, 129, 0.1)';
                    iconColor = 'var(--success-green)';
                    typeIcon = type === 'Copybook' ? 'üìö' : type === 'Program' ? 'üíº' : 'üìÑ';
                    break;
                case 'missing':
                    borderColor = 'var(--error-red)';
                    bgColor = 'rgba(239, 68, 68, 0.1)';
                    iconColor = 'var(--error-red)';
                    typeIcon = type === 'Copybook' ? 'üìö' : type === 'Program' ? 'üíº' : 'üìÑ';
                    break;
            }
        }
        
        // Status icon logic
        if (wasMissingButFound) {
            statusIcon = 'üîÑ'; // Fixed dependency
        } else if (isSystemDetected) {
            statusIcon = 'üîç'; // Auto-detected
        } else if (status === 'found') {
            statusIcon = '‚úÖ';
        } else if (status === 'detected') {
            statusIcon = 'üîç';
        } else {
            statusIcon = '‚ùå';
        }
        
        const isClickable = (status === 'found' || status === 'detected') && !isSystemDetected;
        
        return `
            <div style="
                background: ${bgColor};
                border: 2px solid ${borderColor};
                border-radius: 12px;
                padding: 1rem;
                min-width: 200px;
                max-width: 250px;
                cursor: ${isClickable ? 'pointer' : 'default'};
                transition: all 0.3s ease;
                position: relative;
                ${status === 'missing' ? 'border-style: dashed;' : ''}
                ${isInterface ? 'box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);' : ''}
            " ${isClickable ? `onclick="analyzer.selectComponent('${name}')"` : ''}
               onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';"
               onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='${isInterface ? '0 0 0 2px rgba(139, 92, 246, 0.3)' : 'none'}';">
               
                <!-- Status indicator -->
                <div style="
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: ${borderColor};
                    color: white;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 0.7rem;
                    border: 2px solid white;
                ">${statusIcon}</div>
                
                ${isInterface ? `
                    <!-- Interface indicator -->
                    <div style="
                        position: absolute;
                        top: -8px;
                        left: -8px;
                        background: var(--purple);
                        color: white;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 0.6rem;
                        border: 2px solid white;
                    ">üîå</div>
                ` : ''}
                
                <!-- Component info -->
                <div style="text-align: center;">
                    <div style="font-size: 1.25rem; margin-bottom: 0.5rem; color: ${iconColor};">${typeIcon}</div>
                    
                    <div style="font-weight: bold; font-size: 0.9rem; color: var(--grey-800); margin-bottom: 0.25rem;">
                        ${name}
                    </div>
                    
                    <div style="font-size: 0.8rem; color: var(--primary-blue); margin-bottom: 0.75rem; font-weight: 500; line-height: 1.2;">
                        ${displayName}
                    </div>
                    
                    <div style="font-size: 0.75rem; color: var(--grey-600); line-height: 1.3; margin-bottom: 0.75rem; min-height: 40px;">
                        ${businessPurpose.substring(0, 80)}${businessPurpose.length > 80 ? '...' : ''}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem;">
                        <span class="badge ${isInterface ? 'badge-purple' : 'badge-grey'}">${isInterface ? interfaceType.toUpperCase() : type}</span>
                        ${result ? `<span class="badge badge-info">Q: ${result.qualityScore}/10</span>` : ''}
                        ${status === 'missing' ? '<span class="badge badge-danger">MISSING</span>' : ''}
                        ${wasMissingButFound ? '<span class="badge badge-warning">FIXED</span>' : ''}
                        ${isSystemDetected ? '<span class="badge badge-info">AUTO</span>' : ''}
                    </div>
                    
                    ${isClickable ? `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--grey-200);">
                            <div style="color: ${borderColor}; font-size: 0.7rem;">
                                üîç Click to ${isInterface ? 'view interface' : 'analyze'}
                            </div>
                        </div>
                    ` : status === 'missing' ? `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--grey-200);">
                            <div style="color: var(--error-red); font-size: 0.7rem;">
                                üìÅ ${isInterface ? 'Configure interface' : 'Upload required'}
                            </div>
                        </div>
                    ` : isSystemDetected ? `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--grey-200);">
                            <div style="color: var(--warning-yellow); font-size: 0.7rem;">
                                üîç System detected interface
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    },
    // **NEW: Generate Interface Nodes**
    generateInterfaceNodes(interfaces) {
        let html = '';
        
        // API Interfaces
        interfaces.apis.forEach(api => {
            html += this.createInterfaceNode(api, 'api', 'üåê', 'var(--info-blue)');
        });
        
        // Database Interfaces
        interfaces.databases.forEach(db => {
            html += this.createInterfaceNode(db, 'database', 'üóÑÔ∏è', 'var(--success-green)');
        });
        
        // Queue Interfaces
        interfaces.queues.forEach(queue => {
            html += this.createInterfaceNode(queue, 'queue', 'üì®', 'var(--purple)');
        });
        
        // File Interfaces
        interfaces.files.forEach(file => {
            html += this.createInterfaceNode(file, 'file', 'üìÑ', 'var(--warning-yellow)');
        });
        
        return html;
    },

    // **NEW: Create Interface Node**
    createInterfaceNode(interfaceData, type, icon, color) {
        const { name, status, description, isSystemDetected } = interfaceData;
        
        return `
            <div style="
                background: rgba(139, 92, 246, 0.1);
                border: 2px solid ${color};
                border-radius: 12px;
                padding: 1rem;
                min-width: 180px;
                max-width: 220px;
                text-align: center;
                position: relative;
            ">
                <!-- Interface Type Badge -->
                <div style="
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: ${color};
                    color: white;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 0.7rem;
                    border: 2px solid white;
                ">${status === 'detected' ? 'üîç' : '‚úì'}</div>
                
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem; color: ${color};">${icon}</div>
                <div style="font-weight: bold; font-size: 0.9rem; color: var(--grey-800); margin-bottom: 0.25rem;">
                    ${name}
                </div>
                <div style="font-size: 0.75rem; color: ${color}; margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase;">
                    ${type} Interface
                </div>
                ${description ? `
                    <div style="font-size: 0.7rem; color: var(--grey-600); line-height: 1.3;">
                        ${description}
                    </div>
                ` : ''}
                ${isSystemDetected ? `
                    <div style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--warning-yellow);">
                        üîç Auto-detected
                    </div>
                ` : ''}
            </div>
        `;
    },


// **NEW METHOD: Generate Dependency Diagram**
// ============================================
// VISUAL DEPENDENCY FLOW DIAGRAM
// True Flow Chart with Business Purposes and Connections
// ============================================

// **REPLACE: generateDependencyDiagram method in Part 5**
// Replace the existing generateDependencyDiagram method with this enhanced version

generateDependencyDiagram(dependencyAnalysis) {
    if (!dependencyAnalysis) return '<p>No dependency analysis available</p>';

    return `
        <div style="background: var(--grey-50); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üó∫Ô∏è Business Dependency Flow Diagram</h4>
            <div id="dependencyFlowChart" style="min-height: 600px; background: white; border-radius: 8px; padding: 1rem; overflow-x: auto;">
                ${this.generateVisualFlowChart(dependencyAnalysis)}
            </div>
        </div>

        <div style="background: var(--grey-50); padding: 1.5rem; border-radius: 8px;">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üìä Flow Analysis Summary</h4>
            ${this.generateFlowSummary(dependencyAnalysis)}
        </div>
    `;
},
// **NEW METHOD: Generate Component Card**
    generateComponentCard(component, file) {
        const discoveredComponent = this.discoveredComponents.get(component.name);
        const analysisResult = this.analysisResults[component.name];
        
        const isAnalyzed = discoveredComponent?.analyzed || false;
        const qualityScore = analysisResult?.qualityScore;
        const businessPurpose = discoveredComponent?.businessPurpose || component.businessPurpose;
        
        return `
            <div style="
                background: white;
                border: 1px solid var(--grey-200);
                border-radius: 8px;
                padding: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
            " onclick="analyzer.selectComponentFromLibrary('${component.name}')"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor='var(--primary-blue)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='var(--grey-200)';">
                
                <!-- Analysis Status Badge -->
                <div style="position: absolute; top: -8px; right: -8px;">
                    ${isAnalyzed ? 
                        `<span class="badge badge-success" style="font-size: 0.7rem;">‚úì Analyzed</span>` :
                        `<span class="badge badge-warning" style="font-size: 0.7rem;">‚è≥ Pending</span>`
                    }
                </div>
                
                <!-- Component Header -->
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div style="
                        width: 32px; 
                        height: 32px; 
                        background: var(--primary-blue); 
                        color: white; 
                        border-radius: 6px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 0.9rem;
                    ">
                        ${this.getComponentTypeIcon(component.type)}
                    </div>
                    <div>
                        <div style="font-weight: bold; font-size: 0.9rem; color: var(--grey-800);">
                            ${component.name}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--grey-500);">
                            Line ${component.lineNumber} ‚Ä¢ ${component.type}
                        </div>
                    </div>
                </div>
                
                <!-- Friendly Name -->
                ${discoveredComponent?.friendlyName ? `
                    <div style="font-size: 0.85rem; color: var(--primary-blue); font-weight: 500; margin-bottom: 0.75rem;">
                        ${discoveredComponent.friendlyName}
                    </div>
                ` : ''}
                
                <!-- Business Purpose -->
                <div style="font-size: 0.8rem; color: var(--grey-600); line-height: 1.4; margin-bottom: 0.75rem; min-height: 40px;">
                    ${businessPurpose?.substring(0, 120)}${businessPurpose?.length > 120 ? '...' : ''}
                </div>
                
                <!-- Component Metrics -->
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <span class="badge badge-primary">${component.level ? `L${component.level}` : component.type}</span>
                        ${qualityScore ? `<span class="badge badge-info">Q: ${qualityScore}/10</span>` : ''}
                    </div>
                    <button style="
                        background: var(--primary-blue); 
                        color: white; 
                        border: none; 
                        padding: 0.25rem 0.5rem; 
                        border-radius: 4px; 
                        font-size: 0.7rem; 
                        cursor: pointer;
                    " onclick="event.stopPropagation(); analyzer.analyzeSpecificComponent('${component.name}')">
                        ${isAnalyzed ? 'üîÑ Re-analyze' : 'ü§ñ Analyze'}
                    </button>
                </div>
            </div>
        `;
    },

    // **NEW METHOD: Generate Small Component Card**
    generateSmallComponentCard(component, file) {
        return `
            <div style="
                background: white;
                border: 1px solid var(--grey-200);
                border-radius: 6px;
                padding: 0.75rem;
                cursor: pointer;
                transition: all 0.2s ease;
            " onclick="analyzer.showComponentDetails('${component.name}', '${file.name}')"
            onmouseover="this.style.borderColor='var(--primary-blue)'; this.style.background='var(--grey-50)';"
            onmouseout="this.style.borderColor='var(--grey-200)'; this.style.background='white';">
                
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.8rem;">${this.getComponentTypeIcon(component.type)}</span>
                    <span style="font-weight: 600; font-size: 0.8rem; color: var(--grey-800);">${component.name}</span>
                </div>
                
                <div style="font-size: 0.7rem; color: var(--grey-600); margin-bottom: 0.25rem;">
                    ${component.businessPurpose?.substring(0, 60)}${component.businessPurpose?.length > 60 ? '...' : ''}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem;">
                    <span class="badge badge-grey">${component.level ? `L${component.level}` : component.type}</span>
                    <span style="color: var(--grey-500);">Line ${component.lineNumber}</span>
                </div>
            </div>
        `;
    },

    // **NEW METHOD: Get File Type Icon**
    getFileTypeIcon(fileType) {
        switch(fileType) {
            case 'COBOL Program': return 'üíº';
            case 'Copybook': return 'üìö';
            case 'JCL Job': return '‚öôÔ∏è';
            case 'JCL Procedure': return 'üîß';
            default: return 'üìÑ';
        }
    },

    // **NEW METHOD: Get File Type Color**
    getFileTypeColor(fileType) {
        switch(fileType) {
            case 'COBOL Program': return 'var(--primary-blue)';
            case 'Copybook': return 'var(--success-green)';
            case 'JCL Job': return 'var(--warning-yellow)';
            case 'JCL Procedure': return 'var(--info-blue)';
            default: return 'var(--grey-500)';
        }
    },

    // **NEW METHOD: Get Component Type Icon**
    getComponentTypeIcon(componentType) {
        switch(componentType) {
            case 'PROGRAM': return 'üíº';
            case 'RECORD_LAYOUT': return 'üìã';
            case 'COPYBOOK': return 'üìö';
            case 'FILE': return 'üìÑ';
            case 'FIELD': return 'üè∑Ô∏è';
            default: return 'üì¶';
        }
    },

    // **NEW METHOD: Toggle File Expansion**
    toggleFileExpansion(fileIndex) {
        const componentsDiv = document.getElementById(`file-components-${fileIndex}`);
        const expandIcon = document.getElementById(`expand-icon-${fileIndex}`);
        
        if (!componentsDiv || !expandIcon) return;
        
        const isExpanded = componentsDiv.style.maxHeight && componentsDiv.style.maxHeight !== '0px';
        
        if (isExpanded) {
            // Collapse
            componentsDiv.style.maxHeight = '0px';
            expandIcon.style.transform = 'rotate(0deg)';
            expandIcon.style.color = 'var(--grey-400)';
        } else {
            // Expand
            componentsDiv.style.maxHeight = '2000px';
            expandIcon.style.transform = 'rotate(180deg)';
            expandIcon.style.color = 'var(--primary-blue)';
        }
    },

    // **NEW METHOD: Attach Library Search Listeners**
    attachLibrarySearchListeners() {
        const searchInput = document.getElementById('librarySearchInput');
        const fileTypeFilter = document.getElementById('libraryFileTypeFilter');
        const analysisFilter = document.getElementById('libraryAnalysisFilter');

        if (searchInput) {
            searchInput.addEventListener('input', () => this.filterLibraryContent());
        }

        if (fileTypeFilter) {
            fileTypeFilter.addEventListener('change', () => this.filterLibraryContent());
        }

        if (analysisFilter) {
            analysisFilter.addEventListener('change', () => this.filterLibraryContent());
        }
    },

    // **NEW METHOD: Filter Library Content**
    filterLibraryContent() {
        const searchTerm = document.getElementById('librarySearchInput')?.value?.toLowerCase() || '';
        const fileTypeFilter = document.getElementById('libraryFileTypeFilter')?.value || 'all';
        const analysisFilter = document.getElementById('libraryAnalysisFilter')?.value || 'all';

        // Filter files based on criteria
        const filteredFiles = this.uploadedFiles.filter(file => {
            // Search filter
            const matchesSearch = !searchTerm || 
                file.name.toLowerCase().includes(searchTerm) ||
                (file.components || []).some(comp => 
                    comp.name.toLowerCase().includes(searchTerm) ||
                    (comp.businessPurpose || '').toLowerCase().includes(searchTerm)
                );

            // File type filter
            const matchesFileType = fileTypeFilter === 'all' || file.type === fileTypeFilter;

            // Analysis filter
            let matchesAnalysis = true;
            if (analysisFilter === 'analyzed') {
                matchesAnalysis = (file.components || []).some(comp => 
                    comp.isMainComponent && this.analysisResults[comp.name]
                );
            } else if (analysisFilter === 'pending') {
                matchesAnalysis = (file.components || []).some(comp => 
                    comp.isMainComponent && !this.analysisResults[comp.name]
                );
            }

            return matchesSearch && matchesFileType && matchesAnalysis;
        });

        // Re-render filtered files
        const filesContainer = document.getElementById('filesComponentsList');
        if (filesContainer) {
            if (filteredFiles.length === 0) {
                filesContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--grey-500);">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                        <h4>No files match your filters</h4>
                        <p>Try adjusting your search criteria or filters</p>
                    </div>
                `;
            } else {
                filesContainer.innerHTML = this.generateFileComponentsListFiltered(filteredFiles);
                setTimeout(() => {
                    this.attachFileExpansionListeners();
                }, 100);
            }
        }
    },

    // **NEW METHOD: Generate Filtered File Components List**
    generateFileComponentsListFiltered(filteredFiles) {
        let html = '';

        filteredFiles.forEach((file, index) => {
            const fileComponents = file.components || [];
            const mainComponents = fileComponents.filter(comp => comp.isMainComponent);
            const otherComponents = fileComponents.filter(comp => !comp.isMainComponent);
            
            const fileTypeIcon = this.getFileTypeIcon(file.type);
            const fileTypeColor = this.getFileTypeColor(file.type);
            
            // Find original index for proper expansion handling
            const originalIndex = this.uploadedFiles.indexOf(file);
            
            html += `
                <!-- File Row -->
                <div class="file-row" data-file-index="${originalIndex}" style="
                    border-bottom: 1px solid var(--grey-200);
                    cursor: pointer;
                    transition: background-color 0.2s ease;
                " onclick="analyzer.toggleFileExpansion(${originalIndex})">
                    <div style="padding: 1rem; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <!-- File Icon -->
                            <div style="
                                width: 48px; 
                                height: 48px; 
                                background: ${fileTypeColor}; 
                                color: white; 
                                border-radius: 8px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-size: 1.25rem;
                            ">
                                ${fileTypeIcon}
                            </div>
                            
                            <!-- File Info -->
                            <div>
                                <div style="font-weight: bold; font-size: 1rem; color: var(--grey-800); margin-bottom: 0.25rem;">
                                    ${file.name}
                                </div>
                                <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--grey-600);">
                                    <span>üìã ${file.type}</span>
                                    <span>üìè ${(file.size / 1024).toFixed(1)} KB</span>
                                    <span>üìä ${file.metrics?.codeLines || 0} lines</span>
                                    <span>üéØ ${fileComponents.length} components</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expand/Collapse Indicator -->
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: var(--primary-blue);">
                                    ${mainComponents.length} Main
                                </div>
                                <div style="font-size: 0.75rem; color: var(--grey-500);">
                                    ${otherComponents.length} Other
                                </div>
                            </div>
                            <div class="expand-icon" id="expand-icon-${originalIndex}" style="
                                width: 24px; 
                                height: 24px; 
                                color: var(--grey-400); 
                                transition: transform 0.3s ease;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                ‚ñº
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expandable Components Section -->
                <div class="file-components" id="file-components-${originalIndex}" style="
                    max-height: 0;
                    overflow: hidden;
                    transition: max-height 0.3s ease;
                    background: var(--grey-50);
                ">
                    <div style="padding: 1.5rem;">
                        ${this.generateFileComponentsContent(file, fileComponents)}
                    </div>
                </div>
            `;
        });

        return html;
    },

    // **NEW METHOD: Select Component from Library**
    selectComponentFromLibrary(componentName) {
        // Select the component and switch to dashboard
        this.selectComponent(componentName);
        
        // Switch to dependencies tab to show analysis
        setTimeout(() => {
            const dependenciesTab = document.querySelector('.tab[data-tab="dependencies"]');
            if (dependenciesTab) {
                dependenciesTab.click();
            }
        }, 100);
        
        this.showInfo(`Selected ${componentName} - switching to Dependencies view`);
    },

    // **NEW METHOD: Show Component Details**
    showComponentDetails(componentName, fileName) {
        const discoveredComponent = this.discoveredComponents.get(componentName);
        const analysisResult = this.analysisResults[componentName];
        
        // Create modal dialog
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); z-index: 10000; 
            display: flex; align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0; color: var(--grey-800);">üì¶ Component Details</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        background: none; 
                        border: none; 
                        font-size: 1.5rem; 
                        cursor: pointer; 
                        color: var(--grey-500);
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                    " onmouseover="this.style.background='var(--grey-100)'" onmouseout="this.style.background='none'">√ó</button>
                </div>
                
                <!-- Component Header -->
                <div style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="font-size: 2rem;">${this.getComponentTypeIcon(discoveredComponent?.type || 'COMPONENT')}</div>
                        <div>
                            <h4 style="margin: 0; color: white;">${componentName}</h4>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Found in: ${fileName}</div>
                        </div>
                    </div>
                    ${discoveredComponent?.friendlyName ? `
                        <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 6px;">
                            <strong>Business Name:</strong> ${discoveredComponent.friendlyName}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Component Information -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <strong>Type:</strong> ${discoveredComponent?.type || 'Unknown'}<br>
                        <strong>File Source:</strong> ${discoveredComponent?.fileSource || fileName}<br>
                        <strong>Status:</strong> ${discoveredComponent?.analyzed ? 
                            '<span class="badge badge-success">Analyzed</span>' : 
                            '<span class="badge badge-warning">Pending Analysis</span>'}
                    </div>
                    <div>
                        <strong>Line Count:</strong> ${discoveredComponent?.lineCount || 'N/A'}<br>
                        <strong>Complexity:</strong> ${discoveredComponent?.complexityScore || 'N/A'}/10<br>
                        <strong>Quality Score:</strong> ${analysisResult?.qualityScore || 'N/A'}/10
                    </div>
                </div>
                
                <!-- Business Purpose -->
                <div style="margin-bottom: 1.5rem;">
                    <h5 style="margin: 0 0 0.75rem 0; color: var(--grey-800);">üìã Business Purpose</h5>
                    <div style="background: var(--grey-50); padding: 1rem; border-radius: 8px; line-height: 1.5;">
                        ${discoveredComponent?.businessPurpose || 'Business purpose analysis pending'}
                    </div>
                </div>
                
                <!-- Analysis Results -->
                ${analysisResult ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: var(--grey-800);">üß† Analysis Results</h5>
                        <div style="background: var(--grey-50); padding: 1rem; border-radius: 8px;">
                            <div style="margin-bottom: 0.75rem;">
                                <strong>Dependencies Found:</strong> ${analysisResult.dependencyAnalysis?.summary?.foundCount || 0}<br>
                                <strong>Dependencies Missing:</strong> ${analysisResult.dependencyAnalysis?.summary?.missingCount || 0}<br>
                                <strong>Risk Assessment:</strong> ${analysisResult.llmAnalysis?.riskAssessment?.toUpperCase() || 'Not assessed'}
                            </div>
                            ${analysisResult.llmAnalysis?.recommendations ? `
                                <div>
                                    <strong>Recommendations:</strong>
                                    <ul style="margin: 0.25rem 0 0 1rem; font-size: 0.9rem;">
                                        ${analysisResult.llmAnalysis.recommendations.slice(0, 3).map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Actions -->
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    ${!discoveredComponent?.analyzed ? `
                        <button class="btn btn-primary" onclick="analyzer.analyzeSpecificComponent('${componentName}'); this.parentElement.parentElement.parentElement.remove();">
                            ü§ñ Analyze Component
                        </button>
                    ` : `
                        <button class="btn btn-success" onclick="analyzer.selectComponent('${componentName}'); this.parentElement.parentElement.parentElement.remove();">
                            üéØ View Full Analysis
                        </button>
                    `}
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove();">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    },
// Generate Dependency Flow Chart
generateDependencyFlowChart(dependencyAnalysis) {
    if (!dependencyAnalysis) return '<p>No dependency analysis available</p>';

    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">${dependencyAnalysis.summary.foundCount}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Dependencies Found</div>
            </div>
            <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--error-red);">${dependencyAnalysis.summary.missingCount}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Dependencies Missing</div>
            </div>
        </div>

        <!-- **NEW: Enhanced Architectural Flow** -->
        <div style="background: var(--grey-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üó∫Ô∏è High-Level Dependency Flow - City Map View</h4>
            ${this.generateVisualFlowChart(dependencyAnalysis)}
        </div>

        <div style="background: var(--grey-50); padding: 1.5rem; border-radius: 8px;">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üìä Dependency Health Status</h4>
            <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span>Dependency Completion</span>
                    <span style="font-weight: bold;">${Math.round((dependencyAnalysis.summary.foundCount / (dependencyAnalysis.summary.foundCount + dependencyAnalysis.summary.missingCount)) * 100) || 0}%</span>
                </div>
                <div style="background: var(--grey-200); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--success-green); height: 100%; width: ${Math.round((dependencyAnalysis.summary.foundCount / (dependencyAnalysis.summary.foundCount + dependencyAnalysis.summary.missingCount)) * 100) || 0}%; border-radius: 4px;"></div>
                </div>
            </div>
            <p style="color: var(--grey-600); font-size: 0.9rem; margin: 0;">
                ${dependencyAnalysis.summary.missingCount > 5 ? '‚ö†Ô∏è High impact: Many missing dependencies may affect system functionality' : 
                  dependencyAnalysis.summary.missingCount > 0 ? '‚ö° Medium impact: Some dependencies missing' : 
                  '‚úÖ Low impact: All major dependencies found'}
            </p>
        </div>
    `;
},
// **NEW METHOD: Generate Visual Flow Chart**
generateVisualFlowChart(dependencyAnalysis) {
    const currentComponent = this.currentSelectedComponent;
    const component = this.discoveredComponents.get(currentComponent);
    
    if (!currentComponent || !component) {
        return '<p style="text-align: center; color: var(--grey-500); padding: 2rem;">Select a component to view its dependency flow</p>';
    }

    // Build the flow structure
    const flowData = this.buildFlowData(currentComponent, dependencyAnalysis);
    
    return `
        <div style="display: flex; flex-direction: column; gap: 2rem; min-width: 800px; align-items: center;">
            
            <!-- UPSTREAM DEPENDENCIES (What this component depends on) -->
            ${flowData.upstream.length > 0 ? `
                <div style="text-align: center;">
                    <h5 style="color: var(--info-blue); margin-bottom: 1rem;">‚¨ÜÔ∏è UPSTREAM DEPENDENCIES</h5>
                    <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 1rem;">Components that ${component.friendlyName} depends on</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
                        ${flowData.upstream.map(dep => this.createFlowNode(dep, 'upstream')).join('')}
                    </div>
                    <!-- Connection lines -->
                    <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                        ${flowData.upstream.map(() => '<div style="width: 2px; height: 30px; background: var(--info-blue); margin: 0 2rem;"></div>').join('')}
                    </div>
                    <!-- Arrow down -->
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 1.5rem; color: var(--info-blue);">‚¨áÔ∏è</div>
                        <div style="font-size: 0.8rem; color: var(--grey-600);">feeds into</div>
                    </div>
                </div>
            ` : ''}

            <!-- CURRENT COMPONENT (Center) -->
            <div style="text-align: center; margin: 2rem 0;">
                <div style="position: relative;">
                    ${this.createCenterComponentNode(currentComponent, component)}
                </div>
            </div>

            <!-- DOWNSTREAM DEPENDENCIES (What depends on this component) -->
            ${flowData.downstream.length > 0 ? `
                <div style="text-align: center;">
                    <!-- Arrow down -->
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 1.5rem; color: var(--success-green);">‚¨áÔ∏è</div>
                        <div style="font-size: 0.8rem; color: var(--grey-600);">flows to</div>
                    </div>
                    <!-- Connection lines -->
                    <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                        ${flowData.downstream.map(() => '<div style="width: 2px; height: 30px; background: var(--success-green); margin: 0 2rem;"></div>').join('')}
                    </div>
                    <h5 style="color: var(--success-green); margin-bottom: 1rem;">‚¨áÔ∏è DOWNSTREAM DEPENDENCIES</h5>
                    <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 1rem;">Components that depend on ${component.friendlyName}</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                        ${flowData.downstream.map(dep => this.createFlowNode(dep, 'downstream')).join('')}
                    </div>
                </div>
            ` : ''}

            <!-- MISSING DEPENDENCIES (Broken connections) -->
            ${flowData.missing.length > 0 ? `
                <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 2px dashed var(--error-red);">
                    <h5 style="color: var(--error-red); margin-bottom: 1rem;">‚ö†Ô∏è MISSING DEPENDENCIES</h5>
                    <div style="font-size: 0.8rem; color: var(--grey-600); margin-bottom: 1rem;">Components referenced but not available</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                        ${flowData.missing.map(dep => this.createFlowNode(dep, 'missing')).join('')}
                    </div>
                    <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 6px;">
                        <strong style="color: var(--error-red);">‚ö†Ô∏è Business Impact:</strong>
                        <span style="color: var(--grey-700);">These missing components may cause compilation errors or runtime failures. Upload the missing files or remove unused references.</span>
                    </div>
                </div>
            ` : ''}

            <!-- FLOW LEGEND -->
            <div style="margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--grey-200);">
                <h6 style="margin: 0 0 0.75rem 0; color: var(--grey-800);">üìã Flow Legend</h6>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.8rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 16px; height: 16px; background: var(--info-blue); border-radius: 50%;"></div>
                        <span>Upstream: Dependencies required</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 16px; height: 16px; background: var(--primary-blue); border-radius: 50%;"></div>
                        <span>Current: Selected component</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 16px; height: 16px; background: var(--success-green); border-radius: 50%;"></div>
                        <span>Downstream: Dependent components</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 16px; height: 16px; background: var(--error-red); border-radius: 50%; border: 2px dashed white;"></div>
                        <span>Missing: Unavailable dependencies</span>
                    </div>
                </div>
            </div>
        </div>
    `;
},

// **NEW METHOD: Build Flow Data**
  buildFlowData(currentComponent, dependencyAnalysis) {
        const flowData = {
            upstream: [],
            downstream: [],
            missing: [],
            interfaces: {
                apis: [],
                databases: [],
                queues: [],
                files: []
            }
        };

        // **FIX 1: Include ALL discovered components as potential dependencies**
        const allAvailableComponents = Array.from(this.discoveredComponents.keys());
        
        // UPSTREAM: Components that the current component depends on
        if (dependencyAnalysis.found) {
            [...dependencyAnalysis.found.copybooks, ...dependencyAnalysis.found.programs, ...dependencyAnalysis.found.files]
                .forEach(depName => {
                    const depComponent = this.discoveredComponents.get(depName);
                    const depResult = this.analysisResults[depName];
                    
                    // **ENHANCED: Classify if this is an interface**
                    const interfaceType = this.classifyAsInterface(depName);
                    
                    const flowNode = {
                        name: depName,
                        component: depComponent,
                        result: depResult,
                        type: this.getComponentTypeFromName(depName),
                        status: 'found',
                        interfaceType: interfaceType,
                        isInterface: interfaceType !== null
                    };
                    
                    flowData.upstream.push(flowNode);
                    
                    // **NEW: Add to interface categories if applicable**
                    if (interfaceType) {
                        this.addToInterfaceCategory(flowData.interfaces, interfaceType, flowNode);
                    }
                });
        }

        // **FIX 2: Better Missing Dependencies Detection**
        if (dependencyAnalysis.missing) {
            [...dependencyAnalysis.missing.copybooks, ...dependencyAnalysis.missing.programs, ...dependencyAnalysis.missing.files]
                .forEach(depName => {
                    // **CHECK: Is this actually available but not properly linked?**
                    const actuallyAvailable = allAvailableComponents.find(comp => 
                        comp.toUpperCase() === depName.toUpperCase() ||
                        comp.toUpperCase().includes(depName.toUpperCase()) ||
                        depName.toUpperCase().includes(comp.toUpperCase())
                    );
                    
                    if (actuallyAvailable) {
                        // **FIX: Move from missing to found**
                        const depComponent = this.discoveredComponents.get(actuallyAvailable);
                        const depResult = this.analysisResults[actuallyAvailable];
                        const interfaceType = this.classifyAsInterface(actuallyAvailable);
                        
                        const flowNode = {
                            name: actuallyAvailable,
                            component: depComponent,
                            result: depResult,
                            type: this.getComponentTypeFromName(actuallyAvailable),
                            status: 'found',
                            interfaceType: interfaceType,
                            isInterface: interfaceType !== null,
                            wasMissingButFound: true
                        };
                        
                        flowData.upstream.push(flowNode);
                        
                        if (interfaceType) {
                            this.addToInterfaceCategory(flowData.interfaces, interfaceType, flowNode);
                        }
                    } else {
                        // **TRULY MISSING: Classify what type of interface this might be**
                        const interfaceType = this.classifyAsInterface(depName);
                        
                        flowData.missing.push({
                            name: depName,
                            component: null,
                            result: null,
                            type: this.getComponentTypeFromName(depName),
                            status: 'missing',
                            interfaceType: interfaceType,
                            isInterface: interfaceType !== null
                        });
                    }
                });
        }

        // DOWNSTREAM: Components that depend on the current component
        Object.entries(this.analysisResults).forEach(([compName, result]) => {
            if (compName === currentComponent) return; // Skip self
            
            if (result.dependencyAnalysis && result.dependencyAnalysis.found) {
                const isDependent = [
                    ...result.dependencyAnalysis.found.copybooks,
                    ...result.dependencyAnalysis.found.programs,
                    ...result.dependencyAnalysis.found.files
                ].includes(currentComponent);
                
                if (isDependent) {
                    const depComponent = this.discoveredComponents.get(compName);
                    const interfaceType = this.classifyAsInterface(compName);
                    
                    const flowNode = {
                        name: compName,
                        component: depComponent,
                        result: result,
                        type: depComponent?.type || 'Unknown',
                        status: 'found',
                        interfaceType: interfaceType,
                        isInterface: interfaceType !== null
                    };
                    
                    flowData.downstream.push(flowNode);
                    
                    if (interfaceType) {
                        this.addToInterfaceCategory(flowData.interfaces, interfaceType, flowNode);
                    }
                }
            }
        });

        // **NEW: Auto-detect system interfaces from current component**
        this.detectSystemInterfaces(currentComponent, flowData);

        return flowData;
    },

    // **NEW: Classify Component as Interface Type**
    classifyAsInterface(name) {
        const upperName = name.toUpperCase();
        
        // API Interfaces
        if (upperName.includes('API') || upperName.includes('REST') || upperName.includes('SOAP') || 
            upperName.includes('WS') || upperName.includes('SERVICE') || upperName.includes('ENDPOINT')) {
            return 'api';
        }
        
        // Database Interfaces
        if (upperName.includes('DB2') || upperName.includes('DATABASE') || upperName.includes('TABLE') || 
            upperName.includes('VSAM') || upperName.includes('KSDS') || upperName.includes('ESDS') ||
            upperName.includes('SQL') || upperName.includes('CURSOR')) {
            return 'database';
        }
        
        // Message Queue Interfaces  
        if (upperName.includes('MQ') || upperName.includes('QUEUE') || upperName.includes('MSG') || 
            upperName.includes('TOPIC') || upperName.includes('CHANNEL') || upperName.includes('BROKER')) {
            return 'queue';
        }
        
        // File Interfaces
        if (upperName.includes('FILE') || upperName.includes('DATASET') || upperName.includes('FD') || 
            upperName.includes('SEQUENTIAL') || upperName.includes('INDEXED') || upperName.includes('RELATIVE')) {
            return 'file';
        }
        
        // External System Interfaces
        if (upperName.includes('EXTERNAL') || upperName.includes('INTERFACE') || upperName.includes('ADAPTER') || 
            upperName.includes('CONNECTOR') || upperName.includes('GATEWAY') || upperName.includes('BRIDGE')) {
            return 'external';
        }
        
        return null; // Not an interface
    },

    // **NEW: Add to Interface Category**
    addToInterfaceCategory(interfaces, interfaceType, flowNode) {
        switch (interfaceType) {
            case 'api':
            case 'external':
                interfaces.apis.push(flowNode);
                break;
            case 'database':
                interfaces.databases.push(flowNode);
                break;
            case 'queue':
                interfaces.queues.push(flowNode);
                break;
            case 'file':
                interfaces.files.push(flowNode);
                break;
        }
    },

    // **NEW: Detect System Interfaces from Component Content**
    detectSystemInterfaces(componentName, flowData) {
        // Find files containing this component
        const relevantFiles = this.uploadedFiles.filter(file => 
            file.components && file.components.some(comp => comp.name === componentName)
        );
        
        relevantFiles.forEach(file => {
            const content = file.content.toUpperCase();
            
            // Detect SQL/DB2 interfaces
            if (content.includes('EXEC SQL') || content.includes('DB2') || content.includes('CURSOR')) {
                this.addDetectedInterface(flowData, 'DB2-CONNECTION', 'database', 'SQL Database Interface');
            }
            
            // Detect MQ interfaces
            if (content.includes('MQOPEN') || content.includes('MQPUT') || content.includes('MQGET')) {
                this.addDetectedInterface(flowData, 'MQ-INTERFACE', 'queue', 'Message Queue Interface');
            }
            
            // Detect CICS interfaces
            if (content.includes('EXEC CICS') || content.includes('COMMAREA') || content.includes('RETURN')) {
                this.addDetectedInterface(flowData, 'CICS-INTERFACE', 'external', 'CICS Transaction Interface');
            }
            
            // Detect file operations
            if (content.includes('SELECT') && content.includes('ASSIGN')) {
                const fileMatches = content.match(/SELECT\s+([A-Z][A-Z0-9\-_]+)\s+ASSIGN/g);
                if (fileMatches) {
                    fileMatches.forEach(match => {
                        const fileName = match.split(/\s+/)[1];
                        this.addDetectedInterface(flowData, fileName, 'file', 'Data File Interface');
                    });
                }
            }
        });
    },

    // **NEW: Add Detected Interface**
    addDetectedInterface(flowData, name, type, description) {
        const interfaceNode = {
            name: name,
            component: null,
            result: null,
            type: type,
            status: 'detected',
            interfaceType: type,
            isInterface: true,
            description: description,
            isSystemDetected: true
        };
        
        // Add to upstream (components this depends on)
        flowData.upstream.push(interfaceNode);
        this.addToInterfaceCategory(flowData.interfaces, type, interfaceNode);
    },

// **NEW METHOD: Get Component Type from Name**
getComponentTypeFromName(name) {
    // Try to determine type from naming patterns
    const upperName = name.toUpperCase();
    
    if (upperName.includes('COPY') || upperName.endsWith('CPY') || upperName.includes('MASTER')) {
        return 'Copybook';
    } else if (upperName.includes('PROG') || upperName.includes('PGM') || upperName.includes('PROC')) {
        return 'Program';
    } else if (upperName.includes('FILE') || upperName.includes('FIL')) {
        return 'File';
    } else {
        return 'Component';
    }
},

// **NEW METHOD: Create Center Component Node**
createCenterComponentNode(componentName, component) {
    const result = this.analysisResults[componentName];
    const displayName = component?.friendlyName || componentName;
    const businessPurpose = component?.businessPurpose || 'Business purpose pending analysis';
    
    return `
        <div style="
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
            min-width: 320px;
            max-width: 400px;
            position: relative;
            border: 4px solid var(--primary-blue);
        ">
            <!-- Pulse animation ring -->
            <div style="
                position: absolute;
                top: -8px; left: -8px; right: -8px; bottom: -8px;
                border: 2px solid var(--primary-blue);
                border-radius: 20px;
                animation: pulse 2s infinite;
                opacity: 0.6;
            "></div>
            
            <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.75rem;">üéØ</div>
                <h4 style="margin: 0 0 0.5rem 0; color: white; font-size: 1.1rem;">${displayName}</h4>
                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem; font-family: monospace;">${componentName}</div>
                
                <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.85rem; line-height: 1.4; margin-bottom: 0.75rem;">
                        ${businessPurpose.length > 100 ? businessPurpose.substring(0, 100) + '...' : businessPurpose}
                    </div>
                    <div style="display: flex; justify-content: space-around; font-size: 0.75rem;">
                        <div>
                            <div style="font-weight: bold;">${component?.type || 'Unknown'}</div>
                            <div style="opacity: 0.8;">Type</div>
                        </div>
                        <div>
                            <div style="font-weight: bold;">${component?.fieldCount || 0}</div>
                            <div style="opacity: 0.8;">Fields</div>
                        </div>
                        <div>
                            <div style="font-weight: bold;">${result?.qualityScore || 'N/A'}</div>
                            <div style="opacity: 0.8;">Quality</div>
                        </div>
                    </div>
                </div>
                
                <div style="font-size: 0.75rem; opacity: 0.8;">üîç CURRENT COMPONENT</div>
            </div>
        </div>
        
        <style>
            @keyframes pulse {
                0%, 100% { opacity: 0.6; transform: scale(1); }
                50% { opacity: 0.2; transform: scale(1.05); }
            }
        </style>
    `;
},

// **NEW METHOD: Create Flow Node**
createFlowNode(dependency, flowType) {
    const { name, component, result, type, status } = dependency;
    const displayName = component?.friendlyName || this.generateFriendlyNameFromPattern(name);
    const businessPurpose = component?.businessPurpose || this.generateBusinessPurpose(name);
    
    // Determine colors and styles based on flow type and status
    let borderColor, bgColor, iconColor, statusIcon, connectionColor;
    
    switch (flowType) {
        case 'upstream':
            borderColor = status === 'found' ? 'var(--info-blue)' : 'var(--error-red)';
            bgColor = status === 'found' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            iconColor = 'var(--info-blue)';
            statusIcon = status === 'found' ? '‚úÖ' : '‚ùå';
            connectionColor = 'var(--info-blue)';
            break;
        case 'downstream':
            borderColor = 'var(--success-green)';
            bgColor = 'rgba(16, 185, 129, 0.1)';
            iconColor = 'var(--success-green)';
            statusIcon = '‚úÖ';
            connectionColor = 'var(--success-green)';
            break;
        case 'missing':
            borderColor = 'var(--error-red)';
            bgColor = 'rgba(239, 68, 68, 0.1)';
            iconColor = 'var(--error-red)';
            statusIcon = '‚ùå';
            connectionColor = 'var(--error-red)';
            break;
        default:
            borderColor = 'var(--grey-400)';
            bgColor = 'var(--grey-50)';
            iconColor = 'var(--grey-600)';
            statusIcon = '‚ùì';
            connectionColor = 'var(--grey-400)';
    }
    
    const typeIcon = type === 'Copybook' ? 'üìö' : type === 'Program' ? 'üíº' : 'üìÑ';
    const isClickable = status === 'found';
    
    return `
        <div style="
            background: ${bgColor};
            border: 2px solid ${borderColor};
            border-radius: 12px;
            padding: 1rem;
            min-width: 200px;
            max-width: 250px;
            cursor: ${isClickable ? 'pointer' : 'default'};
            transition: all 0.3s ease;
            position: relative;
            ${status === 'missing' ? 'border-style: dashed;' : ''}
        " ${isClickable ? `onclick="analyzer.selectComponent('${name}')"` : ''}
           onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none';">
           
            <!-- Status indicator -->
            <div style="
                position: absolute;
                top: -8px;
                right: -8px;
                background: ${borderColor};
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                border: 2px solid white;
            ">${statusIcon}</div>
            
            <!-- Component info -->
            <div style="text-align: center;">
                <div style="font-size: 1.25rem; margin-bottom: 0.5rem; color: ${iconColor};">${typeIcon}</div>
                
                <div style="font-weight: bold; font-size: 0.9rem; color: var(--grey-800); margin-bottom: 0.25rem;">
                    ${name}
                </div>
                
                <div style="font-size: 0.8rem; color: var(--primary-blue); margin-bottom: 0.75rem; font-weight: 500; line-height: 1.2;">
                    ${displayName}
                </div>
                
                <div style="font-size: 0.75rem; color: var(--grey-600); line-height: 1.3; margin-bottom: 0.75rem; min-height: 40px;">
                    ${businessPurpose.substring(0, 80)}${businessPurpose.length > 80 ? '...' : ''}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem;">
                    <span class="badge badge-grey">${type}</span>
                    ${result ? `<span class="badge badge-info">Q: ${result.qualityScore}/10</span>` : ''}
                    ${status === 'missing' ? '<span class="badge badge-danger">MISSING</span>' : ''}
                </div>
                
                ${isClickable ? `
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--grey-200);">
                        <div style="color: ${borderColor}; font-size: 0.7rem;">
                            üîç Click to analyze
                        </div>
                    </div>
                ` : status === 'missing' ? `
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--grey-200);">
                        <div style="color: var(--error-red); font-size: 0.7rem;">
                            üìÅ Upload required
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
},

// **NEW METHOD: Generate Flow Summary**
generateFlowSummary(dependencyAnalysis) {
    const upstreamCount = (dependencyAnalysis.found?.copybooks?.length || 0) + 
                         (dependencyAnalysis.found?.programs?.length || 0) + 
                         (dependencyAnalysis.found?.files?.length || 0);
    
    const missingCount = (dependencyAnalysis.missing?.copybooks?.length || 0) + 
                        (dependencyAnalysis.missing?.programs?.length || 0) + 
                        (dependencyAnalysis.missing?.files?.length || 0);
    
    // Calculate downstream dependencies
    const currentComponent = this.currentSelectedComponent;
    const downstreamCount = Object.values(this.analysisResults).filter(result => {
        if (!result.dependencyAnalysis || !result.dependencyAnalysis.found) return false;
        return [...result.dependencyAnalysis.found.copybooks,
                ...result.dependencyAnalysis.found.programs,
                ...result.dependencyAnalysis.found.files].includes(currentComponent);
    }).length;
    
    const totalDependencies = upstreamCount + missingCount;
    const healthPercentage = totalDependencies > 0 ? Math.round((upstreamCount / totalDependencies) * 100) : 100;
    
    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid var(--info-blue);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--info-blue);">${upstreamCount}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Upstream Dependencies</div>
                <div style="font-size: 0.7rem; color: var(--grey-500); margin-top: 0.25rem;">Components this depends on</div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid var(--success-green);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">${downstreamCount}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Downstream Dependencies</div>
                <div style="font-size: 0.7rem; color: var(--grey-500); margin-top: 0.25rem;">Components that depend on this</div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid var(--error-red);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--error-red);">${missingCount}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Missing Dependencies</div>
                <div style="font-size: 0.7rem; color: var(--grey-500); margin-top: 0.25rem;">Broken connections</div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid var(--primary-blue);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">${healthPercentage}%</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Health Score</div>
                <div style="font-size: 0.7rem; color: var(--grey-500); margin-top: 0.25rem;">Dependency completeness</div>
            </div>
        </div>
        
        <div style="background: white; padding: 1rem; border-radius: 8px;">
            <h6 style="margin: 0 0 0.75rem 0; color: var(--grey-800);">üìà Business Flow Impact</h6>
            <div style="background: ${healthPercentage >= 80 ? 'rgba(16, 185, 129, 0.1)' : healthPercentage >= 50 ? 'rgba(245, 158, 11, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; padding: 1rem; border-radius: 6px;">
                <strong style="color: ${healthPercentage >= 80 ? 'var(--success-green)' : healthPercentage >= 50 ? 'var(--warning-yellow)' : 'var(--error-red)'};">
                    ${healthPercentage >= 80 ? '‚úÖ HEALTHY FLOW:' : healthPercentage >= 50 ? '‚ö†Ô∏è MODERATE ISSUES:' : 'üî¥ CRITICAL ISSUES:'}
                </strong>
                <span style="color: var(--grey-700); margin-left: 0.5rem;">
                    ${healthPercentage >= 80 ? 
                        'This component has excellent dependency health and should function reliably in the business process flow.' :
                        healthPercentage >= 50 ?
                        'Some missing dependencies may cause intermittent issues in business operations. Consider resolving missing components.' :
                        'Multiple missing dependencies will likely disrupt business processes. Immediate attention required to restore functionality.'
                    }
                </span>
            </div>
            
            ${missingCount > 0 ? `
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 4px solid var(--error-red);">
                    <strong style="color: var(--error-red);">‚ö° Action Required:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem; color: var(--grey-700); font-size: 0.9rem;">
                        <li>Upload the ${missingCount} missing component${missingCount > 1 ? 's' : ''} listed above</li>
                        <li>Remove unused references if components are no longer needed</li>
                        <li>Update dependency mappings after resolving missing items</li>
                        <li>Re-run analysis to verify dependency health</li>
                    </ul>
                </div>
            ` : `
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 4px solid var(--success-green);">
                    <strong style="color: var(--success-green);">‚úÖ All Dependencies Resolved:</strong>
                    <span style="color: var(--grey-700); margin-left: 0.5rem;">
                        This component has all required dependencies available and should function without issues.
                    </span>
                </div>
            `}
        </div>
    `;
},

// **NEW METHOD: Current Component Section**
generateCurrentComponentSection(componentName) {
    const component = this.discoveredComponents.get(componentName);
    const result = this.analysisResults[componentName];
    
    return `
        <div style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); padding: 1.5rem; border-radius: 12px; color: white; text-align: center;">
            <h4 style="margin: 0 0 0.5rem 0; color: white;">üéØ Current Component</h4>
            <div style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;">
                ${component?.friendlyName || componentName}
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 1rem;">
                ${component?.businessPurpose || 'Business purpose analysis pending'}
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                <div>
                    <div style="font-weight: bold;">${component?.type || 'Unknown'}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Component Type</div>
                </div>
                <div>
                    <div style="font-weight: bold;">${component?.fieldCount || 0}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Fields</div>
                </div>
                <div>
                    <div style="font-weight: bold;">${result?.qualityScore || 'N/A'}/10</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Quality</div>
                </div>
                <div>
                    <div style="font-weight: bold;">${(result?.llmAnalysis?.riskAssessment || 'Medium').toUpperCase()}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Risk Level</div>
                </div>
            </div>
        </div>
    `;
},

// **NEW METHOD: Found Dependencies Section**
generateFoundDependenciesSection(found) {
    return `
        <div style="background: white; padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--success-green);">
            <h4 style="color: var(--success-green); margin: 0 0 1rem 0;">‚úÖ Connected Dependencies (${found.copybooks.length + found.programs.length + found.files.length})</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                ${this.generateDependencyNodes(found, 'found')}
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                <strong>üí° Business Impact:</strong> These components are properly connected and will function correctly together. 
                All dependencies are resolved and available for processing.
            </div>
        </div>
    `;
},

// **NEW METHOD: Missing Dependencies Section**
generateMissingDependenciesSection(missing) {
    return `
        <div style="background: white; padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--error-red);">
            <h4 style="color: var(--error-red); margin: 0 0 1rem 0;">‚ö†Ô∏è Missing Dependencies (${missing.copybooks.length + missing.programs.length + missing.files.length})</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                ${this.generateDependencyNodes(missing, 'missing')}
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                <strong>‚ö†Ô∏è Business Impact:</strong> These missing components may cause compilation failures or runtime errors. 
                Consider uploading these dependencies or updating the code to remove unused references.
            </div>
        </div>
    `;
},

// **NEW METHOD: Generate Dependency Nodes**
generateDependencyNodes(dependencies, status) {
    let nodes = '';
    
    // Process copybooks
    dependencies.copybooks.forEach(name => {
        nodes += this.createEnhancedDependencyNode(name, 'copybook', status);
    });
    
    // Process programs
    dependencies.programs.forEach(name => {
        nodes += this.createEnhancedDependencyNode(name, 'program', status);
    });
    
    // Process files
    dependencies.files.forEach(name => {
        nodes += this.createEnhancedDependencyNode(name, 'file', status);
    });
    
    return nodes;
},

// **NEW METHOD: Enhanced Dependency Node**
createEnhancedDependencyNode(name, type, status) {
    const component = this.discoveredComponents.get(name);
    const result = this.analysisResults[name];
    const isFound = status === 'found';
    
    const friendlyName = component?.friendlyName || this.generateFriendlyNameFromPattern(name);
    const businessPurpose = component?.businessPurpose || this.generateBusinessPurpose(name);
    
    const borderColor = isFound ? 'var(--success-green)' : 'var(--error-red)';
    const bgColor = isFound ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)';
    const icon = type === 'copybook' ? 'üìö' : type === 'program' ? 'üíº' : 'üìÑ';
    
    return `
        <div class="dependency-node" data-component="${name}" style="
            padding: 1rem; 
            background: ${bgColor}; 
            border: 2px solid ${borderColor}; 
            border-radius: 10px; 
            cursor: ${isFound ? 'pointer' : 'default'};
            transition: all 0.3s ease;
            position: relative;
        " ${isFound ? `onclick="analyzer.selectComponent('${name}')"` : ''}>
            <!-- Connection indicator -->
            <div style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 16px; height: 16px; background: ${borderColor}; border-radius: 50%; border: 3px solid white;"></div>
            
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                <span style="font-size: 1.5rem;">${icon}</span>
                <div>
                    <div style="font-weight: bold; font-size: 0.9rem; color: var(--grey-800);">${name}</div>
                    <div style="font-size: 0.75rem; color: var(--grey-500); text-transform: uppercase;">${type}</div>
                </div>
            </div>
            
            <div style="font-size: 0.85rem; color: var(--primary-blue); margin-bottom: 0.75rem; font-weight: 500; line-height: 1.3;">
                ${friendlyName}
            </div>
            
            <div style="font-size: 0.8rem; color: var(--grey-600); line-height: 1.4; margin-bottom: 1rem;">
                ${businessPurpose.substring(0, 100)}${businessPurpose.length > 100 ? '...' : ''}
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span class="badge ${isFound ? 'badge-success' : 'badge-danger'}" style="font-size: 0.7rem;">
                        ${isFound ? 'Available' : 'Missing'}
                    </span>
                    ${component && result ? `<span class="badge badge-info" style="font-size: 0.7rem; margin-left: 0.25rem;">Analyzed</span>` : ''}
                </div>
                ${isFound && result ? `<div style="font-size: 0.75rem; color: var(--grey-500);">Quality: ${result.qualityScore || 'N/A'}/10</div>` : ''}
            </div>
            
            ${isFound ? `
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--grey-200);">
                    <div style="font-size: 0.75rem; color: var(--success-green);">
                        üîó Click to analyze this component
                    </div>
                </div>
            ` : `
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--grey-200);">
                    <div style="font-size: 0.75rem; color: var(--error-red);">
                        ‚ö†Ô∏è Component not found in uploaded files
                    </div>
                </div>
            `}
        </div>
    `;
},

// **NEW METHOD: Connections Visualization**
generateConnectionsVisualization(dependencyAnalysis) {
    const totalConnections = dependencyAnalysis.summary.foundCount;
    const totalMissing = dependencyAnalysis.summary.missingCount;
    const totalDependencies = totalConnections + totalMissing;
    
    if (totalDependencies === 0) {
        return `
            <div style="background: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                <h4 style="color: var(--grey-600); margin: 0 0 0.5rem 0;">üîó No Dependencies Found</h4>
                <p style="color: var(--grey-500); margin: 0;">This component appears to be standalone or dependencies are not explicitly referenced.</p>
            </div>
        `;
    }
    
    const connectionPercentage = Math.round((totalConnections / totalDependencies) * 100);
    
    return `
        <div style="background: white; padding: 1.5rem; border-radius: 12px;">
            <h4 style="color: var(--grey-800); margin: 0 0 1rem 0;">üåê Dependency Network Health</h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">${totalDependencies}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Total Dependencies</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">${totalConnections}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Connected</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--grey-50); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--error-red);">${totalMissing}</div>
                    <div style="font-size: 0.8rem; color: var(--grey-600);">Missing</div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 500;">Network Completeness</span>
                    <span style="font-weight: bold; color: ${connectionPercentage >= 80 ? 'var(--success-green)' : connectionPercentage >= 50 ? 'var(--warning-yellow)' : 'var(--error-red)'};">${connectionPercentage}%</span>
                </div>
                <div style="background: var(--grey-200); height: 12px; border-radius: 6px; overflow: hidden;">
                    <div style="background: ${connectionPercentage >= 80 ? 'var(--success-green)' : connectionPercentage >= 50 ? 'var(--warning-yellow)' : 'var(--error-red)'}; height: 100%; width: ${connectionPercentage}%; border-radius: 6px; transition: width 0.5s ease;"></div>
                </div>
            </div>
            
            <div style="padding: 1rem; background: ${connectionPercentage >= 80 ? 'rgba(16, 185, 129, 0.1)' : connectionPercentage >= 50 ? 'rgba(245, 158, 11, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 8px;">
                <strong>üíº Business Assessment:</strong>
                ${connectionPercentage >= 80 ? 
                    'Excellent dependency health. This component is well-connected and should function reliably in the system.' :
                    connectionPercentage >= 50 ?
                    'Moderate dependency issues. Some missing components may cause runtime problems or require manual intervention.' :
                    'Critical dependency issues. Multiple missing components will likely prevent proper system operation.'
                }
            </div>
        </div>
    `;
},

// **NEW METHOD: Create Dependency Node**
createDependencyNode(name, component, status, type) {
    const isFound = status === 'found';
    const borderColor = isFound ? 'var(--success-green)' : 'var(--error-red)';
    const bgColor = isFound ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
    const icon = type === 'copybook' ? 'üìö' : 'üíº';
    const friendlyName = component?.friendlyName || this.generateFriendlyNameFromPattern(name);
    const businessPurpose = component?.businessPurpose || this.generateBusinessPurpose(name);
    
    return `
        <div style="
            min-width: 200px; 
            max-width: 250px;
            padding: 1rem; 
            background: ${bgColor}; 
            border: 2px solid ${borderColor}; 
            border-radius: 8px; 
            cursor: ${isFound ? 'pointer' : 'default'};
            transition: transform 0.2s ease;
        " ${isFound ? `onclick="analyzer.selectComponent('${name}')"` : ''} 
        onmouseover="this.style.transform='scale(1.02)'" 
        onmouseout="this.style.transform='scale(1)'">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.2rem;">${icon}</span>
                <span style="font-weight: bold; font-size: 0.85rem; color: var(--grey-800);">${name}</span>
            </div>
            <div style="font-size: 0.8rem; color: var(--primary-blue); margin-bottom: 0.5rem; font-weight: 500;">
                ${friendlyName}
            </div>
            <div style="font-size: 0.75rem; color: var(--grey-600); line-height: 1.3;">
                ${businessPurpose.substring(0, 80)}${businessPurpose.length > 80 ? '...' : ''}
            </div>
            <div style="margin-top: 0.5rem;">
                <span class="badge ${isFound ? 'badge-success' : 'badge-danger'}" style="font-size: 0.7rem;">
                    ${isFound ? 'Found' : 'Missing'}
                </span>
                <span class="badge badge-grey" style="font-size: 0.7rem; margin-left: 0.25rem;">
                    ${type}
                </span>
            </div>
        </div>
    `;
},

    // Generate Dependency Table
    generateDependencyTable(dependencyAnalysis) {
        if (!dependencyAnalysis) return '<p>No dependency analysis available</p>';

        let html = '';

        // Found Dependencies
        if (dependencyAnalysis.found.copybooks.length > 0 || dependencyAnalysis.found.programs.length > 0 || dependencyAnalysis.found.files.length > 0) {
            html += `
                <h5 style="color: var(--success-green); margin-bottom: 0.75rem;">‚úÖ Found Dependencies</h5>
                <div class="data-table" style="margin-bottom: 1.5rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Business Name</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            ['copybooks', 'programs', 'files'].forEach(type => {
                dependencyAnalysis.found[type].forEach(name => {
                    const comp = this.discoveredComponents.get(name);
                    html += `
                        <tr onclick="analyzer.selectComponent('${name}')" style="cursor: pointer;">
                            <td style="font-family: monospace;">${name}</td>
                            <td><span class="badge badge-success">${type.slice(0, -1)}</span></td>
                            <td><span class="badge badge-success">Found</span></td>
                            <td>${comp?.friendlyName || 'Not analyzed'}</td>
                        </tr>
                    `;
                });
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Missing Dependencies
        if (dependencyAnalysis.missing.copybooks.length > 0 || dependencyAnalysis.missing.programs.length > 0 || dependencyAnalysis.missing.files.length > 0) {
            html += `
                <h5 style="color: var(--error-red); margin-bottom: 0.75rem;">‚ö†Ô∏è Missing Dependencies</h5>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Impact</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            ['copybooks', 'programs', 'files'].forEach(type => {
                dependencyAnalysis.missing[type].forEach(name => {
                    html += `
                        <tr>
                            <td style="font-family: monospace;">${name}</td>
                            <td><span class="badge badge-warning">${type.slice(0, -1)}</span></td>
                            <td><span class="badge badge-danger">Missing</span></td>
                            <td style="color: var(--error-red);">Potential compilation/runtime issues</td>
                        </tr>
                    `;
                });
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }

        return html || '<p style="text-align: center; color: var(--grey-500);">No dependency information available</p>';
    },

    // Display Field Matrix
    displayFieldMatrix(componentName, result) {
    const container = document.getElementById('fieldMatrixContent');
    if (!container) return;

    const component = this.discoveredComponents.get(componentName);
    const displayName = component?.friendlyName || componentName;
    const fieldAnalysis = result?.fieldAnalysis;

    if (!fieldAnalysis || !fieldAnalysis.fields || fieldAnalysis.fields.length === 0) {
        this.showNoFieldsMessage(componentName);
        return;
    }

    let html = `
        <!-- Component Header -->
        <div style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 0.5rem 0; color: white;">üìã Field Matrix Analysis</h3>
            <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">${displayName}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">${component?.businessPurpose || 'Field-level business intelligence analysis'}</div>
        </div>
        
        <!-- Field Overview Metrics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">${fieldAnalysis.fields.length}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Total Fields</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">${fieldAnalysis.inputFields?.length || 0}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Input Fields</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--info-blue);">${fieldAnalysis.outputFields?.length || 0}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Output Fields</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--grey-200);">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning-yellow);">${fieldAnalysis.unusedFields?.length || 0}</div>
                <div style="font-size: 0.8rem; color: var(--grey-600);">Unused Fields</div>
            </div>
        </div>

        <!-- Business Logic Summary -->
        ${this.generateBusinessLogicSummary(result)}

        <!-- Field Details Table -->
        <div style="background: white; border-radius: 12px; overflow: hidden; border: 1px solid var(--grey-200);">
            <div style="background: var(--grey-50); padding: 1rem; border-bottom: 1px solid var(--grey-200);">
                <h4 style="margin: 0; color: var(--grey-800);">üìä Detailed Field Analysis</h4>
                <p style="margin: 0.5rem 0 0 0; color: var(--grey-600); font-size: 0.9rem;">Click on any field to get business intelligence insights</p>
            </div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Field Name</th>
                            <th>Level</th>
                            <th>Picture Clause</th>
                            <th>Usage Pattern</th>
                            <th>Business Purpose</th>
                            <th>Data Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    fieldAnalysis.fields.slice(0, 100).forEach((field, index) => {
        const usage = this.determineFieldUsage(field, fieldAnalysis);
        const badgeClass = this.getUsageBadgeClass(usage);
        const businessPurpose = field.businessLogic?.businessMeaning || this.generateFieldPurpose(field.name);
        const dataType = this.determineDataType(field.picture);
        
        html += `
            <tr class="field-row" data-field="${field.name}" style="cursor: pointer;">
                <td style="font-family: monospace; font-weight: 600;">${field.name}</td>
                <td>
                    <span class="badge badge-grey">${field.level}</span>
                    ${field.level === 1 ? '<span class="badge badge-primary" style="margin-left: 0.25rem; font-size: 0.7rem;">MAIN</span>' : ''}
                </td>
                <td style="font-family: monospace; font-size: 0.85rem;">${field.picture || '-'}</td>
                <td><span class="badge ${badgeClass}">${usage}</span></td>
                <td style="font-size: 0.85rem; max-width: 250px; line-height: 1.4;">${businessPurpose}</td>
                <td><span class="badge badge-info">${dataType}</span></td>
                <td>
                    <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="analyzer.analyzeField('${componentName}', '${field.name}')">
                        üí° Analyze
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    if (fieldAnalysis.fields.length > 100) {
        html += `
            <div style="margin-top: 1rem; padding: 1rem; background: var(--grey-50); border-radius: 8px; text-align: center;">
                <p style="margin: 0; color: var(--grey-600);">
                    Showing 100 of ${fieldAnalysis.fields.length} fields. 
                    <button class="btn btn-primary" style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="analyzer.showAllFields('${componentName}')">
                        Show All Fields
                    </button>
                </p>
            </div>
        `;
    }

    container.innerHTML = html;

    // Add click handlers for field rows
    setTimeout(() => {
        document.querySelectorAll('.field-row').forEach(row => {
            row.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    const fieldName = row.getAttribute('data-field');
                    this.updateChatContext('field', fieldName);
                    this.showFieldDetails(componentName, fieldName);
                }
            });
        });
    }, 100);
},

// **NEW METHOD: Generate Business Logic Summary**
generateBusinessLogicSummary(result) {
    const llmAnalysis = result.llmAnalysis;
    
    if (!llmAnalysis || (!llmAnalysis.businessLogic && !llmAnalysis.businessPurpose)) {
        return '';
    }
    
    return `
        <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--grey-200);">
            <h4 style="margin: 0 0 1rem 0; color: var(--grey-800);">üß† Business Logic Intelligence</h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div>
                    <h5 style="color: var(--primary-blue); margin: 0 0 0.5rem 0;">üìã Business Purpose</h5>
                    <p style="margin: 0; color: var(--grey-700); font-size: 0.9rem; line-height: 1.5;">
                        ${llmAnalysis.businessPurpose || 'Business purpose analysis pending'}
                    </p>
                </div>
                
                <div>
                    <h5 style="color: var(--success-green); margin: 0 0 0.5rem 0;">‚öñÔ∏è Business Rules</h5>
                    <div style="font-size: 0.85rem; color: var(--grey-700);">
                        ${(llmAnalysis.businessLogic?.businessRules || []).slice(0, 3).map(rule => 
                            `‚Ä¢ ${rule}`
                        ).join('<br>') || '‚Ä¢ No specific business rules identified'}
                    </div>
                </div>
            </div>
            
            ${llmAnalysis.businessLogic?.dataProcessing ? `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--grey-200);">
                    <h5 style="color: var(--warning-yellow); margin: 0 0 0.5rem 0;">üîÑ Data Processing Logic</h5>
                    <p style="margin: 0; color: var(--grey-700); font-size: 0.9rem; line-height: 1.5;">
                        ${llmAnalysis.businessLogic.dataProcessing}
                    </p>
                </div>
            ` : ''}
        </div>
    `;
},

// **NEW METHOD: Determine Data Type**
determineDataType(picture) {
    if (!picture) return 'Unknown';
    
    const pic = picture.toUpperCase();
    
    if (pic.includes('9')) {
        if (pic.includes('V') || pic.includes('.')) {
            return 'Decimal';
        } else if (pic.includes('COMP') || pic.includes('BINARY')) {
            return 'Binary';
        } else {
            return 'Numeric';
        }
    } else if (pic.includes('X')) {
        return 'Alphanumeric';
    } else if (pic.includes('A')) {
        return 'Alphabetic';
    } else {
        return 'Other';
    }
},

// **NEW METHOD: Analyze Field**
async analyzeField(componentName, fieldName) {
    if (!this.serverValidated) {
        this.showError('LLM server not connected');
        return;
    }
    
    const result = this.analysisResults[componentName];
    if (!result || !result.fieldAnalysis) {
        this.showError('Field analysis not available');
        return;
    }
    
    const field = result.fieldAnalysis.fields.find(f => f.name === fieldName);
    if (!field) {
        this.showError('Field not found');
        return;
    }
    
    // Add to chat with field-specific question
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.value = `Tell me about the business purpose and usage of field ${fieldName} in component ${componentName}. What does this field represent in business terms?`;
        this.updateChatContext('field', fieldName);
        this.sendChatMessage();
    }
    
    // Switch to chat panel
    const rightPanel = document.getElementById('rightPanel');
    if (rightPanel && rightPanel.classList.contains('collapsed')) {
        this.togglePanel('right');
    }
},

// **NEW METHOD: Show Field Details**
showFieldDetails(componentName, fieldName) {
    const result = this.analysisResults[componentName];
    if (!result || !result.fieldAnalysis) return;
    
    const field = result.fieldAnalysis.fields.find(f => f.name === fieldName);
    if (!field) return;
    
    const usage = this.determineFieldUsage(field, result.fieldAnalysis);
    const businessPurpose = field.businessLogic?.businessMeaning || this.generateFieldPurpose(field.name);
    const dataType = this.determineDataType(field.picture);
    
    // Create modal-like display
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: var(--grey-800);">üìã Field Analysis: ${fieldName}</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <strong>Level:</strong> ${field.level}<br>
                    <strong>Picture:</strong> ${field.picture || 'Not specified'}<br>
                    <strong>Data Type:</strong> ${dataType}<br>
                    <strong>Usage Pattern:</strong> <span class="badge ${this.getUsageBadgeClass(usage)}">${usage}</span>
                </div>
                <div>
                    <strong>File:</strong> ${field.fileName}<br>
                    <strong>Line Number:</strong> ${field.lineNumber}<br>
                    <strong>Component:</strong> ${componentName}
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <strong>Business Purpose:</strong><br>
                <p style="margin: 0.5rem 0; padding: 1rem; background: var(--grey-50); border-radius: 8px; line-height: 1.5;">
                    ${businessPurpose}
                </p>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-primary" onclick="analyzer.analyzeField('${componentName}', '${fieldName}'); this.parentElement.parentElement.parentElement.remove();">
                    üí¨ Ask AI About This Field
                </button>
                <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove();">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
},

    // Determine Field Usage
    determineFieldUsage(field, fieldAnalysis) {
        const fieldName = field.name;
        
        if (fieldAnalysis.inputFields && fieldAnalysis.inputFields.includes(fieldName)) return 'INPUT';
        if (fieldAnalysis.outputFields && fieldAnalysis.outputFields.includes(fieldName)) return 'OUTPUT';
        if (fieldAnalysis.referenceFields && fieldAnalysis.referenceFields.includes(fieldName)) return 'REFERENCE';
        if (fieldAnalysis.unusedFields && fieldAnalysis.unusedFields.includes(fieldName)) return 'UNUSED';
        
        return 'UNKNOWN';
    },

    // Get Usage Badge Class
    getUsageBadgeClass(usage) {
        switch(usage) {
            case 'INPUT': return 'badge-success';
            case 'OUTPUT': return 'badge-primary';
            case 'REFERENCE': return 'badge-warning';
            case 'UNUSED': return 'badge-danger';
            default: return 'badge-grey';
        }
    }
});

// ============================================
// GLOBAL INITIALIZATION AND SETUP
// ============================================

// Initialize analyzer on page load with proper error handling
let analyzer;
document.addEventListener('DOMContentLoaded', function() {
    try {
        analyzer = new EnhancedCodeAnalyzer();
        window.analyzer = analyzer; // Make globally accessible
        
        // Initialize chat system
        analyzer.initializeChat();
        
        console.log('‚úÖ Enhanced Code Analyzer - Powered by Opulence Ready!');
    } catch (error) {
        console.error('Failed to initialize Enhanced Code Analyzer:', error);
        // Show error message to user
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f9fafb;">
                <div style="text-align: center; padding: 2rem; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #ef4444; margin-bottom: 1rem;">‚ùå Initialization Failed</h2>
                    <p style="color: #6b7280; margin-bottom: 1rem;">Enhanced Code Analyzer failed to initialize properly.</p>
                    <p style="color: #374151; font-size: 0.9rem;">Error: ${error.message}</p>
                    <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Reload Page
                    </button>
                </div>
            </div>
        `;
    }
});

// Add cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (analyzer && analyzer.cleanup) {
        analyzer.cleanup();
    }
});

// Export the analyzer for external use
if (typeof module !== 'undefined' && module.exports) {
    module.exports = EnhancedCodeAnalyzer;
}

console.log('üöÄ Enhanced Code Analyzer - All Parts Loaded Successfully!');// ============================================
// ENHANCED CODE ANALYZER - PART 5
// Chat System and Final Integration
// ============================================

// Extend the EnhancedCodeAnalyzer class with chat and display methods
Object.assign(EnhancedCodeAnalyzer.prototype, {

    // ============================================
    // CHAT SYSTEM INITIALIZATION
    // ============================================

    // Initialize Chat System
    initializeChat() {
        this.setupChatUI();
        this.attachChatEventListeners();
        this.displayWelcomeMessage();
    },

    // Setup Chat UI
    setupChatUI() {
        const chatContainer = document.getElementById('chatContainer');
        if (!chatContainer) return;

        chatContainer.innerHTML = `
            <!-- Chat Header Info -->
            <div style="padding: 1rem; background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%); color: white; border-radius: 12px; margin-bottom: 1rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">üß† Business Intelligence Chat</h3>
                <p style="font-size: 0.8rem; opacity: 0.9;">Drill down into programs, fields, files, and business logic</p>
            </div>

            <!-- Chat Context Selector -->
            <div class="form-section" id="chatContextSection" style="display: none;">
                <div class="form-section-title">
                    <span style="color: var(--info-blue);">üéØ</span>
                    Chat Context
                </div>
                <div class="form-group">
                    <label class="form-label">Current Focus</label>
                    <select id="chatContext" class="form-input">
                        <option value="general">General Analysis</option>
                        <option value="component">Specific Component</option>
                        <option value="dependencies">Dependencies</option>
                        <option value="modernization">Modernization</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Selected Item</label>
                    <input type="text" id="chatSelectedItem" class="form-input" placeholder="Auto-selected based on dashboard" readonly>
                </div>
            </div>

            <!-- Chat Suggestions -->
            <div id="chatSuggestions" class="chat-suggestions" style="display: none;">
                <div class="chat-suggestions-title">üí° Suggested Questions:</div>
                <div class="chat-suggestion-chips">
                    <button class="chat-suggestion-btn" data-question="What is the business purpose of this system?">
                        üéØ Business Purpose
                    </button>
                    <button class="chat-suggestion-btn" data-question="Show me the complete dependency flow">
                        üåä Dependency Flow
                    </button>
                    <button class="chat-suggestion-btn" data-question="What are the missing dependencies and their impact?">
                        ‚ö†Ô∏è Missing Dependencies
                    </button>
                    <button class="chat-suggestion-btn" data-question="How can we optimize this system for modernization?">
                        üöÄ Optimization
                    </button>
                    <button class="chat-suggestion-btn" data-question="What business rules are implemented?">
                        ‚öñÔ∏è Business Rules
                    </button>
                    <button class="chat-suggestion-btn" data-question="What components have the highest risk?">
                        üìä Risk Analysis
                    </button>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Chat Input Section -->
            <div class="chat-input-section">
                <div class="chat-input-group">
                    <textarea id="chatInput" 
                              class="chat-input" 
                              placeholder="Ask about business purpose, dependencies, optimization..." 
                              disabled 
                              rows="1"></textarea>
                    <button id="chatSendBtn" class="chat-send-btn" disabled>
                        <span>Send</span>
                    </button>
                </div>
            </div>
        `;
    }
});
    
</script>
</body>
</html>